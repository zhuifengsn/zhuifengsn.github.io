<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker生产环境架设步骤 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker生产环境架设步骤" />
<meta property="og:description" content="1、 安装docker和下载docker镜像等完成前置工作。
YUM安装Docker引擎服务；
yum install docker* -y
查看Docker软件是否安装；
rpm -qa|grep docker
启动Docker引擎服务；
service docker restart
systemctl restart docker.service
查看Docker引擎服务进程；
ps -ef|grep docker
如果出错要更换yum源，阿里云测试的不行，要换清华源:
该文件夹只提供 CentOS 7 与 8，架构仅为 x86_64 ，如果需要较早版本的 CentOS，请参考 centos-vault 的帮助，若需要其他架构，请参考 centos-altarch 的帮助。
建议先备份 /etc/yum.repos.d/ 内的文件。
然后编辑 /etc/yum.repos.d/ 中的相应文件，在 mirrorlist= 开头行前面加 # 注释掉；并将 baseurl= 开头行取消注释（如果被注释的话）。 对于 CentOS 7 ，请把该行内的域名（例如mirror.centos.org）替换为 mirrors.tuna.tsinghua.edu.cn。 对于 CentOS 8 ，请把 mirror.centos.org/$contentdir 替换为 mirrors.tuna.tsinghua.edu.cn/centos。
yum makecache
2、镜像源要改国内163的快
#从docker官网仓库搜索tomcat|nginx|redis镜像；
docker search tomcat
docker search nginx" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/de651091e496121783be871cc748b45d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-01T21:35:35+08:00" />
<meta property="article:modified_time" content="2023-08-01T21:35:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker生产环境架设步骤</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>1、 安装docker和下载docker镜像等完成前置工作。<br> YUM安装Docker引擎服务；<br> yum install docker* -y<br> 查看Docker软件是否安装；<br> rpm -qa|grep docker<br> 启动Docker引擎服务；<br> service docker restart<br> systemctl restart docker.service<br> 查看Docker引擎服务进程；<br> ps -ef|grep docker</p> 
<p>如果出错要更换yum源，阿里云测试的不行，要换清华源:<br> 该文件夹只提供 CentOS 7 与 8，架构仅为 x86_64 ，如果需要较早版本的 CentOS，请参考 centos-vault 的帮助，若需要其他架构，请参考 centos-altarch 的帮助。<br> 建议先备份 /etc/yum.repos.d/ 内的文件。<br> 然后编辑 /etc/yum.repos.d/ 中的相应文件，在 mirrorlist= 开头行前面加 # 注释掉；并将 baseurl= 开头行取消注释（如果被注释的话）。 对于 CentOS 7 ，请把该行内的域名（例如mirror.centos.org）替换为 mirrors.tuna.tsinghua.edu.cn。 对于 CentOS 8 ，请把 mirror.centos.org/$contentdir 替换为 mirrors.tuna.tsinghua.edu.cn/centos。<br> yum makecache</p> 
<p>2、镜像源要改国内163的快<br> <img src="https://images2.imgbox.com/67/35/AvtR8rOP_o.png" alt="在这里插入图片描述"></p> 
<p>#从docker官网仓库搜索tomcat|nginx|redis镜像；<br> docker search tomcat<br> docker search nginx<br> docker search redis<br> #从公共仓库下载tomcat镜像；<br> docker pull docker.io/tomcat<br> docker pull docker.io/nginx<br> docker pull docker.io/redis<br> docker pull docker.io/lemonbar/centos6-ssh</p> 
<p>镜像名字太长了，改名字：<br> Docker tar docker docker.io/lemonbar/centos6-ssh centos6<br> 改完后删除原来那个名字长的：<br> Docker rmi docker.io/lemonbar/centos6-ssh<br> 改完后再用这个新镜像时记得这样的格式来指定镜像了：<br> Centos6:latest</p> 
<p>docker images<br> 查看下载好到本地的镜像</p> 
<p>#基于Docker镜像启动Tomcat容器（-i interactive交互、-t tty终端、-d daemon后台运行）；</p> 
<p>此案例只用于实验学习，如果生产中不要这样启容器，生产用—net=none不设置网卡先的，要手动指定网卡和真实物理网卡绑定的模式。</p> 
<pre><code class="prism language-bash">Docker run -–privileged –name<span class="token operator">=</span>yeng-web01 –itd –p <span class="token number">80</span>:80 docker.io/tomcat:latest   
Privileged是超级管理权限意思，--name改名
</code></pre> 
<p>Docker exec –it id或名称 passwd root<br> 直接执行命令改密码等</p> 
<p>Cp /etc/skel/.bash* /root/<br> 这样解决容器里面的centos机器名称问题老是显示bash-4.1</p> 
<p>Docker history docker.io/nginx<br> 查看镜像到底是怎么做的，可以看到一些初始密码之类的东西</p> 
<p>#查看Docker tomcat容器的运行状态；<br> docker ps -a</p> 
<p>#查看Docker tomcat容器的IP地址；<br> docker inspect 0499058becea |grep -i ipaddr</p> 
<h3><a id="2_66"></a>2、几种网络模式和创建案例：</h3> 
<p>host模式；（生产很少用）<br> Docke引擎启动容器，本来默认方式会分配给容器网络子系统，如果指定–net=host，启动后的容器不会拥有独立的网络系统，跟宿主机公用一个网络子系统，公用宿主机的IP和端口；（宿主机使用了22端口，容器不能用22端口）<br> docker run -itd --net=host --name=none_test docker.io/lemonbar/centos6-ssh</p> 
<p>None模式（生产常用，单独起个容器虚拟机系统就用这种）<br> Docker引擎启动容器，会分配给容器网络子系统，但是并不会设置网卡、IP、路由等信息，需要用户自定义去配置和添加，借助pipework工具去实现；<br> docker run -itd --net=none --name=centos6_test docker.io/lemonbar/centos6-ssh</p> 
<p>Container模式(忽略，生产环境一般没人用)<br> Docker引擎启动容器，不会分配给容器网络子系统，共享已经存在的容器的IP和网络空间，跟host模式类似的，host模式是共享宿主机，而Container模式共享容器；<br> docker run -itd --net=container:692de87ac76c --name=container_test docker.io/lemonbar/centos6-ssh sleep 999d</p> 
<p>Bridge模式（桥接模式）（如果把应用软件直接跑在dcoker上，不装操作系统容器，就用这种。用真实物理机IP+端口访问应用服务，真实机用nat转给应用，网络效率不高）<br> 默认Docker引擎启动容器，是使用桥接模式，Bridge默认模式，桥接模式：Docker0（绑定在宿主机网卡、虚拟二层交换机）；<br> 将宿主机系统的8080端口映射到容器的8080端口；（第一个端口宿主机监听的，第二个端口是容器内部服务端口）<br> 利用宿主机上的docker0网卡上网，宿主机上的docker0就是各容器的网关，也相当宿主机用docker0建了一个虚拟交接机<br> 其它容器连接上这个虚拟交换机，不仅容器间能相互连通还能上外网。<br> 而且宿主机上还多了两个vethXX网卡，一个是进一个是出，都是给容器用的。用brctl工具才能看到，要单独安装这个工具<br> 创建一个容器，宿主机上就会多一对veth网关出来<br> docker run -p 8080:8080 -itd docker.io/tomcat:latest</p> 
<h3><a id="3_netnoneIPIPIP_89"></a>3、 下面就按真实生产环境中要把虚拟交换机绑定到真实的物理网卡上面，这样以后所有以–net=none模式起的虚拟机在设置完各容器IP地址后，网络就和宿主机是平起平坐的，容器IP直接指定局域网IP，局域网网关，转发就是利用绑定的那个物理网卡出去上网。</h3> 
<p>4、必须先装安装 pipework，建议宿主机上最少两块网关，如果只有一块网卡，一会改完绑定，物理机网卡就不能上网了，如果有两块网卡可以先不装这个，一会还可以用另一网卡，绑定只用了一个物理网卡，另一个可以再设置ip进行上网。<br> 下载地址：wget https://codeload.github.com/jpetazzo/pipework/zip/refs/heads/master<br> Unzip pipework-master.zip<br> cp -p /root/pipework-master/pipework /usr/local/bin/</p> 
<p>5、如果想整完后删除原来不用的docker0网卡，还要再装一个软件(可以不用删除的，不影响，只是ifconfig查看有，但又不用，看着不爽)：<br> Yum install bridge* -y<br> Ifconfig docker0 down ( 先停掉)<br> Brctl delbr docker0 （再删除）<br> 完后重启docker 服务</p> 
<p>6、物理机上先在netwrok-script里面建立一个网卡ifcfg-br0文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@client opt<span class="token punctuation">]</span><span class="token comment"># cat ifcfg-br0 </span>
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>br0
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">"Bridge"</span>
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>static
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token number">192.168</span>.17.143
<span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token number">255.255</span>.255.0
<span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token number">192.168</span>.17.2

<span class="token number">7</span>、改真实网卡ifcfg-ens34:
<span class="token punctuation">[</span>root@client opt<span class="token punctuation">]</span><span class="token comment"># cat ifcfg-ens34</span>
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>ens34
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span>Ethernet
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>static
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">BRIDGE</span><span class="token operator">=</span><span class="token string">"br0"</span>
<span class="token comment">#IPADDR=192.168.17.143   //真机可以不写IP掩码网关</span>
<span class="token comment">#NETMASK=255.255.255.0</span>
<span class="token comment">#GATEWAY=192.168.17.2</span>

这里添加个文件加入<span class="token punctuation">(</span>centos7上要加入行，8版的不行要用其它方法<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@control<span class="token punctuation">]</span><span class="token comment"># cat /etc/docker/docker-network </span>
<span class="token assign-left variable">DOCKER_NETWORK_OPTIONS</span><span class="token operator">=</span><span class="token string">"-b=br0"</span>

重启网卡服务

接下创建容器一定要用--net<span class="token operator">=</span>none模式，如果用bridge模式会有可能和网关冲突，因为他是自动获取第一个地址的。
<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--net</span><span class="token operator">=</span>none <span class="token parameter variable">--privileged</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>nginx_test docker.io/nginx

用刚才下载的工具给容器添加IP和网关（容器重启后IP就没了，每次容器停止后再启动还得用这个命令再运行一次）
pipework br0 nginx_test <span class="token number">192.168</span>.17.188/24@192.168.17.2

查看容器IP是否完成
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx_test <span class="token function">ifconfig</span>
</code></pre> 
<h3><a id="8_143"></a>8、生产环境中创建容器常用的参数</h3> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--privileged</span> --cpuset-cpus<span class="token operator">=</span><span class="token number">0</span>-0  <span class="token parameter variable">-m</span> 512m --memory-swap<span class="token operator">=</span>512m  <span class="token parameter variable">--name</span><span class="token operator">=</span>centos110 <span class="token parameter variable">--net</span><span class="token operator">=</span>none  docker.io/lemonbar/centos6-ssh 
<span class="token punctuation">(</span><span class="token number">0</span>-0代表使用第一颗cpu，用第二颗就是1-1，每个容器都要分配不同的cpu才能进行监控方便，-m就是内存<span class="token punctuation">)</span>

查看有几颗cpu按top命令后在交互状态下按数字1就看出来了
</code></pre> 
<p>查看配置参数用：<br> Docker inspect 容器id名</p> 
<p>另一种查看方法最流行：<br> Docker stats 容ID名 --no-stream</p> 
<h3><a id="_158"></a>设置磁盘使用限制：</h3> 
<p>2种改容器的最大磁盘使用量：Docker从1.13版本开始默认磁盘驱动模式：overlay2，<br> 默认是这样的：所有容器无限制，自由使用物理机磁盘空间。</p> 
<p>先查看当前docker用哪种磁盘模式：<br> cat /etc/sysconfig/docker-storage</p> 
<p>第一种：默认是overlay2，这种模式的修改方法：</p> 
<p>用磁盘配额来限制，但是只能是xfs分区，其它的分区格式不支持<br> 可以单独加一块盘格式化成xfs<br> Mkfs.xfs –f /dev/sdb</p> 
<p>创建个目录来挂载新磁盘并开配额(对目录做配额用pquota/prjquota；如果对用户uquota/usrquota/quota)：<br> Mkdir /data/ -p<br> Mount –o pquota,prjquota /dev/sdb /data/</p> 
<p>然后查看<br> Mount |grep data</p> 
<p>创建并查看配额详情：</p> 
<pre><code class="prism language-bash">Xfs_quota  <span class="token parameter variable">-x</span>  <span class="token parameter variable">-c</span>  ‘limit  <span class="token assign-left variable">bsoft</span><span class="token operator">=</span>10M  <span class="token assign-left variable">bhard</span><span class="token operator">=</span>10M  jfedu’  /data

Xfs_quota  –x  <span class="token parameter variable">-c</span>  ‘report’  /data/
</code></pre> 
<p>把docker引擎默认数据存储目录/var/lib/docker重命名，并将/data/docker目录软链接到/var/lib/下<br> Mkdir –p /data/docker/<br> Cd /var/lib/<br> Mv docker docker.bak<br> Ln –s /data/docker/ ./</p> 
<h3><a id="docker%0APs_efgrep__docker_193"></a>设置完成后，重启docker服务查看是不是配好：<br> Ps –ef|grep docker</h3> 
<p>第二种：可以修改为磁盘模式为device mapper模式（前提是分区格式不能是xfs，要ext2-4才行）：<br> 默认是这样的：<br> <img src="https://images2.imgbox.com/97/de/sfQCNi5z_o.png" alt="在这里插入图片描述"></p> 
<p>可以修改为Device mapper模式，修改方法：<br> Cat /etc/sysconfig/docker-storage-setup<br> STORAGE_DRIVER=devicemapper<br> 下图改完后顺便给每台起的容器20G的最大使用空间，<br> cat /etc/sysconfig/docker-storage<br> DOCKER_STORAGE_OPTIONS=“–storage-driver devicemapper --storage-opt dm.basesize=20G”<br> <img src="https://images2.imgbox.com/cc/e5/HRdc5yoZ_o.png" alt="在这里插入图片描述"></p> 
<p>设置完成后，重启docker服务查看是不是配好：<br> Ps –ef|grep docker</p> 
<p>9、用pipework改容器ip地址(最后的地址是真实物理网络的网关)<br> Pipework br0 容器ID(或用刚才建立的name:centos01) 192.168.1.110/24@192.168.1.1</p> 
<p>设置好ip后，docker服务不能重启，如果重启了，容器中的ip就没了就变成127.0.0.1了，还要重新这条命令来配置，写脚本加入开机启动项也可以。<br> 10、改好后进容器查看地址是否正确：<br> Docker exec centos01 ifconfig</p> 
<h3><a id="11root123456docker_history_id_220"></a>11、进容器改root密码（默认是123456，如果不是可以用docker history id号看）</h3> 
<pre><code class="prism language-bash">Docker <span class="token builtin class-name">exec</span> –it centos01 /bin/bash 
进去容器虚拟机操作一切 

<span class="token function">docker</span> update <span class="token parameter variable">--restart</span><span class="token operator">=</span>always a9a83c499b0c 
设置开机自动启动容器，要不然关机或重启docker服务后，容器不会自动开
</code></pre> 
<h3><a id="9webapiweb_230"></a>9、如果有需要可以装个webapi图形化来进行web管理</h3> 
<pre><code class="prism language-bash">Docker web 页面配置<span class="token punctuation">(</span>更详细的配置在csdn上我有单独的贴子<span class="token punctuation">)</span>：
先下载下来这个镜像
<span class="token function">docker</span> pull  docker.io/uifd/ui-for-docker
再启容器:
用brige模式，用真机的另一个网卡加上9000访问<span class="token punctuation">(</span>亲测必须这样，不能用那种none模式网络<span class="token punctuation">)</span>：
<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--privileged</span> --cpuset-cpus<span class="token operator">=</span><span class="token number">0</span>-0 <span class="token parameter variable">-m</span> 512m --memory-swap<span class="token operator">=</span>512m <span class="token parameter variable">--name</span><span class="token operator">=</span>apiweb <span class="token parameter variable">-p</span> <span class="token number">9000</span>:9000 <span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock docker.io/uifd/ui-for-docker
再用浏览器打开真机的网卡地址：9000就能打开web页面了


<span class="token number">10</span>、cadvisor监控：
先下载镜像:
<span class="token function">docker</span> pull docker.io/google/cadvisor
<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--privileged</span> --cpuset-cpus<span class="token operator">=</span><span class="token number">0</span>-0 <span class="token parameter variable">-m</span> 512m --memory-swap<span class="token operator">=</span>512m <span class="token parameter variable">--name</span><span class="token operator">=</span>jk <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock docker.io/google/cadvisor
再用浏览器打开真机的网卡地址：8080就能打开web页面了
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4507ce4e2209cf7a8164727d9649291f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">docker启动报错：Cannot connect to the Docker daemon</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5f686f56dbea5a356b6eddf50e9d58b2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue跳转到新的页面之后，不让其回退的解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>