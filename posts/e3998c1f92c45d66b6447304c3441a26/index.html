<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Wi-Fi直连 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Wi-Fi直连" />
<meta property="og:description" content="这几天看wifi直连的内容，对其中的api还不熟悉，总是看一个就去网上搜，好麻烦。所以果断的将下面文章(http://wiki.eoeandroid.com/Wi-Fi_Direct)给复制下来供参考使用。 Wi-Fi 直连 Wi-Fi 直连技术允许已经配备了相应硬件并预装了Android 4.0(API level 14)或更后的操作系统的设备在不需要Wi-Fi中间热点的支持下通过Wi-Fi直接互联的技术。使用这些API,你可以发现和连接其他支持此技术的设 备，然后以距离远超蓝牙连接技术且速度更快的方式进行通信。这项技术对于一些多用户共享资料，比如多用户联机游戏或者相片分享等应用非常有用。
Wi-Fi直连技术的API包含以下主要部分：
允许用户发现，请求然后连接对等设备的各种方法，定义在WifiP2pManager类中。允许用户定义收到调用WifiP2pManager类中方法成功或失败的通知的监听器。当用户调用WifiP2pManager类中的方法时，每一个方法都可以收到一个以参数形式传过来的特定监听。通知用户被Wi-Fi直连技术框架检测到的特定事件的意图，比如一个已丢掉的连接或者一个新的对等设备的发现等。 你经常会同时使用这三个主要组件的相关功能。例如，你可以为去调用android.net.wifi.p2p.WifiP2pManager.ActionListener) discoverPeers()方法而提供一个WifiP2pManager.ActionListener的监听器，这样以后你可以收到一个ActionListener.onSuccess()或者ActionListener.onFailure()方法的通知。一个WIFI_P2P_PEERS_CHANGED_ACTION意图同时也是当android.net.wifi.p2p.WifiP2pManager.ActionListener) discoverPeers()方法发现的对等设备列表发生改变时的一个广播。
API 概述 WifiP2pManager类提供了很多方法允许用户通过设备的Wi-Fi模块来进行交互，比如做一些如发现，连接其他对等设备的事情。下列的方法都是可以使用的： 表格1.Wi-Fi直连技术方法
方法名详细描述 initialize()
通过Wi-Fi框架对应用来进行注册。这个方法必须在任何其他Wi-Fi直连方法使用之前调用。
connect()]
开始一个拥有特定设置的设备的点对点连接。
cancelConnect()
取消任何一个正在进行的点对点组的连接。
requestConnectInfo()
获取一个设备的连接信息。
createGroup()
以当前设备为组拥有者来创建一个点对点连接组。
removeGroup()
移除当前的点对点连接组。
requestGroupInfo()
获取点对点连接组的信息。
discoverPeers()
初始化对等设备的发现。
requestPeers()
获取当前发现的对等设备列表。
WifiP2pManager的方法可以让你在一个监听器里传递参数，这样Wi-fi直连框架就可以通知给你的窗体这个方法调用的状态。可以被使用的监听器接口和使用监听器的相应的WifiP2pManager的方法的调用都将在下面这张表中有所描述：
表格 2. Wi-Fi直连监听器方法
监听器接口相关联的方法 WifiP2pManager.ActionListener
connect(), cancelConnect(), createGroup(), removeGroup(), and discoverPeers()
WifiP2pManager.ChannelListener
initialize()
WifiP2pManager.ConnectionInfoListener
requestConnectInfo()
WifiP2pManager.GroupInfoListener
requestGroupInfo()
WifiP2pManager.PeerListListener
requestPeers()
Wi-Fi直连技术的API定义了一些当特定的Wi-Fi直连事件发生时作为广播的意图，比如说当一个新的对等设备被发现，或者一个设备的Wi-Fi状态的改变。你可以在你的应用里通过创建一个处理这些意图的广播接收器来注册去接收这些意图。
Table 3. Wi-Fi 直连意图
意图名称详细描述 WIFI_P2P_CONNECTION_CHANGED_ACTION
当设备的Wi-Fi连接信息状态改变时候进行广播。
WIFI_P2P_PEERS_CHANGED_ACTION
当调用discoverPeers()方法的时候进行广播。在你的应用里处理此意图时，你通常会调用requestPeers()去获得对等设备列表的更新。
WIFI_P2P_STATE_CHANGED_ACTION
当设备的Wi-Fi 直连功能打开或关闭时进行广播。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/e3998c1f92c45d66b6447304c3441a26/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-02-26T10:22:10+08:00" />
<meta property="article:modified_time" content="2013-02-26T10:22:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Wi-Fi直连</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="iteye-blog-content-contain" style="font-size:14px;"> 
 <h6>这几天看wifi直连的内容，对其中的api还不熟悉，总是看一个就去网上搜，好麻烦。所以果断的将下面文章(http://wiki.eoeandroid.com/Wi-Fi_Direct)给复制下来供参考使用。<img title="吐舌头" src="https://images2.imgbox.com/14/08/rWRvDaCf_o.gif" alt="吐舌头" border="0"></h6> 
 <p> </p> 
 <h2><span id="Wi-Fi_.E7.9B.B4.E8.BF.9E" class="mw-headline">Wi-Fi 直连</span></h2> 
 <p>Wi-Fi 直连技术允许已经配备了相应硬件并预装了Android 4.0(API level 14)或更后的操作系统的设备在不需要Wi-Fi中间热点的支持下通过Wi-Fi直接互联的技术。使用这些API,你可以发现和连接其他支持此技术的设 备，然后以距离远超蓝牙连接技术且速度更快的方式进行通信。这项技术对于一些多用户共享资料，比如多用户联机游戏或者相片分享等应用非常有用。</p> 
 <p>Wi-Fi直连技术的API包含以下主要部分：</p> 
 <ul><li>允许用户发现，请求然后连接对等设备的各种方法，定义在<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html" rel="nofollow">WifiP2pManager</a>类中。</li><li>允许用户定义收到调用<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html" rel="nofollow">WifiP2pManager</a>类中方法成功或失败的通知的监听器。当用户调用<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html" rel="nofollow">WifiP2pManager</a>类中的方法时，每一个方法都可以收到一个以参数形式传过来的特定监听。</li><li>通知用户被Wi-Fi直连技术框架检测到的特定事件的意图，比如一个已丢掉的连接或者一个新的对等设备的发现等。</li></ul> 
 <p>你经常会同时使用这三个主要组件的相关功能。例如，你可以为去调用<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html#discoverPeers%28android.net.wifi.p2p.WifiP2pManager.Channel," rel="nofollow">android.net.wifi.p2p.WifiP2pManager.ActionListener) discoverPeers()</a>方法而提供一个<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.ActionListener.html" rel="nofollow">WifiP2pManager.ActionListener</a>的监听器，这样以后你可以收到一个<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.ActionListener.html#onSuccess%28%29" rel="nofollow">ActionListener.onSuccess()</a>或者<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.ActionListener.html#onFailure%28int%29" rel="nofollow">ActionListener.onFailure()</a>方法的通知。一个<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html#WIFI_P2P_PEERS_CHANGED_ACTION" rel="nofollow">WIFI_P2P_PEERS_CHANGED_ACTION</a>意图同时也是当<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html#discoverPeers%28android.net.wifi.p2p.WifiP2pManager.Channel," rel="nofollow">android.net.wifi.p2p.WifiP2pManager.ActionListener) discoverPeers()</a>方法发现的对等设备列表发生改变时的一个广播。</p> 
 <h3><span id="API_.E6.A6.82.E8.BF.B0" class="mw-headline">API 概述</span></h3> 
 <p><a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html" rel="nofollow">WifiP2pManager</a>类提供了很多方法允许用户通过设备的Wi-Fi模块来进行交互，比如做一些如发现，连接其他对等设备的事情。下列的方法都是可以使用的： 表格1.Wi-Fi直连技术方法</p> 
 <table style="border-spacing:0px;border-left:1px solid #cccccc;border-top:1px solid #cccccc;"><tbody><tr><th style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;">方法名</th><th style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;">详细描述</th></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>initialize()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>通过Wi-Fi框架对应用来进行注册。这个方法必须在任何其他Wi-Fi直连方法使用之前调用。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>connect()]</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>开始一个拥有特定设置的设备的点对点连接。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>cancelConnect()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>取消任何一个正在进行的点对点组的连接。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>requestConnectInfo()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>获取一个设备的连接信息。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>createGroup()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>以当前设备为组拥有者来创建一个点对点连接组。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>removeGroup()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>移除当前的点对点连接组。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>requestGroupInfo()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>获取点对点连接组的信息。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>discoverPeers()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>初始化对等设备的发现。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>requestPeers()</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>获取当前发现的对等设备列表。</p> </td></tr></tbody></table> 
 <p><a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html" rel="nofollow">WifiP2pManager</a>的方法可以让你在一个监听器里传递参数，这样Wi-fi直连框架就可以通知给你的窗体这个方法调用的状态。可以被使用的监听器接口和使用监听器的相应的<a class="external text" href="http://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html" rel="nofollow">WifiP2pManager</a>的方法的调用都将在下面这张表中有所描述：</p> 
 <p>表格 2. Wi-Fi直连监听器方法</p> 
 <table style="border-spacing:0px;border-left:1px solid #cccccc;border-top:1px solid #cccccc;"><tbody><tr><th style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;">监听器接口</th><th style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;">相关联的方法</th></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WifiP2pManager.ActionListener</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>connect(), cancelConnect(), createGroup(), removeGroup(), and discoverPeers()</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WifiP2pManager.ChannelListener</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>initialize()</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WifiP2pManager.ConnectionInfoListener</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>requestConnectInfo()</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WifiP2pManager.GroupInfoListener</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>requestGroupInfo()</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WifiP2pManager.PeerListListener</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>requestPeers()</p> </td></tr></tbody></table> 
 <p>Wi-Fi直连技术的API定义了一些当特定的Wi-Fi直连事件发生时作为广播的意图，比如说当一个新的对等设备被发现，或者一个设备的Wi-Fi状态的改变。你可以在你的应用里通过创建一个处理这些意图的广播接收器来注册去接收这些意图。</p> 
 <p>Table 3. Wi-Fi 直连意图</p> 
 <table style="border-spacing:0px;border-left:1px solid #cccccc;border-top:1px solid #cccccc;"><tbody><tr><th style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;">意图名称</th><th style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;">详细描述</th></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WIFI_P2P_CONNECTION_CHANGED_ACTION</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>当设备的Wi-Fi连接信息状态改变时候进行广播。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WIFI_P2P_PEERS_CHANGED_ACTION</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>当调用discoverPeers()方法的时候进行广播。在你的应用里处理此意图时，你通常会调用requestPeers()去获得对等设备列表的更新。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WIFI_P2P_STATE_CHANGED_ACTION</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>当设备的Wi-Fi 直连功能打开或关闭时进行广播。</p> </td></tr><tr style="vertical-align:top;"><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>WIFI_P2P_THIS_DEVICE_CHANGED_ACTION</p> </td><td style="border-right:1px solid #cccccc;border-bottom:1px solid #cccccc;"> <p>当设备的详细信息改变的时候进行广播，比如设备的名称</p> </td></tr></tbody></table> 
 <h3><span id=".E5.88.9B.E5.BB.BA.E4.B8.80.E4.B8.AAWi-Fi.E7.9B.B4.E8.BF.9E.E6.84.8F.E5.9B.BE.E4.BD.BF.E7.94.A8.E7.9A.84.E5.B9.BF.E6.92.AD.E6.8E.A5.E6.94.B6.E5.99.A8" class="mw-headline">创建一个Wi-Fi直连意图使用的广播接收器</span></h3> 
 <p>一个广播接收器允许你接收由android系统发布的意图广播，这样你的应用就可以对那些你感兴趣的事件作出响应。创建一个基本的Wi-Fi直连意图使用的广播接收器的步骤如下：</p> 
 <p>1.创建一个继承自BroadcastReceiver的类。对于类的构造，一般最常用的就是以WifiP2pManager, WifiP2pManager.Channel作为参数，同时这个广播接收器对应的窗体也将被注册进来。这个广播接收器可以像窗体发送更新或者在需要的时 候可以访问Wi-Fi硬件或通信通道。</p> 
 <p>2.在广播接收器里，处理onReceive()方法里你感兴趣的意图。执行接收到的意图的任何需要的动作。比如，广播接收器接收到一个 WIFI_P2P_PEERS_CHANGED_ACTION的意图，你就要调用requestPeers()方法去获得当前发现的对等设备列表。</p> 
 <p>下面的代码展示了怎样去创建一个典型的广播接收器。广播接收器接收一个WifiP2pManager对象和一个窗体对象作为参数然后利用这两个类去处理接收到的意图的特定的动作需求。</p> 
 <pre><code class="language-java"> 
<span style="color:#808080;font-style:italic;">/**
 * A BroadcastReceiver that notifies of important Wi-Fi p2p events.
 */</span>
<span style="color:#000000;font-weight:bold;">public</span> <span style="color:#000000;font-weight:bold;">class</span> WiFiDirectBroadcastReceiver <span style="color:#000000;font-weight:bold;">extends</span> BroadcastReceiver <span style="color:#66cc66;">{<!-- --></span>
 
    <span style="color:#000000;font-weight:bold;">private</span> WifiP2pManager manager;
    <span style="color:#000000;font-weight:bold;">private</span> Channel channel;
    <span style="color:#000000;font-weight:bold;">private</span> MyWiFiActivity activity;
 
    <span style="color:#000000;font-weight:bold;">public</span> WiFiDirectBroadcastReceiver<span style="color:#66cc66;">(</span>WifiP2pManager manager, Channel channel,
            MyWifiActivity activity<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#000000;font-weight:bold;">super</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
        <span style="color:#000000;font-weight:bold;">this</span>.<span style="color:#006600;">manager</span> = manager;
        <span style="color:#000000;font-weight:bold;">this</span>.<span style="color:#006600;">channel</span> = channel;
        <span style="color:#000000;font-weight:bold;">this</span>.<span style="color:#006600;">activity</span> = activity;
    <span style="color:#66cc66;">}</span>
 
    @Override
    <span style="color:#000000;font-weight:bold;">public</span> <span style="color:#993333;">void</span> onReceive<span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AContext+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Context</span></a> context, Intent intent<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AString+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">String</span></a> action = intent.<span style="color:#006600;">getAction</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
 
        <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_STATE_CHANGED_ACTION</span>.<span style="color:#006600;">equals</span><span style="color:#66cc66;">(</span>action<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#808080;font-style:italic;">// Check to see if Wi-Fi is enabled and notify appropriate activity</span>
        <span style="color:#66cc66;">}</span> <span style="color:#b1b100;">else</span> <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_PEERS_CHANGED_ACTION</span>.<span style="color:#006600;">equals</span><span style="color:#66cc66;">(</span>action<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#808080;font-style:italic;">// Call WifiP2pManager.requestPeers() to get a list of current peers</span>
        <span style="color:#66cc66;">}</span> <span style="color:#b1b100;">else</span> <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_CONNECTION_CHANGED_ACTION</span>.<span style="color:#006600;">equals</span><span style="color:#66cc66;">(</span>action<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#808080;font-style:italic;">// Respond to new connection or disconnections</span>
        <span style="color:#66cc66;">}</span> <span style="color:#b1b100;">else</span> <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_THIS_DEVICE_CHANGED_ACTION</span>.<span style="color:#006600;">equals</span><span style="color:#66cc66;">(</span>action<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#808080;font-style:italic;">// Respond to this device's wifi state changing</span>
        <span style="color:#66cc66;">}</span>
    <span style="color:#66cc66;">}</span>
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <h3><span id=".E5.88.9B.E5.BB.BA.E4.B8.80.E4.B8.AAWi-Fi.E7.9B.B4.E8.BF.9E.E7.9A.84.E5.BA.94.E7.94.A8" class="mw-headline">创建一个Wi-Fi直连的应用</span></h3> 
 <p>创建一个Wi-Fi直连的应用包括创建和注册一个广播接收器，发现其他设备，连接其他设备，然后传输数据等步骤。接下来的几个部分描述了怎么去做这些工作。</p> 
 <h4><span id=".E5.88.9D.E5.A7.8B.E5.8C.96.E8.AE.BE.E7.BD.AE" class="mw-headline">初始化设置</span></h4> 
 <p>在使用Wi-Fi直连的API之前，你必须确保你的应用可以访问设备的硬件并且你的设备要支持Wi-Fi直连的通讯协议。如果Wi-Fi直连技术是 支持的，你可以获得一个WifiP2pManager的实例对象，然后创建并注册你的广播接收器，然后开始使用Wi-Fi直连的API方法。</p> 
 <p>1.为设备的Wi-Fi硬件获取权限并在Android的清单文件中声明你的应用正确使用的最低SDK版本：</p> 
 <pre><code class="language-java"> 
&lt;uses-sdk android:minSdkVersion=<span style="color:#ff0000;">"14"</span> /&gt;
&lt;uses-permission android:name=<span style="color:#ff0000;">"android.permission.ACCESS_WIFI_STATE"</span> /&gt;
&lt;uses-permission android:name=<span style="color:#ff0000;">"android.permission.CHANGE_WIFI_STATE"</span> /&gt;
&lt;uses-permission android:name=<span style="color:#ff0000;">"android.permission.CHANGE_NETWORK_STATE"</span> /&gt;
&lt;uses-permission android:name=<span style="color:#ff0000;">"android.permission.INTERNET"</span> /&gt;
&lt;uses-permission android:name=<span style="color:#ff0000;">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;
 
 </code></pre> 
 <p>2.检查设备是否支持Wi-Fi直连技术。一种好的解决办法是当你的广播接收器接收到一个WIFI_P2P_STATE_CHANGED_ACTION意图。通知你的窗体Wi-Fi直连的状态和相应的反应。</p> 
 <pre><code class="language-java"> 
@Override
<span style="color:#000000;font-weight:bold;">public</span> <span style="color:#993333;">void</span> onReceive<span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AContext+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Context</span></a> context, Intent intent<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
    ...
    <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AString+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">String</span></a> action = intent.<span style="color:#006600;">getAction</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_STATE_CHANGED_ACTION</span>.<span style="color:#006600;">equals</span><span style="color:#66cc66;">(</span>action<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#993333;">int</span> state = intent.<span style="color:#006600;">getIntExtra</span><span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">EXTRA_WIFI_STATE</span>, <span style="color:#cc66cc;">-1</span><span style="color:#66cc66;">)</span>;
        <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>state == WifiP2pManager.<span style="color:#006600;">WIFI_P2P_STATE_ENABLED</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#808080;font-style:italic;">// Wifi Direct is enabled</span>
        <span style="color:#66cc66;">}</span> <span style="color:#b1b100;">else</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#808080;font-style:italic;">// Wi-Fi Direct is not enabled</span>
        <span style="color:#66cc66;">}</span>
    <span style="color:#66cc66;">}</span>
    ...
<span style="color:#66cc66;">}</span>
 
 </code></pre> 
 <p>3.在你的窗体的onCreate()方法里，获得一个WifiP2pManager的实例并调用initialize()方法通过Wi-Fi直连 框架去注册你的应用。这个方法返回一个WifiP2pManager.Channel对象，是被用来连接你的应用和Wi-Fi直连框架的。你应该再创建一 个以WifiP2pManager和WifiP2pManager.Channel为参数且关联你的窗体的广播接收器的实例。这样你的广播接收器就可以接 收到你感兴趣的事件去通知你的窗体并更新它。它还可以让你在需要的时候操纵设备的Wi-Fi状态。</p> 
 <pre><code class="language-java"> 
WifiP2pManager mManager;
Channel mChannel;
BroadcastReceiver mReceiver;
...
@Override
<span style="color:#000000;font-weight:bold;">protected</span> <span style="color:#993333;">void</span> onCreate<span style="color:#66cc66;">(</span>Bundle savedInstanceState<span style="color:#66cc66;">)</span><span style="color:#66cc66;">{<!-- --></span>
    ...
    <span style="color:#006600;">mManager</span> = <span style="color:#66cc66;">(</span>WifiP2pManager<span style="color:#66cc66;">)</span> getSystemService<span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AContext+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Context</span></a>.<span style="color:#006600;">WIFI_P2P_SERVICE</span><span style="color:#66cc66;">)</span>;
    mChannel = mManager.<span style="color:#006600;">initialize</span><span style="color:#66cc66;">(</span><span style="color:#000000;font-weight:bold;">this</span>, getMainLooper<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>, <span style="color:#000000;font-weight:bold;">null</span><span style="color:#66cc66;">)</span>;
    mReceiver = <span style="color:#000000;font-weight:bold;">new</span> WiFiDirectBroadcastReceiver<span style="color:#66cc66;">(</span>manager, channel, <span style="color:#000000;font-weight:bold;">this</span><span style="color:#66cc66;">)</span>;
    ...
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <p>4.创建一个意图过滤器并把它添加在你的广播接收器需要处理的意图上。</p> 
 <pre><code class="language-java"> 
IntentFilter mIntentFilter;
...
@Override
<span style="color:#000000;font-weight:bold;">protected</span> <span style="color:#993333;">void</span> onCreate<span style="color:#66cc66;">(</span>Bundle savedInstanceState<span style="color:#66cc66;">)</span><span style="color:#66cc66;">{<!-- --></span>
    ...
    <span style="color:#006600;">mIntentFilter</span> = <span style="color:#000000;font-weight:bold;">new</span> IntentFilter<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    mIntentFilter.<span style="color:#006600;">addAction</span><span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_STATE_CHANGED_ACTION</span><span style="color:#66cc66;">)</span>;
    mIntentFilter.<span style="color:#006600;">addAction</span><span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_PEERS_CHANGED_ACTION</span><span style="color:#66cc66;">)</span>;
    mIntentFilter.<span style="color:#006600;">addAction</span><span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_CONNECTION_CHANGED_ACTION</span><span style="color:#66cc66;">)</span>;
    mIntentFilter.<span style="color:#006600;">addAction</span><span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_THIS_DEVICE_CHANGED_ACTION</span><span style="color:#66cc66;">)</span>;
    ...
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <p>5.注册你的广播接收器在窗体的onResume()方法，解除注册在onPause()方法中。</p> 
 <pre><code class="language-java"> 
<span style="color:#808080;font-style:italic;">/* register the broadcast receiver with the intent values to be matched */</span>
@Override
<span style="color:#000000;font-weight:bold;">protected</span> <span style="color:#993333;">void</span> onResume<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
    <span style="color:#000000;font-weight:bold;">super</span>.<span style="color:#006600;">onResume</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    registerReceiver<span style="color:#66cc66;">(</span>mReceiver, mIntentFilter<span style="color:#66cc66;">)</span>;
<span style="color:#66cc66;">}</span>
<span style="color:#808080;font-style:italic;">/* unregister the broadcast receiver */</span>
@Override
<span style="color:#000000;font-weight:bold;">protected</span> <span style="color:#993333;">void</span> onPause<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
    <span style="color:#000000;font-weight:bold;">super</span>.<span style="color:#006600;">onPause</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    unregisterReceiver<span style="color:#66cc66;">(</span>mReceiver<span style="color:#66cc66;">)</span>;
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <p>当你获取到一个WifiP2pManager.Channel对象并且设置好你的广播接收器时，你的应用就可以调用Wi-Fi直连的方法并且可以接收Wi-Fi直连的意图。</p> 
 <p>你可以现在就通过调用WifiP2pManager中的方法取实现你的应用体验Wi-Fi直连技术的特性了。下面的章节描述了怎样去实现一些常用的操作，比如说发现其他设备和连接它们。</p> 
 <p> </p> 
 <h4><span id=".E5.8F.91.E7.8E.B0.E5.AF.B9.E7.AD.89.E8.AE.BE.E5.A4.87" class="mw-headline">发现对等设备</span></h4> 
 <p>要发现可以使用并连接的对等设备，调用discoverPeers()方法去检测在范围内的可使用设备。这个方法的调用是异步的同时如果你创建了一 个WifiP2pManager.ActionListener监听器的话你会通过onSuccess()或者onFailure()方法收到发现成功或 失败的消息。onSuccess()方法只能通知你发现的过程是否成功而不能提供任何关于发现设备的信息：</p> 
 <pre><code class="language-java"> 
manager.<span style="color:#006600;">discoverPeers</span><span style="color:#66cc66;">(</span>channel, <span style="color:#000000;font-weight:bold;">new</span> WifiP2pManager.<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AActionListener+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">ActionListener</span></a><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
    @Override
    <span style="color:#000000;font-weight:bold;">public</span> <span style="color:#993333;">void</span> onSuccess<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        ...
    <span style="color:#66cc66;">}</span>
 
    @Override
    <span style="color:#000000;font-weight:bold;">public</span> <span style="color:#993333;">void</span> onFailure<span style="color:#66cc66;">(</span><span style="color:#993333;">int</span> reasonCode<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        ...
    <span style="color:#66cc66;">}</span>
<span style="color:#66cc66;">}</span><span style="color:#66cc66;">)</span>;
 </code></pre> 
 <p>如果发现过程成功且检测到了对等设备，系统将会广播出一个WIFI_P2P_PEERS_CHANGED_ACTION意图，这样你就可以利用广播 监听器监听并获得发现设备的列表。当你的应用接收到WIFI_P2P_PEERS_CHANGED_ACTION意图时，你就可以调用 requestPeers()方法来获取发现设备的列表，代码如下：</p> 
 <pre><code class="language-java"> 
PeerListListener myPeerListListener;
...
<span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>WifiP2pManager.<span style="color:#006600;">WIFI_P2P_PEERS_CHANGED_ACTION</span>.<span style="color:#006600;">equals</span><span style="color:#66cc66;">(</span>action<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
 
    <span style="color:#808080;font-style:italic;">// request available peers from the wifi p2p manager. This is an</span>
    <span style="color:#808080;font-style:italic;">// asynchronous call and the calling activity is notified with a</span>
    <span style="color:#808080;font-style:italic;">// callback on PeerListListener.onPeersAvailable()</span>
    <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>manager != <span style="color:#000000;font-weight:bold;">null</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        manager.<span style="color:#006600;">requestPeers</span><span style="color:#66cc66;">(</span>channel, myPeerListListener<span style="color:#66cc66;">)</span>;
    <span style="color:#66cc66;">}</span>
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <h4><span id=".E8.BF.9E.E6.8E.A5.E5.88.B0.E8.AE.BE.E5.A4.87" class="mw-headline">连接到设备</span></h4> 
 <p>当你已经找到你要连接的设备在获得发现设备列表之后，调用connect()方法去连接指定设备。这个方法的调用需要一个包含待连接设备信息的 WifiP2pConfig对象。你可以通过WifiP2pManager.ActionListener接收到连接是否成功的通知。下面的代码展示了怎 样去连接一个想得到的连接：</p> 
 <pre><code class="language-java"> 
<span style="color:#808080;font-style:italic;">//obtain a peer from the WifiP2pDeviceList</span>
WifiP2pDevice device;
WifiP2pConfig config = <span style="color:#000000;font-weight:bold;">new</span> WifiP2pConfig<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
config.<span style="color:#006600;">deviceAddress</span> = device.<span style="color:#006600;">deviceAddress</span>;
manager.<span style="color:#006600;">connect</span><span style="color:#66cc66;">(</span>channel, config, <span style="color:#000000;font-weight:bold;">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AActionListener+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">ActionListener</span></a><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
 
    @Override
    <span style="color:#000000;font-weight:bold;">public</span> <span style="color:#993333;">void</span> onSuccess<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#808080;font-style:italic;">//success logic</span>
    <span style="color:#66cc66;">}</span>
 
    @Override
    <span style="color:#000000;font-weight:bold;">public</span> <span style="color:#993333;">void</span> onFailure<span style="color:#66cc66;">(</span><span style="color:#993333;">int</span> reason<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#808080;font-style:italic;">//failure logic</span>
    <span style="color:#66cc66;">}</span>
<span style="color:#66cc66;">}</span><span style="color:#66cc66;">)</span>;
 </code></pre> 
 <h4><span id=".E6.95.B0.E6.8D.AE.E4.BC.A0.E8.BE.93" class="mw-headline">数据传输</span></h4> 
 <p>一旦连接已经建立，你可以通过套接字来进行数据的传输。基本的数据传输步骤如下：</p> 
 <p>1.创建一个ServerSocket对象。这个服务端套接字对象等待一个来自指定地址和端口的客户端的连接且阻塞线程直到连接发生，所以把它建立在一个后台线程里。</p> 
 <p>2.创建一个客户端Socket.这个客户端套接字对象使用指定ip地址和端口去连接服务端设备。</p> 
 <p>3.从客户端给服务端发送数据。当客户端成功连接服务端设备后，你可以通过字节流从客户端给服务端发送数据。</p> 
 <p>4.服务端等待客户端的连接(使用accept()方法)。这个调用阻塞服务端线程直到客户端连接上，所以叫这个过程一个新的线程。当连接建立时，服务端可以接受来自客户端的数据。执行关于数据的任何动作，比如保存数据或者展示给用户。</p> 
 <p>下来的例子，从Wi-Fi直连示例改编而来，展示了怎样去创建服务端和客户端的连接和通信，并且使用一个客户端到服务端的服务来传输了一张JPEG图像。如需要得到一个完整的商业例子，请移步Wi-Fi直连示例。</p> 
 <pre><code class="language-java"> 
<span style="color:#000000;font-weight:bold;">public</span> <span style="color:#000000;font-weight:bold;">static</span> <span style="color:#000000;font-weight:bold;">class</span> FileServerAsyncTask <span style="color:#000000;font-weight:bold;">extends</span> AsyncTask <span style="color:#66cc66;">{<!-- --></span>
 
    <span style="color:#000000;font-weight:bold;">private</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AContext+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Context</span></a> context;
    <span style="color:#000000;font-weight:bold;">private</span> TextView statusText;
 
    <span style="color:#000000;font-weight:bold;">public</span> FileServerAsyncTask<span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AContext+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Context</span></a> context, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AView+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">View</span></a> statusText<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#000000;font-weight:bold;">this</span>.<span style="color:#006600;">context</span> = context;
        <span style="color:#000000;font-weight:bold;">this</span>.<span style="color:#006600;">statusText</span> = <span style="color:#66cc66;">(</span>TextView<span style="color:#66cc66;">)</span> statusText;
    <span style="color:#66cc66;">}</span>
 
    @Override
    <span style="color:#000000;font-weight:bold;">protected</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AString+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">String</span></a> doInBackground<span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AVoid+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Void</span></a>... <span style="color:#006600;">params</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#000000;font-weight:bold;">try</span> <span style="color:#66cc66;">{<!-- --></span>
 
            <span style="color:#808080;font-style:italic;">/**
             * Create a server socket and wait for client connections. This
             * call blocks until a connection is accepted from a client
             */</span>
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AServerSocket+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">ServerSocket</span></a> serverSocket = <span style="color:#000000;font-weight:bold;">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AServerSocket+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">ServerSocket</span></a><span style="color:#66cc66;">(</span><span style="color:#cc66cc;">8888</span><span style="color:#66cc66;">)</span>;
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3ASocket+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Socket</span></a> client = serverSocket.<span style="color:#006600;">accept</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
 
            <span style="color:#808080;font-style:italic;">/**
             * If this code is reached, a client has connected and transferred data
             * Save the input stream from the client as a JPEG file
             */</span>
            <span style="color:#000000;font-weight:bold;">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AFile+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">File</span></a> f = <span style="color:#000000;font-weight:bold;">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AFile+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">File</span></a><span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AEnvironment+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Environment</span></a>.<span style="color:#006600;">getExternalStorageDirectory</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> + <span style="color:#ff0000;">"/"</span>
                    + context.<span style="color:#006600;">getPackageName</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span> + <span style="color:#ff0000;">"/wifip2pshared-"</span> + <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3ASystem+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">System</span></a>.<span style="color:#006600;">currentTimeMillis</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>
                    + <span style="color:#ff0000;">".jpg"</span><span style="color:#66cc66;">)</span>;
 
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AFile+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">File</span></a> dirs = <span style="color:#000000;font-weight:bold;">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AFile+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">File</span></a><span style="color:#66cc66;">(</span>f.<span style="color:#006600;">getParent</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span>;
            <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>!dirs.<span style="color:#006600;">exists</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span>
                dirs.<span style="color:#006600;">mkdirs</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
            f.<span style="color:#006600;">createNewFile</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AInputStream+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">InputStream</span></a> inputstream = client.<span style="color:#006600;">getInputStream</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
            copyFile<span style="color:#66cc66;">(</span>inputstream, <span style="color:#000000;font-weight:bold;">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AFileOutputStream+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">FileOutputStream</span></a><span style="color:#66cc66;">(</span>f<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span>;
            serverSocket.<span style="color:#006600;">close</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
            <span style="color:#000000;font-weight:bold;">return</span> f.<span style="color:#006600;">getAbsolutePath</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
        <span style="color:#66cc66;">}</span> <span style="color:#000000;font-weight:bold;">catch</span> <span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AIOException+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">IOException</span></a> e<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            Log.<span style="color:#006600;">e</span><span style="color:#66cc66;">(</span>WiFiDirectActivity.<span style="color:#006600;">TAG</span>, e.<span style="color:#006600;">getMessage</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span>;
            <span style="color:#000000;font-weight:bold;">return</span> <span style="color:#000000;font-weight:bold;">null</span>;
        <span style="color:#66cc66;">}</span>
    <span style="color:#66cc66;">}</span>
 
    <span style="color:#808080;font-style:italic;">/**
     * Start activity that can handle the JPEG image
     */</span>
    @Override
    <span style="color:#000000;font-weight:bold;">protected</span> <span style="color:#993333;">void</span> onPostExecute<span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AString+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">String</span></a> result<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>result != <span style="color:#000000;font-weight:bold;">null</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            statusText.<span style="color:#006600;">setText</span><span style="color:#66cc66;">(</span><span style="color:#ff0000;">"File copied - "</span> + result<span style="color:#66cc66;">)</span>;
            Intent intent = <span style="color:#000000;font-weight:bold;">new</span> Intent<span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
            intent.<span style="color:#006600;">setAction</span><span style="color:#66cc66;">(</span>android.<span style="color:#006600;">content</span>.<span style="color:#006600;">Intent</span>.<span style="color:#006600;">ACTION_VIEW</span><span style="color:#66cc66;">)</span>;
            intent.<span style="color:#006600;">setDataAndType</span><span style="color:#66cc66;">(</span>Uri.<span style="color:#006600;">parse</span><span style="color:#66cc66;">(</span><span style="color:#ff0000;">"file://"</span> + result<span style="color:#66cc66;">)</span>, <span style="color:#ff0000;">"image/*"</span><span style="color:#66cc66;">)</span>;
            context.<span style="color:#006600;">startActivity</span><span style="color:#66cc66;">(</span>intent<span style="color:#66cc66;">)</span>;
        <span style="color:#66cc66;">}</span>
    <span style="color:#66cc66;">}</span>
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <p>在客户端，使用客户端套接字连接服务端套接字并传输数据。这个例子从客户端的文件系统里传输了一张JPEG的图像到服务端。</p> 
 <pre><code class="language-java"> 
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AContext+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Context</span></a> context = <span style="color:#000000;font-weight:bold;">this</span>.<span style="color:#006600;">getApplicationContext</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AString+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">String</span></a> host;
<span style="color:#993333;">int</span> port;
<span style="color:#993333;">int</span> len;
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3ASocket+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Socket</span></a> socket = <span style="color:#000000;font-weight:bold;">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3ASocket+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">Socket</span></a><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
<span style="color:#993333;">byte</span> buf<span style="color:#66cc66;">[</span><span style="color:#66cc66;">]</span>  = <span style="color:#000000;font-weight:bold;">new</span> <span style="color:#993333;">byte</span><span style="color:#66cc66;">[</span><span style="color:#cc66cc;">1024</span><span style="color:#66cc66;">]</span>;
...
<span style="color:#000000;font-weight:bold;">try</span> <span style="color:#66cc66;">{<!-- --></span>
    <span style="color:#808080;font-style:italic;">/**
     * Create a client socket with the host,
     * port, and timeout information.
     */</span>
    socket.<span style="color:#006600;">bind</span><span style="color:#66cc66;">(</span><span style="color:#000000;font-weight:bold;">null</span><span style="color:#66cc66;">)</span>;
    socket.<span style="color:#006600;">connect</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">(</span><span style="color:#000000;font-weight:bold;">new</span> InetSocketAddress<span style="color:#66cc66;">(</span>host, port<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span>, <span style="color:#cc66cc;">500</span><span style="color:#66cc66;">)</span>;
 
    <span style="color:#808080;font-style:italic;">/**
     * Create a byte stream from a JPEG file and pipe it to the output stream
     * of the socket. This data will be retrieved by the server device.
     */</span>
    <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AOutputStream+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">OutputStream</span></a> outputStream = socket.<span style="color:#006600;">getOutputStream</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    ContentResolver cr = context.<span style="color:#006600;">getContentResolver</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AInputStream+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">InputStream</span></a> inputStream = <span style="color:#000000;font-weight:bold;">null</span>;
    inputStream = cr.<span style="color:#006600;">openInputStream</span><span style="color:#66cc66;">(</span>Uri.<span style="color:#006600;">parse</span><span style="color:#66cc66;">(</span><span style="color:#ff0000;">"path/to/picture.jpg"</span><span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span>;
    <span style="color:#b1b100;">while</span> <span style="color:#66cc66;">(</span><span style="color:#66cc66;">(</span>len = inputStream.<span style="color:#006600;">read</span><span style="color:#66cc66;">(</span>buf<span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> != <span style="color:#cc66cc;">-1</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        outputStream.<span style="color:#006600;">write</span><span style="color:#66cc66;">(</span>buf, <span style="color:#cc66cc;">0</span>, len<span style="color:#66cc66;">)</span>;
    <span style="color:#66cc66;">}</span>
    outputStream.<span style="color:#006600;">close</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
    inputStream.<span style="color:#006600;">close</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
<span style="color:#66cc66;">}</span> <span style="color:#000000;font-weight:bold;">catch</span> <span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AFileNotFoundException+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">FileNotFoundException</span></a> e<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
    <span style="color:#808080;font-style:italic;">//catch logic</span>
<span style="color:#66cc66;">}</span> <span style="color:#000000;font-weight:bold;">catch</span> <span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AIOException+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">IOException</span></a> e<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
    <span style="color:#808080;font-style:italic;">//catch logic</span>
<span style="color:#66cc66;">}</span>
 
<span style="color:#808080;font-style:italic;">/**
 * Clean up any open sockets when done
 * transferring or if an exception occurred.
 */</span>
<span style="color:#000000;font-weight:bold;">finally</span> <span style="color:#66cc66;">{<!-- --></span>
    <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>socket != <span style="color:#000000;font-weight:bold;">null</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
        <span style="color:#b1b100;">if</span> <span style="color:#66cc66;">(</span>socket.<span style="color:#006600;">isConnected</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span><span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
            <span style="color:#000000;font-weight:bold;">try</span> <span style="color:#66cc66;">{<!-- --></span>
                socket.<span style="color:#006600;">close</span><span style="color:#66cc66;">(</span><span style="color:#66cc66;">)</span>;
            <span style="color:#66cc66;">}</span> <span style="color:#000000;font-weight:bold;">catch</span> <span style="color:#66cc66;">(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3AIOException+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky" rel="nofollow"><span style="color:#aaaadd;font-weight:bold;">IOException</span></a> e<span style="color:#66cc66;">)</span> <span style="color:#66cc66;">{<!-- --></span>
                <span style="color:#808080;font-style:italic;">//catch logic</span>
            <span style="color:#66cc66;">}</span>
        <span style="color:#66cc66;">}</span>
    <span style="color:#66cc66;">}</span>
<span style="color:#66cc66;">}</span>
 </code></pre> 
 <p> </p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2d6fd52205391582e25a2262cce8c85d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">比较两个文档中的文字的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e0c09e0a56e2a2289bcbcd35f1be8b6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于单链表的多项式问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>