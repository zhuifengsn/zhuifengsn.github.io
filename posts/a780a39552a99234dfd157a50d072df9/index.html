<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux内核配置——树莓派3B&#43; - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux内核配置——树莓派3B&#43;" />
<meta property="og:description" content="树莓派内核文件的获取 如果想要树莓派的内核文件，可以到
Raspberry Pi · GitHub
中选择linux（在连接树莓派的终端中利用指令uname -r来知道自己的树莓派版本）
选择对应的版本，在code里选择download.zip下载压缩包，放到windows中自己之前弄过的共享文件夹中，方便在Ubuntu中文件的传递
我们把下载好的压缩包放在一个创建好的文件夹中（SYSTEM），解压，目的是为了后续配置文件做好准备
驱动代码的编写 驱动代码的编译需要一个提前编译好的内核
编译内核就需要配置
配置的最终目标会生成.config文件，该文件指导Makefile去把有用的东西组织成内核
第一种方式：
厂家配linux内核源码，比如买树莓派，树莓派的linux内核源码商家会一并给你
查找各种内核源码的指令是：find -name *_defconfig
配置对应的内核源码：
cp 厂家.config .config
第二种方式：
make menuconfig 一项项配置，通常是基于厂家的config来配置
第三种方式：
完全自己来
我们把这个为什么配置以及方式有哪几种说清楚后，开始我们的配置工作
如何配置树莓派的linux内核 参考博文 树莓派-内核开发-说明 下载代码 编译 替换内核_树莓派-内核开发-说明 下载代码 编译 替换内核 nicekwell-CSDN博客
1、配置交叉编译（之前有记笔记，或者点击上述链接进入后进行配置） 2、配置config Linux源码中有很多工程：
树莓派1的工程是bcmrpi_defconfig
树莓派2,3的工程是bcm2709_defconfig
我们选择使用源码里自带的config（内核配置）
ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=
指定ARM架构 指定编译器 树莓派 kernel7 make bcm2709_defconfig
主要核心指令
注：上面这个指令不是分段进行
完整指令如下：
ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make bcm2709_defconfig
（当然我的建议是先把下面提到的树莓派linux内核编译提到的必要的库安装完成之后在执行这个指令）
这个指令在/home/wbw/SYSTEM/linux-rpi-4.14.y这个目录下进行
注：在你自己解压好的内核源码目录下也就是（linux-rpi-4.14.y）我之所以是4.14是因为我的树莓派版本是4.14，前面有提到。
此命令功能是获取bcm2709_defconfig的配置到.config里
树莓派linux内核编译 安装必要的库： sudo apt-get install bc" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/a780a39552a99234dfd157a50d072df9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-20T13:16:22+08:00" />
<meta property="article:modified_time" content="2024-01-20T13:16:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux内核配置——树莓派3B&#43;</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 style="margin-left:.0001pt;text-align:justify;">树莓派内核文件的获取</h3> 
<p style="margin-left:.0001pt;text-align:justify;">如果想要树莓派的内核文件，可以到</p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="https://github.com/Raspberrypi" title="Raspberry Pi · GitHub">Raspberry Pi · GitHub</a></p> 
<p style="margin-left:.0001pt;text-align:justify;">中选择linux（在连接树莓派的终端中利用指令uname -r来知道自己的树莓派版本）</p> 
<p class="img-center"><img alt="" height="79" src="https://images2.imgbox.com/4d/f6/thWwvQy0_o.png" width="335"></p> 
<p style="margin-left:.0001pt;text-align:justify;">选择对应的版本，在code里选择download.zip下载压缩包，放到windows中自己之前弄过的共享文件夹中，方便在Ubuntu中文件的传递</p> 
<p style="margin-left:.0001pt;text-align:justify;">我们把下载好的压缩包放在一个创建好的文件夹中（SYSTEM），解压，目的是为了后续配置文件做好准备</p> 
<h3 style="margin-left:.0001pt;text-align:justify;">驱动代码的编写</h3> 
<p style="margin-left:.0001pt;text-align:justify;">驱动代码的编译需要一个提前编译好的内核</p> 
<p style="margin-left:.0001pt;text-align:justify;">        编译内核就需要配置</p> 
<p style="margin-left:.0001pt;text-align:justify;">                配置的最终目标会生成.config文件，该文件指导Makefile去把有用的东西组织成内核</p> 
<p style="margin-left:.0001pt;text-align:justify;">第一种方式：</p> 
<p style="margin-left:.0001pt;text-align:justify;">厂家配linux内核源码，比如买树莓派，树莓派的linux内核源码商家会一并给你</p> 
<p style="margin-left:.0001pt;text-align:justify;">查找各种内核源码的指令是：find -name *_defconfig</p> 
<p style="margin-left:.0001pt;text-align:justify;">配置对应的内核源码：</p> 
<p style="margin-left:.0001pt;text-align:justify;">cp 厂家.config .config</p> 
<p style="margin-left:.0001pt;text-align:justify;">第二种方式：</p> 
<p style="margin-left:.0001pt;text-align:justify;">make menuconfig 一项项配置，通常是基于厂家的config来配置</p> 
<p style="margin-left:.0001pt;text-align:justify;">第三种方式：</p> 
<p style="margin-left:.0001pt;text-align:justify;">完全自己来</p> 
<p style="margin-left:.0001pt;text-align:justify;">我们把这个为什么配置以及方式有哪几种说清楚后，开始我们的配置工作</p> 
<h3 style="margin-left:.0001pt;text-align:justify;">如何配置树莓派的linux内核</h3> 
<h4>参考博文</h4> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="https://blog.csdn.net/nicekwell/article/details/78482833" title="树莓派-内核开发-说明 下载代码 编译 替换内核_树莓派-内核开发-说明 下载代码 编译 替换内核 nicekwell-CSDN博客">树莓派-内核开发-说明 下载代码 编译 替换内核_树莓派-内核开发-说明 下载代码 编译 替换内核 nicekwell-CSDN博客</a></p> 
<h4 style="margin-left:.0001pt;text-align:justify;">1、配置交叉编译（之前有记笔记，或者点击上述链接进入后进行配置）</h4> 
<h4 style="margin-left:.0001pt;text-align:justify;">2、配置config</h4> 
<p style="margin-left:.0001pt;text-align:justify;">Linux源码中有很多工程：</p> 
<p style="margin-left:.0001pt;text-align:justify;">树莓派1的工程是bcmrpi_defconfig</p> 
<p style="margin-left:.0001pt;text-align:justify;">树莓派2,3的工程是bcm2709_defconfig</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">我们选择使用源码里自带的config（内核配置）</p> 
<p style="margin-left:.0001pt;text-align:left;">ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=</p> 
<p style="margin-left:.0001pt;text-align:left;">指定ARM架构      指定编译器            树莓派         </p> 
<p style="margin-left:.0001pt;text-align:left;">kernel7 make bcm2709_defconfig</p> 
<p style="margin-left:.0001pt;text-align:left;">主要核心指令</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">注：上面这个指令不是分段进行</p> 
<p style="margin-left:.0001pt;text-align:left;">完整指令如下：</p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;">ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make bcm2709_defconfig</p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;">（当然我的建议是先把下面提到的<strong>树莓派linux内核编译</strong>提到的必要的库安装完成之后在执行这个指令）</p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>这个指令在/home/wbw/SYSTEM/linux-rpi-4.14.y这个目录下进行</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">注：在你自己解压好的内核源码目录下也就是（linux-rpi-4.14.y）我之所以是4.14是因为我的树莓派版本是4.14，前面有提到。</p> 
<p style="margin-left:.0001pt;text-align:left;">此命令功能是获取bcm2709_defconfig的配置到.config里</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h3 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">树莓派linux内核编译</span></span></h3> 
<h4 style="margin-left:.0001pt;text-align:left;">安装必要的库：</h4> 
<p style="margin-left:.0001pt;text-align:left;">sudo apt-get install bc</p> 
<p style="margin-left:.0001pt;text-align:left;">sudo apt-get install libcurses5-dev libncursesw5-dev（或者sudo apt-get install libncurses5-dev）</p> 
<p style="margin-left:.0001pt;text-align:left;">如果你在安装ncurses5出现了Unable to locate package libcurses5-dev问题</p> 
<h6>问题样式：</h6> 
<p style="margin-left:.0001pt;text-align:left;">                                Reading package lists... Done</p> 
<p style="margin-left:.0001pt;text-align:left;">                                Building dependency tree       </p> 
<p style="margin-left:.0001pt;text-align:left;">                                Reading state information... Done</p> 
<p style="margin-left:.0001pt;text-align:left;">                                E: Unable to locate package libcurses5-dev</p> 
<h6 style="margin-left:.0001pt;text-align:left;">解决方法如下：</h6> 
<p style="margin-left:.0001pt;text-align:left;">可以考虑是apt源的问题，修改apt源</p> 
<p style="margin-left:.0001pt;text-align:left;">（1）备份下apt源</p> 
<p style="margin-left:.0001pt;text-align:left;">sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak</p> 
<p style="margin-left:.0001pt;text-align:left;">（2）修改/etc/apt/sources.list文件内容</p> 
<p style="margin-left:.0001pt;text-align:left;">1.首先我们在修改文件内容之前先确认我们自己的Ubuntu版本和code name</p> 
<p style="margin-left:.0001pt;text-align:left;">可以在终端输入如下指令：</p> 
<p style="margin-left:.0001pt;text-align:left;">lsb_release -a</p> 
<p class="img-center"><img alt="" height="122" src="https://images2.imgbox.com/3f/50/AxrkJBBn_o.png" width="368"></p> 
<p style="margin-left:.0001pt;text-align:left;">2./etc/apt# vi sources.list（在/rtc/apt目录下）（这里建议加sudo，这样可以修改里面的内容）</p> 
<p style="margin-left:.0001pt;text-align:left;">3.然后可以到阿里云官网（https://developer.aliyun.com/mirror/）找到Ubuntu的下载地址</p> 
<p class="img-center"><img alt="" height="207" src="https://images2.imgbox.com/60/cc/zou49nHt_o.png" width="382"></p> 
<p style="margin-left:.0001pt;text-align:left;">4.点击进去，下滑，找到对应的源，复制</p> 
<p style="margin-left:.0001pt;text-align:left;">5.回到linux终端进入/etc/apt# sudo vi sources.list将里面的源替换掉，退出文件</p> 
<p style="margin-left:.0001pt;text-align:left;">如下是18.04（bionic）的源</p> 
<p style="margin-left:.0001pt;text-align:left;">deb https://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;">deb-src https://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">deb https://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;">deb-src https://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">deb https://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;">deb-src https://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"># deb https://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;"># deb-src https://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">deb https://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;">deb-src https://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">（3）更新源</p> 
<p style="margin-left:.0001pt;text-align:left;">sudo apt-get update（也是在/etc/apt目录下进行）</p> 
<p style="margin-left:.0001pt;text-align:left;">（4）再执行一次sudo apt-get install libcurses5-dev libncursesw5-dev（或sudo apt-get install libncurses5-dev）</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h5 style="margin-left:.0001pt;text-align:left;">（继续上面安装必要的库说）</h5> 
<p style="margin-left:.0001pt;text-align:left;">sudo apt-get install zlib1g:i386</p> 
<p style="margin-left:.0001pt;text-align:left;">sudo apt-get install libc6-i386 lib32stdc++6 lib32gcc1 lib32ncurses5</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h4 style="margin-left:.0001pt;text-align:left;">1、执行menuconfig</h4> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;">ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make menuconfig</p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;">会进入这样一个界面</p> 
<p class="img-center"><img alt="" height="250" src="https://images2.imgbox.com/18/23/qxch5pud_o.png" width="428"></p> 
<p style="margin-left:.0001pt;text-align:left;">对图片中的一些东西进行解释：</p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;">General setup —&gt;（通用选项）</p> 
 <p style="margin-left:.0001pt;text-align:left;">[ * ] Enable loadable module support —&gt; 内核模块选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">[ * ]Enable the block layer —&gt; 块设备逻辑层选项（大文件支持、分区、I/O调度）</p> 
 <p style="margin-left:.0001pt;text-align:left;">System Type —&gt;（平台选项）</p> 
 <p style="margin-left:.0001pt;text-align:left;">Bus support —&gt; 总线选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">Kernel Features —&gt;内核特征</p> 
 <p style="margin-left:.0001pt;text-align:left;">Boot options —&gt; 引导选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">CPU Power Management —&gt; CPU电源管理选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">Floating point emulation —&gt; 浮点运算</p> 
 <p style="margin-left:.0001pt;text-align:left;">Userspace binary formats —&gt; 用户程序格式</p> 
 <p style="margin-left:.0001pt;text-align:left;">Power management options —&gt; 电源管理选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">[*] Networking support —&gt; 网络协议选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">Device Drivers —&gt; 设备驱动</p> 
 <p style="margin-left:.0001pt;text-align:left;">Firmware Drivers ---- 驱动固件选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">File systems —&gt; 文件系统选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">Kernel hacking —&gt; 内核调试选项</p> 
 <p style="margin-left:.0001pt;text-align:left;">Security options —&gt; 安全模块选项</p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;">[*]：编译进内核（*代表Y，编译进内核，zImage包含了驱动）</p> 
 <p style="margin-left:.0001pt;text-align:left;">[M]：编译成模块（以模块的方式生成驱动文件xxx.ko，系统启动后，</p> 
 <p style="margin-left:.0001pt;text-align:left;">                通过命令inmosd xxx.ko来加载驱动，也可以减小一些内核大小）</p> 
 <p style="margin-left:.0001pt;text-align:left;">[ ]:表示不需要的部分</p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;">空格可切换修改。</p> 
<p style="margin-left:.0001pt;text-align:left;">修改完毕后，保存退出</p> 
<p style="margin-left:.0001pt;text-align:left;">如果没有改的就不用执行这一步。</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h4 style="margin-left:.0001pt;text-align:left;">2、编译</h4> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;">ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make -j4 zImage modules dtbs</p> 
</blockquote> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>-j4：指定用多少电脑资源进行编译</strong></span></span></strong></p> 
 <p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>zImage：生成内核镜像</strong></span></span></strong></p> 
 <p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>modules：要生成驱动模块</strong></span></span></strong></p> 
 <p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>dtbs：生成配置文件</strong></span></span></strong></p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>编译成功后，看到源码树目录多了vmlinux，失败则无此文件</strong></span></span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>成功后，目标zImage镜像在arch/arm/boot底下</strong></span></span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;"><strong>我们要打包zImage成树莓派可用的xxx.img</strong></span></span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">3、打包zlmage文件</span></span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">直接用linux源码包里的工具：</span></span></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">./scripts/mkknlimg arch/arm/boot/zImage ./kernel_new.img</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">（在linux-rpi-4.14.y目录下使用）</span></span></p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">可能会出现以下报错：</span></span></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">bash: ./scripts/mkknlimg:No such file or directory</span></span></p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">这是因为这个版本的linux源码包将mkknlimg工具给淘汰了，可以从一些旧版本的源码包中复制过来，也可以使用，同样位于/scripts目录。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">在本目录生成一个kernel_new.img文件，这个文件就是要放到sd卡中的文件。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">注：网上很多地方说的用 tools/mkimage/imagetool-uncompressd.py 的方法不行！！</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h4 style="background-color:transparent;margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">4、将树莓派SD卡的U盘映射到虚拟机上</span></span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">将树莓派SD卡插到读卡器，再与电脑连接，然后映射到虚拟机，过程中虚拟机可能会识别不到。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">我的原因是会被windows系统抢占，这个时候需要在虚拟机——&gt;可移动设备——&gt;打开Super Top Mass Storage Device</span></span></p> 
<p style="text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#333333;">指令dmesg可以看到内核信息</span></span></p> 
<p class="img-center"><img alt="" height="337" src="https://images2.imgbox.com/d5/81/eexShFRw_o.png" width="572"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">出现 sdb1 和 sdb2 说明成功映射到虚拟机上了。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">把树莓派的sd卡插入Ubuntu系统电脑，树莓派的sd卡有两个分区</span></span></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">一个是fat分区（sdb1），是boot相关的内容，kernel的img文件就放在这个分区里；</span></span></p> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">一个是ext4分区（sdb2），也就是系统的根目录分区</span></span></p> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">一般插入ubuntu会自动挂载，fat分区不需要root权限，ext4需要root权限操作</span></span></p> 
</blockquote> 
<h4 style="background-color:transparent;margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">5、数据拷贝</span></span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">创建两个文件夹为挂载做准备</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">mkdir data1</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">mkdir data2</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo mount /dev/sdb1 data1  </span></span></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">    //挂载U盘的sdb1文件分区到当前路径下的data1文件夹,   </span></span></p> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">    //该分区为fat分区，是boot相关的内容，kernel的img.</span></span></p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo mount /dev/sdb2 data2  </span></span></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">    //挂载U盘的sdb2文件分区到当前路径下的data2文件夹,</span></span></p> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">    //该分区为ext4分区,也就是系统的根目录分区.</span></span></p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#333333;"><span style="background-color:#ffffff;">这个地方需要注意一些问题：</span></span><a href="https://blog.csdn.net/zhezhehenkenai/article/details/135713922" title="关于树莓派3B+内核配置遇到的一个问题——nl80211-CSDN博客">关于树莓派3B+内核配置遇到的一个问题——nl80211-CSDN博客</a></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="color:#fe2c24;">（一定要点进去看看，很重要！！！）</span></strong></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">6、安装modules（内核的驱动文件）</span></span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">运行指令安装，因为内核配置时，有一部分是编译成模块的形式配置进来的，安装后hdmi接口、usb、wifi、io口等等的设备才能使用，所以需要这么一步。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">如下指令：</span></span></p> 
<blockquote> 
 <p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make INSTALL_MOD_PATH=[ext4] modules_install</span></span></p> 
</blockquote> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;">[ext4]为第二分区（sdb2）虚拟机上挂载的地址(data2的位置)，需要根据自己的地址更改</span></span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">eg：sudo ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make INSTALL_MOD_PATH=</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">home/wbw/data2</span></span><span style="background-color:#ffffff;"><span style="color:#333333;"> modules_install</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">这个指令一定要在解压的源码文件夹（/linux-rpi-</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">4.14</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">.y）里运行。 </span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">7、更新内核文件</span></span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">有两种方式更新内核文件，</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">第一种：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">运行以下指令，将生成的kernel_new.img文件拷贝到boot分区（也就是data1文件夹）。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">cp ./kernel_new.img ~/data1</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">还要修改boot分区的config.text文件。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">vi ~/data1/config.text</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;"> //在最后一行加入kernel=kernel_new.img</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">第二种：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">先备份</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">cd /home/</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">wbw</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">/data1（在用户目录运行）</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo </span></span><span style="background-color:#ffffff;"><span style="color:#333333;">cp kernel7.img kernel7OLD.img</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">再把编译新生成的拷贝到data1，起名kernel7.img</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo </span></span><span style="background-color:#ffffff;"><span style="color:#333333;">cp kernel_new.img /home/</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">wbw/data1/kernel7.img（在linux-rpi-4.14.y目录运行）</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">检查：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">du kernel_new.img -h</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">可以查看文件的大小</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="background-color:#ffffff;"><span style="color:#333333;">每个文件都有一个独一无二的特殊编码号（md5），检查拷贝文件是否损坏可以通过查看两个文件的md5是否相同来确认</span></span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">指令为：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">md5sum kernel_new.img</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">md5sum /home/wbw/data1/kernel7.img</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">8、拷贝配置相关文件</span></span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo </span></span><span style="background-color:#ffffff;"><span style="color:#333333;">cp arch/arm/boot/dts/.*dtb* [fat]/</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo </span></span><span style="background-color:#ffffff;"><span style="color:#333333;">cp arch/arm/boot/dts/overlays/.*dtb* [fat]/overlays/</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">sudo </span></span><span style="background-color:#ffffff;"><span style="color:#333333;">cp arch/arm/boot/dts/overlays/README [fat]/overlays/</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">[fat]为第一分区（sdb1）虚拟机上挂载的地址(data1的位置)，需要根据自己的地址更改。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">这样就完成了，然后断开与虚拟机的连接，windows连接，在出现的U盘里把cmdline.txt更改成以下内容。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">dwc_otg.lpm_enable=0 console=tty1 console=serial0,115200 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">最后，将SD卡插回树莓派，用串口查看是否刷机成功。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">今天的分享就到这里啦！！！</span></span></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5882ba836457dbff58183445257e74bd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于树莓派3B&#43;内核配置遇到的一个问题——nl80211</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f0163692b90da0fee67fbde1c4f26252/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">删除顺序表表中值为X的数据元素，要求时间复杂度为O(n)，空间复杂度为O(1)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>