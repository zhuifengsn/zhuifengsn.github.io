<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Albumentations库的数据增强 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Albumentations库的数据增强" />
<meta property="og:description" content="基于Albumentations库的数据增强 对于自己采集的数据集，最头疼的就是标注数据集，如何自己少标注一点数据集而又获得更多的数据集来训练出更好的模型，则可以使用Albumentations开源库(Github地址: https://github.com/albumentations-team/albumentations)进行数据增强，获得更多的针对性的数据集，如：在移动的小车上进行检测，可能需要对图片进行模糊，缩放等来增强模型。当然首要任务还是(偷懒)。完整项目可以看我的AI Studio主页(https://aistudio.baidu.com/aistudio/projectdetail/4334420)。
一、安装Albumentations库 直接pip安装会导致opencv, numpy, scipy等安装到最新的版本, 如果出现版本错误需要重新安装；使用源码安装可以在set.py中设置依赖库的版本问题。
# 源码安装 unzip -d /path/to/save /path/albumentations-master.zip cd /path/albumentations-master python3 setup.py install # pip安装 pip install -U albumentations # 依自己情况 pip install opencv-python-headless==4.1.1.26 pip install numpy==1.16.4 pip install scipy==1.3.0 # 首先进行图片增强小测试 # 首先进行图片增强小测试, 该测试只是选择一下增强的方式, 例如: 如果你的检测目标与颜色有关联, # 可能就不能选择改变颜色的增强方式, 如果采用镜像的增强方式, 左转路标可能就变成右转路标, 需要注意!!! import albumentations as A import cv2 import numpy as np import matplotlib.pyplot as plt # 读取原始图片 original_image = cv2.imread(&#39;/home/aistudio/work/0000.jpg&#39;) # 像素级变换 transform_Pixel = A." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/b9935ff6bb0d084c51c0fa38571ceef0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-21T12:59:51+08:00" />
<meta property="article:modified_time" content="2022-07-21T12:59:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Albumentations库的数据增强</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Albumentations_0"></a>基于Albumentations库的数据增强</h2> 
<p> 对于自己采集的数据集，最头疼的就是标注数据集，如何自己少标注一点数据集而又获得更多的数据集来训练出更好的模型，则可以使用Albumentations开源库(Github地址: <a href="https://github.com/albumentations-team/albumentations">https://github.com/albumentations-team/albumentations</a>)进行数据增强，获得更多的针对性的数据集，如：在移动的小车上进行检测，可能需要对图片进行模糊，缩放等来增强模型。当然首要任务还是(偷懒)。完整项目可以看我的AI Studio主页(<a href="https://aistudio.baidu.com/aistudio/projectdetail/4334420" rel="nofollow">https://aistudio.baidu.com/aistudio/projectdetail/4334420</a>)。</p> 
<h3><a id="Albumentations_2"></a>一、安装Albumentations库</h3> 
<p>  直接pip安装会导致opencv, numpy, scipy等安装到最新的版本, 如果出现版本错误需要重新安装；使用源码安装可以在set.py中设置依赖库的版本问题。</p> 
<pre><code class="prism language-bash"><span class="token comment"># 源码安装</span>
<span class="token function">unzip</span> -d /path/to/save /path/albumentations-master.zip
<span class="token builtin class-name">cd</span> /path/albumentations-master
python3 setup.py <span class="token function">install</span> 

<span class="token comment"># pip安装</span>
pip <span class="token function">install</span> -U albumentations

<span class="token comment"># 依自己情况</span>
pip <span class="token function">install</span> opencv-python-headless<span class="token operator">==</span><span class="token number">4.1</span>.1.26 
pip <span class="token function">install</span> <span class="token assign-left variable">numpy</span><span class="token operator">==</span><span class="token number">1.16</span>.4
pip <span class="token function">install</span> <span class="token assign-left variable">scipy</span><span class="token operator">==</span><span class="token number">1.3</span>.0
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 首先进行图片增强小测试</span>
<span class="token comment"># 首先进行图片增强小测试, 该测试只是选择一下增强的方式, 例如: 如果你的检测目标与颜色有关联, </span>
<span class="token comment"># 可能就不能选择改变颜色的增强方式, 如果采用镜像的增强方式, 左转路标可能就变成右转路标, 需要注意!!!</span>
<span class="token keyword">import</span> albumentations <span class="token keyword">as</span> A
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token comment"># 读取原始图片</span>
original_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'/home/aistudio/work/0000.jpg'</span><span class="token punctuation">)</span>

<span class="token comment"># 像素级变换</span>
transform_Pixel <span class="token operator">=</span> A<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment"># A.CLAHE(p=1),  # 直方图均衡</span>
    <span class="token comment"># A.ChannelDropout(p=1),  # 随机丢弃通道</span>
    <span class="token comment"># A.ChannelShuffle(p=1),  # 随机排列通道</span>
    A<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 随机改变图像的亮度、对比度、饱和度、色调</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 空间级变换</span>
transform_Spatial <span class="token operator">=</span> A<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment"># A.RandomCrop(width=256, height=256),</span>
    A<span class="token punctuation">.</span>HorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    A<span class="token punctuation">.</span>RandomBrightnessContrast<span class="token punctuation">(</span>brightness_limit<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> contrast_limit<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 与像素级变换结合使用</span>
    <span class="token comment"># A.SafeRotate(limit=60, p=1),</span>
    <span class="token comment"># A.Rotate(limit=45, p=1),</span>
    <span class="token comment"># A.Affine(p=1),</span>
    <span class="token comment"># A.GridDistortion(p=1),</span>

<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 进行增强变化</span>
transformed <span class="token operator">=</span> transform_Spatial<span class="token punctuation">(</span>image<span class="token operator">=</span>original_image<span class="token punctuation">)</span>

<span class="token comment"># 获得增强后的图片</span>
transformed_image <span class="token operator">=</span> transformed<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span>
transformed_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>transformed_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
original_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>original_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"original image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>original_image<span class="token punctuation">)</span> 
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"transformed image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>transformed_image<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_68"></a>二、说明</h3> 
<p><strong>1、对于安装albumentations, 如果直接pip安装会安装最新的版本同时有些库也会改变，如numpy，opencv等；</strong></p> 
<p><strong>2、本项目仅对三种格式做批量增强，对于albumentations库的更多用法请去Github主页或另行搜索。同时三种格式的规范如果不理解可以参考示例或自行搜索。</strong></p> 
<p><strong>3、本项目按照作者习惯进行，其中图片命名均从0000.jpg开始，0001.jpg …依次向后。</strong></p> 
<p><strong>4、本项目按照作者习惯进行，其中图片命名均从0000.jpg开始，0001.jpg …依次向后。</strong></p> 
<p><strong>5、Albumentations的空间级增强后生成的标注框有时候会存在误差, 像仿射变换, 像素级的变化没有影响。作者也在Github上说在修复改进, 所以最好安装最新的版本, 同时在以下代码中将is_show参数 设置为True, 每次增强一张图片都会把标注框画出并展示, 可以通过按键选择是否保存, 检查一下还是好的。 但在AI Studio上, opencv的交互函数好像运行有问题, 像imshow, waitKey, 所以在本地会好一些, 每种格式增强后使用了matplotlib函数展示了增强后的图片, 没有加上框, 可在对应的目录上查看增强后的文件。</strong></p> 
<h3><a id="COCOYOLOVOC_81"></a>三、COCO、YOLO、VOC格式的批量增强</h3> 
<h4><a id="1COCO_82"></a>1、COCO格式数据增强</h4> 
<p>  coco格式如下：</p> 
<p>COCO<br>  |-- annotations<br>   |-- train.json<br>   |-- val.json</p> 
<p> |-- train<br>   |-- 0000.jpg<br>   |-- 0001.jpg<br>   |-- …jpg</p> 
<p> |-- val<br>   |-- 0000.jpg<br>   |-- 0001.jpg<br>   |-- …jpg<br>   本次只用少数val数据集示例。</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义增强类</span>
<span class="token keyword">class</span> <span class="token class-name">COCOAug</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>


    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 anno_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 pre_image_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 save_image_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 anno_mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span>
                 is_show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 start_filename_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 start_anno_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""

        :param anno_path: json文件的路径
        :param pre_image_path: 需要增强的图片路径
        :param save_image_path: 保存的图片路径
        :param anno_mode: 有train,val两种, 同时也对应两种路径, 两种json文件[train.json, val.json]
        :param is_show: 是否实时展示: 每增强一张图片就把对应的标注框和标签画出并imshow
        :param start_filename_id: 新的图片起始名称. 同时也对应图片的id, 后续在此基础上依次+1,
                                  如果没有指定则按已有的图片长度继续+1
        :param start_anno_id: 新的注释id起始号, 后续在此基础上依次+1, 如果没有指定则按已有的注释个数长度继续+1
        """</span>
        self<span class="token punctuation">.</span>anno_path <span class="token operator">=</span> anno_path
        self<span class="token punctuation">.</span>aug_image_path <span class="token operator">=</span> pre_image_path
        self<span class="token punctuation">.</span>save_image_path <span class="token operator">=</span> save_image_path
        self<span class="token punctuation">.</span>anno_mode <span class="token operator">=</span> anno_mode
        self<span class="token punctuation">.</span>is_show <span class="token operator">=</span> is_show
        self<span class="token punctuation">.</span>start_filename_id <span class="token operator">=</span> start_filename_id
        self<span class="token punctuation">.</span>start_anno_id <span class="token operator">=</span> start_anno_id

        <span class="token comment"># 数据增强选项</span>
        self<span class="token punctuation">.</span>aug <span class="token operator">=</span> A<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
            A<span class="token punctuation">.</span>RandomBrightnessContrast<span class="token punctuation">(</span>brightness_limit<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> contrast_limit<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 高斯滤波</span>
            A<span class="token punctuation">.</span>GaussNoise<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 高斯模糊</span>
            A<span class="token punctuation">.</span>CLAHE<span class="token punctuation">(</span>clip_limit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> tile_grid_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 直方图均衡</span>
            A<span class="token punctuation">.</span>Equalize<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 均衡图像直方图</span>
            A<span class="token punctuation">.</span>HorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            A<span class="token punctuation">.</span>OneOf<span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token comment"># A.RGBShift(r_shift_limit=50, g_shift_limit=50, b_shift_limit=50, p=0.5),</span>
                <span class="token comment"># A.ChannelShuffle(p=0.3),  # 随机排列通道</span>
                <span class="token comment"># A.ColorJitter(p=0.3),  # 随机改变图像的亮度、对比度、饱和度、色调</span>
                <span class="token comment"># A.ChannelDropout(p=0.3),  # 随机丢弃通道</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># A.Downscale(p=0.1),  # 随机缩小和放大来降低图像质量</span>
            A<span class="token punctuation">.</span>Emboss<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 压印输入图像并将结果与原始图像叠加</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment"># coco: [x_min, y_min, width, height]</span>
            <span class="token comment"># min_area: 表示bbox占据的像素总个数, 当数据增强后, 若bbox小于这个值则从返回的bbox列表删除该bbox.</span>
            <span class="token comment"># min_visibility: 值域为[0,1], 如果增强后的bbox面积和增强前的bbox面积比值小于该值, 则删除该bbox</span>
            A<span class="token punctuation">.</span>BboxParams<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'coco'</span><span class="token punctuation">,</span> min_area<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> min_visibility<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> label_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 打开json文件</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>anno_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>anno_mode<span class="token punctuation">}</span></span><span class="token string">.json"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> load_f<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>load_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>load_f<span class="token punctuation">)</span>  <span class="token comment"># ['images', 'annotations', 'categories']</span>

            self<span class="token punctuation">.</span>labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 读取标签列表</span>
            <span class="token keyword">for</span> anno <span class="token keyword">in</span> self<span class="token punctuation">.</span>load_dict<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------- * ---------"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>start_filename_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>start_filename_id <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>load_dict<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the start_filename_id is not set, default: len(images)"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>start_anno_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>start_anno_id <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>load_dict<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the start_anno_id is not set, default: len(annotations)"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"len(images)     : "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>start_filename_id<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"len(annotations): "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>start_anno_id<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"categories: "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>load_dict<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"labels: "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------- * ---------"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">image_aug</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_len<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        json格式
        "images": [{"file_name": "013856.jpg", "height": 1080, "width": 1920, "id": 13856},...]
        "annotations": [{"image_id": 13856, "id": 0, "category_id": 2, "bbox": [541, 517, 79, 102],
                         "area": 8058, "iscrowd": 0, "segmentation": []}, ...]
        "categories": [{"id": 0, "name": "Motor Vehicle"}, ...]


        :param start_filename_id: 起始图片id号
        :param start_anno_id: 起始注释框id号
        :param max_len: 默认数据集不超过9999, 即: 0000~9999 如果更多可以设置为5 即00000~99999

        :return: None
        """</span>
        <span class="token comment"># 保存原始数据</span>
        aug_data <span class="token operator">=</span> self<span class="token punctuation">.</span>load_dict

        <span class="token comment"># 记录给定的开始序列</span>
        cnt_filename <span class="token operator">=</span> self<span class="token punctuation">.</span>start_filename_id
        cnt_anno_id <span class="token operator">=</span> self<span class="token punctuation">.</span>start_anno_id

        <span class="token comment"># 对每一张图片遍历</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>load_dict<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            image_name <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span>
            image_suffix <span class="token operator">=</span> image_name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 获取图片后缀 e.g. [.jpg .png]</span>
            image_id <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>

            bboxes_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            category_id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment"># 对每一张图片找到所有的标注框, 并且bbox和label的id要对应上</span>
            <span class="token keyword">for</span> anno <span class="token keyword">in</span> self<span class="token punctuation">.</span>load_dict<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> anno<span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span> <span class="token operator">==</span> image_id<span class="token punctuation">:</span>
                    bboxes_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    category_id_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 读取图片</span>
            image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>aug_image_path<span class="token punctuation">,</span> image_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            h<span class="token punctuation">,</span> w <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
            <span class="token comment"># 生成需要增强的图片的anno字典</span>
            <span class="token comment"># augmented {'image':, 'height':,'width:', 'bboxes':[(),()], 'category_id':[,,]}</span>
            aug_anno <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> image<span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> h<span class="token punctuation">,</span> <span class="token string">'width'</span><span class="token punctuation">:</span> w<span class="token punctuation">,</span> <span class="token string">'bboxes'</span><span class="token punctuation">:</span> bboxes_list<span class="token punctuation">,</span> <span class="token string">'category_id'</span><span class="token punctuation">:</span> category_id_list<span class="token punctuation">}</span>

            <span class="token comment"># 得到增强后的数据 {"image", "height", "width", "bboxes", "category_id"}</span>
            augmented <span class="token operator">=</span> self<span class="token punctuation">.</span>aug<span class="token punctuation">(</span><span class="token operator">**</span>aug_anno<span class="token punctuation">)</span>
            <span class="token comment"># print(augmented)</span>
            aug_image <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>
            aug_bboxes <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'bboxes'</span><span class="token punctuation">]</span>
            aug_category_id <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span>
            height <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span>
            width <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span>

            <span class="token comment"># 对增强后的bbox取整</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> bbox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>aug_bboxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> bbox
                aug_bboxes<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

            <span class="token comment"># 是否进行实时展示图片, 用于检测是否有误</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_show<span class="token punctuation">:</span>
                tl <span class="token operator">=</span> <span class="token number">2</span>
                <span class="token comment"># aug_image_copy = aug_image.copy()</span>
                aug_image_copy <span class="token operator">=</span> aug_image
                <span class="token keyword">for</span> bbox<span class="token punctuation">,</span> category_id <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>aug_bboxes<span class="token punctuation">,</span> aug_category_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    text <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>category_id<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    t_size <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fontScale<span class="token operator">=</span>tl <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span>tl<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>aug_image_copy<span class="token punctuation">,</span> <span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> t_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> t_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>  <span class="token comment"># filled</span>
                    cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>aug_image_copy<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tl <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tl<span class="token punctuation">,</span>
                                cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
                    aug_image_show <span class="token operator">=</span> cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>aug_image_copy<span class="token punctuation">,</span> <span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   <span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

                <span class="token comment"># cv2.imshow('aug_image_show', aug_image_show)</span>
                
                <span class="token comment"># 实时检测增强后的标注框是否有较大偏差, 符合要求按下's'健保存, 其他键跳过</span>
                key <span class="token operator">=</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment"># 按下s键保存增强，否则取消保存此次增强</span>
                <span class="token keyword">if</span> key <span class="token operator">&amp;</span> <span class="token number">0xff</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    cv2<span class="token punctuation">.</span>destroyWindow<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'aug_image_show'</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>
                cv2<span class="token punctuation">.</span>destroyWindow<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'aug_image_show'</span></span><span class="token punctuation">)</span>


            <span class="token comment"># 获取新的图片名称 e.g.  cnt_filename=45   new_filename: 0045.image_suffix</span>
            name <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">*</span> max_len  <span class="token comment"># e.g. '0'*4 = '0000'</span>
            cnt_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>cnt_filename<span class="token punctuation">)</span>
            length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cnt_str<span class="token punctuation">)</span>
            new_filename <span class="token operator">=</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>length<span class="token punctuation">]</span> <span class="token operator">+</span> cnt_str <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f'.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>image_suffix<span class="token punctuation">}</span></span><span class="token string">'</span></span>
            <span class="token comment"># 保存增强后的图片</span>
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_image_path<span class="token punctuation">,</span> new_filename<span class="token punctuation">)</span><span class="token punctuation">,</span> aug_image<span class="token punctuation">)</span>
            <span class="token comment"># 添加增强后的图片</span>
            dict_image <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> new_filename<span class="token punctuation">,</span>
                <span class="token string">"height"</span><span class="token punctuation">:</span> height<span class="token punctuation">,</span>
                <span class="token string">"width"</span><span class="token punctuation">:</span> width<span class="token punctuation">,</span>
                <span class="token string">"id"</span><span class="token punctuation">:</span> cnt_filename
            <span class="token punctuation">}</span>
            aug_data<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dict_image<span class="token punctuation">)</span>

            <span class="token comment"># print("augmented['bboxes']: ", augmented['bboxes'])</span>
            <span class="token keyword">for</span> bbox<span class="token punctuation">,</span> idx <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>bboxes_list<span class="token punctuation">,</span> category_id_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
                dict_anno <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'image_id'</span><span class="token punctuation">:</span> cnt_filename<span class="token punctuation">,</span>
                             <span class="token string">'id'</span><span class="token punctuation">:</span> cnt_anno_id<span class="token punctuation">,</span>
                             <span class="token string">'category_id'</span><span class="token punctuation">:</span> idx<span class="token punctuation">,</span>
                             <span class="token string">'bbox'</span><span class="token punctuation">:</span> bbox<span class="token punctuation">,</span>
                             <span class="token string">'area'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token string">'iscrowd'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                             <span class="token string">"segmentation"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                             <span class="token punctuation">}</span>
                aug_data<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dict_anno<span class="token punctuation">)</span>

                <span class="token comment"># 每一个增加的anno_id+1</span>
                cnt_anno_id <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token comment"># 图片数+1</span>
            cnt_filename <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment"># 保存增强后的json文件</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>anno_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'aug_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>anno_mode<span class="token punctuation">}</span></span><span class="token string">.json'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ft<span class="token punctuation">:</span>
            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>aug_data<span class="token punctuation">,</span> ft<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 对示例数据集进行增强, 运行成功后会在相应目录下保存</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> cv2

<span class="token comment"># 图片路径</span>
PRE_IMAGE_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/COCO/val'</span>
SAVE_IMAGE_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/COCO/val'</span>

<span class="token comment"># anno路径</span>
ANNO_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/COCO/annotations'</span>
mode <span class="token operator">=</span> <span class="token string">'val'</span>  <span class="token comment"># ['train', 'val']</span>

aug <span class="token operator">=</span> COCOAug<span class="token punctuation">(</span>
        anno_path<span class="token operator">=</span>ANNO_PATH<span class="token punctuation">,</span>
        pre_image_path<span class="token operator">=</span>PRE_IMAGE_PATH<span class="token punctuation">,</span>
        save_image_path<span class="token operator">=</span>SAVE_IMAGE_PATH<span class="token punctuation">,</span>
        anno_mode<span class="token operator">=</span>mode<span class="token punctuation">,</span>
        is_show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

aug<span class="token punctuation">.</span>image_aug<span class="token punctuation">(</span><span class="token punctuation">)</span>

cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  增强示例：<br> <img src="https://images2.imgbox.com/0d/29/JVZra9fO_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="2YOLO_335"></a>2、YOLO格式数据增强</h4> 
<p>  yolo格式如下：</p> 
<p>YOLO<br>  |-- images<br>   |-- 0000.jpg<br>   |-- 0001.jpg<br>   |-- …jpg</p> 
<p> |-- labels<br>   |-- 0000.txt<br>   |-- 0001.txt<br>   |-- …txt<br>   本次只用少数数据集示例。</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义类</span>
<span class="token keyword">class</span> <span class="token class-name">YOLOAug</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>


    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 pre_image_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 pre_label_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 aug_save_image_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 aug_save_label_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 is_show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 start_filename_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 max_len<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        
        :param pre_image_path: 
        :param pre_label_path: 
        :param aug_save_image_path: 
        :param aug_save_label_path: 
        :param labels: 标签列表, 需要根据自己的设定, 用于展示图片
        :param is_show: 
        :param start_filename_id: 
        :param max_len: 
        """</span>
        self<span class="token punctuation">.</span>pre_image_path <span class="token operator">=</span> pre_image_path
        self<span class="token punctuation">.</span>pre_label_path <span class="token operator">=</span> pre_label_path
        self<span class="token punctuation">.</span>aug_save_image_path <span class="token operator">=</span> aug_save_image_path
        self<span class="token punctuation">.</span>aug_save_label_path <span class="token operator">=</span> aug_save_label_path
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> labels
        self<span class="token punctuation">.</span>is_show <span class="token operator">=</span> is_show
        self<span class="token punctuation">.</span>start_filename_id <span class="token operator">=</span> start_filename_id
        self<span class="token punctuation">.</span>max_len <span class="token operator">=</span> max_len
        <span class="token comment"># 数据增强选项</span>
        self<span class="token punctuation">.</span>aug <span class="token operator">=</span> A<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
            A<span class="token punctuation">.</span>RandomBrightnessContrast<span class="token punctuation">(</span>brightness_limit<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> contrast_limit<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>GaussNoise<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>CLAHE<span class="token punctuation">(</span>clip_limit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> tile_grid_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 直方图均衡</span>
            A<span class="token punctuation">.</span>Equalize<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 均衡图像直方图</span>
            A<span class="token punctuation">.</span>OneOf<span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token comment"># A.RGBShift(r_shift_limit=50, g_shift_limit=50, b_shift_limit=50, p=0.5),</span>
                <span class="token comment"># A.ChannelShuffle(p=0.3),  # 随机排列通道</span>
                <span class="token comment"># A.ColorJitter(p=0.3),  # 随机改变图像的亮度、对比度、饱和度、色调</span>
                <span class="token comment"># A.ChannelDropout(p=0.3),  # 随机丢弃通道</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># A.Downscale(p=0.1),  # 随机缩小和放大来降低图像质量</span>
            A<span class="token punctuation">.</span>Emboss<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 压印输入图像并将结果与原始图像叠加</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment"># yolo: [x_center, y_center, width, height]  # 经过归一化</span>
            <span class="token comment"># min_area: 表示bbox占据的像素总个数, 当数据增强后, 若bbox小于这个值则从返回的bbox列表删除该bbox.</span>
            <span class="token comment"># min_visibility: 值域为[0,1], 如果增强后的bbox面积和增强前的bbox面积比值小于该值, 则删除该bbox</span>
            A<span class="token punctuation">.</span>BboxParams<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'yolo'</span><span class="token punctuation">,</span> min_area<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> min_visibility<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> label_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------*--------"</span><span class="token punctuation">)</span>
        image_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_image_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the length of images: "</span><span class="token punctuation">,</span> image_len<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>start_filename_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the start_filename id is not set, default: len(image)"</span><span class="token punctuation">,</span> image_len<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>start_filename_id <span class="token operator">=</span> image_len

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------*--------"</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        获取图片和对应的label信息

        :param image_name: 图片文件名, e.g. 0000.jpg
        :return:
        """</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_image_path<span class="token punctuation">,</span> image_name<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_label_path<span class="token punctuation">,</span> image_name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            label_txt <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>

        label_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        cls_id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> label <span class="token keyword">in</span> label_txt<span class="token punctuation">:</span>
            label_info <span class="token operator">=</span> label<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
            cls_id_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>label_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            label_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> label_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        anno_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> image<span class="token punctuation">,</span> <span class="token string">'bboxes'</span><span class="token punctuation">:</span> label_list<span class="token punctuation">,</span> <span class="token string">'category_id'</span><span class="token punctuation">:</span> cls_id_list<span class="token punctuation">}</span>
        <span class="token keyword">return</span> anno_info


    <span class="token keyword">def</span> <span class="token function">aug_image</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image_list <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_image_path<span class="token punctuation">)</span>

        file_name_id <span class="token operator">=</span> self<span class="token punctuation">.</span>start_filename_id
        <span class="token keyword">for</span> image_filename <span class="token keyword">in</span> image_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            image_suffix <span class="token operator">=</span> image_filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> image_suffix <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            image_suffix <span class="token operator">=</span> image_filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

            aug_anno <span class="token operator">=</span> self<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span>image_filename<span class="token punctuation">)</span>
            <span class="token keyword">if</span> aug_anno <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token comment"># 获取增强后的信息</span>
            augmented <span class="token operator">=</span> self<span class="token punctuation">.</span>aug<span class="token punctuation">(</span><span class="token operator">**</span>aug_anno<span class="token punctuation">)</span>  <span class="token comment"># {'image': , 'bboxes': , 'category_id': }</span>
  
            aug_image <span class="token operator">=</span> aug_info<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>
            aug_bboxes <span class="token operator">=</span> aug_info<span class="token punctuation">[</span><span class="token string">'bboxes'</span><span class="token punctuation">]</span>
            aug_category_id <span class="token operator">=</span> aug_info<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span>

            name <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>max_len
            cnt_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>file_name_id<span class="token punctuation">)</span>
            length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cnt_str<span class="token punctuation">)</span>
            new_image_filename <span class="token operator">=</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>length<span class="token punctuation">]</span> <span class="token operator">+</span> cnt_str <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f'.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>image_suffix<span class="token punctuation">}</span></span><span class="token string">'</span></span>
            new_label_filename <span class="token operator">=</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>length<span class="token punctuation">]</span> <span class="token operator">+</span> cnt_str <span class="token operator">+</span> <span class="token string">'.txt'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"aug_image_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>new_image_filename<span class="token punctuation">}</span></span><span class="token string">: "</span></span><span class="token punctuation">)</span>

            aug_image_copy <span class="token operator">=</span> aug_image<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> cls_id<span class="token punctuation">,</span> bbox <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>aug_category_id<span class="token punctuation">,</span> aug_bboxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f" --- --- cls_id: "</span></span><span class="token punctuation">,</span> cls_id<span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_show<span class="token punctuation">:</span>
                    tl <span class="token operator">=</span> <span class="token number">2</span>
                    h<span class="token punctuation">,</span> w <span class="token operator">=</span> aug_image_copy<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
                    x_center <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> w<span class="token punctuation">)</span>
                    y_center <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> h<span class="token punctuation">)</span>
                    width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> w<span class="token punctuation">)</span>
                    height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> h<span class="token punctuation">)</span>
                    xmin <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x_center <span class="token operator">-</span> width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    ymin <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y_center <span class="token operator">-</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    xmax <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x_center <span class="token operator">+</span> width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    ymax <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y_center <span class="token operator">+</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    text <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>cls_id<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    t_size <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fontScale<span class="token operator">=</span>tl <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span>tl<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>aug_image_copy<span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin <span class="token operator">+</span> t_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ymin <span class="token operator">-</span> t_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>  <span class="token comment"># filled</span>
                    cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>aug_image_copy<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tl <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tl<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
                    aug_image_show <span class="token operator">=</span> cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>aug_image_copy<span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_show<span class="token punctuation">:</span>
                cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'aug_image_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>new_image_filename<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> aug_image_show<span class="token punctuation">)</span>
                key <span class="token operator">=</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment"># 按下s键保存增强，否则取消保存此次增强</span>
                <span class="token keyword">if</span> key <span class="token operator">&amp;</span> <span class="token number">0xff</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    cv2<span class="token punctuation">.</span>destroyWindow<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'aug_image_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>new_image_filename<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>
                cv2<span class="token punctuation">.</span>destroyWindow<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'aug_image_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>new_image_filename<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
                
           <span class="token comment"># 保存增强后的信息</span>
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>aug_save_image_path<span class="token punctuation">,</span> new_image_filename<span class="token punctuation">)</span><span class="token punctuation">,</span> aug_image<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>aug_save_label_path<span class="token punctuation">,</span> new_label_filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lf<span class="token punctuation">:</span>
                <span class="token keyword">for</span> cls_id<span class="token punctuation">,</span> bbox <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>aug_category_id<span class="token punctuation">,</span> aug_bboxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    lf<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> i <span class="token keyword">in</span> bbox<span class="token punctuation">:</span>
                        <span class="token comment"># 保存小数点后六位</span>
                        lf<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token punctuation">)</span>
                    lf<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>

            file_name_id <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 对示例数据集进行增强, 运行成功后会在相应目录下保存 </span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># 原始图片和label路径</span>
PRE_IMAGE_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/YOLO/images'</span>
PRE_LABEL_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/YOLO/labels'</span>

<span class="token comment"># 增强后的图片和label保存的路径</span>
AUG_SAVE_IMAGE_PATH <span class="token operator">=</span><span class="token string">'/home/aistudio/work/TestImage/YOLO/images'</span>
AUG_SAVE_LABEL_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/YOLO/labels'</span>

<span class="token comment"># 类别列表, 需要根据自己的修改</span>
labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'side-walk'</span><span class="token punctuation">,</span> <span class="token string">'speed-limit'</span><span class="token punctuation">,</span> <span class="token string">'turn-left'</span><span class="token punctuation">,</span> <span class="token string">'slope'</span><span class="token punctuation">,</span> <span class="token string">'speed'</span><span class="token punctuation">]</span>

aug <span class="token operator">=</span> YOLOAug<span class="token punctuation">(</span>pre_image_path<span class="token operator">=</span>PRE_IMAGE_PATH<span class="token punctuation">,</span>
                pre_label_path<span class="token operator">=</span>PRE_LABEL_PATH<span class="token punctuation">,</span>
                aug_save_image_path<span class="token operator">=</span>AUG_SAVE_IMAGE_PATH<span class="token punctuation">,</span>
                aug_save_label_path<span class="token operator">=</span>AUG_SAVE_LABEL_PATH<span class="token punctuation">,</span>
                labels<span class="token operator">=</span>labels<span class="token punctuation">,</span>
                is_show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
aug<span class="token punctuation">.</span>get_aug_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3VOC_541"></a>3、VOC格式数据增强</h4> 
<p>  voc格式如下：</p> 
<p>VOC<br>  |-- images<br>   |-- 0000.jpg<br>   |-- 0001.jpg<br>   |-- …jpg</p> 
<p> |-- labels<br>   |-- 0000.xml<br>   |-- 0001.xml<br>   |-- …xml<br>   本次只用少数数据集示例。</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义类</span>
<span class="token keyword">class</span> <span class="token class-name">VOCAug</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>


    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 pre_image_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 pre_xml_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 aug_image_save_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 aug_xml_save_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 start_aug_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 max_len<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
                 is_show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        
        :param pre_image_path: 
        :param pre_xml_path: 
        :param aug_image_save_path: 
        :param aug_xml_save_path: 
        :param start_aug_id: 
        :param labels: 标签列表, 展示增强后的图片用
        :param max_len: 
        :param is_show: 
        """</span>
        self<span class="token punctuation">.</span>pre_image_path <span class="token operator">=</span> pre_image_path
        self<span class="token punctuation">.</span>pre_xml_path <span class="token operator">=</span> pre_xml_path
        self<span class="token punctuation">.</span>aug_image_save_path <span class="token operator">=</span> aug_image_save_path
        self<span class="token punctuation">.</span>aug_xml_save_path <span class="token operator">=</span> aug_xml_save_path
        self<span class="token punctuation">.</span>start_aug_id <span class="token operator">=</span> start_aug_id
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> labels
        self<span class="token punctuation">.</span>max_len <span class="token operator">=</span> max_len
        self<span class="token punctuation">.</span>is_show <span class="token operator">=</span> is_show

        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>labels<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>labels <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">"labels is None!!!"</span>

        <span class="token comment"># 数据增强选项</span>
        <span class="token comment"># 数据增强选项</span>
        self<span class="token punctuation">.</span>aug <span class="token operator">=</span> A<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
            A<span class="token punctuation">.</span>RandomBrightnessContrast<span class="token punctuation">(</span>brightness_limit<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> contrast_limit<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>GaussNoise<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            A<span class="token punctuation">.</span>CLAHE<span class="token punctuation">(</span>clip_limit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> tile_grid_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 直方图均衡</span>
            A<span class="token punctuation">.</span>Equalize<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 均衡图像直方图</span>
            A<span class="token punctuation">.</span>OneOf<span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token comment"># A.RGBShift(r_shift_limit=50, g_shift_limit=50, b_shift_limit=50, p=0.5),</span>
                <span class="token comment"># A.ChannelShuffle(p=0.3),  # 随机排列通道</span>
                <span class="token comment"># A.ColorJitter(p=0.3),  # 随机改变图像的亮度、对比度、饱和度、色调</span>
                <span class="token comment"># A.ChannelDropout(p=0.3),  # 随机丢弃通道</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># A.Downscale(p=0.1),  # 随机缩小和放大来降低图像质量</span>
            A<span class="token punctuation">.</span>Emboss<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 压印输入图像并将结果与原始图像叠加</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment"># voc: [xmin, ymin, xmax, ymax]  # 经过归一化</span>
            <span class="token comment"># min_area: 表示bbox占据的像素总个数, 当数据增强后, 若bbox小于这个值则从返回的bbox列表删除该bbox.</span>
            <span class="token comment"># min_visibility: 值域为[0,1], 如果增强后的bbox面积和增强前的bbox面积比值小于该值, 则删除该bbox</span>
            A<span class="token punctuation">.</span>BboxParams<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'pascal_voc'</span><span class="token punctuation">,</span> min_area<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> min_visibility<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> label_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--------------*--------------'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"labels: "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>start_aug_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>start_aug_id <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_xml_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the start_aug_id is not set, default: len(images)"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>start_aug_id<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--------------*--------------'</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">get_xml_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> xml_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_xml_path<span class="token punctuation">,</span> xml_filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
            root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
            image_name <span class="token operator">=</span> tree<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
            size <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">)</span>
            w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            bboxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            cls_id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> obj <span class="token keyword">in</span> root<span class="token punctuation">.</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># difficult = obj.find('difficult').text</span>
                difficult <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
                cls_name <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text  <span class="token comment"># label</span>
                <span class="token keyword">if</span> cls_name <span class="token keyword">not</span> <span class="token keyword">in</span> LABELS <span class="token keyword">or</span> <span class="token builtin">int</span><span class="token punctuation">(</span>difficult<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                xml_box <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>

                xmin <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
                ymin <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
                xmax <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
                ymax <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>

                <span class="token comment"># 标注越界修正</span>
                <span class="token keyword">if</span> xmax <span class="token operator">&gt;</span> w<span class="token punctuation">:</span>
                    xmax <span class="token operator">=</span> w
                <span class="token keyword">if</span> ymax <span class="token operator">&gt;</span> h<span class="token punctuation">:</span>
                    ymax <span class="token operator">=</span> h
                bbox <span class="token operator">=</span> <span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span>
                bboxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span>
                cls_id_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>labels<span class="token punctuation">.</span>index<span class="token punctuation">(</span>cls_name<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># 读取图片</span>
            image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_image_path<span class="token punctuation">,</span> image_name<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> bboxes<span class="token punctuation">,</span> cls_id_list<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image_name


    <span class="token keyword">def</span> <span class="token function">aug_image</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        xml_list <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_xml_path<span class="token punctuation">)</span>

        cnt <span class="token operator">=</span> self<span class="token punctuation">.</span>start_aug_id
        <span class="token keyword">for</span> xml <span class="token keyword">in</span> xml_list<span class="token punctuation">:</span>
            file_suffix <span class="token operator">=</span> xml<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> file_suffix <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'xml'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
                
            bboxes<span class="token punctuation">,</span> cls_id_list<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image_name <span class="token operator">=</span> self<span class="token punctuation">.</span>get_xml_data<span class="token punctuation">(</span>xml<span class="token punctuation">)</span>

            anno_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> image<span class="token punctuation">,</span> <span class="token string">'bboxes'</span><span class="token punctuation">:</span> bboxes<span class="token punctuation">,</span> <span class="token string">'category_id'</span><span class="token punctuation">:</span> cls_id_list<span class="token punctuation">}</span>
            <span class="token comment"># 获得增强后的数据 {"image", "bboxes", "category_id"}</span>
            augmented <span class="token operator">=</span> self<span class="token punctuation">.</span>aug<span class="token punctuation">(</span><span class="token operator">**</span>anno_dict<span class="token punctuation">)</span>

            <span class="token comment"># 保存增强后的数据</span>
            flag <span class="token operator">=</span> self<span class="token punctuation">.</span>save_aug_data<span class="token punctuation">(</span>augmented<span class="token punctuation">,</span> image_name<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span>

            <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
                cnt <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>


    <span class="token keyword">def</span> <span class="token function">save_aug_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> augmented<span class="token punctuation">,</span> image_name<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        aug_image <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>
        aug_bboxes <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'bboxes'</span><span class="token punctuation">]</span>
        aug_category_id <span class="token operator">=</span> augmented<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span>
        <span class="token comment"># print(aug_bboxes)</span>
        <span class="token comment"># print(aug_category_id)</span>

        name <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>max_len
        <span class="token comment"># 获取图片的后缀名</span>
        image_suffix <span class="token operator">=</span> image_name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment"># 未增强对应的xml文件名</span>
        pre_xml_name <span class="token operator">=</span> image_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>image_suffix<span class="token punctuation">,</span> <span class="token string">'xml'</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取新的增强图像的文件名</span>
        cnt_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span>
        length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cnt_str<span class="token punctuation">)</span>
        new_image_name <span class="token operator">=</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>length<span class="token punctuation">]</span> <span class="token operator">+</span> cnt_str <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> image_suffix

        <span class="token comment"># 获取新的增强xml文本的文件名</span>
        new_xml_name <span class="token operator">=</span> new_image_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>image_suffix<span class="token punctuation">,</span> <span class="token string">'xml'</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取增强后的图片新的宽和高</span>
        new_image_height<span class="token punctuation">,</span> new_image_width <span class="token operator">=</span> aug_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

        <span class="token comment"># 深拷贝图片</span>
        aug_image_copy <span class="token operator">=</span> aug_image<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 在对应的原始xml上进行修改, 获得增强后的xml文本</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_xml_path<span class="token punctuation">,</span> pre_xml_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pre_xml<span class="token punctuation">:</span>
            aug_tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>pre_xml<span class="token punctuation">)</span>

        <span class="token comment"># 修改image_filename值</span>
        root <span class="token operator">=</span> aug_tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        aug_tree<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> new_image_name

        <span class="token comment"># 修改变换后的图片大小</span>
        size <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">)</span>
        size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>new_image_width<span class="token punctuation">)</span>
        size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>new_image_height<span class="token punctuation">)</span>

        <span class="token comment"># 修改每一个标注框</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> obj <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>aug_category_id<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span>
            xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> aug_bboxes<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            xml_box <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
            xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmin<span class="token punctuation">)</span><span class="token punctuation">)</span>
            xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>ymin<span class="token punctuation">)</span><span class="token punctuation">)</span>
            xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmax<span class="token punctuation">)</span><span class="token punctuation">)</span>
            xml_box<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>ymax<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_show<span class="token punctuation">:</span>
                tl <span class="token operator">=</span> <span class="token number">2</span>
                text <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>LABELS<span class="token punctuation">[</span>aug_category_id<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                t_size <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fontScale<span class="token operator">=</span>tl <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span>tl<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>aug_image<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ymin<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmin<span class="token punctuation">)</span> <span class="token operator">+</span> t_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ymin<span class="token punctuation">)</span> <span class="token operator">-</span> t_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>  <span class="token comment"># filled</span>
                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>aug_image<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ymin<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tl <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tl<span class="token punctuation">,</span>
                            cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>aug_image<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ymin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>xmax<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ymax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_show<span class="token punctuation">:</span>
            cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'aug_image_show'</span><span class="token punctuation">,</span> aug_image_copy<span class="token punctuation">)</span>
            <span class="token comment"># 按下s键保存增强，否则取消保存此次增强</span>
            key <span class="token operator">=</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> key <span class="token operator">&amp;</span> <span class="token number">0xff</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token comment"># 保存增强后的图片</span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>aug_image_save_path<span class="token punctuation">,</span> new_image_name<span class="token punctuation">)</span><span class="token punctuation">,</span> aug_image<span class="token punctuation">)</span>
        <span class="token comment"># 保存增强后的xml文件</span>
        tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>ElementTree<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        tree<span class="token punctuation">.</span>write<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>aug_xml_save_path<span class="token punctuation">,</span> new_xml_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token boolean">True</span>

</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> cv2

<span class="token keyword">import</span> albumentations <span class="token keyword">as</span> A
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET

<span class="token comment"># 原始的xml路径和图片路径</span>
PRE_IMAGE_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/VOC/images'</span>
PRE_XML_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/VOC/labels'</span>

<span class="token comment"># 增强后保存的xml路径和图片路径</span>
AUG_SAVE_IMAGE_PATH <span class="token operator">=</span><span class="token string">'/home/aistudio/work/TestImage/VOC/images'</span>
AUG_SAVE_XML_PATH <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/TestImage/VOC/labels'</span>

<span class="token comment"># 标签列表</span>
LABELS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'zu'</span><span class="token punctuation">,</span> <span class="token string">'pai'</span><span class="token punctuation">,</span> <span class="token string">'lan'</span><span class="token punctuation">]</span>

aug <span class="token operator">=</span> VOCAug<span class="token punctuation">(</span>
    pre_image_path<span class="token operator">=</span>PRE_IMAGE_PATH<span class="token punctuation">,</span>
    pre_xml_path<span class="token operator">=</span>PRE_XML_PATH<span class="token punctuation">,</span>
    aug_image_save_path<span class="token operator">=</span>AUG_SAVE_IMAGE_PATH<span class="token punctuation">,</span>
    aug_xml_save_path<span class="token operator">=</span>AUG_SAVE_XML_PATH<span class="token punctuation">,</span>
    start_aug_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    labels<span class="token operator">=</span>LABELS<span class="token punctuation">,</span>
    is_show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

aug<span class="token punctuation">.</span>aug_image<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># cv2.destroyAllWindows()</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb2690b4a2a67d5f36c447ccac47c7b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构之顺序队列(C语言基本操作及代码)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/20f95fc0cafea459a3357a4cab3ed2b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">感情牌、PUA？三招教你破解职场“套路”</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>