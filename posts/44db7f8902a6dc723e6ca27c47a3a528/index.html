<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 实现微信自定义分享 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 实现微信自定义分享" />
<meta property="og:description" content="目录
需求与调整
代码实现
获取令牌
生成合法票据
获取有效签名
客户端准备 客户端实现
小结
需求与调整 在微信中打开网页应用后，可以选择将地址发送给朋友进行分享，如下图：
在实际的应用中，我们可能不是简单的将该网页的链接直接分享出去，而是生成符合实际需要的URL，微信称其为自定义分享。意思即，在用户点击“转发给朋友”按钮之前，进行URL等内容的更新 ，经过调整后，再把链接发送给要分享的朋友。微信给出的关键方法是：updateAppMessageShareData。
需要注意的是：
最好不要再使用 wx.onMenuShareTimeline、wx.onMenuShareAppMessage、wx.onMenuShareQQ、wx.onMenuShareQZone 接口，请尽快迁移使用客户端6.7.2及JSSDK 1.4.0以上版本而支持 wx.updateAppMessageShareData、wx.updateTimelineShareData接口。
代码实现 获取令牌 获取令牌是调用API的基础，请提供合法的APPID和APPSECRET，示例代码如下：
public string GetAccessToken() { string accessToken = &#34;&#34;; //获取配置信息Datatable string respText = &#34;&#34;; //获取appid和appsercret string wechat_appid = &#34;&#34;; string wechat_appsecret = &#34;&#34;; //获取josn数据 string getAccessTokenUrl = &#34;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid={0}&amp;secret={1}&#34;; string url = string.Format(getAccessTokenUrl, wechat_appid, wechat_appsecret); HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url); HttpWebResponse response = (HttpWebResponse)request.GetResponse(); using (Stream resStream = response.GetResponseStream()) { StreamReader reader = new StreamReader(resStream, Encoding." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/44db7f8902a6dc723e6ca27c47a3a528/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-08T10:00:13+08:00" />
<meta property="article:modified_time" content="2024-02-08T10:00:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 实现微信自定义分享</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E9%9C%80%E6%B1%82%E4%B8%8E%E8%B0%83%E6%95%B4-toc" style="margin-left:40px;"><a href="#%E9%9C%80%E6%B1%82%E4%B8%8E%E8%B0%83%E6%95%B4" rel="nofollow">需求与调整</a></p> 
<p id="%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" rel="nofollow">代码实现</a></p> 
<p id="%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C-toc" style="margin-left:80px;"><a href="#%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C" rel="nofollow">获取令牌</a></p> 
<p id="%E7%94%9F%E6%88%90%E5%90%88%E6%B3%95%E7%A5%A8%E6%8D%AE-toc" style="margin-left:80px;"><a href="#%E7%94%9F%E6%88%90%E5%90%88%E6%B3%95%E7%A5%A8%E6%8D%AE" rel="nofollow">生成合法票据</a></p> 
<p id="%C2%A0%E8%8E%B7%E5%8F%96%E6%9C%89%E6%95%88%E7%AD%BE%E5%90%8D-toc" style="margin-left:80px;"><a href="#%C2%A0%E8%8E%B7%E5%8F%96%E6%9C%89%E6%95%88%E7%AD%BE%E5%90%8D" rel="nofollow">获取有效签名</a></p> 
<p id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%86%E5%A4%87%C2%A0-toc" style="margin-left:80px;"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%86%E5%A4%87%C2%A0" rel="nofollow">客户端准备 </a></p> 
<p id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B0-toc" style="margin-left:80px;"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B0" rel="nofollow">客户端实现</a></p> 
<p id="%E5%B0%8F%E7%BB%93-toc" style="margin-left:40px;"><a href="#%E5%B0%8F%E7%BB%93" rel="nofollow">小结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3>需求与调整</h3> 
<p>在微信中打开网页应用后，可以选择将地址发送给朋友进行分享，如下图：</p> 
<p class="img-center"><img alt="00e06d4028864c45b1c654a0ac2157c6.png" height="864" src="https://images2.imgbox.com/d7/29/SXfoRFha_o.png" width="370"></p> 
<p></p> 
<p class="img-center"><img alt="92c55e7e8c2941cbbc927f46ed6a7228.png" height="862" src="https://images2.imgbox.com/60/af/wVhG8cj8_o.png" width="369"></p> 
<p>在实际的应用中，我们可能不是简单的将该网页的链接直接分享出去，而是生成符合实际需要的URL，微信称其为自定义分享。意思即，在用户点击“转发给朋友”按钮之前，进行URL等内容的更新 ，经过调整后，再把链接发送给要分享的朋友。微信给出的关键方法是：updateAppMessageShareData。</p> 
<p>需要注意的是：</p> 
<p>最好不要再使用 wx.onMenuShareTimeline、wx.onMenuShareAppMessage、wx.onMenuShareQQ、wx.onMenuShareQZone 接口，请尽快迁移使用客户端6.7.2及JSSDK 1.4.0以上版本而支持 wx.updateAppMessageShareData、wx.updateTimelineShareData接口。</p> 
<h3 id="%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码实现</h3> 
<h4 id="%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C">获取令牌</h4> 
<p>获取令牌是调用API的基础，请提供合法的APPID和APPSECRET，示例代码如下：</p> 
<pre><code class="language-cs">        public string GetAccessToken()
        {
            string accessToken = "";
            //获取配置信息Datatable
            string respText = "";
            //获取appid和appsercret
            string wechat_appid = "";
            string wechat_appsecret = "";
            //获取josn数据
            string getAccessTokenUrl = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid={0}&amp;secret={1}";
            string url = string.Format(getAccessTokenUrl, wechat_appid, wechat_appsecret);

            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
            HttpWebResponse response = (HttpWebResponse)request.GetResponse();

            using (Stream resStream = response.GetResponseStream())
            {
                StreamReader reader = new StreamReader(resStream, Encoding.Default);
                respText = reader.ReadToEnd();
                resStream.Close();
            }
            JavaScriptSerializer Jss = new JavaScriptSerializer();
            Dictionary&lt;string, object&gt; respDic = (Dictionary&lt;string, object&gt;)Jss.DeserializeObject(respText);
            //通过键access_token获取值
            try
            {
                accessToken = respDic["access_token"].ToString();
            }
            catch (Exception e)
            {
                accessToken =e.Message;
            }

            return accessToken;
        }
</code></pre> 
<h4 id="%E7%94%9F%E6%88%90%E5%90%88%E6%B3%95%E7%A5%A8%E6%8D%AE">生成合法票据</h4> 
<p>正式调用前需要生成合法的票据，C#示例代码如下：</p> 
<pre><code class="language-cs">        public string getJsapi_ticket(string accessToken)
        {
            string content = "";
            try
            {

                string url = "https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=" + accessToken + "&amp;type=jsapi";
                string method = "GET";
                HttpWebRequest request = WebRequest.Create(url) as HttpWebRequest;
                CookieContainer cookieContainer = new CookieContainer();
                request.CookieContainer = cookieContainer;
                request.AllowAutoRedirect = true;
                request.Method = method;
                request.ContentType = "text/html";
                request.Headers.Add("charset", "utf-8");
                //发送请求并获取响应数据
                HttpWebResponse response = request.GetResponse() as HttpWebResponse;
                Stream responseStream = response.GetResponseStream();
                StreamReader sr = new StreamReader(responseStream, Encoding.UTF8);
                //获取返回过来的结果
                content = sr.ReadToEnd();
                dynamic resultStr = JsonConvert.DeserializeObject(content, new { errcode = "", errmsg = "", ticket = "", expires_in = "" }.GetType());

                //请求成功
                if (resultStr.errcode == "0" &amp;&amp; resultStr.errmsg == "ok")
                {
                    content = resultStr.ticket;
                }
                else
                {
                    content = "";
                }

                return content;
            }
            catch (Exception ex)
            {
                content = ex.Message;
                return content;
            }
        }
</code></pre> 
<h4 id="%C2%A0%E8%8E%B7%E5%8F%96%E6%9C%89%E6%95%88%E7%AD%BE%E5%90%8D">获取有效签名</h4> 
<p>通过获取成功的票据信息，生成有效签名后，就可以在客户端进行调用及分享了，示例代码如下：</p> 
<pre><code class="language-cs">            public static string GetMD5(string encypStr, string charset)
            {
                string retStr;
                MD5CryptoServiceProvider m5 = new MD5CryptoServiceProvider();

                //创建md5对象
                byte[] inputBye;
                byte[] outputBye;

                //使用GB2312编码方式把字符串转化为字节数组．
                try
                {
                    inputBye = Encoding.GetEncoding(charset).GetBytes(encypStr);
                }
                catch (Exception ex)
                {
                    inputBye = Encoding.GetEncoding("GB2312").GetBytes(encypStr);
                }
                outputBye = m5.ComputeHash(inputBye);

                retStr = System.BitConverter.ToString(outputBye);
                retStr = retStr.Replace("-", "").ToUpper();
                return retStr;
            }
                /// &lt;summary&gt;
                /// 随机串
                /// &lt;/summary&gt;
                public string getNoncestr()
                {
                    Random random = new Random();
                    return GetMD5(random.Next(1000).ToString(), "GBK").ToLower().Replace("s", "S");
                }

                /// &lt;summary&gt;
                /// 时间截，自1970年以来的秒数
                /// &lt;/summary&gt;
                public  string getTimestamp()
                {
                    TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
                    return Convert.ToInt64(ts.TotalSeconds).ToString();
                }

        /// &lt;summary&gt;
        /// 签名加密，使用SHA加密所得
        /// &lt;/summary&gt;
        /// &lt;param name="content"&gt;签名加密参数&lt;/param&gt;
        /// &lt;param name="encode"&gt;编码UTF-8&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string Sha1(string content, Encoding encode)
        {
            try
            {
                SHA1 sha1 = new SHA1CryptoServiceProvider();
                byte[] bytesIn = encode.GetBytes(content);
                byte[] bytesOut = sha1.ComputeHash(bytesIn);
                sha1.Dispose();
                string result = BitConverter.ToString(bytesOut);
                result = result.Replace("-", "");
                return result;
            }
            catch (Exception ex)
            {
                throw new Exception("SHA1加密出错：" + ex.Message);
            }
        }

        /// &lt;summary&gt;
        /// 获取签名
        /// &lt;/summary&gt;
        /// &lt;param name="jsapi_ticket"&gt;微信公众号调用微信JS临时票据&lt;/param&gt;
        /// &lt;param name="nonceStr"&gt;随机串&lt;/param&gt;
        /// &lt;param name="timestamp"&gt;时间戳&lt;/param&gt;
        /// &lt;param name="url"&gt;当前网页URL&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string GetSignature(string jsapi_ticket, string nonceStr, long timestamp, string url)
        {

            var string1Builder = new StringBuilder();
            //注意这里参数名必须全部小写，且必须有序
            string1Builder.Append("jsapi_ticket=").Append(jsapi_ticket).Append("&amp;")
                          .Append("noncestr=").Append(nonceStr).Append("&amp;")
                          .Append("timestamp=").Append(timestamp).Append("&amp;")
                          .Append("url=").Append(url.IndexOf("#") &gt;= 0 ? url.Substring(0, url.IndexOf("#")) : url);

            return Sha1(string1Builder.ToString(), Encoding.UTF8);
        }

</code></pre> 
<h4 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%86%E5%A4%87%C2%A0">客户端准备 </h4> 
<p>我们通过准备 ViewState 传递到客户端，示例代码如下：</p> 
<pre><code class="language-cs">string at=GetAccessToken();
string ticket = getJsapi_ticket(at);
string nonceStr = getNoncestr();
string timestamp = getTimestamp();
string currentWebUrl = Request.Url.ToString() ;
string sign = GetSignature(ticket, nonceStr, Int64.Parse(timestamp), currentWebUrl);

ViewState["ticket"] = ticket;
ViewState["nonceStr"] = nonceStr;
ViewState["timestamp"] = timestamp;
ViewState["url"] = currentWebUrl;
ViewState["sign"] = sign;
</code></pre> 
<h4 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B0">客户端实现</h4> 
<p>首先需要引用腾讯JS包，如下：</p> 
<pre><code class="language-javascript">&lt;script src="https://res2.wx.qq.com/open/js/jweixin-1.6.0.js"&gt;&lt;/script&gt;
</code></pre> 
<p>后续我们将进行初始化配置，如下代码：</p> 
<pre><code class="language-javascript">wx.config({
   debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
   appId: '', // 必填，公众号的唯一标识
   timestamp:&lt;%=ViewState["timestamp"]%&gt; , // 必填，生成签名的时间戳
   nonceStr:'&lt;%=ViewState["nonceStr"]%&gt;', // 必填，生成签名的随机串
   signature:'&lt;%=ViewState["sign"]%&gt;',// 必填，签名
   jsApiList:['updateAppMessageShareData','updateTimelineShareData','onMenuShareAppMessage', 'onMenuShareTimeline' ] 
});
</code></pre> 
<p>最后定义自定义分享函数 shareUrl ，如下代码：</p> 
<pre><code class="language-javascript">//自定义分享
//分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致

function shareUrl(title,link,desc,imgUrl){
    var desc = document.getElementById('x_shareDesc').value;
    var imgUrl ="";

    wx.updateAppMessageShareData({ 
        title: title, // 分享标题
        desc: desc, // 分享描述
        link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
        imgUrl: imgUrl , // 分享图标
        success: function () {
//          alert("更新分享地址："+link+" 信息成功");
        },
        fail: function () {
//          alert("分享fail");
        }

    })
}

//关键方法调用
wx.ready(function(){
    shareUrl();        
});
</code></pre> 
<h3 id="%E5%B0%8F%E7%BB%93">小结</h3> 
<p>使用微信JSSDK需要登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。</p> 
<p>另外为保障稳定性，引入的JS最好使用：http://res2.wx.qq.com/open/js/jweixin-1.6.0.js （支持https）。</p> 
<p>目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复。</p> 
<p>信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。</p> 
<p>error接口可处理失败验证，如下所示：</p> 
<pre><code class="language-javascript">wx.error(function(res){
  // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});</code></pre> 
<p>更多的开发细节请参考 <a class="link-info" href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html" rel="nofollow" title="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html</a>。</p> 
<p>再次感谢您的阅读，请大家多评论指正。</p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5511dd5ec9d4f36bc6e92448d75c4a8f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Sublime Text 3配置 Node.js 开发环境</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94391df43bc775e80b57ff6cd094b2fd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Seurat - 聚类教程 (1)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>