<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>对象池 GenericObjectPool 配置参数详解 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="对象池 GenericObjectPool 配置参数详解" />
<meta property="og:description" content="对象池 GenericObjectPool 配置参数详解 1. 依赖2. 父类BaseObjectPoolConfig配置参数2.1 lifo2.2 fairness2.3 maxWaitMillis2.4 minEvictableIdleTimeMillis2.5 evictorShutdownTimeoutMillis2.6 softMinEvictableIdleTimeMillis2.7 numTestsPerEvictionRun2.8 evictionPolicyClassName2.9 testOnCreate2.10 testOnBorrow2.11 testOnReturn2.12 testWhileIdle2.13 timeBetweenEvictionRunsMillis2.14 blockWhenExhausted2.15 jmxEnabled2.16 jmxNamePrefix2.17 jmxNameBase 3. 子类GenericObjectPoolConfig配置参数3.1 maxTotal3.2 maxIdle3.3 minIdle 1. 依赖 &lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt; &lt;version&gt;2.4.3&lt;/version&gt; &lt;/dependency&gt; 使用 GenericObjectPool，有必要了解一下 GenericObjectPoolConfig，下面将说明一下其配置参数。
2. 父类BaseObjectPoolConfig配置参数 /** * Provides the implementation for the common attributes shared by the * sub-classes. New instances of this class will be created using the defaults * defined by the public constants." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/8ba745c15ca50ae9e1f2990f1bdb39f6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-15T15:22:33+08:00" />
<meta property="article:modified_time" content="2023-06-15T15:22:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">对象池 GenericObjectPool 配置参数详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>对象池 GenericObjectPool 配置参数详解</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1. 依赖</a></li><li><a href="#2_BaseObjectPoolConfig_10" rel="nofollow">2. 父类BaseObjectPoolConfig配置参数</a></li><li><ul><li><a href="#21_lifo_57" rel="nofollow">2.1 lifo</a></li><li><a href="#22_fairness_71" rel="nofollow">2.2 fairness</a></li><li><a href="#23_maxWaitMillis_80" rel="nofollow">2.3 maxWaitMillis</a></li><li><a href="#24_minEvictableIdleTimeMillis_92" rel="nofollow">2.4 minEvictableIdleTimeMillis</a></li><li><a href="#25_evictorShutdownTimeoutMillis_104" rel="nofollow">2.5 evictorShutdownTimeoutMillis</a></li><li><a href="#26_softMinEvictableIdleTimeMillis_125" rel="nofollow">2.6 softMinEvictableIdleTimeMillis</a></li><li><a href="#27_numTestsPerEvictionRun_129" rel="nofollow">2.7 numTestsPerEvictionRun</a></li><li><a href="#28_evictionPolicyClassName_148" rel="nofollow">2.8 evictionPolicyClassName</a></li><li><a href="#29_testOnCreate_181" rel="nofollow">2.9 testOnCreate</a></li><li><a href="#210_testOnBorrow_217" rel="nofollow">2.10 testOnBorrow</a></li><li><a href="#211_testOnReturn_229" rel="nofollow">2.11 testOnReturn</a></li><li><a href="#212_testWhileIdle_254" rel="nofollow">2.12 testWhileIdle</a></li><li><a href="#213_timeBetweenEvictionRunsMillis_289" rel="nofollow">2.13 timeBetweenEvictionRunsMillis</a></li><li><a href="#214_blockWhenExhausted_312" rel="nofollow">2.14 blockWhenExhausted</a></li><li><a href="#215_jmxEnabled_337" rel="nofollow">2.15 jmxEnabled</a></li><li><a href="#216_jmxNamePrefix_366" rel="nofollow">2.16 jmxNamePrefix</a></li><li><a href="#217_jmxNameBase_383" rel="nofollow">2.17 jmxNameBase</a></li></ul> 
  </li><li><a href="#3_GenericObjectPoolConfig_433" rel="nofollow">3. 子类GenericObjectPoolConfig配置参数</a></li><li><ul><li><a href="#31_maxTotal_452" rel="nofollow">3.1 maxTotal</a></li><li><a href="#32_maxIdle_454" rel="nofollow">3.2 maxIdle</a></li><li><a href="#33_minIdle_456" rel="nofollow">3.3 minIdle</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1. 依赖</h2> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>使用 <strong>GenericObjectPool</strong>，有必要了解一下 <strong>GenericObjectPoolConfig</strong>，下面将说明一下其配置参数。</p> 
<h2><a id="2_BaseObjectPoolConfig_10"></a>2. 父类BaseObjectPoolConfig配置参数</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Provides the implementation for the common attributes shared by the
 * sub-classes. New instances of this class will be created using the defaults
 * defined by the public constants.
 * &lt;p&gt;
 * This class is not thread-safe.
 *  * @since 2.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseObjectPoolConfig</span> <span class="token keyword">extends</span> <span class="token class-name">BaseObject</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> lifo <span class="token operator">=</span> DEFAULT_LIFO<span class="token punctuation">;</span>
	
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> fairness <span class="token operator">=</span> DEFAULT_FAIRNESS<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">long</span> maxWaitMillis <span class="token operator">=</span> DEFAULT_MAX_WAIT_MILLIS<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">long</span> minEvictableIdleTimeMillis <span class="token operator">=</span> DEFAULT_MIN_EVICTABLE_IDLE_TIME_MILLIS<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">long</span> evictorShutdownTimeoutMillis <span class="token operator">=</span> DEFAULT_EVICTOR_SHUTDOWN_TIMEOUT_MILLIS<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">long</span> softMinEvictableIdleTimeMillis <span class="token operator">=</span> DEFAULT_SOFT_MIN_EVICTABLE_IDLE_TIME_MILLIS<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">int</span> numTestsPerEvictionRun <span class="token operator">=</span> DEFAULT_NUM_TESTS_PER_EVICTION_RUN<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> evictionPolicyClassName <span class="token operator">=</span> DEFAULT_EVICTION_POLICY_CLASS_NAME<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> testOnCreate <span class="token operator">=</span> DEFAULT_TEST_ON_CREATE<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> testOnBorrow <span class="token operator">=</span> DEFAULT_TEST_ON_BORROW<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> testOnReturn <span class="token operator">=</span> DEFAULT_TEST_ON_RETURN<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> testWhileIdle <span class="token operator">=</span> DEFAULT_TEST_WHILE_IDLE<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">long</span> timeBetweenEvictionRunsMillis <span class="token operator">=</span> DEFAULT_TIME_BETWEEN_EVICTION_RUNS_MILLIS<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> blockWhenExhausted <span class="token operator">=</span> DEFAULT_BLOCK_WHEN_EXHAUSTED<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> jmxEnabled <span class="token operator">=</span> DEFAULT_JMX_ENABLE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> jmxNamePrefix <span class="token operator">=</span> DEFAULT_JMX_NAME_PREFIX<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> jmxNameBase <span class="token operator">=</span> DEFAULT_JMX_NAME_BASE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="21_lifo_57"></a>2.1 lifo</h3> 
<p>提供了后进先出(<code>LIFO</code>)与先进先出(<code>FIFO</code>)两种行为模式的池；<br> 默认 <code>DEFAULT_LIFO = true</code>， 当池中有空闲可用的对象时，调用<code>borrowObject</code> 方法会返回最近（后进）的实例。</p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	idleObjects<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    idleObjects<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22_fairness_71"></a>2.2 fairness</h3> 
<p>当从池中获取资源或者将资源还回池中时,是否使用；<code>java.util.concurrent.locks.ReentrantLock.ReentrantLock</code> 的公平锁机制。<br> 默认 <code>DEFAULT_FAIRNESS = false</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">	idleObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PooledObject</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getFairness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="23_maxWaitMillis_80"></a>2.3 maxWaitMillis</h3> 
<p>当连接池资源用尽后，调用者获取连接时的最大等待时间（单位 ：毫秒）；<br> 默认值 <code>DEFAULT_MAX_WAIT_MILLIS = -1L</code>， 永不超时。</p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">borrowObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">borrowObject</span><span class="token punctuation">(</span><span class="token function">getMaxWaitMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="24_minEvictableIdleTimeMillis_92"></a>2.4 minEvictableIdleTimeMillis</h3> 
<p>连接的最小空闲时间，达到此值后该空闲连接可能会被移除（还需看是否已达最大空闲连接数）；<br> 默认值 <code>DEFAULT_MIN_EVICTABLE_IDLE_TIME_MILLIS = 1000L * 60L * 30L</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">final</span> <span class="token class-name">EvictionConfig</span> evictionConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvictionConfig</span><span class="token punctuation">(</span>
                        <span class="token function">getMinEvictableIdleTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">getSoftMinEvictableIdleTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="25_evictorShutdownTimeoutMillis_104"></a>2.5 evictorShutdownTimeoutMillis</h3> 
<p>关闭驱逐线程的超时时间；<br> 默认值 <code>DEFAULT_EVICTOR_SHUTDOWN_TIMEOUT_MILLIS = 10L * 1000L</code></p> 
<p><code>org.apache.commons.pool2.impl.BaseGenericObjectPool</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">startEvictor</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>evictionLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> evictor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">EvictionTimer</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>evictor<span class="token punctuation">,</span> evictorShutdownTimeoutMillis<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                evictor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                evictionIterator <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                evictor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Evictor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EvictionTimer</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>evictor<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="26_softMinEvictableIdleTimeMillis_125"></a>2.6 softMinEvictableIdleTimeMillis</h3> 
<p>连接空闲的最小时间，达到此值后空闲链接将会被移除，且保留 <code>minIdle</code> 个空闲连接数；<br> 默认值 <code>DEFAULT_SOFT_MIN_EVICTABLE_IDLE_TIME_MILLIS = -1</code></p> 
<h3><a id="27_numTestsPerEvictionRun_129"></a>2.7 numTestsPerEvictionRun</h3> 
<p>检测空闲对象线程每次运行时检测的空闲对象的数量；</p> 
<ul><li>如果 <code>numTestsPerEvictionRun&gt;=0</code>, 则取 <code>numTestsPerEvictionRun</code> 和池内的连接数 的较小值 作为每次检测的连接数；</li><li>如果 <code>numTestsPerEvictionRun&lt;0</code>，则每次检查的连接数是检查时池内连接的总数除以这个值的绝对值再向上取整的结果；</li></ul> 
<p>默认值 <code>DEFAULT_NUM_TESTS_PER_EVICTION_RUN = 3</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getNumTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> numTestsPerEvictionRun <span class="token operator">=</span> <span class="token function">getNumTestsPerEvictionRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numTestsPerEvictionRun <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>numTestsPerEvictionRun<span class="token punctuation">,</span> idleObjects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>idleObjects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> numTestsPerEvictionRun<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="28_evictionPolicyClassName_148"></a>2.8 evictionPolicyClassName</h3> 
<p>驱逐策略的类名；<br> 默认值 <code>DEFAULT_EVICTION_POLICY_CLASS_NAME = "org.apache.commons.pool2.impl.DefaultEvictionPolicy"</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setEvictionPolicyClassName</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> evictionPolicyClassName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>evictionPolicyClassName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>evictionPolicyClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> policy <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>policy <span class="token keyword">instanceof</span> <span class="token class-name">EvictionPolicy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> <span class="token comment">// safe, because we just checked the class</span>
                <span class="token keyword">final</span> <span class="token class-name">EvictionPolicy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> evicPolicy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EvictionPolicy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> policy<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>evictionPolicy <span class="token operator">=</span> evicPolicy<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"["</span> <span class="token operator">+</span> evictionPolicyClassName <span class="token operator">+</span> <span class="token string">"] does not implement EvictionPolicy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unable to create EvictionPolicy instance of type "</span> <span class="token operator">+</span> evictionPolicyClassName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unable to create EvictionPolicy instance of type "</span> <span class="token operator">+</span> evictionPolicyClassName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unable to create EvictionPolicy instance of type "</span> <span class="token operator">+</span> evictionPolicyClassName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="29_testOnCreate_181"></a>2.9 testOnCreate</h3> 
<p>在创建对象时检测对象是否有效(<code>true : 是</code>) , 配置 <code>true</code> 会降低性能；<br> 默认值 <code>DEFAULT_TEST_ON_CREATE = false</code>。</p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool##borrowObject(final long borrowMaxWaitMillis)</code></p> 
<pre><code class="prism language-java">	<span class="token class-name">PooledObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token comment">// ...省略</span>
	<span class="token comment">// 配置true，新创建对象都会检测对象是否有效 【 create &amp;&amp; getTestOnCreate() 】</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">getTestOnBorrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> create <span class="token operator">&amp;&amp;</span> <span class="token function">getTestOnCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">boolean</span> validate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Throwable</span> validationThrowable <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            validate <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">validateObject</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">PoolUtils</span><span class="token punctuation">.</span><span class="token function">checkRethrow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            validationThrowable <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">destroy</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                destroyedByBorrowValidationCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Ignore - validation failure is more important</span>
            <span class="token punctuation">}</span>
            p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>create<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">NoSuchElementException</span> nsee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"Unable to validate object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                nsee<span class="token punctuation">.</span><span class="token function">initCause</span><span class="token punctuation">(</span>validationThrowable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> nsee<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="210_testOnBorrow_217"></a>2.10 testOnBorrow</h3> 
<p>在从对象池获取对象时是否检测对象有效(<code>true : 是)</code> , 配置 <code>true</code> 会降低性能；<br> 默认值 <code>DEFAULT_TEST_ON_BORROW = false</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool##borrowObject(final long borrowMaxWaitMillis)</code></p> 
<pre><code class="prism language-java">	<span class="token comment">// 配置true，从对象池获取对象，总是要检测对象是否有效 【 getTestOnBorrow() 】</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">getTestOnBorrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> create <span class="token operator">&amp;&amp;</span> <span class="token function">getTestOnCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// ...省略</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="211_testOnReturn_229"></a>2.11 testOnReturn</h3> 
<p>在向对象池中归还对象时是否检测对象有效(<code>true : 是</code>) , 配置 <code>true</code> 会降低性能；<br> 默认值 <code>DEFAULT_TEST_ON_RETURN = false</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool##returnObject(final T obj)</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getTestOnReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>factory<span class="token punctuation">.</span><span class="token function">validateObject</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">destroy</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">swallowException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">ensureIdle</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">swallowException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">updateStatsReturn</span><span class="token punctuation">(</span>activeTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="212_testWhileIdle_254"></a>2.12 testWhileIdle</h3> 
<p>在检测空闲对象线程检测到对象不需要移除时，是否检测对象的有效性。建议配置为 <code>true</code>，不影响性能，并且保证安全性；<br> 默认值 <code>DEFAULT_TEST_WHILE_IDLE = false</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool##evict()</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">final</span> <span class="token keyword">boolean</span> testWhileIdle <span class="token operator">=</span> <span class="token function">getTestWhileIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// .... 代码省略</span>
	<span class="token comment">// 配置为true， 检测空闲对象线程检测到对象不需要移除时，检测对象的有效性</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>testWhileIdle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token keyword">boolean</span> active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	        factory<span class="token punctuation">.</span><span class="token function">activateObject</span><span class="token punctuation">(</span>underTest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token function">destroy</span><span class="token punctuation">(</span>underTest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        destroyedByEvictorCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>factory<span class="token punctuation">.</span><span class="token function">validateObject</span><span class="token punctuation">(</span>underTest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token function">destroy</span><span class="token punctuation">(</span>underTest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            destroyedByEvictorCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	                factory<span class="token punctuation">.</span><span class="token function">passivateObject</span><span class="token punctuation">(</span>underTest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token function">destroy</span><span class="token punctuation">(</span>underTest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                destroyedByEvictorCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="213_timeBetweenEvictionRunsMillis_289"></a>2.13 timeBetweenEvictionRunsMillis</h3> 
<p>空闲连接检测的周期（单位毫秒）；如果为负值，表示不运行检测线程；<br> 默认值 <code>DEFAULT_TIME_BETWEEN_EVICTION_RUNS_MILLIS = -1L</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">GenericObjectPool</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PooledObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">GenericObjectPoolConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       	<span class="token keyword">super</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> ONAME_BASE<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getJmxNamePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">jmxUnregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// tidy up</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"factory may not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>factory <span class="token operator">=</span> factory<span class="token punctuation">;</span>
        
        idleObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PooledObject</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getFairness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 启动空闲连接检测线程</span>
        <span class="token function">startEvictor</span><span class="token punctuation">(</span><span class="token function">getTimeBetweenEvictionRunsMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="214_blockWhenExhausted_312"></a>2.14 blockWhenExhausted</h3> 
<p>当对象池没有空闲对象时，新的获取对象的请求是否阻塞（<code>true</code> 阻塞，<code>maxWaitMillis</code> 才生效； <code>false</code> 连接池没有资源立马抛异常）<br> 默认值 <code>DEFAULT_BLOCK_WHEN_EXHAUSTED = true</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool##borrowObject(final long borrowMaxWaitMillis)</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">final</span> <span class="token keyword">boolean</span> blockWhenExhausted <span class="token operator">=</span> <span class="token function">getBlockWhenExhausted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ... 省略</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>blockWhenExhausted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>borrowMaxWaitMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                p <span class="token operator">=</span> idleObjects<span class="token punctuation">.</span><span class="token function">takeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                p <span class="token operator">=</span> idleObjects<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span>borrowMaxWaitMillis<span class="token punctuation">,</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span>
                    <span class="token string">"Timeout waiting for idle object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
</code></pre> 
<h3><a id="215_jmxEnabled_337"></a>2.15 jmxEnabled</h3> 
<p>是否注册 <code>JMX</code><br> 默认值 <code>DEFAULT_JMX_ENABLE = true</code></p> 
<p><code>org.apache.commons.pool2.impl.BaseGenericObjectPool</code></p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">BaseGenericObjectPool</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BaseObjectPoolConfig</span> config<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> jmxNameBase<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> jmxNamePrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getJmxEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>oname <span class="token operator">=</span> <span class="token function">jmxRegister</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> jmxNameBase<span class="token punctuation">,</span> jmxNamePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>oname <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Populate the creation stack trace</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>creationStackTrace <span class="token operator">=</span> <span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// save the current TCCL (if any) to be used later by the evictor Thread</span>
        <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            factoryClassLoader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            factoryClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        fairness <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getFairness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="216_jmxNamePrefix_366"></a>2.16 jmxNamePrefix</h3> 
<p><code>JMX</code> 前缀<br> 默认值 <code>DEFAULT_JMX_NAME_PREFIX = "pool"</code></p> 
<p><code>org.apache.commons.pool2.impl.GenericObjectPool</code></p> 
<pre><code class="prism language-java">	<span class="token comment">// JMX specific attributes</span>
   	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ONAME_BASE <span class="token operator">=</span> <span class="token string">"org.apache.commons.pool2:type=GenericObjectPool,name="</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">GenericObjectPool</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PooledObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">GenericObjectPoolConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 参见上述 jmxEnabled 部分</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> ONAME_BASE<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getJmxNamePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// .....</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="217_jmxNameBase_383"></a>2.17 jmxNameBase</h3> 
<p>使用 <code>base + jmxNamePrefix + i</code> 来生成 <code>ObjectName</code><br> 默认值 <code>DEFAULT_JMX_NAME_BASE = null</code>，<code>GenericObjectPool</code> 构造方法使用 <code>ONAME_BASE</code> 初始化。</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token class-name">ObjectName</span> <span class="token function">jmxRegister</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BaseObjectPoolConfig</span> config<span class="token punctuation">,</span><span class="token keyword">final</span> <span class="token class-name">String</span> jmxNameBase<span class="token punctuation">,</span> <span class="token class-name">String</span> jmxNamePrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ObjectName</span> objectName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">MBeanServer</span> mbs <span class="token operator">=</span> <span class="token class-name">ManagementFactory</span><span class="token punctuation">.</span><span class="token function">getPlatformMBeanServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> registered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> base <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getJmxNameBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            base <span class="token operator">=</span> jmxNameBase<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ObjectName</span> objName<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    objName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectName</span><span class="token punctuation">(</span>base <span class="token operator">+</span> jmxNamePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    objName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectName</span><span class="token punctuation">(</span>base <span class="token operator">+</span> jmxNamePrefix <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mbs<span class="token punctuation">.</span><span class="token function">registerMBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> objName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                objectName <span class="token operator">=</span> objName<span class="token punctuation">;</span>
                registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MalformedObjectNameException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BaseObjectPoolConfig</span><span class="token punctuation">.</span>DEFAULT_JMX_NAME_PREFIX<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jmxNamePrefix<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> jmxNameBase<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果走到这步，就跳过jmx注册，应该不会发生</span>
                    registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 前者使用的名称不是默认配置，则使用默认配置替代</span>
                    jmxNamePrefix <span class="token operator">=</span>
                            <span class="token class-name">BaseObjectPoolConfig</span><span class="token punctuation">.</span>DEFAULT_JMX_NAME_PREFIX<span class="token punctuation">;</span>
                    base <span class="token operator">=</span> jmxNameBase<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InstanceAlreadyExistsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 增加一个索引，再试一次</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MBeanRegistrationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果走到这步，就跳过jmx注册，应该不会发生</span>
                registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">NotCompliantMBeanException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果走到这步，就跳过jmx注册，应该不会发生</span>
                registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> objectName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>		
</code></pre> 
<h2><a id="3_GenericObjectPoolConfig_433"></a>3. 子类GenericObjectPoolConfig配置参数</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
 * A simple "struct" encapsulating the configuration for a
 * {@link GenericObjectPool}.
 *  * &lt;p&gt;
 * This class is not thread-safe; it is only intended to be used to provide
 * attributes used when creating a pool.
 *  * @since 2.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericObjectPoolConfig</span> <span class="token keyword">extends</span> <span class="token class-name">BaseObjectPoolConfig</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">private</span> <span class="token keyword">int</span> maxTotal <span class="token operator">=</span> DEFAULT_MAX_TOTAL<span class="token punctuation">;</span>
	
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxIdle <span class="token operator">=</span> DEFAULT_MAX_IDLE<span class="token punctuation">;</span>
	
    <span class="token keyword">private</span> <span class="token keyword">int</span> minIdle <span class="token operator">=</span> DEFAULT_MIN_IDLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="31_maxTotal_452"></a>3.1 maxTotal</h3> 
<p><strong>最大连接数</strong>，默认值 <code>DEFAULT_MAX_TOTAL = 8</code></p> 
<h3><a id="32_maxIdle_454"></a>3.2 maxIdle</h3> 
<p><strong>最大空闲连接数</strong>， 默认值 <code>DEFAULT_MAX_IDLE = 8</code></p> 
<h3><a id="33_minIdle_456"></a>3.3 minIdle</h3> 
<p><strong>最小空闲连接数</strong>， 默认值 <code>DEFAULT_MIN_IDLE = 0</code></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0a84c94d4ca3b2919e3340acae39bd98/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">利用注解及ResponseBodyAdvice对返回参进行加密</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ffaee42b647d52eb1611e120160300e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">利用JWT、注解拦截请求并验证token</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>