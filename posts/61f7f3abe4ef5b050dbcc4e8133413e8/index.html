<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL知识梳理（五）常用函数（聚合、条件、窗口） - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL知识梳理（五）常用函数（聚合、条件、窗口）" />
<meta property="og:description" content="SQL常用函数 一、聚合函数1、 用处2、 常用的聚合函数3、注意 二、 条件判断-case when1、用处2、语法3、使用场景 三.条件判断-if函数1、用处2、语法 四、窗口函数1、用处2、语法：3、 常见窗口函数4、MySQL排序窗口函数的区别 一、聚合函数 1、 用处 聚合函数常和分组计算group by语句结合使用，对数据分组后执行计算并为每组返回唯一值。
2、 常用的聚合函数 COUNT()，SUM()，AVG()，MIN()，MAX()。
COUNT()：计数，返回每组的行数,也会返回有NULL值的列，可用于数字和字符列。
SUM()：返回每组数值的总和，忽略NULL值，仅用于数字列。
AVG()：返回每组数值的平均值，忽略NULL值，仅用于数字列。
MIN()：返回每组数据的最小值，忽略NULL值，可用于数字、字符和日期时间列。
MAX()：返回每组数据的最大值，忽略NULL值，可用于数字、字符和日期时间列。
3、注意 聚合函数不能用在where语句中，需要用在having语句中进行过滤。
原因是SQL语句执行顺序为from 、on 、join 、where 、group by(开始使用select中的别名，后面的语句中都可以使用)、 聚合函数… 、having 、select 、distinct 、order by、limit，
聚合函数是在分组之后进行计算，而分组是where语句过滤完数据后才进行分组，因此如果在where语句中使用聚合函数，还未分组无法进行统计计算，程序会报错。
二、 条件判断-case when 1、用处 利用现有字段，根据条件语句，生成新字段。
2、语法 ① case id when 0 then &#39;学生&#39; when 1 then &#39;学生&#39; when2 then &#39;老师&#39; else &#39;其他&#39; end as identification ② Case when id in (0,1) then &#39;学生&#39; When id = 2 then &#39;老师&#39; Else &#39;其他&#39; end as identification 注意：end关键词不可省" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/61f7f3abe4ef5b050dbcc4e8133413e8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T12:05:35+08:00" />
<meta property="article:modified_time" content="2022-08-23T12:05:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL知识梳理（五）常用函数（聚合、条件、窗口）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>SQL常用函数</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、聚合函数</a></li><li><ul><li><a href="#1%09_2" rel="nofollow">1、 用处</a></li><li><a href="#2%09_4" rel="nofollow">2、 常用的聚合函数</a></li><li><a href="#3_12" rel="nofollow">3、注意</a></li></ul> 
  </li><li><a href="#_case_when_16" rel="nofollow">二、 条件判断-case when</a></li><li><ul><li><a href="#1_17" rel="nofollow">1、用处</a></li><li><a href="#2_19" rel="nofollow">2、语法</a></li><li><a href="#3_38" rel="nofollow">3、使用场景</a></li></ul> 
  </li><li><a href="#if_77" rel="nofollow">三.条件判断-if函数</a></li><li><ul><li><a href="#1_78" rel="nofollow">1、用处</a></li><li><a href="#2_80" rel="nofollow">2、语法</a></li></ul> 
  </li><li><a href="#_98" rel="nofollow">四、窗口函数</a></li><li><ul><li><a href="#1_99" rel="nofollow">1、用处</a></li><li><a href="#2_104" rel="nofollow">2、语法：</a></li><li><a href="#3%09_125" rel="nofollow">3、 常见窗口函数</a></li><li><a href="#4MySQL_127" rel="nofollow">4、MySQL排序窗口函数的区别</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、聚合函数</h2> 
<h3><a id="1%09_2"></a>1、 用处</h3> 
<p>聚合函数常和分组计算group by语句结合使用，对数据分组后执行计算并为每组返回唯一值。</p> 
<h3><a id="2%09_4"></a>2、 常用的聚合函数</h3> 
<p>COUNT()，SUM()，AVG()，MIN()，MAX()。<br> COUNT()：计数，返回每组的行数,也会返回有NULL值的列，可用于数字和字符列。<br> SUM()：返回每组数值的总和，忽略NULL值，仅用于数字列。<br> AVG()：返回每组数值的平均值，忽略NULL值，仅用于数字列。<br> MIN()：返回每组数据的最小值，忽略NULL值，可用于数字、字符和日期时间列。<br> MAX()：返回每组数据的最大值，忽略NULL值，可用于数字、字符和日期时间列。</p> 
<h3><a id="3_12"></a>3、注意</h3> 
<p>聚合函数不能用在where语句中，需要用在having语句中进行过滤。<br> 原因是SQL语句执行顺序为from 、on 、join 、where 、group by(开始使用select中的别名，后面的语句中都可以使用)、 聚合函数… 、having 、select 、distinct 、order by、limit，<br> 聚合函数是在分组之后进行计算，而分组是where语句过滤完数据后才进行分组，因此如果在where语句中使用聚合函数，还未分组无法进行统计计算，程序会报错。</p> 
<h2><a id="_case_when_16"></a>二、 条件判断-case when</h2> 
<h3><a id="1_17"></a>1、用处</h3> 
<p>利用现有字段，根据条件语句，生成新字段。</p> 
<h3><a id="2_19"></a>2、语法</h3> 
<pre><code class="prism language-sql">①
<span class="token keyword">case</span> id <span class="token keyword">when</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'学生'</span>
       <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'学生'</span>
when2 <span class="token keyword">then</span> <span class="token string">'老师'</span>
	<span class="token keyword">else</span> <span class="token string">'其他'</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> identification

②
<span class="token keyword">Case</span> <span class="token keyword">when</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token string">'学生'</span>
<span class="token keyword">When</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'老师'</span>
<span class="token keyword">Else</span> <span class="token string">'其他'</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> identification
</code></pre> 
<p>注意：end关键词不可省</p> 
<h3><a id="3_38"></a>3、使用场景</h3> 
<p>① case when可用于select后 生成新字段:</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span> quantity
<span class="token keyword">case</span> <span class="token keyword">when</span> quantity <span class="token operator">&gt;</span><span class="token number">30</span> <span class="token keyword">then</span> <span class="token number">1</span>
<span class="token keyword">when</span> quantity <span class="token operator">=</span> <span class="token number">30</span> <span class="token keyword">then</span> <span class="token number">2</span>
<span class="token keyword">else</span> <span class="token number">3</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> QuantityText
<span class="token keyword">from</span> orders<span class="token punctuation">;</span>
</code></pre> 
<p>② case when可以写在分组group by后按新字段分组，注意case when用在group by后不可以使用字段别名，即到end关键字结束，无as new_colname。<br> ③ case when可以用在聚合函数中。比如统计每个学生考试通过的学科数，可写为：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span>
id，
name<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> score<span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">then</span> subject <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_pass_subject
<span class="token keyword">from</span> scores
	<span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">&gt;=</span>’<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>’
	<span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>name<span class="token punctuation">;</span>
</code></pre> 
<p>④ case when可以写在order by后</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> CustomerName<span class="token punctuation">,</span> City<span class="token punctuation">,</span> Country
<span class="token keyword">FROM</span> Customers
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span>
    <span class="token keyword">WHEN</span> City <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> Country
    <span class="token keyword">ELSE</span> City
<span class="token keyword">END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>说明：将用户按城市排序，如果城市为空按国家排序。</p> 
<h2><a id="if_77"></a>三.条件判断-if函数</h2> 
<h3><a id="1_78"></a>1、用处</h3> 
<p>根据条件判断，更改原始列数据或者新增列。if比case when执行用时更短一点。</p> 
<h3><a id="2_80"></a>2、语法</h3> 
<p>If（expression，v1,v2） 表达式为真，返回v1, 否则返回v2<br> 例：<br> ① id不是偶数且姓名不以M开头的职员bonus等于其薪水，否则为0：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> employee_id<span class="token punctuation">,</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>employee_id <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">and</span> <span class="token keyword">left</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'M'</span><span class="token punctuation">,</span>salary<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bonus
<span class="token keyword">from</span> Employees
<span class="token keyword">order</span> <span class="token keyword">by</span> employee_id；
</code></pre> 
<p>② 将性别列的所有m和f对调：</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> sex <span class="token operator">=</span> <span class="token keyword">if</span><span class="token punctuation">(</span>sex<span class="token operator">=</span><span class="token string">'m'</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">,</span><span class="token string">'m'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_98"></a>四、窗口函数</h2> 
<h3><a id="1_99"></a>1、用处</h3> 
<p>窗口函数与聚合函数类似，它也会对数据分组之后进行计算，但它不是为每组返回一个值，而是会为分组中的每条记录返回特定值。<br> 窗口函数只能用在select 语句中。它不会用在group by,也不会用在聚合函数中。<br> 窗口函数可以减少表连接。</p> 
<h3><a id="2_104"></a>2、语法：</h3> 
<p>函数名（）over (partition by col1,col2 order by col3 desc/asc, col4 desc/asc) as new_col</p> 
<p>例，统计2022年每个用户最近一次登录的记录：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>
	name<span class="token punctuation">,</span>
	login_time
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id<span class="token punctuation">,</span>
		name<span class="token punctuation">,</span>
		login_time
	row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>name <span class="token keyword">order</span> <span class="token keyword">by</span> login_time <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rank
	<span class="token keyword">from</span> user_login
	<span class="token keyword">where</span> login_time <span class="token operator">&gt;=</span> ‘<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>’
）t
<span class="token keyword">where</span> rank <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p>partition by 表示对所有记录按照用户的id和name进行分组，具有相同id和name的每组用户的记录按登录时间login_time降序排列，最新的记录会排在最前面，并通过窗口函数rou_number()over为同组所有记录返回排序值，最新的记录返回1，次新的记录返回2…最后在外层查询中使用where rank = 1，即得到所有用户最近一次登录的记录。</p> 
<h3><a id="3%09_125"></a>3、 常见窗口函数</h3> 
<h3><a id="4MySQL_127"></a>4、MySQL排序窗口函数的区别</h3> 
<p>ROW_NUMBER()：按照顺序进行排序（1、2、3…）<br> RANK()：并列排序，会跳过重复的序号（1、1、3…）<br> DENSE_RANK()：并列排序，不会跳过重复的序号（1、1、2…）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9f22bbd3f84217fd61a8185258960b74/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【计算机网络】计算机网络概述（湖科大教书匠第一章笔记）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9180de082d4b12297e8029e73b1c84a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LCD1602液晶显示屏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>