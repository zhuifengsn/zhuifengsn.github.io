<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>监控日志 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="监控日志" />
<meta property="og:description" content="1.创建脚本存放目录，写脚本，给执行权限，改脚本存放目录的属主属组为zabbix 在客户端上进入根目录
[root@lwq-client ~]# cd /scripts/ //传入脚本log.py [root@lwq-client scripts]# ls check_swap.sh log.py zabbix.sh [root@lwq-client scripts]# chmod a&#43;x log.py [root@lwq-client scripts]# chown -R zabbix.zabbix log.py [root@lwq-client scripts]# ll 总用量 12 -rwxr-xr-x. 1 zabbix zabbix 187 8月 25 09:50 check_swap.sh -rwxr-xr-x. 1 zabbix zabbix 1854 8月 25 10:27 log.py -rwxr-xr-x. 1 zabbix zabbix 126 8月 24 16:45 zabbix.sh //log.py脚本内容如下 #!/usr/bin/env python3 import sys import re def prePos(seekfile): global curpos try: cf = open(seekfile) except IOError: curpos = 0 return curpos except FileNotFoundError: curpos = 0 return curpos else: try: curpos = int(cf." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/2217abf5ab1bbf8201a91eaa534028e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-25T16:03:44+08:00" />
<meta property="article:modified_time" content="2019-08-25T16:03:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">监控日志</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1zabbix_0"></a>1.创建脚本存放目录，写脚本，给执行权限，改脚本存放目录的属主属组为zabbix</h3> 
<p><strong>在客户端上进入根目录</strong></p> 
<pre><code>[root@lwq-client ~]# cd /scripts/
//传入脚本log.py
[root@lwq-client scripts]# ls
check_swap.sh  log.py  zabbix.sh
[root@lwq-client scripts]# chmod a+x log.py 
[root@lwq-client scripts]# chown -R zabbix.zabbix log.py 
[root@lwq-client scripts]# ll
总用量 12
-rwxr-xr-x. 1 zabbix zabbix  187 8月  25 09:50 check_swap.sh
-rwxr-xr-x. 1 zabbix zabbix 1854 8月  25 10:27 log.py
-rwxr-xr-x. 1 zabbix zabbix  126 8月  24 16:45 zabbix.sh
</code></pre> 
<pre><code>//log.py脚本内容如下
#!/usr/bin/env python3
import sys
import re

def prePos(seekfile):
    global curpos
    try:
        cf = open(seekfile)
    except IOError:
        curpos = 0
        return curpos
    except FileNotFoundError:
        curpos = 0
        return curpos
    else:
        try:
            curpos = int(cf.readline().strip())
        except ValueError:
            curpos = 0
            cf.close()
            return curpos
        cf.close()
    return curpos

def lastPos(filename):
    with open(filename) as lfile:
        if lfile.readline():
            lfile.seek(0,2)
        else:
            return 0
        lastPos = lfile.tell()
    return lastPos

def getSeekFile():
    try:
        seekfile = sys.argv[2]
    except IndexError:
        seekfile = '/tmp/logseek'
    return seekfile

def getKey():
    try:
        tagKey = str(sys.argv[3])
    except IndexError:
        tagKey = 'Error'
    return tagKey

def getResult(filename,seekfile,tagkey):
    destPos = prePos(seekfile)
    curPos = lastPos(filename)

    if curPos &lt; destPos:
        curpos = 0

    try:
        f = open(filename)
    except IOError:
        print('Could not open file: %s' % filename)
    except FileNotFoundError:
        print('Could not open file: %s' % filename)
    else:
        f.seek(destPos)

        while curPos != 0 and f.tell() &lt; curPos:
            rresult = f.readline().strip()
            global result
            if re.search(tagkey, rresult):
                result = 1
                break
            else:
                result = 0

        with open(seekfile,'w') as sf:
            sf.write(str(curPos))
    finally:
        f.close()
    return result

if __name__ == "__main__":
    result = 0
    curpos = 0
    tagkey = getKey()
    seekfile = getSeekFile()
    result = getResult(sys.argv[1],seekfile,tagkey)
    print(result)
</code></pre> 
<h3><a id="2agentdconf_104"></a>2.更改客户端配置文件agentd.conf</h3> 
<pre><code>[root@lwq-client ~]# vim /usr/local/etc/zabbix_agentd.conf
UnsafeUserParameters=1
UserParameter=check_log[*],/usr/bin/python /scripts/log.py $1 $2 $3   //传参数

[root@lwq-client ~]# which python
/usr/bin/python
[root@lwq-client scripts]# /usr/bin/python log.py /var/log/httpd/error_log 
0
[root@lwq-client ~]# cd /var/log/httpd/ 
[root@lwq-client httpd]# ll -d
drwx------. 2 root root 41 8月  24 16:30 .
[root@lwq-client httpd]# setfacl -m u:zabbix:r-x .       //给zabbix用户读和执行权限
</code></pre> 
<h3><a id="3zabbix_agent_120"></a>3.重启zabbix_agent</h3> 
<pre><code>[root@lwq-client ~]# pkill zabbix
[root@lwq-client ~]# zabbix_agentd 
</code></pre> 
<h3><a id="4_125"></a>4.在服务端手动测试</h3> 
<pre><code>[root@lwq-server ~]# zabbix_get -s 192.168.176.112 -k check_log['/var/log/httpd/error_log','/tmp/qq.seek','error']
0
</code></pre> 
<h3><a id="5_130"></a>5.配置网页界面，添加监控项以及触发器</h3> 
<p><strong>添加监控项</strong><br> <img src="https://images2.imgbox.com/4b/f5/kMfJGFlP_o.png" alt="在这里插入图片描述"><br> <strong>添加触发器</strong><br> <img src="https://images2.imgbox.com/62/85/i231YE4b_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6_135"></a>6.验证</h3> 
<pre><code>在配置文件/var/log/httpd/error_log打印字符
[root@lwq-client httpd]# echo "error" &gt;&gt; /var/log/httpd/error_log 
</code></pre> 
<p><strong>检测——&gt;最新数据——&gt;主机群组——&gt;主机——&gt;应用</strong><img src="https://images2.imgbox.com/40/7c/C3DY7HE9_o.png" alt="在这里插入图片描述"><br> <strong>由上图log——&gt;图形</strong><br> <img src="https://images2.imgbox.com/9e/68/wbBdceNT_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5dddb2e3ba5b23e74cf0ed840e6197e8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">架构整理-CentOS 7中KVM的安装与使用-CentOS 7中noVNC的安装与使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dbf82057c1190c57e98fb8d85073f407/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">滴滴笔试--算术转移（20190827）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>