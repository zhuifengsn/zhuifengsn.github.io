<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Jenkins集成 SonarQube - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Jenkins集成 SonarQube" />
<meta property="og:description" content="一、SonarQube基本概述 1.1 什么是SonarQube SonarQube 是一个开源的代码质量管理系统，用于检测代码中的错误、漏洞。它可以与 Jenkins 集成，让我们
能自动化进行代码质量扫描。
1.2 使用Sonarqube环境 1.SonarQube基于Java开发，所以需要安装 OpenJDK8 版本。
2.SonarQube需要依赖 MySQL 数据库，至少 5.6 版本以上。
3.SonarQube的小型实例至少需要4GB 内存，如果是大型实例需要 16GB
1.3 SonarQube服务安装 1.3.1 环境准备 [root@sonarqube ~]# systemctl stop firewalld [root@sonarqube ~]# systemctl disable firewalld [root@sonarqube ~]# setenforce 0 setenforce: SELinux is disabled [root@sonarqube ~]# yum install git java unzip wget -y 1.3.2 安装mysql数据库 1.安装 MySQL5.6 版本数据库
wget --no-check-certificate https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communityserver-5.6.45-2.el7.x86_64.rpm wget https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communityclient-5.6.45-2.el7.x86_64.rpm wget https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communitycommon-5.6.45-2.el7.x86_64.rpm wget https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communitylibs-5.6.45-2.el7.x86_64.rpm [root@sonarqube ~]# yum localinstall mysql-community-* 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/2f9502ea2f09a5593f1679cb40c211b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-27T04:45:00+08:00" />
<meta property="article:modified_time" content="2021-10-27T04:45:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Jenkins集成 SonarQube</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="SonarQube_0"></a>一、SonarQube基本概述</h2> 
<h3><a id="11_SonarQube_1"></a>1.1 什么是SonarQube</h3> 
<p>SonarQube 是一个开源的代码质量管理系统，用于检测代码中的错误、漏洞。它可以与 Jenkins 集成，让我们<br> 能自动化进行代码质量扫描。<br> <img src="https://images2.imgbox.com/87/63/vvYMayet_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12_Sonarqube_5"></a>1.2 使用Sonarqube环境</h3> 
<p>1.SonarQube基于Java开发，所以需要安装 OpenJDK8 版本。<br> 2.SonarQube需要依赖 MySQL 数据库，至少 5.6 版本以上。<br> 3.SonarQube的小型实例至少需要4GB 内存，如果是大型实例需要 16GB</p> 
<h3><a id="13_SonarQube_10"></a>1.3 SonarQube服务安装</h3> 
<h4><a id="131__11"></a>1.3.1 环境准备</h4> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># systemctl stop firewalld

<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># systemctl disable firewalld
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># setenforce <span class="token number">0</span>
setenforce<span class="token operator">:</span> SELinux is disabled
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># yum install git java unzip wget <span class="token operator">-</span>y
</code></pre> 
<h4><a id="132__mysql_21"></a>1.3.2 安装mysql数据库</h4> 
<p>1.安装 MySQL5.6 版本数据库</p> 
<pre><code class="prism language-c">wget  <span class="token operator">--</span>no<span class="token operator">-</span>check<span class="token operator">-</span>certificate https<span class="token operator">:</span><span class="token comment">//mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communityserver-5.6.45-2.el7.x86_64.rpm</span>
wget https<span class="token operator">:</span><span class="token comment">//mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communityclient-5.6.45-2.el7.x86_64.rpm</span>
wget https<span class="token operator">:</span><span class="token comment">//mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communitycommon-5.6.45-2.el7.x86_64.rpm</span>
wget https<span class="token operator">:</span><span class="token comment">//mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql56-community-el7/mysql-communitylibs-5.6.45-2.el7.x86_64.rpm</span>
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># yum localinstall mysql<span class="token operator">-</span>community<span class="token operator">-</span><span class="token operator">*</span>

</code></pre> 
<p>2.创建sonar库</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>p123456 <span class="token operator">-</span>e <span class="token string">"create database sonar charset utf8;"</span>
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>p123456 <span class="token operator">-</span>e <span class="token string">"show databases;"</span>
Warning<span class="token operator">:</span> Using a password on the command line interface can be insecure<span class="token punctuation">.</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> Database           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sonar              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre> 
<h4><a id="133_sonarqube_47"></a>1.3.3 安装sonarqube</h4> 
<p>1.下载 sonarqube，并安装解压至 /usr/local</p> 
<pre><code class="prism language-c">wget https<span class="token operator">:</span><span class="token comment">//binaries.sonarsource.com/Distributi on/sonarqube/sonarqube-7.0.zip</span>
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># unzip sonarqube<span class="token operator">-</span><span class="token number">7.0</span><span class="token punctuation">.</span>zip <span class="token operator">-</span>d <span class="token operator">/</span>usr<span class="token operator">/</span>local
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># ln <span class="token operator">-</span>s <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonarqube<span class="token operator">-</span><span class="token number">7.0</span><span class="token operator">/</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonarqube

</code></pre> 
<p>2.修改 sonarqube 连接数据库配置文件</p> 
<pre><code class="prism language-c">sonar<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>username<span class="token operator">=</span>root
sonar<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>password<span class="token operator">=</span><span class="token number">123456</span>
sonar<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance&amp;useSSL=false</span>
</code></pre> 
<h4><a id="134_Sonarqube_62"></a>1.3.4 启动Sonarqube</h4> 
<p>启动 sonarqube 服务需要使用普通用户运行；如果使用root 则会启动失败；</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># useradd sonar
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># chown <span class="token operator">-</span>R sonar<span class="token punctuation">.</span>sonar <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonarqube<span class="token operator">-</span><span class="token number">7.0</span><span class="token operator">/</span>

<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># su <span class="token operator">-</span> sonar <span class="token operator">-</span>c <span class="token string">"/usr/local/sonarqube/bin/linux-x86-64/sonar.sh start"</span>

</code></pre> 
<h4><a id="135__Sonarqube_72"></a>1.3.5 访问Sonarqube</h4> 
<p>1.通过浏览器输入 http://hostname:9000地址来访问sonarqube<br> 点击登录–&gt;输入用户名：admin 用户密码：admin<br> <img src="https://images2.imgbox.com/ea/3d/kRFcovAO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/7b/PAxoC6vu_o.png" alt="在这里插入图片描述"><br> 3.如何使用 SonarQube 质量分析；java 代码直接通过mvn即可分析；</p> 
<pre><code class="prism language-c">mvn sonar<span class="token operator">:</span>sonar \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>host<span class="token punctuation">.</span>url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token comment">//sonar.bertwu.net:9000 \
  -Dsonar.login=a5eba929217499d5f17d15dbe750a39f4360ad32</span>
</code></pre> 
<p>4.如何使用SonarQube质量分析；非 java 代码则需要使用 sonar-scanner工具分析；</p> 
<p><img src="https://images2.imgbox.com/1c/46/megPBZKC_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner<span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>projectKey<span class="token operator">=</span>html \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>sources<span class="token operator">=</span><span class="token punctuation">.</span> \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>host<span class="token punctuation">.</span>url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token comment">//sonar.bertwu.net:9000 \
  -Dsonar.login=a5eba929217499d5f17d15dbe750a39f4360ad32</span>
</code></pre> 
<h3><a id="14_Sonarqube_96"></a>1.4 Sonarqube插件管理</h3> 
<p>Sonarqube默认已经安装了 C Java Python Php 等代码的质量分析工具；那我们为什么还需要安装插件？因为我们还需要检测 html等类型代码，而默认插件没有，所以需要安装；以便将代码检测的更加完善；</p> 
<h4><a id="141__100"></a>1.4.1 联网安装插件</h4> 
<p>联网安装插件比较简单，仅需要上应用市场搜索插件名称即可，如下以安装中文语言包插件为例；点击Administration &gt; Marketplace --&gt; 搜索框chinese，出现一个Chinese Pack，然后点击<br> install安装好的插件会存储至<br> usr/local/sonarqube/extensions/plugins/xx.jar<br> <img src="https://images2.imgbox.com/a4/81/FLWHUVrv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="142__105"></a>1.4.2 离线安装插件</h4> 
<p>由于 SonarQube 需要安装很多的插件，并且插件安装需要很长的时间；所以我们可以通过导入的方式来完成插件的安装；注意导入后需要重启 Sonarqube</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># rm <span class="token operator">-</span>rf <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonarqube<span class="token operator">/</span>extensions<span class="token operator">/</span>plugins<span class="token operator">/</span>
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># tar xf sonar_plugins<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonarqube<span class="token operator">/</span>extensions
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># chown <span class="token operator">-</span>R sonar<span class="token punctuation">.</span>sonar <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonarqube<span class="token operator">/</span>extensions<span class="token operator">/</span>plugins<span class="token operator">/</span>
<span class="token punctuation">[</span>root@sonarqube <span class="token operator">~</span><span class="token punctuation">]</span># su <span class="token operator">-</span> sonar <span class="token operator">-</span>c <span class="token string">"/usr/local/sonarqube/bin/linux-x86-64/sonar.sh restart"</span>

</code></pre> 
<h2><a id="_SonarQube_115"></a>二 、SonarQube代码检测</h2> 
<p>前面已经将 SonarQube服务以及插件安装完成，那么接下来只需要将代码推送至 Sonarqube 进行分析即可。</p> 
<h3><a id="21_JAVA_118"></a>2.1 JAVA项目分析</h3> 
<p>Sonarqube 分析 JAVA 项目；进入项目目录，使用 mvn命令将代码直接推送至 Sonarqube 分析；</p> 
<pre><code class="prism language-c">mvn sonar<span class="token operator">:</span>sonar \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>host<span class="token punctuation">.</span>url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token comment">//sonar.bertwu.net:9000 \
  -Dsonar.login=a5eba929217499d5f17d15dbe750a39f4360ad32 \
  -Dsonar.java.binaries=target/sonar</span>
</code></pre> 
<h3><a id="22_HTML_127"></a>2.2 HTML项目分析</h3> 
<p>Sonarqube 分析 Html、php、go 项目；需要借助sonar-scanner客户端工具来完成代码的分析；<br> 需要在项目所在的主机安装sonar-scanner<br> 1.安装 sonar-scanner 命令；<a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/" rel="nofollow">sonar-scanner下载地址</a></p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@jenkins <span class="token operator">~</span><span class="token punctuation">]</span># wget https<span class="token operator">:</span><span class="token comment">//binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.0.0.1744-linux.zip</span>
<span class="token punctuation">[</span>root@jenkins <span class="token operator">~</span><span class="token punctuation">]</span># unzip sonar<span class="token operator">-</span>scanner<span class="token operator">-</span>cli<span class="token operator">-</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.1744</span><span class="token operator">-</span>linux<span class="token punctuation">.</span>zip <span class="token operator">-</span>d <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>
<span class="token punctuation">[</span>root@jenkins <span class="token operator">~</span><span class="token punctuation">]</span># ln <span class="token operator">-</span>s <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner<span class="token operator">-</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.1744</span><span class="token operator">-</span>linux<span class="token operator">/</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
</code></pre> 
<p>2.进入项目目录，使用 sonar-scanner 工具将代码推送Sonarqube 服务端进行分析；如果没有加入环境变量，则建议使用绝对路径</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner<span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>projectKey<span class="token operator">=</span>html \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>sources<span class="token operator">=</span><span class="token punctuation">.</span> \
  <span class="token operator">-</span>Dsonar<span class="token punctuation">.</span>host<span class="token punctuation">.</span>url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token comment">//sonar.bertwu.net:9000 \
  -Dsonar.login=a5eba929217499d5f17d15dbe750a39f4360ad32</span>
</code></pre> 
<p>3.登陆 Sonarqube 查看项目分析结果；<br> <img src="https://images2.imgbox.com/5b/98/6UJLULaD_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="JenkinsSonarQube_148"></a>三、Jenkins集成SonarQube</h2> 
<p>Jenkins 需要知道 Sonarqube 服务；以便能将代码推送指定服务节点；<br> Jenkins 需要知道 Sonar-Scanner 客户端工具，以便能正常调用</p> 
<h3><a id="31_Sonarqube_152"></a>3.1 集成Sonarqube</h3> 
<p>1.插件安装；系统管理–&gt;插件管理–&gt;SonarQube Scanner for Jenkins<br> <img src="https://images2.imgbox.com/e4/c9/i4907Rpb_o.png" alt="在这里插入图片描述"><br> 2.在 Jenkins 上配置 SonarQube 服务端地址；系统管理–&gt;系统配置–&gt;sonarQube (告诉jenkins<br> SonarQubeServers服务端地址)<br> Name 可以随意填写<br> URL 添加 SonarQube服务端地址；确保Jenkins能正<br> 常访问；<br> <img src="https://images2.imgbox.com/4f/79/RaLxj1pS_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d8/ba/F76a6APR_o.png" alt="在这里插入图片描述"><br> 如果 SonarQube 没有在配置-&gt;通用设置-&gt;权限-&gt;启用Force user authentication 则可忽略token 验证</p> 
<h3><a id="32_SonarScanner_166"></a>3.2 集成Sonar-Scanner</h3> 
<p>在 Jenkins 上配置 Sonar-Scanner 客户端工具路径； 系统管理–&gt;全局工具配置–&gt;sonar-scanner（告诉jenkins SonarScanner在本地哪个路径）<br> 1.Name 可以随意填写，但最好有规范<br> 2.SONAR_RUNNER_HOME 填写 sonar-scanner 在Jenkins本地路径<br> <img src="https://images2.imgbox.com/9d/c9/xl3rtw7l_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_Jenkins_171"></a>3.3 Jenkins为项目添加测试阶段</h3> 
<p>1.java项目 maven质检方式<br> <img src="https://images2.imgbox.com/a6/a8/fUzjV261_o.png" alt="在这里插入图片描述"><br> 2.java项目 Scanner质检方式</p> 
<pre><code class="prism language-c">sonar<span class="token punctuation">.</span>projectName<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>JOB_NAME<span class="token punctuation">}</span> #项目在sonarqube上的显示名称
sonar<span class="token punctuation">.</span>projectKey<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>JOB_NAME<span class="token punctuation">}</span> #项目的唯一标识，不能重复
sonar<span class="token punctuation">.</span>sources<span class="token operator">=</span><span class="token punctuation">.</span> #扫描哪个项目的源码
sonar<span class="token punctuation">.</span>java<span class="token punctuation">.</span>binaries<span class="token operator">=</span>target<span class="token operator">/</span>sonar
</code></pre> 
<p><img src="https://images2.imgbox.com/37/d3/fzJWhLfK_o.png" alt="在这里插入图片描述"><br> 推荐用scanner方式质检</p> 
<ol start="3"><li>html项目Scanner质检方式<br> <img src="https://images2.imgbox.com/ec/30/aRIYP38w_o.png" alt="在这里插入图片描述"><br> 这样配置后，每次项目CI时候，先会进行质量检测，并将结果传送至SonarQube服务器。</li></ol> 
<h2><a id="Jenkins_189"></a>四、Jenkins为项目添加通知阶段</h2> 
<h3><a id="41__190"></a>4.1 配置钉钉</h3> 
<p>1.打开钉钉群组，点击设置–智能群助手–群机器人–添加机人–自定义机器人。(如果你不是群主，且群主开启了仅群主可管理，那么将无法创建机器人。)<br> 2.添加一个自定义机器人<br> 3.可以修改机器人名称，以及机器人的名字。(这块自行修改）<br> 4.机器人修改成功后，会给出一个webhook地址。(此处的webhook后续jenkins需要使用)<br> <img src="https://images2.imgbox.com/36/00/W8cyMutf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a2/a8/O7H8hcHR_o.png" alt="在这里插入图片描述"></p> 
<p>https://oapi.dingtalk.com/robot/send?access_token=3e7e83379717a4bd052a928864d7bd1fbaa9df93aa473cc3b0f1c844aeea4996</p> 
<h3><a id="42_Jenkins_200"></a>4.2 Jenkins集成钉钉</h3> 
<p>1.Jenkins安装dingding插件。<br> <img src="https://images2.imgbox.com/1d/c4/caSIqZ6p_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/89/18/nOjc9UgO_o.png" alt="在这里插入图片描述"></p> 
<p>2.配置钉钉机器人<br> 系统管理----系统配置<br> <img src="https://images2.imgbox.com/70/7e/KcLMvRZp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43__209"></a>4.3 为项目添加通知</h3> 
<h4><a id="431_CI_210"></a>4.3.1 .CI阶段通知质检结果</h4> 
<p>质检通知相对繁琐，需要自定义环境变量<br> 1.启用钉钉机器人</p> 
<p><img src="https://images2.imgbox.com/4e/98/4uPPBfVT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/60/a7/aeMTybhi_o.png" alt="在这里插入图片描述"></p> 
<p>2.编写质量检查脚本获取相关的值</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@jenkins scripts<span class="token punctuation">]</span># cat dingding<span class="token punctuation">.</span>sh 
# 调用查询异常状态接口函数，该接口是在SonarQube平台直接爬的
function <span class="token function">issues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   # 如果sonar启用了强制认证，可以通过添加 <span class="token operator">-</span>u username<span class="token operator">:</span>password 进行校验
  curl <span class="token operator">-</span>sH <span class="token string">"Content-Length:0"</span> <span class="token operator">-</span>X GET <span class="token string">"http://10.0.0.130:9000/api/issues/search?resolved=false&amp;facets=severities%2Ctypes&amp;componentKeys=$1"</span>
<span class="token punctuation">}</span>

# 类型
<span class="token keyword">for</span> i in <span class="token punctuation">{<!-- --></span><span class="token number">0.</span><span class="token number">.2</span><span class="token punctuation">}</span>
<span class="token keyword">do</span>
  a<span class="token operator">=</span>`issues $<span class="token number">1</span> <span class="token operator">|</span> jq <span class="token string">'.facets[1].values['</span>$<span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span><span class="token string">'].val'</span>`

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>a<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"BUG"'</span> <span class="token punctuation">]</span>
  then
    BUG<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"BUG：`issues $1 | jq '.facets[1].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
    N_BUG<span class="token operator">=</span>`issues $<span class="token number">1</span> <span class="token operator">|</span> jq <span class="token string">'.facets[1].values['</span>$<span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span><span class="token string">'].count'</span>`
  fi

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>a<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"VULNERABILITY"'</span> <span class="token punctuation">]</span>
  then
    VULNERABILITY<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"漏洞：`issues $1 | jq '.facets[1].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
    N_VULNERABILITY<span class="token operator">=</span>`issues $<span class="token number">1</span> <span class="token operator">|</span> jq <span class="token string">'.facets[1].values['</span>$<span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span><span class="token string">'].count'</span>`
  fi

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>a<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"CODE_SMELL"'</span> <span class="token punctuation">]</span>
  then
    CODE_SMELL<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"异味：`issues $1 | jq '.facets[1].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
  fi
done

# 严重程度
<span class="token keyword">for</span> i in <span class="token punctuation">{<!-- --></span><span class="token number">0.</span><span class="token number">.4</span><span class="token punctuation">}</span>
<span class="token keyword">do</span>
  b<span class="token operator">=</span>`issues $<span class="token number">1</span> <span class="token operator">|</span> jq <span class="token string">'.facets[0].values['</span>$<span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span><span class="token string">'].val'</span>`

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"MINOR"'</span> <span class="token punctuation">]</span>
  then
     MINOR<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"次要：`issues $1 | jq '.facets[0].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
  fi

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"MAJOR"'</span> <span class="token punctuation">]</span>
  then
     MAJOR<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"主要：`issues $1 | jq '.facets[0].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
  fi

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"CRITICAL"'</span> <span class="token punctuation">]</span>
  then
    CRITICAL<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"严重：`issues $1 | jq '.facets[0].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
  fi

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"INFO"'</span> <span class="token punctuation">]</span>
  then
    INFO<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"提示：`issues $1 | jq '.facets[0].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
  fi

  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'"BLOCKER"'</span> <span class="token punctuation">]</span>
  then
  BLOCKER<span class="token operator">=</span>$<span class="token punctuation">(</span>echo <span class="token string">"阻断：`issues $1 | jq '.facets[0].values['${i}'].count'`个"</span><span class="token punctuation">)</span>
  fi
done
# 如何将脚本的结果定义为系统变量，供钉钉调用 https<span class="token operator">:</span><span class="token comment">//www.it1352.com/1470666.html</span>
echo <span class="token string">"BUG=${BUG}"</span> <span class="token operator">&gt;</span> $<span class="token punctuation">{<!-- --></span>WORKSPACE<span class="token punctuation">}</span><span class="token operator">/</span>build
echo <span class="token string">"VULNERABILITY=${VULNERABILITY}"</span> <span class="token operator">&gt;&gt;</span> $<span class="token punctuation">{<!-- --></span>WORKSPACE<span class="token punctuation">}</span><span class="token operator">/</span>build
echo <span class="token string">"CODE_SMELL=${CODE_SMELL}"</span> <span class="token operator">&gt;&gt;</span> $<span class="token punctuation">{<!-- --></span>WORKSPACE<span class="token punctuation">}</span><span class="token operator">/</span>build 
echo <span class="token string">"CRITICAL=${CRITICAL}"</span> <span class="token operator">&gt;&gt;</span> $<span class="token punctuation">{<!-- --></span>WORKSPACE<span class="token punctuation">}</span><span class="token operator">/</span>build

</code></pre> 
<p>3.jenkins中安装env插件<br> <img src="https://images2.imgbox.com/24/d1/3lxdn4qr_o.png" alt="在这里插入图片描述"></p> 
<p>4.需要在Jenkins中定义环境变量<br> <img src="https://images2.imgbox.com/70/18/U3stmqtr_o.png" alt="在这里插入图片描述"><br> 5.钉钉通知结果验证<br> <img src="https://images2.imgbox.com/dd/7f/rZFkZvDy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="432_CD_295"></a>4.3.2 .CD阶段通知质检结果</h4> 
<p>相对简单，可以用系统环境变量<br> <img src="https://images2.imgbox.com/88/25/s3CYwLWG_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/fb/f6/kdgHUtAD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/01/54/LgIRBQGF_o.png" alt="在这里插入图片描述"><br> CI/CD整体测试流程<br> <img src="https://images2.imgbox.com/d4/5b/00J4tSsX_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/76c6abb65cfb5122d7fa2129804be874/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序测试注意事项</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cdb37fa9e5d23a971bac9365d994f599/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">免费批量修改图片MD5软件 图片处理防和谐软件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>