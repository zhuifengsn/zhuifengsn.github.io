<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>7. MySql高级之优化SQL步骤 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="7. MySql高级之优化SQL步骤" />
<meta property="og:description" content="文章目录 MySql高级之优化SQL步骤1. 查看SQL执行频率2. 定位低效率执行SQL3. explain分析执行计划☆3.1 环境准备3.2 explain 之 id3.3 explain 之 select_type3.4 explain 之 table3.5 explain 之 type3.6 explain 之 key3.7 explain 之 rows3.8 explain 之 extra 4. show profile分析SQL5. trace分析优化器执行计划 ☆ MySql高级之优化SQL步骤 在应用的的开发过程中，由于初期数据量小，开发人员写 SQL 语句时更重视功能上的实现，但是当应用系统正式上线后，随着生产数据量的急剧增长，很多 SQL 语句开始逐渐显露出性能问题，对生产的影响也越来越大，此时这些有问题的 SQL 语句就成为整个系统性能的瓶颈。因此我们必须要对它们进行优化，本文将介绍在 MySQL 中优化 SQL 语句的方法。当面对一个有 SQL 性能问题的数据库时，我们应该从何处入手来进行系统的分析，使得能够尽快定位问题 SQL 并尽快解决问题。 1. 查看SQL执行频率 MySQL 客户端连接成功后，通过 show [session|global] status 命令可以提供服务器状态信息。show [session|global] status 可以根据需要加上参数“session”或者“global”来显示 session 级（当前连接）的计结果和 global 级（自数据库上次启动至今）的统计结果。如果不写，默认使用参数是“session”。 -- 显示了当前 session 中所有统计参数的值： -- 注意是7个_ show status like &#39;Com_______&#39;; show status like &#39;Innodb_rows_%&#39;; Com_xxx 表示每个 xxx 语句执行的次数，我们通常比较关心的是以下几个统计参数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/738fcc6ef2f74f42456e998fae9535b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-28T14:50:53+08:00" />
<meta property="article:modified_time" content="2020-07-28T14:50:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">7. MySql高级之优化SQL步骤</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#MySqlSQL_1" rel="nofollow">MySql高级之优化SQL步骤</a></li><li><ul><li><ul><li><a href="#1_SQL_8" rel="nofollow">1. 查看SQL执行频率</a></li><li><a href="#2_SQL_48" rel="nofollow">2. 定位低效率执行SQL</a></li><li><a href="#3_explain_65" rel="nofollow">3. explain分析执行计划☆</a></li><li><ul><li><a href="#31__91" rel="nofollow">3.1 环境准备</a></li><li><a href="#32_explain__id_98" rel="nofollow">3.2 explain 之 id</a></li><li><a href="#33_explain__select_type_139" rel="nofollow">3.3 explain 之 select_type</a></li><li><a href="#34_explain__table_152" rel="nofollow">3.4 explain 之 table</a></li><li><a href="#35_explain__type_157" rel="nofollow">3.5 explain 之 type</a></li><li><a href="#36_explain___key_181" rel="nofollow">3.6 explain 之 key</a></li><li><a href="#37_explain__rows_187" rel="nofollow">3.7 explain 之 rows</a></li><li><a href="#38_explain__extra_192" rel="nofollow">3.8 explain 之 extra</a></li></ul> 
     </li><li><a href="#4_show_profileSQL_202" rel="nofollow">4. show profile分析SQL</a></li><li><a href="#5_trace_268" rel="nofollow">5. trace分析优化器执行计划</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_467" rel="nofollow">☆</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="MySqlSQL_1"></a>MySql高级之优化SQL步骤</h3> 
<blockquote> 
 <ol><li>在应用的的开发过程中，由于初期数据量小，开发人员写 SQL 语句时更重视功能上的实现，但是当应用系统正式上线后，随着生产数据量的急剧增长，很多 SQL 语句开始逐渐显露出性能问题，对生产的影响也越来越大，此时这些有问题的 SQL 语句就成为整个系统性能的瓶颈。</li><li>因此我们必须要对它们进行优化，本文将介绍在 MySQL 中优化 SQL 语句的方法。</li><li>当面对一个有 SQL 性能问题的数据库时，我们应该从何处入手来进行系统的分析，使得能够尽快定位问题 SQL 并尽快解决问题。</li></ol> 
</blockquote> 
<h5><a id="1_SQL_8"></a>1. 查看SQL执行频率</h5> 
<blockquote> 
 <ol><li>MySQL 客户端连接成功后，通过 <code>show [session|global] status 命令</code>可以提供服务器状态信息。</li><li><code>show [session|global] status 可以根据需要加上参数“session”或者“global”来显示 session 级（当前连接）的计结果和 global 级（自数据库上次启动至今）的统计结果。如果不写，默认使用参数是“session”。</code></li></ol> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 显示了当前 session 中所有统计参数的值：</span>
<span class="token comment">-- 注意是7个_</span>
<span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Com_______'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5e/71/S4DTPAxr_o.png" alt="在这里插入图片描述"></p> 
<pre><code>show status like 'Innodb_rows_%';
</code></pre> 
<p><img src="https://images2.imgbox.com/3e/b9/l2sQ9NZC_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><code>Com_xxx 表示每个 xxx 语句执行的次数</code>，我们通常比较关心的是以下几个统计参数。</p> 
</blockquote> 
<table><thead><tr><th align="left">参数</th><th>含义</th></tr></thead><tbody><tr><td align="left">Com_select</td><td>执行 select 操作的次数，一次查询只累加 1。</td></tr><tr><td align="left">Com_insert</td><td>执行 INSERT 操作的次数，对于批量插入的 INSERT 操作，只累加一次。</td></tr><tr><td align="left">Com_update</td><td>执行 UPDATE 操作的次数。</td></tr><tr><td align="left">Com_delete</td><td>执行 DELETE 操作的次数。</td></tr><tr><td align="left">Innodb_rows_read</td><td>select 查询返回的行数。</td></tr><tr><td align="left">Innodb_rows_inserted</td><td>执行 INSERT 操作插入的行数。</td></tr><tr><td align="left">Innodb_rows_updated</td><td>执行 UPDATE 操作更新的行数。</td></tr><tr><td align="left">Innodb_rows_deleted</td><td>执行 DELETE 操作删除的行数。</td></tr><tr><td align="left">Connections</td><td>试图连接 MySQL 服务器的次数。</td></tr><tr><td align="left">Uptime</td><td>服务器工作时间。</td></tr><tr><td align="left">Slow_queries</td><td>慢查询的次数。</td></tr></tbody></table> 
<blockquote> 
 <ul><li><code>Com_*** :</code> 这些参数对于所有存储引擎的表操作都会进行累计。</li><li><code>Innodb_*** :</code> 这几个参数只是针对InnoDB 存储引擎的，累加的算法也略有不同。</li></ul> 
</blockquote> 
<h5><a id="2_SQL_48"></a>2. 定位低效率执行SQL</h5> 
<blockquote> 
 <p>可以通过以下两种方式定位执行效率较低的 SQL 语句。</p> 
 <ul><li> <p><code>慢查询日志 :</code> 通过慢查询日志定位那些执行效率较低的 SQL 语句，用<code>--log-slow-queries[=file_name]选项启动时</code>，mysqld 写一个包含所有执行时间超过 long_query_time 秒的 SQL 语句的日志文件。</p> </li><li> <p><code>show processlist :</code> 慢查询日志在查询结束以后才纪录，所以在应用反映执行效率出现问题的时候查询慢查询日志并不能定位问题，可以<code>使用show processlist命令查看当前MySQL在进行的线程，包括线程的状态、是否锁表等，可以实时地查看 SQL 的执行情况，同时对一些锁表操作进行优化。</code></p> </li><li> <p><img src="https://images2.imgbox.com/dc/ec/YlMi6I87_o.png" alt="在这里插入图片描述"></p> 
   <ul><li>id列，用户登录mysql时，系统分配的"connection_id"。</li><li>user列，显示当前用户。如果不是root，这个命令就只显示用户权限范围的sql语句。</li><li>host列，显示这个语句是从哪个<code>ip</code>的哪个端口上发的，可以用来跟踪出现问题语句的用户</li><li>db列，显示这个进程目前连接的是哪个数据库</li><li>command列，显示当前连接的执行的命令，一般取值为休眠（sleep），查询（query），连接（connect）等</li><li>time列，显示这个状态持续的时间，单位是秒</li><li><code>state列，</code>显示使用当前连接的<code>sql</code>语句的状态，很重要的列。<code>一个sql语句，以查询为例，可能需要经过copying to tmp table、sorting result、sending data等状态才可以完成。</code></li><li>info列，显示这个<code>sql</code>语句，是判断问题语句的一个重要依据。</li></ul> </li></ul> 
</blockquote> 
<h5><a id="3_explain_65"></a>3. explain分析执行计划☆</h5> 
<p>通过以上步骤查询到效率低的 SQL 语句后，可以<code>通过 explain 或者 desc 命令获取 mysql 如何执行 select 语句的信息，包括在 select 语句执行过程中表如何连接和连接的顺序。</code></p> 
<pre><code class="prism language-sql"><span class="token comment">-- 查询SQL语句的执行计划 ： </span>
<span class="token keyword">explain</span><span class="token operator">/</span><span class="token keyword">desc</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_item <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0e/00/cpbNJG3t_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td><code>id</code></td><td><code>select查询的序列号，是一组数字，表示的是查询中执行select子句或者是操作表的顺序。</code></td></tr><tr><td><code>select_type</code></td><td><code>表示 SELECT 的类型，常见的取值有 SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION 中的第二个或者后面的查询语句）、SUBQUERY（子查询中的第一个 SELECT）等</code></td></tr><tr><td><code>table</code></td><td><code>输出结果集的表</code></td></tr><tr><td><code>type</code>☆</td><td><code>表示表的连接类型，性能由好到差的连接类型为( system ---&gt; const -----&gt; eq_ref ------&gt; ref -------&gt; ref_or_null----&gt; index_merge ---&gt; index_subquery -----&gt; range -----&gt; index ------&gt; all )</code></td></tr><tr><td><code>possible_keys</code></td><td><code>表示查询时，可能使用的索引</code></td></tr><tr><td><code>key</code>☆</td><td><code>表示实际使用的索引</code></td></tr><tr><td><code>key_len</code>☆</td><td><code>索引字段的长度</code></td></tr><tr><td><code>rows</code>☆</td><td><code>扫描行的数量</code></td></tr><tr><td><code>extra</code></td><td><code>执行情况的说明和描述</code></td></tr></tbody></table> 
<h6><a id="31__91"></a>3.1 环境准备</h6> 
<blockquote> 
 <p><a href="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/mysql_senior/%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5.sql" rel="nofollow">建表语句…</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/5e/6e/mcBtWhwR_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="32_explain__id_98"></a>3.2 explain 之 id</h6> 
<blockquote> 
 <p>id 字段是 select查询的序列号，是一组数字，表示的是查询中执行select子句或者是操作表的顺序。id 情况有三种</p> 
 <ol><li><code>id 相同表示加载表的顺序是从上到下。</code></li></ol> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> 
<span class="token keyword">select</span> 	<span class="token operator">*</span> <span class="token keyword">from</span> t_role r<span class="token punctuation">,</span> t_user u<span class="token punctuation">,</span> user_role ur 
<span class="token keyword">where</span> r<span class="token punctuation">.</span>id <span class="token operator">=</span> ur<span class="token punctuation">.</span>role_id 
	<span class="token operator">and</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> ur<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ba/86/317ENkcr_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <ol start="2"><li><code>id 不同id值越大，优先级越高，越先被执行。</code></li></ol> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> t_role 
<span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> role_id <span class="token keyword">from</span> user_role <span class="token keyword">where</span> user_id <span class="token operator">=</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> id <span class="token keyword">from</span> t_user <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'stu1'</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d3/da/TEQqi4W0_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <ol start="3"><li>id 有相同，也有不同，同时存在。<code>id相同的可以认为是一组，从上往下顺序执行；</code>在所有的组中，id的值越大，优先级越高，越先执行。</li></ol> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_role r<span class="token punctuation">,</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role ur <span class="token keyword">where</span> ur<span class="token punctuation">.</span>user_id <span class="token operator">=</span><span class="token string">'2'</span>
<span class="token punctuation">)</span>a
<span class="token keyword">where</span> r<span class="token punctuation">.</span>id <span class="token operator">=</span> a<span class="token punctuation">.</span>role_id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/81/02/atXCCBAK_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="33_explain__select_type_139"></a>3.3 explain 之 select_type</h6> 
<p><strong><font color="green"> 表示 SELECT 的类型，常见的取值,由上到下效率依次变低</font></strong></p> 
<table><thead><tr><th><code>select_type</code></th><th><code>含义</code></th></tr></thead><tbody><tr><td><code>SIMPLE</code></td><td><code>简单的select查询，查询中不包含子查询或者UNION</code></td></tr><tr><td><code>PRIMARY</code></td><td><code>查询中若包含任何复杂的子查询，最外层查询标记为该标识</code></td></tr><tr><td><code>SUBQUERY</code></td><td><code>在SELECT 或 WHERE 列表中包含了子查询</code></td></tr><tr><td><code>DERIVED</code></td><td><code>在FROM 列表中包含的子查询，被标记为 DERIVED（衍生） MYSQL会递归执行这些子查询，把结果放在临时表中</code></td></tr><tr><td><code>UNION</code></td><td><code>若第二个SELECT出现在UNION之后，则标记为UNION ； 若UNION包含在FROM子句的子查询中，外层SELECT将被标记为 ： DERIVED</code></td></tr><tr><td><code>UNION RESULT</code></td><td><code>从UNION表获取结果的SELECT</code></td></tr></tbody></table> 
<h6><a id="34_explain__table_152"></a>3.4 explain 之 table</h6> 
<blockquote> 
 <p>展示这一行的数据是关于哪一张表的</p> 
</blockquote> 
<h6><a id="35_explain__type_157"></a>3.5 explain 之 type</h6> 
<blockquote> 
 <p>type 显示的是访问类型，是较为重要的一个指标</p> 
</blockquote> 
<table><thead><tr><th>type</th><th>含义</th></tr></thead><tbody><tr><td>NULL</td><td>MySQL不访问任何表，索引，直接返回结果</td></tr><tr><td>system</td><td>表只有一行记录(等于系统表)，这是const类型的特例，一般不会出现</td></tr><tr><td><code>const</code></td><td><code>表示通过索引一次就找到了，const 用于比较primary key 或者 unique 索引。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL 就能将该查询转换为一个常亮。const于将 "主键" 或 "唯一" 索引的所有部分与常量值进行比较</code></td></tr><tr><td><code>eq_ref</code></td><td>类似ref，<code>区别在于使用的是唯一索引</code>，使用主键的关联查询，关联查询出的记录只有一条。常见于主键或唯一索引扫描</td></tr><tr><td><code>ref</code></td><td><code>非唯一性索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，返回所有匹配某个单独值的所有行（多个）</code></td></tr><tr><td><code>range</code></td><td><code>只检索给定返回的行，使用一个索引来选择行。 where 之后出现 between ， &lt; , &gt; , in 等操作。</code></td></tr><tr><td>index</td><td>index 与 ALL的区别为 index 类型只是遍历了索引树， 通常比ALL 快， ALL 是遍历数据文件。</td></tr><tr><td><code>all</code></td><td><code>将遍历全表以找到匹配的行</code></td></tr></tbody></table> 
<blockquote> 
 <p>结果值从最好到最坏以此是：</p> 
 <ol><li><code>NULL &gt; system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</code></li><li><code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code></li><li><mark>一般来说， 我们需要保证查询至少达到 range 级别， 最好达到ref 。</mark></li></ol> 
</blockquote> 
<h6><a id="36_explain___key_181"></a>3.6 explain 之 key</h6> 
<blockquote> 
 <ol><li><code>possible_keys :</code> 显示可能应用在这张表的索引， 一个或多个。</li><li><code>key ：</code> 实际使用的索引， 如果为NULL， 则没有使用索引。</li><li><code>key_len :</code> 表示索引中使用的字节数， 该值为索引字段最大可能长度，并非实际使用长度，<code>在不损失精确性的前提下， 长度越短越好 。</code></li></ol> 
</blockquote> 
<h6><a id="37_explain__rows_187"></a>3.7 explain 之 rows</h6> 
<blockquote> 
 <p>扫描行的数量。</p> 
</blockquote> 
<h6><a id="38_explain__extra_192"></a>3.8 explain 之 extra</h6> 
<p>其他的额外的执行计划信息，在该列展示 。</p> 
<table><thead><tr><th>extra</th><th>含义</th></tr></thead><tbody><tr><td>using filesort</td><td>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取， 称为 “文件排序”, 效率低。</td></tr><tr><td>using temporary</td><td>使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于 order by 和 group by； 效率低</td></tr><tr><td><code>using index</code></td><td><code>表示相应的select操作使用了覆盖索引， 避免访问表的数据行， 效率不错。</code></td></tr></tbody></table> 
<h5><a id="4_show_profileSQL_202"></a>4. show profile分析SQL</h5> 
<blockquote> 
 <p>Mysql从5.0.37版本开始增加了对 show profiles 和 show profile 语句的支持。show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了。</p> 
 <p>通过 <code>@@have_profiling 参数</code>，能够看到当前MySQL是否支持profile：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1c/e1/CP3kD24y_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>默认<code>@@profiling</code>是关闭的，可以通过set语句在Session级别开启profiling：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/28/07/3JXrAHey_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">-- 开启profiling 开关</span>
<span class="token keyword">set</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
</code></pre> 
<blockquote> 
 <p>通过profile，我们能够更清楚地了解SQL执行的过程。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 首先，我们可以执行一系列的操作</span>
<span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> mysql_senior<span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_seller<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_seller<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>执行完上述命令之后，<code>再执行show profiles 指令</code>， 来查看SQL语句执行的耗时：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/cb/70/ZWwWGkZL_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><code>通过show profile for query query_id 语句</code>可以查看到该SQL执行过程中每个线程的状态和消耗的时间：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4e/22/Nnvd1c9p_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><code>Sending data 状态表示MySQL线程开始访问数据行并把结果返回给客户端，而不仅仅是返回个客户端。由于在Sending data状态下，MySQL线程往往需要做大量的磁盘读取操作，所以经常是整各查询中耗时最长的状态。</code></p> 
 <p>在获取到最消耗时间的线程状态后，MySQL支持进一步选择all、cpu、block io 、context switch、page faults等明细类型类查看MySQL在使用什么资源上耗费了过高的时间。</p> 
 <p>例如，<code>选择查看CPU的耗费时间 ：show profile cpu for query 4;</code></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2d/21/7mLBFsdW_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>Status</td><td>sql 语句执行的状态</td></tr><tr><td>Duration</td><td>sql 执行过程中每一个步骤的耗时</td></tr><tr><td>CPU_user</td><td>当前用户占有的cpu</td></tr><tr><td>CPU_system</td><td>系统占有的cpu</td></tr></tbody></table> 
<h5><a id="5_trace_268"></a>5. trace分析优化器执行计划</h5> 
<blockquote> 
 <p>MySQL5.6提供了对SQL的跟踪trace, 通过trace文件能够进一步了解为什么优化器选择A计划, 而不是选择B计划。</p> 
 <p>打开trace ， 设置格式为 JSON，并设置trace最大能够使用的内存大小，避免解析过程中因为默认内存过小而不能够完整展示。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">"enabled=on"</span><span class="token punctuation">,</span>end_markers_in_json<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> optimizer_trace_max_mem_size<span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>执行SQL语句 ：</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_seller <span class="token keyword">where</span> id <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>最后， 检查information_schema.optimizer_trace就可以知道MySQL是如何执行SQL的 ：</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>optimizer_trace\G<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span> <span class="token number">1.</span> row <span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>
<span class="token constant">QUERY</span><span class="token punctuation">:</span> select <span class="token operator">*</span> <span class="token keyword">from</span> tb_item where id <span class="token operator">&lt;</span> <span class="token number">4</span>
<span class="token constant">TRACE</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"join_preparation"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"select#"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"expanded_query"</span><span class="token punctuation">:</span> <span class="token string">"/* select#1 */ select `tb_item`.`id` AS `id`,`tb_item`.`title` AS `title`,`tb_item`.`price` AS `price`,`tb_item`.`num` AS `num`,`tb_item`.`categoryid` AS `categoryid`,`tb_item`.`status` AS `status`,`tb_item`.`sellerid` AS `sellerid`,`tb_item`.`createtime` AS `createtime`,`tb_item`.`updatetime` AS `updatetime` from `tb_item` where (`tb_item`.`id` &lt; 4)"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      <span class="token punctuation">}</span> <span class="token comment">/* join_preparation */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"join_optimization"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"select#"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"condition_processing"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"condition"</span><span class="token punctuation">:</span> <span class="token string">"WHERE"</span><span class="token punctuation">,</span>
              <span class="token string">"original_condition"</span><span class="token punctuation">:</span> <span class="token string">"(`tb_item`.`id` &lt; 4)"</span><span class="token punctuation">,</span>
              <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"transformation"</span><span class="token punctuation">:</span> <span class="token string">"equality_propagation"</span><span class="token punctuation">,</span>
                  <span class="token string">"resulting_condition"</span><span class="token punctuation">:</span> <span class="token string">"(`tb_item`.`id` &lt; 4)"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"transformation"</span><span class="token punctuation">:</span> <span class="token string">"constant_propagation"</span><span class="token punctuation">,</span>
                  <span class="token string">"resulting_condition"</span><span class="token punctuation">:</span> <span class="token string">"(`tb_item`.`id` &lt; 4)"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"transformation"</span><span class="token punctuation">:</span> <span class="token string">"trivial_condition_removal"</span><span class="token punctuation">,</span>
                  <span class="token string">"resulting_condition"</span><span class="token punctuation">:</span> <span class="token string">"(`tb_item`.`id` &lt; 4)"</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
            <span class="token punctuation">}</span> <span class="token comment">/* condition_processing */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"table_dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span>
                <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token string">"`tb_item`"</span><span class="token punctuation">,</span>
                <span class="token string">"row_may_be_null"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token string">"map_bit"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"depends_on_map_bits"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">]</span> <span class="token comment">/* depends_on_map_bits */</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span> <span class="token comment">/* table_dependencies */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"ref_optimizer_key_uses"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">]</span> <span class="token comment">/* ref_optimizer_key_uses */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"rows_estimation"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span>
                <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token string">"`tb_item`"</span><span class="token punctuation">,</span>
                <span class="token string">"range_analysis"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"table_scan"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"rows"</span><span class="token punctuation">:</span> <span class="token number">9816098</span><span class="token punctuation">,</span>
                    <span class="token string">"cost"</span><span class="token punctuation">:</span> <span class="token number">2.04e6</span>
                  <span class="token punctuation">}</span> <span class="token comment">/* table_scan */</span><span class="token punctuation">,</span>
                  <span class="token string">"potential_range_indices"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string">"index"</span><span class="token punctuation">:</span> <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                      <span class="token string">"usable"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                      <span class="token string">"key_parts"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"id"</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* key_parts */</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span> <span class="token comment">/* potential_range_indices */</span><span class="token punctuation">,</span>
                  <span class="token string">"setup_range_conditions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">]</span> <span class="token comment">/* setup_range_conditions */</span><span class="token punctuation">,</span>
                  <span class="token string">"group_index_range"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"chosen"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token string">"cause"</span><span class="token punctuation">:</span> <span class="token string">"not_group_by_or_distinct"</span>
                  <span class="token punctuation">}</span> <span class="token comment">/* group_index_range */</span><span class="token punctuation">,</span>
                  <span class="token string">"analyzing_range_alternatives"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"range_scan_alternatives"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                      <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"index"</span><span class="token punctuation">:</span> <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                        <span class="token string">"ranges"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                          <span class="token string">"id &lt; 4"</span>
                        <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span><span class="token punctuation">,</span>
                        <span class="token string">"index_dives_for_eq_ranges"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token string">"rowid_ordered"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token string">"using_mrr"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">"index_only"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">"rows"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                        <span class="token string">"cost"</span><span class="token punctuation">:</span> <span class="token number">1.6154</span><span class="token punctuation">,</span>
                        <span class="token string">"chosen"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">]</span> <span class="token comment">/* range_scan_alternatives */</span><span class="token punctuation">,</span>
                    <span class="token string">"analyzing_roworder_intersect"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token string">"usable"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                      <span class="token string">"cause"</span><span class="token punctuation">:</span> <span class="token string">"too_few_roworder_scans"</span>
                    <span class="token punctuation">}</span> <span class="token comment">/* analyzing_roworder_intersect */</span>
                  <span class="token punctuation">}</span> <span class="token comment">/* analyzing_range_alternatives */</span><span class="token punctuation">,</span>
                  <span class="token string">"chosen_range_access_summary"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"range_access_plan"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"range_scan"</span><span class="token punctuation">,</span>
                      <span class="token string">"index"</span><span class="token punctuation">:</span> <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
                      <span class="token string">"rows"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                      <span class="token string">"ranges"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"id &lt; 4"</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span>
                    <span class="token punctuation">}</span> <span class="token comment">/* range_access_plan */</span><span class="token punctuation">,</span>
                    <span class="token string">"rows_for_plan"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                    <span class="token string">"cost_for_plan"</span><span class="token punctuation">:</span> <span class="token number">1.6154</span><span class="token punctuation">,</span>
                    <span class="token string">"chosen"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
                  <span class="token punctuation">}</span> <span class="token comment">/* chosen_range_access_summary */</span>
                <span class="token punctuation">}</span> <span class="token comment">/* range_analysis */</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span> <span class="token comment">/* rows_estimation */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"considered_execution_plans"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span>
                <span class="token string">"plan_prefix"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">]</span> <span class="token comment">/* plan_prefix */</span><span class="token punctuation">,</span>
                <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token string">"`tb_item`"</span><span class="token punctuation">,</span>
                <span class="token string">"best_access_path"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"considered_access_paths"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string">"access_type"</span><span class="token punctuation">:</span> <span class="token string">"range"</span><span class="token punctuation">,</span>
                      <span class="token string">"rows"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                      <span class="token string">"cost"</span><span class="token punctuation">:</span> <span class="token number">2.2154</span><span class="token punctuation">,</span>
                      <span class="token string">"chosen"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span> <span class="token comment">/* considered_access_paths */</span>
                <span class="token punctuation">}</span> <span class="token comment">/* best_access_path */</span><span class="token punctuation">,</span>
                <span class="token string">"cost_for_plan"</span><span class="token punctuation">:</span> <span class="token number">2.2154</span><span class="token punctuation">,</span>
                <span class="token string">"rows_for_plan"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string">"chosen"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span> <span class="token comment">/* considered_execution_plans */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"attaching_conditions_to_tables"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"original_condition"</span><span class="token punctuation">:</span> <span class="token string">"(`tb_item`.`id` &lt; 4)"</span><span class="token punctuation">,</span>
              <span class="token string">"attached_conditions_computation"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">]</span> <span class="token comment">/* attached_conditions_computation */</span><span class="token punctuation">,</span>
              <span class="token string">"attached_conditions_summary"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token string">"`tb_item`"</span><span class="token punctuation">,</span>
                  <span class="token string">"attached"</span><span class="token punctuation">:</span> <span class="token string">"(`tb_item`.`id` &lt; 4)"</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span> <span class="token comment">/* attached_conditions_summary */</span>
            <span class="token punctuation">}</span> <span class="token comment">/* attaching_conditions_to_tables */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"refine_plan"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span>
                <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token string">"`tb_item`"</span><span class="token punctuation">,</span>
                <span class="token string">"access_type"</span><span class="token punctuation">:</span> <span class="token string">"range"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span> <span class="token comment">/* refine_plan */</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      <span class="token punctuation">}</span> <span class="token comment">/* join_optimization */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"join_execution"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"select#"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      <span class="token punctuation">}</span> <span class="token comment">/* join_execution */</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_467"></a>☆</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d38bde31ab1d7e984de698feb10e20da/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">为什么spring单例要使用三级缓存</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2a63b762618c7917ae76259d3d8be63f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Sklearn Impute SimpleImputer 处理缺失值</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>