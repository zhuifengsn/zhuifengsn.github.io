<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>计算机设计大赛 深度学习大数据物流平台 python - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="计算机设计大赛 深度学习大数据物流平台 python" />
<meta property="og:description" content="文章目录 0 前言1 课题背景2 物流大数据平台的架构与设计3 智能车货匹配推荐算法的实现**1\. 问题陈述****2\. 算法模型**3\. 模型构建总览 **4 司机标签体系的搭建及算法****1\. 冷启动**2\. LSTM多标签模型算法 5 货运价格预测6 总结7 部分核心代码8 最后 0 前言 🔥 优质竞赛项目系列，今天要分享的是
🚩 深度学习大数据物流平台
该项目较为新颖，适合作为竞赛课题方向，学长非常推荐！
🥇学长这里给一个题目综合评分(每项满分5分)
难度系数：3分工作量：3分创新点：4分 🧿 更多资料, 项目分享：
https://gitee.com/dancheng-senior/postgraduate
1 课题背景 根据研究报告，中国拥有全球最大的道路运输市场，2020年市场规模为人民币6.2万亿元。其中整车（FTL）和零担（LTL）运输占中国公路运输市场的大部分，2020年到达了人民币5.3万亿元。
整个物流市场由物流公司、专项车队、司机等角色组成。一个普通物流订单由货主，物流公司，车队和司机通过逐层人工订单传递完成。物流中还有计划外的货运需求，需要由调度人员通过人工电话联系各个下级的承运方进行承运。另外，物流行业中还有许多地方需要人工支持，如车辆的在途信息、货运单据以及财务结算。可见，人工支持在物流行业中占有较高比例。
较高的人工支持占比导致物流企业在运营过程中无法针对一些具体的情况或者突发事件进行快速的反应和决策，使得一些中小企业在市场竞争中处于劣势。因此，物流公司需要一个智能高效的数字化物流平台，使其拥有信息化、数据处理以及算法能力，形成一个高效的物流生态。
2 物流大数据平台的架构与设计 物流大数据平台通过数字化各个物流环节，使得各流程实时衔接，提升物流系统的效率。随着车辆的移动、票据资金的流转以及交易的完成，所有业务数据都会沉淀到物流大数据平台。接着，通过大数据平台的计算能力，对数据进行整理，归类和分析，将数据提供给物流平台中的各个应用模块。同时，平台引入算法（机器学习和深度学习），在海量数据中不断接近业务问题的全局最优解，借助算法决策使得收益最大化。
目前，物流大数据技术平台主要是由应用层，算法平台，数据仓库和数据平台组成。
最上层的是 应用层 ，包括销售管理、智能调度、货源推荐、图片资料审核等，提供了平台所需要的核心功能，其实现应用了很多算法。这些算法是在算法平台上开发的。
算法平台 提供丰富的算法以及模型来支撑整个平台的运转。
算法层的下一层是 数据仓库 ，存放了集团所有的业务数据。只有基于这些丰富的数据，算法才能够能够为上层应用提供服务。
最底层是整个 大数据平台基础设施 ，包含CDH集群（Hadoop/ spark/
Impala）、Doris集群和监控系统。它们实现了海量数据的基础存储和计算能力，对批量数据进行秒级的统计分析，让企业的业务人员和分析人员能实时掌握企业的运营情况。
应用案例
① 车辆在途追踪
数据平台可追踪到任意一台已经安装了特定GPS设备的车辆。GPS设备每三十秒给数据中心传输一条经纬度位置的数据，从而让数据平台获取车辆的实时位置。连续的实时位置可构成行车记录，用于判断车辆在货运的途中是否正常行驶、是否偏离方向、是否超速行驶等。
② 实时调度中心
实时调度中心可以实时地计算出物流平台上各时间段内累计的货运单量、活跃司机数、货主数、交易金额等，便于业务决策。
3 智能车货匹配推荐算法的实现 1. 问题陈述 智能车货匹配推荐算法的应用场景分为两种：一是人找货，二是货找人。人找货是货运司机通过浏览货运信息找到想要运输的货物；货找人是发货人下单后调度人员推送货源信息给货运司机。两个场景均涉及三个变量：司机、货物、环境。（具体涵盖如下图所示）
唯有合理运用这三个变量，才能计算出合理的车货匹配度。问题可以被抽象地用数学表达为 y=F(Xi, Xu,
Xc)，其中y表示匹配程度，Xi指的是我们的item货物，Xu指的是货运司机user，Xc指的是环境context。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/8333ef61283242ca85f23f19872850c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-26T13:29:54+08:00" />
<meta property="article:modified_time" content="2024-02-26T13:29:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">计算机设计大赛 深度学习大数据物流平台 python</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#0__3" rel="nofollow">0 前言</a></li><li><a href="#1__21" rel="nofollow">1 课题背景</a></li><li><a href="#2__31" rel="nofollow">2 物流大数据平台的架构与设计</a></li><li><a href="#3__55" rel="nofollow">3 智能车货匹配推荐算法的实现</a></li><li><ul><li><a href="#1__57" rel="nofollow">**1\. 问题陈述**</a></li><li><a href="#2__68" rel="nofollow">**2\. 算法模型**</a></li><li><a href="#3__100" rel="nofollow">3\. 模型构建总览</a></li></ul> 
  </li><li><a href="#4__106" rel="nofollow">**4 司机标签体系的搭建及算法**</a></li><li><ul><li><a href="#1__114" rel="nofollow">**1\. 冷启动**</a></li><li><a href="#2_LSTM_122" rel="nofollow">2\. LSTM多标签模型算法</a></li></ul> 
  </li><li><a href="#5__146" rel="nofollow">5 货运价格预测</a></li><li><a href="#6__156" rel="nofollow">6 总结</a></li><li><a href="#7__160" rel="nofollow">7 部分核心代码</a></li><li><a href="#8__305" rel="nofollow">8 最后</a></li></ul> 
</div> 
<p></p> 
<h2><a id="0__3"></a>0 前言</h2> 
<p>🔥 优质竞赛项目系列，今天要分享的是</p> 
<p>🚩 <strong>深度学习大数据物流平台</strong></p> 
<p>该项目较为新颖，适合作为竞赛课题方向，学长非常推荐！</p> 
<p>🥇学长这里给一个题目综合评分(每项满分5分)</p> 
<ul><li>难度系数：3分</li><li>工作量：3分</li><li>创新点：4分</li></ul> 
<p>🧿 <strong>更多资料, 项目分享：</strong></p> 
<p><a href="https://gitee.com/dancheng-senior/postgraduate" rel="nofollow">https://gitee.com/dancheng-senior/postgraduate</a></p> 
<h2><a id="1__21"></a>1 课题背景</h2> 
<p>根据研究报告，中国拥有全球最大的道路运输市场，2020年市场规模为人民币6.2万亿元。其中整车（FTL）和零担（LTL）运输占中国公路运输市场的大部分，2020年到达了人民币5.3万亿元。</p> 
<p><img src="https://images2.imgbox.com/62/e4/Z4suflEV_o.png" alt="在这里插入图片描述"></p> 
<p>整个物流市场由物流公司、专项车队、司机等角色组成。一个普通物流订单由货主，物流公司，车队和司机通过逐层人工订单传递完成。物流中还有计划外的货运需求，需要由调度人员通过人工电话联系各个下级的承运方进行承运。另外，物流行业中还有许多地方需要人工支持，如车辆的在途信息、货运单据以及财务结算。可见，人工支持在物流行业中占有较高比例。</p> 
<p>较高的人工支持占比导致物流企业在运营过程中无法针对一些具体的情况或者突发事件进行快速的反应和决策，使得一些中小企业在市场竞争中处于劣势。因此，物流公司需要一个智能高效的数字化物流平台，使其拥有信息化、数据处理以及算法能力，形成一个高效的物流生态。</p> 
<h2><a id="2__31"></a>2 物流大数据平台的架构与设计</h2> 
<p>物流大数据平台通过数字化各个物流环节，使得各流程实时衔接，提升物流系统的效率。随着车辆的移动、票据资金的流转以及交易的完成，所有业务数据都会沉淀到物流大数据平台。接着，通过大数据平台的计算能力，对数据进行整理，归类和分析，将数据提供给物流平台中的各个应用模块。同时，平台引入算法（机器学习和深度学习），在海量数据中不断接近业务问题的全局最优解，借助算法决策使得收益最大化。</p> 
<p>目前，物流大数据技术平台主要是由应用层，算法平台，数据仓库和数据平台组成。</p> 
<p>最上层的是 应用层 ，包括销售管理、智能调度、货源推荐、图片资料审核等，提供了平台所需要的核心功能，其实现应用了很多算法。这些算法是在算法平台上开发的。<br> 算法平台 提供丰富的算法以及模型来支撑整个平台的运转。<br> 算法层的下一层是 数据仓库 ，存放了集团所有的业务数据。只有基于这些丰富的数据，算法才能够能够为上层应用提供服务。<br> 最底层是整个 大数据平台基础设施 ，包含CDH集群（Hadoop/ spark/<br> Impala）、Doris集群和监控系统。它们实现了海量数据的基础存储和计算能力，对批量数据进行秒级的统计分析，让企业的业务人员和分析人员能实时掌握企业的运营情况。</p> 
<p><strong>应用案例</strong></p> 
<p><img src="https://images2.imgbox.com/47/41/0DwW8F82_o.png" alt="在这里插入图片描述"></p> 
<p><strong>① 车辆在途追踪</strong></p> 
<p>数据平台可追踪到任意一台已经安装了特定GPS设备的车辆。GPS设备每三十秒给数据中心传输一条经纬度位置的数据，从而让数据平台获取车辆的实时位置。连续的实时位置可构成行车记录，用于判断车辆在货运的途中是否正常行驶、是否偏离方向、是否超速行驶等。</p> 
<p><strong>② 实时调度中心</strong></p> 
<p>实时调度中心可以实时地计算出物流平台上各时间段内累计的货运单量、活跃司机数、货主数、交易金额等，便于业务决策。</p> 
<h2><a id="3__55"></a>3 智能车货匹配推荐算法的实现</h2> 
<h3><a id="1__57"></a><strong>1. 问题陈述</strong></h3> 
<p>智能车货匹配推荐算法的应用场景分为两种：一是人找货，二是货找人。人找货是货运司机通过浏览货运信息找到想要运输的货物；货找人是发货人下单后调度人员推送货源信息给货运司机。两个场景均涉及三个变量：司机、货物、环境。（具体涵盖如下图所示）</p> 
<p><img src="https://images2.imgbox.com/7d/82/lLx3NS52_o.png" alt="在这里插入图片描述"></p> 
<p>唯有合理运用这三个变量，才能计算出合理的车货匹配度。问题可以被抽象地用数学表达为 y=F(Xi, Xu,<br> Xc)，其中y表示匹配程度，Xi指的是我们的item货物，Xu指的是货运司机user，Xc指的是环境context。</p> 
<p>不妨将该问题变成点击率预测问题。当司机查看一个货源列表的时候，如果他点击了某条货源信息，就表示该司机对这条货源信息比较感兴趣；如果他没有点击，则假设他对这条货源信息不感兴趣。通过点击数据，我们可以把每一条货源信息标记为0和1，点击是1，未点击是0。从而，根据司机、货物以及环境所有的属性特征，我们预测该货源信息最终是否发生点击（变成了一个二分类问题）。</p> 
<h3><a id="2__68"></a><strong>2. 算法模型</strong></h3> 
<p>在实际应用中，解决是否点击问题经常引用的模型是DeepFM。DeepFM是深度学习和FM模型结合的一个框架，比单个深度学习模型或FM模型要表现好。</p> 
<p>① FM模型</p> 
<p>FM (Factorization Machine) 主要是为了解决数据稀疏的情况下，特征怎样组合的问题，也就是特征两两组合的问题。数学表达式如下：</p> 
<p>其中n表示样本的特征数。这里的特征是离散化后的特征。与线性模型相比，FM的模型多了特征两两组合的部分。</p> 
<p>② DeepFM构建</p> 
<p><img src="https://images2.imgbox.com/66/85/PZ6blL4P_o.png" alt="在这里插入图片描述"></p> 
<p>DeepFM模型包含FM和DNN两部分，FM模型可以抽取low-order特征，DNN可以抽取high-<br> order特征，因而无需人工特征工程。FM模块进行一阶和二阶的特征进行组合并学习到低阶特征；深度模型模块可以让模型学到更高阶的特征组合。最终，通过激活函数，预测点击概率。DeepFM具体框架如上图右半部分所示。首先，DeepFM对所有输入的稀疏特征进行embedding向量化，并对不同的特征之间进行交叉，生成新特征。FM<br> layer实现了上图左上的公式(2)，把变量的二阶的特征交叉进行线性累加；Hidden<br> layer（DNN）实现了特征多重交叉，获得更高阶的特征交叉。FM模型和DNN模块共享特征embedding。通过FM和DNN，模型同时学习低阶和高阶的一个特征组合。</p> 
<p>③ 模型评估</p> 
<p>我们先用AUC评价并筛选出最优DeepFM模型。除此以外，还有其它离线指标评判模型是否能上线。</p> 
<p>离线指标(Top10) ： 根据回溯数据 ，模型算出司机（用户）前十适配的货源信息，前十适配的货源里有哪些货源被点击，从而计算出离线的前十点击率；<br> CTR: 货源展现点击率；<br> CVR： 订单成交转化率；<br> 订单量： 由对应推荐位。<br> 经过评估，如果该模型比之前的模型离线效果更好，我们就可以上线这个模型，再对其进行基于AB<br> test的线上效果评估。如下图所示，我们先将用户随机分成三组，占比30%，40%和30%。根据三组的线上CTR和CVR情况，平台抉择出最优版本进行发布。抉择可基于数值，也可基于统计学的假设检验。</p> 
<p><img src="https://images2.imgbox.com/80/fd/AmDGulG8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__100"></a>3. 模型构建总览</h3> 
<p><img src="https://images2.imgbox.com/0c/51/0Sk7ScQC_o.png" alt="在这里插入图片描述"></p> 
<p>平台收集到用户行为数据后，通过实时计算框架，对行为数据进行处理并存到离线仓库，以制作模型训练集。模型给用户提供线上推荐。根据离线仓库里的数据，我们计算出一些离线特征。将离线仓库数据按日处理获得日志，其中包括统计分析以及近线特征。根据统计分析可以提炼出指标报表，为业务与模型训练提供指引；近线特征是指通过司机最近的行为计算其近期特征，可加入推荐模型以获得更好的推荐效果。</p> 
<h2><a id="4__106"></a><strong>4 司机标签体系的搭建及算法</strong></h2> 
<p>推荐车货匹配系统需要用到很多司机的标签特征，而且公司的产品和运营也需要良好的标签体系的辅助。接下来我们介绍司机的标签体系。</p> 
<p>马玉潮：物流平台的车货匹配推荐算法及标签体系搭建</p> 
<p>司机的标签体系主要有发货地、目的地、车型、车长、货物等。我们需要通过司机用户的历史行为，包括当前坐标、浏览货源筛选、报价等，做出标签预测。</p> 
<h3><a id="1__114"></a><strong>1. 冷启动</strong></h3> 
<p>前期数据匮乏时，我们需要经历一个冷启动的阶段。此时我们需要通过一些人工规则方式给司机打标签。例如，当司机访问一个货源时，若这个货源上面有标签，最简单的方法就是把这个货源上的标签打到这个司机身上。但司机的货运需求是变化的。例如，司机A之前更加关注轻工业产品的货运信息，但现在他比较关注普通商品的货运信息。可见，司机的近期的行为才更能代表其目前需求。</p> 
<p>对于这个问题，我们借鉴了牛顿冷却定律的思想提出了解决方案。牛顿冷却定律指出物体的冷却速度与它当前温度与室温之间的温差成正比。将该公式映射到推荐场景中，则为距离当前时间越远的行为其权重越低。权重公式：</p> 
<p>冷启动下的标签规则为，基于权重公式和人工规定的阈值，通过司机点击行为来给司机打上标签。</p> 
<h3><a id="2_LSTM_122"></a>2. LSTM多标签模型算法</h3> 
<p>当累积一定的司机数据后，不仅平台会预测司机标签，司机用户也会自己维护标签。之后我们可以拿完整的司机数据（如标签完整度大于80%且其在app中交互行为超过一定阈值的司机数据）作为训练集，训练模型以预测司机的标签情况。</p> 
<p><img src="https://images2.imgbox.com/fd/2c/4cMUTWDl_o.png" alt="在这里插入图片描述"></p> 
<p>这里提出LSTM多标签模型，因为循环神经网络可以处理不定长的用户行为输入。具体框架示意如下：</p> 
<p><img src="https://images2.imgbox.com/bc/3a/ILsMIxbX_o.png" alt="在这里插入图片描述"></p> 
<p>X表示的司机行为数据，例如X0表示司机的一次点击行为，X1表示司机的一次电话联系行为。X是不可预测的。司机用户每发生一种行为，都会被构建成输入，并被输入到LSTM模型当中。经过一系列行为后，模型输出对该司机的多标签预测。框架最后一层其实是对每一个标签做二分类，生成了一个多标签模型。</p> 
<p>模型评价标准有精确度（Precision）以及召回率（Recall）：</p> 
<p><img src="https://images2.imgbox.com/85/6d/YKP7gLnA_o.png" alt="在这里插入图片描述"></p> 
<p>此处L是用户实际标签，P是模型预测标签。</p> 
<p>这个模型现在还有以下几点待实现和解决：</p> 
<ul><li>预测出来的标签都可以作为推荐模型的一个输入；</li><li>司机车型、发货地和卸货地的预测困难，当前司机的车型标签比较少且固定，但司机对于发货地卸货地需求变化多端，因而我们需要更多数据才能更加准确地预测；</li><li>召回率与精确度平衡问题，比如给司机推送消息需要更高精确性以减少不必要的打扰。</li></ul> 
<h2><a id="5__146"></a>5 货运价格预测</h2> 
<p>货运价格一方面可以作为模型的输入，另一方面可为系统整体运作提供提示和参考，尤其是需要知道整体市场价格的调度人员。因此，需要有模型来对货运价格进行预测。若要建模，首先要把货运价格通过专业知识拆分出固定的成本，如过路费、邮费、司机劳务费用、车辆折旧费用等等。另外，针对一些返程空车情况严重的路线，我们还需要考虑供需关系对于价格的影响。基础的货运价格公式和价格模型如下图所示。</p> 
<p><img src="https://images2.imgbox.com/76/cd/2RmTBmoz_o.png" alt="在这里插入图片描述"></p> 
<p>要搭建模型，首先要做特征工程，得到城市、月份、路程、车长以及其他特征。成本分为三种：线性成本、周期成本与时序成本。对于不同成本，我们施与不同的模型策略。线性成本是可以根据货运距离和油价计算出来的成本，例如过路费和邮费，因此使用线性回归模型进行学习。周期成本是跟天气相关、季节相关的。时序成本，如司机劳务费，是随着当地环境因素（如：收入水平）是在动态变化的。因此，通过连续的成本模型LSTM模型去进行预测。对于突发状况，模型则应用规则策略。规则策略主要是靠人工观察市场行情，并调参以调整价格模型。那么随着逐步收集市场数据，模型中可加入市场行情模型实现自动价格调整以及价格预测。</p> 
<p>价格模型的评估指标为SMAPE（对称平均绝对值百分比误差），以处理高价带来的高方差。正常来说，模型对价格预测在实际价格上下10%波动，可以达到85%左右的准确率。</p> 
<h2><a id="6__156"></a>6 总结</h2> 
<p>物流大数据平台通过大量业务数据沉淀，训练出基于DeepFM的车货匹配系统模型，基于LSTM的司机标签体系模型，以及货运价格预测模型，从而成功建造了一个高效的物流生态。</p> 
<h2><a id="7__160"></a>7 部分核心代码</h2> 
<p>​</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">as</span> sio
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> matplotlib
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> math
<span class="token keyword">import</span> csv
 
<span class="token comment"># Define LSTM Neural Networks</span>
<span class="token keyword">class</span> <span class="token class-name">LstmRNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
        Parameters：
        - input_size: feature size
        - hidden_size: number of hidden units
        - output_size: number of output
        - num_layers: layers of LSTM to stack
    """</span>
 
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> hidden_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">)</span>  <span class="token comment"># utilize the LSTM model in torch.nn</span>
        self<span class="token punctuation">.</span>linear1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_size<span class="token punctuation">,</span> output_size<span class="token punctuation">)</span> <span class="token comment"># 全连接层</span>
 
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> _x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>_x<span class="token punctuation">)</span>  <span class="token comment"># _x is input, size (seq_len, batch, input_size)</span>
        s<span class="token punctuation">,</span> b<span class="token punctuation">,</span> h <span class="token operator">=</span> x<span class="token punctuation">.</span>shape  <span class="token comment"># x is output, size (seq_len, batch, hidden_size)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>s <span class="token operator">*</span> b<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>linear1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>s<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
 
<span class="token comment"># checking if GPU is available</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Training on GPU.'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'No GPU available, training on CPU.'</span><span class="token punctuation">)</span>
 
    <span class="token comment"># 数据读取&amp;类型转换</span>
    data_x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'Data_x.csv'</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
    data_y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'Data_y.csv'</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
 
    <span class="token comment"># 数据集分割</span>
    data_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_x<span class="token punctuation">)</span>
    t <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> data_len<span class="token punctuation">,</span> data_len<span class="token punctuation">)</span>
 
    train_data_ratio <span class="token operator">=</span> <span class="token number">0.8</span>  <span class="token comment"># Choose 80% of the data for training</span>
    train_data_len <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data_len <span class="token operator">*</span> train_data_ratio<span class="token punctuation">)</span>
 
    train_x <span class="token operator">=</span> data_x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span>train_data_len<span class="token punctuation">]</span>
    train_y <span class="token operator">=</span> data_y<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span>train_data_len<span class="token punctuation">]</span>
    t_for_training <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span>train_data_len<span class="token punctuation">]</span>
 
    test_x <span class="token operator">=</span> data_x<span class="token punctuation">[</span>train_data_len<span class="token punctuation">:</span><span class="token punctuation">]</span>
    test_y <span class="token operator">=</span> data_y<span class="token punctuation">[</span>train_data_len<span class="token punctuation">:</span><span class="token punctuation">]</span>
    t_for_testing <span class="token operator">=</span> t<span class="token punctuation">[</span>train_data_len<span class="token punctuation">:</span><span class="token punctuation">]</span>
 
    <span class="token comment"># ----------------- train -------------------</span>
    INPUT_FEATURES_NUM <span class="token operator">=</span> <span class="token number">5</span>
    OUTPUT_FEATURES_NUM <span class="token operator">=</span> <span class="token number">1</span>
    train_x_tensor <span class="token operator">=</span> train_x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> INPUT_FEATURES_NUM<span class="token punctuation">)</span>  <span class="token comment"># set batch size to 1</span>
    train_y_tensor <span class="token operator">=</span> train_y<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> OUTPUT_FEATURES_NUM<span class="token punctuation">)</span>  <span class="token comment"># set batch size to 1</span>
 
    <span class="token comment"># transfer data to pytorch tensor</span>
    train_x_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x_tensor<span class="token punctuation">)</span>
    train_y_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y_tensor<span class="token punctuation">)</span>
 
    lstm_model <span class="token operator">=</span> LstmRNN<span class="token punctuation">(</span>INPUT_FEATURES_NUM<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span>OUTPUT_FEATURES_NUM<span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 20 hidden units</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'LSTM model:'</span><span class="token punctuation">,</span> lstm_model<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'model.parameters:'</span><span class="token punctuation">,</span> lstm_model<span class="token punctuation">.</span>parameters<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'train x tensor dimension:'</span><span class="token punctuation">,</span> Variable<span class="token punctuation">(</span>train_x_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>lstm_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e-2</span><span class="token punctuation">)</span>
 
    prev_loss <span class="token operator">=</span> <span class="token number">1000</span>
    max_epochs <span class="token operator">=</span> <span class="token number">2000</span>
 
    train_x_tensor <span class="token operator">=</span> train_x_tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
 
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        output <span class="token operator">=</span> lstm_model<span class="token punctuation">(</span>train_x_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> train_y_tensor<span class="token punctuation">)</span>
 
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
        <span class="token keyword">if</span> loss <span class="token operator">&lt;</span> prev_loss<span class="token punctuation">:</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>lstm_model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'lstm_model.pt'</span><span class="token punctuation">)</span>  <span class="token comment"># save model parameters to files</span>
            prev_loss <span class="token operator">=</span> loss
 
        <span class="token keyword">if</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1e-4</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [{}/{}], Loss: {:.5f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> max_epochs<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The loss value is reached"</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">elif</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch: [{}/{}], Loss:{:.5f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> max_epochs<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token comment"># prediction on training dataset</span>
    pred_y_for_train <span class="token operator">=</span> lstm_model<span class="token punctuation">(</span>train_x_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    pred_y_for_train <span class="token operator">=</span> pred_y_for_train<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> OUTPUT_FEATURES_NUM<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    <span class="token comment"># ----------------- test -------------------</span>
    lstm_model <span class="token operator">=</span> lstm_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># switch to testing model</span>
 
    <span class="token comment"># prediction on test dataset</span>
    test_x_tensor <span class="token operator">=</span> test_x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                   INPUT_FEATURES_NUM<span class="token punctuation">)</span>
    test_x_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_x_tensor<span class="token punctuation">)</span>  <span class="token comment"># 变为tensor</span>
    test_x_tensor <span class="token operator">=</span> test_x_tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
 
    pred_y_for_test <span class="token operator">=</span> lstm_model<span class="token punctuation">(</span>test_x_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    pred_y_for_test <span class="token operator">=</span> pred_y_for_test<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> OUTPUT_FEATURES_NUM<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>pred_y_for_test<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"test loss："</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token comment"># ----------------- plot -------------------</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_for_training<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'y_trn'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_for_training<span class="token punctuation">,</span> pred_y_for_train<span class="token punctuation">,</span> <span class="token string">'y--'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pre_trn'</span><span class="token punctuation">)</span>
 
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_for_testing<span class="token punctuation">,</span> test_y<span class="token punctuation">,</span> <span class="token string">'k'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'y_tst'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>t_for_testing<span class="token punctuation">,</span> pred_y_for_test<span class="token punctuation">,</span> <span class="token string">'m--'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pre_tst'</span><span class="token punctuation">)</span>
 
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Vce'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="8__305"></a>8 最后</h2> 
<p>🧿 <strong>更多资料, 项目分享：</strong></p> 
<p><a href="https://gitee.com/dancheng-senior/postgraduate" rel="nofollow">https://gitee.com/dancheng-senior/postgraduate</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b8f4a2288c8bd76c1e9d46a60648fb28/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[超实用插件]在Visual Studio中查看EF Core查询计划</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a201ccf996e2d681112033b3a685448f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">苹果设计之路：从麦金塔到iPhone的传奇</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>