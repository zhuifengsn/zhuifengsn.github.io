<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kubernetes集群搭建(1.26版本) - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kubernetes集群搭建(1.26版本)" />
<meta property="og:description" content="集群搭建 1.初始化安装k8s集群的实验1.1修改主机名称1.2关闭防火墙1.3关闭SELINUX1.4配置主机hosts文件，相互之间通过主机名访问1.5配置主机之间无密码登录1.6关闭交换分区swap，提升性能1.7修改机器内核参数1.9配置阿里云的repo源1.10配置安装k8s组件需要的阿里云repo源1.11配置时间同步1.12安装基础软件包 2.安装containerd服务2.1安装containerd 3.安装k8s需要的软件包4.kubeadm初始化k8s网络集群4.1基于kubeadm.yaml初始化k8s集群 5.添加第一次工作节点6.安装kubernetes网络组件-calico6.1calico网络插件配置文件说明 7.测试在k8s创建pod是否可以正常访问网络8.ctr和crictl的区别9.扩容k8s集群，添加第二个工作节点10.扩容k8s集群，添加第二个管理节点 环境准备 角色IP主节点：master1192.168.40.180主节点：master2192.168.40.183工作节点：node1192.168.40.181工作节点：node2192.168.40.182 master2和node2用做k8s集群的扩容
安装需要
链接：https://pan.baidu.com/s/17eFlM6kJN2rdeSvhTTVRFw
提取码：nx09
–来自百度网盘超级会员V3的分享
1.初始化安装k8s集群的实验 1.1修改主机名称 master1
# 修改主机名称 hostnamectl set-hostname master1 &amp;&amp; bash node1
hostnamectl set-hostname node1 &amp;&amp; bash 1.2关闭防火墙 master1
# 关闭防火墙 [root@master1 ~]# systemctl stop firewalld &amp;&amp; systemctl disable firewalld node1
[root@node1 ~]# systemctl stop firewalld &amp;&amp; systemctl disable firewalld 1.3关闭SELINUX master1
#修改配置文件 [root@master1 ~]# sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/co # 重启机器生效 [root@master1 ~]# reboot node1
[root@node1 ~]# sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/co [root@node1 ~]# reboot 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/29dd32bb8e7c8fc8e042b783713d7edd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-25T20:26:08+08:00" />
<meta property="article:modified_time" content="2024-02-25T20:26:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kubernetes集群搭建(1.26版本)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>集群搭建</h4> 
 <ul><li><a href="#1k8s_18" rel="nofollow">1.初始化安装k8s集群的实验</a></li><li><ul><li><a href="#11_19" rel="nofollow">1.1修改主机名称</a></li><li><a href="#12_29" rel="nofollow">1.2关闭防火墙</a></li><li><a href="#13SELINUX_39" rel="nofollow">1.3关闭SELINUX</a></li><li><a href="#14hosts_53" rel="nofollow">1.4配置主机hosts文件，相互之间通过主机名访问</a></li><li><a href="#15_69" rel="nofollow">1.5配置主机之间无密码登录</a></li><li><a href="#16swap_111" rel="nofollow">1.6关闭交换分区swap，提升性能</a></li><li><a href="#17_125" rel="nofollow">1.7修改机器内核参数</a></li><li><a href="#19repo_185" rel="nofollow">1.9配置阿里云的repo源</a></li><li><a href="#110k8srepo_199" rel="nofollow">1.10配置安装k8s组件需要的阿里云repo源</a></li><li><a href="#111_220" rel="nofollow">1.11配置时间同步</a></li><li><a href="#112_241" rel="nofollow">1.12安装基础软件包</a></li></ul> 
  </li><li><a href="#2containerd_250" rel="nofollow">2.安装containerd服务</a></li><li><ul><li><a href="#21containerd_251" rel="nofollow">2.1安装containerd</a></li></ul> 
  </li><li><a href="#3k8s_352" rel="nofollow">3.安装k8s需要的软件包</a></li><li><a href="#4kubeadmk8s_367" rel="nofollow">4.kubeadm初始化k8s网络集群</a></li><li><ul><li><a href="#41kubeadmyamlk8s_430" rel="nofollow">4.1基于kubeadm.yaml初始化k8s集群</a></li></ul> 
  </li><li><a href="#5_456" rel="nofollow">5.添加第一次工作节点</a></li><li><a href="#6kubernetescalico_471" rel="nofollow">6.安装kubernetes网络组件-calico</a></li><li><ul><li><a href="#61calico_486" rel="nofollow">6.1calico网络插件配置文件说明</a></li></ul> 
  </li><li><a href="#7k8spod_517" rel="nofollow">7.测试在k8s创建pod是否可以正常访问网络</a></li><li><a href="#8ctrcrictl_539" rel="nofollow">8.ctr和crictl的区别</a></li><li><a href="#9k8s_553" rel="nofollow">9.扩容k8s集群，添加第二个工作节点</a></li><li><a href="#10k8s_556" rel="nofollow">10.扩容k8s集群，添加第二个管理节点</a></li></ul> 
</div> 
<br> 
<strong>环境准备</strong> 
<p></p> 
<table><thead><tr><th>角色</th><th>IP</th></tr></thead><tbody><tr><td>主节点：master1</td><td>192.168.40.180</td></tr><tr><td>主节点：master2</td><td>192.168.40.183</td></tr><tr><td>工作节点：node1</td><td>192.168.40.181</td></tr><tr><td>工作节点：node2</td><td>192.168.40.182</td></tr></tbody></table> 
<p><font color="red"><strong>master2和node2用做k8s集群的扩容</strong></font></p> 
<p><strong>安装需要</strong><br> 链接：https://pan.baidu.com/s/17eFlM6kJN2rdeSvhTTVRFw<br> 提取码：nx09<br> –来自百度网盘超级会员V3的分享</p> 
<h2><a id="1k8s_18"></a>1.初始化安装k8s集群的实验</h2> 
<h3><a id="11_19"></a>1.1修改主机名称</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 修改主机名称</span>
hostnamectl set-hostname master1 <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell">hostnamectl set-hostname node1 <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span>
</code></pre> 
<h3><a id="12_29"></a>1.2关闭防火墙</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 关闭防火墙</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span>
</code></pre> 
<h3><a id="13SELINUX_39"></a>1.3关闭SELINUX</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment">#修改配置文件</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/co</span>
<span class="token comment"># 重启机器生效</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># reboot</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/co</span>

<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># reboot</span>
</code></pre> 
<h3><a id="14hosts_53"></a>1.4配置主机hosts文件，相互之间通过主机名访问</h3> 
<p>修改每台机器的/etc/hosts文件，文件最后增加如下内容：<br> master1:</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> /etc/hosts

<span class="token number">192.168</span>.40.180 master1
<span class="token number">192.168</span>.40.181 node1
</code></pre> 
<p>node1:</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> /etc/hosts

<span class="token number">192.168</span>.40.180 master1
<span class="token number">192.168</span>.40.181 node1
</code></pre> 
<h3><a id="15_69"></a>1.5配置主机之间无密码登录</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 创建密钥</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># ssh-keygen </span>
Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/root/.ssh/id_rsa<span class="token punctuation">)</span>: 
Created directory <span class="token string">'/root/.ssh'</span><span class="token builtin class-name">.</span>
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>: 
Enter same passphrase again: 
Your identification has been saved <span class="token keyword">in</span> /root/.ssh/id_rsa.
Your public key has been saved <span class="token keyword">in</span> /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:jCUEBllzJUq672lZGR5ck5BTy9C59vXsKAaG3JgbLUM root@master1
The key<span class="token string">'s randomart image is:
+---[RSA 2048]----+
|  .+*.**oo       |
|  .+ =o+*.       |
|  . ...o+o       |
|   .  E=o   .    |
|  .  +.@S. . o   |
|   .  % = .   o  |
|    .o * .   o   |
|   .o..   o . .  |
|   .o    . .     |
+----[SHA256]-----+
# 传输到noded1节点
[root@master1 ~]# ssh-copy-id node1
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
The authenticity of host '</span>node1 <span class="token punctuation">(</span><span class="token number">192.168</span>.40.181<span class="token punctuation">)</span><span class="token string">' can'</span>t be established.
ECDSA key fingerprint is SHA256:M6KzBDyB8kkCkrVm3GtFytNb44nD/1WR9DT18yHEWZ4.
ECDSA key fingerprint is MD5:13:76:bd:4c:17:2d:f0:e4:43:ee:4e:1a:37:6a:49:a2.
Are you sure you want to <span class="token builtin class-name">continue</span> connecting <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span>
/usr/bin/ssh-copy-id: INFO: attempting to log <span class="token keyword">in</span> with the new key<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: <span class="token number">1</span> key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> remain to be installed -- <span class="token keyword">if</span> you are prompted now it is to <span class="token function">install</span> the new keys
root@node1<span class="token string">'s password:    # 输入node1的密码

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh '</span>node1'"
and check to <span class="token function">make</span> sure that only the key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> you wanted were added.
</code></pre> 
<h3><a id="16swap_111"></a>1.6关闭交换分区swap，提升性能</h3> 
<p><code>问题1：为什么要关闭swap交换分区？</code><br> Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是<code>不允许使用交换分区</code>的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定<code>--ignore-preflight-errors=Swap</code>来解决。<br> master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 临时关闭swap分区</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># swapoff -a</span>
<span class="token comment"># 永久关闭swap分区,fstab文件给swap这行开头加一下注释</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@noded1 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/fstab</span>
<span class="token comment">#/dev/mapper/centos-swap swap                    swap    defaults        0 0</span>
</code></pre> 
<h3><a id="17_125"></a>1.7修改机器内核参数</h3> 
<p><code>问题1：sysctl是做什么的？</code><br> 在运行时配置内核参数<br> -p 从指定的文件加载系统参数，如不指定即从/etc/sysctl.conf中加载</p> 
<p><code>问题2：为什么要执行modprobe br_netfilter？</code><br> 修改/etc/sysctl.d/k8s.conf文件，增加如下三行参数：<br> net.bridge.bridge-nf-call-ip6tables = 1<br> net.bridge.bridge-nf-call-iptables = 1<br> net.ipv4.ip_forward = 1</p> 
<p>sysctl -p /etc/sysctl.d/k8s.conf出现报错：</p> 
<p>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory<br> sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory</p> 
<p><code>解决方法：</code><br> modprobe br_netfilter</p> 
<p><code>问题3：为什么开启net.bridge.bridge-nf-call-iptables内核参数？</code><br> 在centos下安装docker，执行docker info出现如下警告：<br> WARNING: bridge-nf-call-iptables is disabled<br> WARNING: bridge-nf-call-ip6tables is disabled</p> 
<p><code>解决办法：</code><br> vim /etc/sysctl.d/k8s.conf<br> net.bridge.bridge-nf-call-ip6tables = 1<br> net.bridge.bridge-nf-call-iptables = 1</p> 
<p><code>问题4：为什么要开启net.ipv4.ip_forward = 1参数？</code><br> kubeadm初始化k8s如果报错：<br> <img src="https://images2.imgbox.com/cb/fc/5UTJiZ6T_o.png" alt="在这里插入图片描述"></p> 
<p>就表示没有开启ip_forward，需要开启。</p> 
<p>net.ipv4.ip_forward是数据包转发：<br> 出于安全考虑，<code>Linux系统默认是禁止数据包转发的</code>。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。<br> 要让Linux系统<code>具有路由转发功能</code>，需要配置一个Linux的内核参数<code>net.ipv4.ip_forward</code>。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。<br> master1:</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># modprobe br_netfilter</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span>
 net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
 net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
 net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
 EOF
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># sysctl -p /etc/sysctl.d/k8s.conf</span>
</code></pre> 
<p>node1:</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># modprobe br_netfilter</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span>
 net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
 net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
 net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
 EOF
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># sysctl -p /etc/sysctl.d/k8s.conf</span>
</code></pre> 
<h3><a id="19repo_185"></a>1.9配置阿里云的repo源</h3> 
<p><code>配置国内安装docker和containerd的阿里云的repo源</code><br> master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 安装工具</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># yum install yum-utils -y</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#yum install yum-utils -y</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre> 
<h3><a id="110k8srepo_199"></a>1.10配置安装k8s组件需要的阿里云repo源</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#cat &gt;  /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span>
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
EOF
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#cat &gt;  /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span>
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
EOF
</code></pre> 
<h3><a id="111_220"></a>1.11配置时间同步</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 安装ntpdate命令</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install ntpdate</span>
<span class="token comment"># 跟网络时间做同步</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># ntpdate cn.pool.ntp.org</span>
<span class="token comment"># 把时间同步做成计划任务</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># crontab -e</span>
* *  * * * /usr/sbin/ntpdate   cn.pool.ntp.org
<span class="token comment"># 重启crond服务</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># service crond restart</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install ntpdate</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ntpdate cn.pool.ntp.org</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># crontab -e</span>
* *  * * * /usr/sbin/ntpdate   cn.pool.ntp.org
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># service crond restart</span>
</code></pre> 
<h3><a id="112_241"></a>1.12安装基础软件包</h3> 
<p>master1:</p> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> device-mapper-persistent-data lvm2 <span class="token function">wget</span> net-tools nfs-utils lrzsz gcc gcc-c++ <span class="token function">make</span> cmake libxml2-devel openssl-devel <span class="token function">curl</span> curl-devel <span class="token function">unzip</span> <span class="token function">sudo</span> ntp libaio-devel <span class="token function">wget</span> <span class="token function">vim</span> ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> device-mapper-persistent-data lvm2 <span class="token function">wget</span> net-tools nfs-utils lrzsz gcc gcc-c++ <span class="token function">make</span> cmake libxml2-devel openssl-devel <span class="token function">curl</span> curl-devel <span class="token function">unzip</span> <span class="token function">sudo</span> ntp libaio-devel <span class="token function">wget</span> <span class="token function">vim</span> ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm
</code></pre> 
<h2><a id="2containerd_250"></a>2.安装containerd服务</h2> 
<h3><a id="21containerd_251"></a>2.1安装containerd</h3> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 安装containerd</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install  containerd.io-1.6.6</span>
<span class="token comment"># 接下来生成 containerd 的配置文件</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#mkdir -p /etc/containerd</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#containerd config default &gt; /etc/containerd/config.toml</span>
<span class="token comment"># 修改配置文件</span>
打开/etc/containerd/config.toml
把SystemdCgroup <span class="token operator">=</span> false修改成SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>
把sandbox_image <span class="token operator">=</span> <span class="token string">"k8s.gcr.io/pause:3.6"</span>修改成sandbox_image<span class="token operator">=</span><span class="token string">"registry.aliyuncs.com/google_containers/pause:3.7"</span>
<span class="token comment"># 配置 containerd 开机启动，并启动 containerd</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#systemctl enable containerd  --now</span>
<span class="token comment"># 修改/etc/crictl.yaml文件，配置容器运行时</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment">#cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: <span class="token number">10</span>
debug: <span class="token boolean">false</span>
EOF
<span class="token comment"># 重启containerd服务</span>
<span class="token punctuation">[</span>root@xianchaomaster1 ~<span class="token punctuation">]</span><span class="token comment">#systemctl restart  containerd</span>

<span class="token comment"># 配置containerd镜像加速</span>
配置containerd镜像加速器，k8s所有节点均按照以下配置：
编辑vim /etc/containerd/config.toml文件
找到config_path <span class="token operator">=</span> <span class="token string">""</span>，修改成如下目录：
config_path <span class="token operator">=</span> <span class="token string">"/etc/containerd/certs.d"</span>
保存退出

<span class="token comment"># 创建并配置存放镜像加速器的目录</span>
<span class="token function">mkdir</span> /etc/containerd/certs.d/docker.io/ <span class="token parameter variable">-p</span>
<span class="token function">vim</span> /etc/containerd/certs.d/docker.io/hosts.toml
<span class="token comment">#写入如下内容：</span>
<span class="token punctuation">[</span>host.<span class="token string">"https://ag38j4ig.mirror.aliyuncs.com"</span>,host.<span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">]</span>
  capabilities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"pull"</span><span class="token punctuation">]</span>
<span class="token comment">#重启containerd服务</span>
重启containerd：
systemctl restart containerd
<span class="token comment"># docker也要安装，docker跟containerd不冲突，安装docker是为了能基于dockerfile构建镜像</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install  docker-ce </span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span>
<span class="token comment">#配置docker的镜像加速器</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt;&gt; /etc/docker/daemon.json &lt;&lt;EOF</span>
<span class="token punctuation">{<!-- --></span>
<span class="token string">"registry-mirrors"</span>:<span class="token punctuation">[</span><span class="token string">"https://ag38j4ig.mirror.aliyuncs.com"</span>,<span class="token string">"https://registry.docker-cn.com"</span>,<span class="token string">"https://docker.mirrors.ustc.edu.cn"</span>,<span class="token string">"https://dockerhub.azk8s.cn"</span>,<span class="token string">"http://hub-mirror.c.163.com"</span><span class="token punctuation">]</span>,
<span class="token string">"exec-opts"</span>:<span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
EOF
<span class="token comment"># 重启docker服务</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl  restart docker</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install  containerd.io-1.6.6</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#mkdir -p /etc/containerd</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#containerd config default &gt; /etc/containerd/config.toml</span>
打开/etc/containerd/config.toml
把SystemdCgroup <span class="token operator">=</span> false修改成SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>
把sandbox_image <span class="token operator">=</span> <span class="token string">"k8s.gcr.io/pause:3.6"</span>修改成sandbox_image<span class="token operator">=</span><span class="token string">"registry.aliyuncs.com/google_containers/pause:3.7"</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#systemctl enable containerd  --now</span>

<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: <span class="token number">10</span>
debug: <span class="token boolean">false</span>
EOF
<span class="token comment"># 重启containerd服务</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment">#systemctl restart  containerd</span>

<span class="token comment"># 配置containerd镜像加速</span>
配置containerd镜像加速器，k8s所有节点均按照以下配置：
编辑vim /etc/containerd/config.toml文件
找到config_path <span class="token operator">=</span> <span class="token string">""</span>，修改成如下目录：
config_path <span class="token operator">=</span> <span class="token string">"/etc/containerd/certs.d"</span>
保存退出

<span class="token comment"># 创建并配置存放镜像加速器的目录</span>
<span class="token function">mkdir</span> /etc/containerd/certs.d/docker.io/ <span class="token parameter variable">-p</span>
<span class="token function">vim</span> /etc/containerd/certs.d/docker.io/hosts.toml
<span class="token comment">#写入如下内容：</span>
<span class="token punctuation">[</span>host.<span class="token string">"https://ag38j4ig.mirror.aliyuncs.com"</span>,host.<span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">]</span>
  capabilities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"pull"</span><span class="token punctuation">]</span>
<span class="token comment">#重启containerd服务</span>
重启containerd：
systemctl restart containerd

<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install  docker-ce </span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span>

<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt;&gt; /etc/docker/daemon.json &lt;&lt;EOF</span>
<span class="token punctuation">{<!-- --></span>
<span class="token string">"registry-mirrors"</span>:<span class="token punctuation">[</span><span class="token string">"https://ag38j4ig.mirror.aliyuncs.com"</span>,<span class="token string">"https://registry.docker-cn.com"</span>,<span class="token string">"https://docker.mirrors.ustc.edu.cn"</span>,<span class="token string">"https://dockerhub.azk8s.cn"</span>,<span class="token string">"http://hub-mirror.c.163.com"</span><span class="token punctuation">]</span>,
<span class="token string">"exec-opts"</span>:<span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
EOF
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl  restart docker</span>
</code></pre> 
<h2><a id="3k8s_352"></a>3.安装k8s需要的软件包</h2> 
<p><code>kubeadm</code>: kubeadm是一个工具，用来<strong>初始化k8s集群</strong>的<br> <code>kubelet</code>: 安装在集群所有节点上，用于启动Pod的，kubeadm安装k8s，k8s控制节点和工作节点的组件，都是基于pod运行的，只要pod启动，就需要kubelet<br> <code>kubectl</code>: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</p> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y kubelet-1.26.0 kubeadm-1.26.0 kubectl-1.26.0</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable kubelet</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y kubelet-1.26.0 kubeadm-1.26.0 kubectl-1.26.0</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable kubelet</span>
</code></pre> 
<h2><a id="4kubeadmk8s_367"></a>4.kubeadm初始化k8s网络集群</h2> 
<p>master1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 设置容器运行时</span>
 <span class="token punctuation">[</span>root@master1~<span class="token punctuation">]</span><span class="token comment"># crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span>
</code></pre> 
<p>node1</p> 
<pre><code class="prism language-shell"><span class="token comment"># 设置容器运行时</span>
 <span class="token punctuation">[</span>root@node1~<span class="token punctuation">]</span><span class="token comment"># crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span>
</code></pre> 
<p><code>只在master1节点运行</code></p> 
<pre><code class="prism language-shell"><span class="token comment"># 初始化k8s集群</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm config print init-defaults &gt; kubeadm.yaml</span>

根据我们自己的需求修改配置，比如修改 imageRepository 的值，kube-proxy 的模式为 ipvs，需要注意的是由于我们使用的containerd作为运行时，所以在初始化节点的时候需要指定cgroupDriver为systemd

kubeadm.yaml配置文件如下：

apiVersion: kubeadm.k8s.io/v1beta3
。。。
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: <span class="token number">192.168</span>.40.180 <span class="token comment">#控制节点的ip</span>
  bindPort: <span class="token number">6443</span>
nodeRegistration:
  criSocket: unix:///run/containerd/containerd.sock  <span class="token comment">#指定containerd容器运行时</span>
  imagePullPolicy: IfNotPresent
  name: master1 <span class="token comment">#控制节点主机名</span>
  taints: null
---
apiVersion: kubeadm.k8s.io/v1beta3
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
dns: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
<span class="token comment"># 指定阿里云镜像仓库地址</span>
kind: ClusterConfiguration
kubernetesVersion: <span class="token number">1.26</span>.0 <span class="token comment">#k8s版本</span>
networking:
  dnsDomain: cluster.local
  podSubnet: <span class="token number">10.244</span>.0.0/16 <span class="token comment">#指定pod网段， 需要新增加这个</span>
  serviceSubnet: <span class="token number">10.96</span>.0.0/12 <span class="token comment">#指定Service网段</span>
scheduler: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token comment">#在文件最后，插入以下内容，（复制时，要带着---）：</span>
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
</code></pre> 
<p><code>特别提醒</code>：–image-repository registry.aliyuncs.com/google_containers为保证拉取镜像不到国外站点拉取，手动指定仓库地址为registry.aliyuncs.com/google_containers。kubeadm默认从k8s.gcr.io拉取镜像。 我们本地有导入到的离线镜像，所以会优先使用本地的镜像。</p> 
<p><code>mode</code>: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，但是iptables效率低，所以我们生产环境建议开启ipvs，阿里云和华为云托管的K8s，也提供ipvs模式</p> 
<h3><a id="41kubeadmyamlk8s_430"></a>4.1基于kubeadm.yaml初始化k8s集群</h3> 
<p><code>将提前下载好的镜像上传到master1和node1上</code><br> <strong>备注：k8s_1.26.0.tar.gz这个文件如何来的？</strong><br> 这个文件把安装k8s需要的镜像都集成好了，这个是我第一次安装1.26.0这个版本，获取到对应的镜像，通过ctr images export 这个命令把镜像输出到k8s_1.26.0.tar.gz文件，如果大家安装其他版本，那就不需要实现解压镜像，可以默认从网络拉取镜像即可。<br> ctr是containerd自带的工具，有命名空间的概念，若是k8s相关的镜像，都默认在k8s.io这个命名空间，所以导入镜像时需要指定命令空间为k8s.io<br> #使用ctr命令指定命名空间导入镜像</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># ctr -n=k8s.io images import k8s_1.26.0.tar.gz</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ctr -n=k8s.io images import k8s_1.26.0.tar.gz</span>
</code></pre> 
<p><code>在master1节点运行</code></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification</span>
</code></pre> 
<p>显示如下，说明安装成功<br> <img src="https://images2.imgbox.com/b8/29/8ROCv7CF_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell"><span class="token comment">#配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对k8s集群进行管理</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p $HOME/.kube</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>

<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
AME      STATUS     ROLES           AGE   VERSION
master1   NotReady   control-plane   13m   v1.26.0
</code></pre> 
<h2><a id="5_456"></a>5.添加第一次工作节点</h2> 
<pre><code class="prism language-shell">在master1上查看加入节点的命令：
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm token create --print-join-command</span>

显示如下：                                                                    
kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.40.180:6443 <span class="token parameter variable">--token</span> atdvq3.vtad9galyly4x5pv --discovery-token-ca-cert-hash sha256:dfebbd9a9373dfeb5d7a28835d839646a0a10381086f084de5693e938609b2cf 

把node1加入k8s集群：
<span class="token punctuation">[</span>root@node1~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 192.168.40.180:6443 --token atdvq3.vtad9galyly4x5pv --discovery-token-ca-cert-hash sha256:dfebbd9a9373dfeb5d7a28835d839646a0a10381086f084de5693e938609b2cf  --ignore-preflight-errors=SystemVerification</span>
</code></pre> 
<p>看到下面说明node1节点已经加入到集群了,充当工作节点<br> <img src="https://images2.imgbox.com/09/19/MeNePWzK_o.png" alt="在这里插入图片描述"><br> 在master1节点上看集群的情况<br> <img src="https://images2.imgbox.com/c8/ee/9MtaO0FF_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="6kubernetescalico_471"></a>6.安装kubernetes网络组件-calico</h2> 
<p>把安装calico需要的镜像calico.tar.gz传到master1和node1节点，手动解压：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># ctr -n=k8s.io images import calico.tar.gz</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ctr -n=k8s.io images import calico.tar.gz</span>
</code></pre> 
<p>上传calico.yaml到master1上，使用yaml文件安装calico 网络插件 。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f  calico.yaml</span>
</code></pre> 
<p><code>注：在线下载配置文件地址是： https://docs.projectcalico.org/manifests/calico.yaml 。</code></p> 
<p><strong>看到如下status都是ready，表明网络安装正常</strong><br> <img src="https://images2.imgbox.com/57/c8/oedgI7p2_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="61calico_486"></a>6.1calico网络插件配置文件说明</h3> 
<p>1、Daemonset配置<br> ……<br> containers:<br> # Runs calico-node container on each Kubernetes node. This<br> # container programs network policy and routes on each<br> # host.<br> - name: calico-node<br> image: docker.io/calico/node:v3.18.0<br> ……<br> env:<br> # Use Kubernetes API as the backing datastore.<br> - name: DATASTORE_TYPE<br> value: “kubernetes”<br> # Cluster type to identify the deployment type<br> - name: CLUSTER_TYPE<br> value: “k8s,bgp”<br> # Auto-detect the BGP IP address.<br> - name: IP<br> value: “autodetect”<br> #pod网段<br> - name: CALICO_IPV4POOL_CIDR<br> value: “10.244.0.0/16”<br> # Enable IPIP<br> - name: CALICO_IPV4POOL_IPIP<br> value: “Always”</p> 
<p>IP_AUTODETECTION_METHOD：获取Node IP地址的方式，默认使用第1个网络接口的IP地址，对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如"interface=eth.*"表示选择名称以eth开头的网卡的IP地址。</p> 
<ul><li>name: IP_AUTODETECTION_METHOD<br> value: “interface=ens33”</li></ul> 
<h2><a id="7k8spod_517"></a>7.测试在k8s创建pod是否可以正常访问网络</h2> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run busybox --image docker.io/library/busybox:1.28  --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- sh</span>


/ <span class="token comment"># ping www.baidu.com</span>
PING www.baidu.com <span class="token punctuation">(</span><span class="token number">39.156</span>.66.18<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">39.156</span>.66.18: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">127</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">39.3</span> ms
<span class="token comment">#通过上面可以看到能访问网络，说明calico网络插件已经被正常安装了</span>

/ <span class="token comment"># nslookup kubernetes.default.svc.cluster.local</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes.default.svc.cluster.local
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.1 kubernetes.default.svc.cluster.local

/ <span class="token comment"># exit #退出pod</span>

<span class="token number">10.96</span>.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。
解析内部Service的名称，是通过coreDNS去解析的。
</code></pre> 
<h2><a id="8ctrcrictl_539"></a>8.ctr和crictl的区别</h2> 
<p><strong>ctr和crictl区别</strong></p> 
<p>背景：在部署k8s的过程中，经常要对镜像进行操作（拉取、删除、查看等）</p> 
<p><strong>问题：使用过程中会发现ctr和crictl有很多相同功能，也有些不同，那区别到底在哪里？</strong></p> 
<p>说明：</p> 
<ol><li> <p>ctr是containerd自带的CLI命令行工具，crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互；</p> </li><li> <p>ctr和crictl命令具体区别如下，也可以–help查看。crictl缺少对具体镜像的管理能力，可能是k8s层面镜像管理可以由用户自行控制，能配置pod里面容器的统一镜像仓库，镜像的管理可以有habor等插件进行处理。<br> <img src="https://images2.imgbox.com/a4/df/FXWOs2oX_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h2><a id="9k8s_553"></a>9.扩容k8s集群，添加第二个工作节点</h2> 
<p><strong>添加node2节点</strong><br> <code>参照node1节点进行操作</code></p> 
<h2><a id="10k8s_556"></a>10.扩容k8s集群，添加第二个管理节点</h2> 
<p><code>参照上述1,2,3操作</code><br> <strong>将master2加入到k8s集群</strong></p> 
<pre><code class="prism language-shell"><span class="token comment"># 把master1节点的证书拷贝到master2上</span>
<span class="token comment"># 在master2创建证书存放目录:</span>
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment"># cd /root &amp;&amp; mkdir -p /etc/kubernetes/pki/etcd &amp;&amp;mkdir -p ~/.kube/</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/ca.crt  master2:/etc/kubernetes/pki/</span>
ca.crt                                                                                   <span class="token number">100</span>% <span class="token number">1099</span>   <span class="token number">869</span>.2KB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/ca.key  master2:/etc/kubernetes/pki/</span>
ca.key                                                                                   <span class="token number">100</span>% <span class="token number">1679</span>     <span class="token number">1</span>.5MB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/sa.key  master2:/etc/kubernetes/pki/</span>
sa.key                                                                                   <span class="token number">100</span>% <span class="token number">1679</span>     <span class="token number">1</span>.6MB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/sa.pub  master2:/etc/kubernetes/pki/</span>
sa.pub                                                                                   <span class="token number">100</span>%  <span class="token number">451</span>   <span class="token number">435</span>.4KB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/front-proxy-ca.crt  master2:/etc/kubernetes/pki/</span>
front-proxy-ca.crt                                                                       <span class="token number">100</span>% <span class="token number">1115</span>   <span class="token number">790</span>.8KB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/front-proxy-ca.key  master2:/etc/kubernetes/pki/</span>
front-proxy-ca.key                                                                       <span class="token number">100</span>% <span class="token number">1675</span>     <span class="token number">1</span>.5MB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/etcd/ca.crt  master2:/etc/kubernetes/pki/etcd</span>
ca.crt                                                                                   <span class="token number">100</span>% <span class="token number">1086</span>     <span class="token number">1</span>.2MB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/kubernetes/pki/etcd/ca.key  master2:/etc/kubernetes/pki/etcd</span>
ca.key                                                                                   <span class="token number">100</span>% <span class="token number">1679</span>     <span class="token number">1</span>.2MB/s   00:00    
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre> 
<pre><code class="prism language-shell">把安装calico需要的镜像calico.tar.gz传到master2，手动解压：
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment"># ctr -n=k8s.io images import k8s_1.26.0.tar.gz</span>
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment"># ctr -n=k8s.io images import calico.tar.gz</span>
</code></pre> 
<pre><code class="prism language-shell">检查 kubeadm-config ConfigMap 是否正确配置了 controlPlaneEndpoint。可以使用 kubectl 命令获取 kubeadm-config ConfigMap 的信息：
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl -n kube-system edit cm kubeadm-config -o yaml</span>

<span class="token comment"># apiVersion下面添加如下字段：</span>
controlPlaneEndpoint: <span class="token string">"192.168.40.180:6443"</span>

<span class="token comment"># 重启kubelet：</span>
<span class="token punctuation">[</span>root@master1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 在master1上查看加入节点的命令：</span>
<span class="token punctuation">[</span>root@xianchaomaster1 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm token create --print-join-command</span>
显示如下：
 kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.40.180:6443 <span class="token parameter variable">--token</span> 6fitex.qdr7fkyloe7mukrj --discovery-token-ca-cert-hash sha256:dfebbd9a9373dfeb5d7a28835d839646a0a10381086f084de5693e938609b2cf
<span class="token comment"># 加入k8s集群</span>
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 192.168.40.180:6443 --token 6fitex.qdr7fkyloe7mukrj --discovery-token-ca-cert-hash sha256:dfebbd9a9373dfeb5d7a28835d839646a0a10381086f084de5693e938609b2cf   --control-plane --ignore-preflight-errors=SystemVerification</span>
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment">#         mkdir -p $HOME/.kube</span>
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment">#         sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment">#         sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</code></pre> 
<p>在master2上查看集群情况</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master2 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  nodes</span>
NAME      STATUS   ROLES           AGE    VERSION
master1   Ready    control-plane   129m   v1.26.0
master2   Ready    control-plane   7m     v1.26.0
node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          114m   v1.26.0
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e96344e714cd7535ed4d747fae04b997/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何利用EXCEL批量插入图片</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f3cfd22c6eec4be7f26c40584c7c2296/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C#高级--设计模式（七个原则）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>