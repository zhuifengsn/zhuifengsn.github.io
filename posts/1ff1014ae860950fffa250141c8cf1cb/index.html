<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>监督机器学习——基于手写数字数据集的图像分类 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="监督机器学习——基于手写数字数据集的图像分类" />
<meta property="og:description" content="监督机器学习——基于手写数字数据集的图像分类 MNIST手写数据集介绍 输入数据集是 MNIST，这是机器学习中的一个经典数据集，由大小为 28×28 的手写数字的灰度图像组成。原始训练数据集包含 60000 个样本（手写数字图像和标签，用于训练机器学习模型），测试数据集包含 10000 个样本（手写数字图像和标签作为基本真值，用于测试所学习模型的准确性）。给定一组手写数字和图像及其标签（0～9），目标是学习一种机器学习模型，该模型可以自动识别不可见图像中的数字，并为图像分配一个标签0～9）。具体步骤如下。
（1）使用训练数据集训练一些监督机器学习（多类分类）模型（分类器）。
（2）它们将用于预测来自测试数据集的图像的标签。
（3）将预测的标签与基本真值标签进行比较，以评估分类器的性能。
训练、预测和评估基本分类模型的步骤如下图所示。当在训练数据集上训练更多不同的模型（可能是使用不同的算法，或者使用相同的算法但算法具有不同的超参数值）时，为了选择最好的模型，需要第三个数据集，也就是验证数据集（训练数据集分为两部分，一部分用于训练，另一部分用于验证），用于模型选择和超参调优。
同样，先导入所需的库，如下面的代码所示：
import matplotlib from sklearn.naive_bayes import MultinomialNB import pandas as pd import seaborn as sn from sklearn import metrics from sklearn.ensemble import RandomForestClassifier from sklearn.svm import SVC import time from sklearn.neighbors import BallTree import gzip, os, sys import numpy as np import urllib.request as ureq from scipy.stats import multivariate_normal from keras.datasets import mnist from keras.utils import to_categorical from sklearn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/1ff1014ae860950fffa250141c8cf1cb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-04T19:48:50+08:00" />
<meta property="article:modified_time" content="2022-09-04T19:48:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">监督机器学习——基于手写数字数据集的图像分类</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>监督机器学习——基于手写数字数据集的图像分类</h2> 
<h3><a id="MNIST_1"></a>MNIST手写数据集介绍</h3> 
<p>输入数据集是 MNIST，这是机器学习中的一个经典数据集，由大小为 28×28 的手写数字的灰度图像组成。原始训练数据集包含 60000 个样本（手写数字图像和标签，用于训练机器学习模型），测试数据集包含 10000 个样本（手写数字图像和标签作为基本真值，用于测试所学习模型的准确性）。给定一组手写数字和图像及其标签（0～9），目标是学习一种机器学习模型，该模型可以自动识别不可见图像中的数字，并为图像分配一个标签0～9）。具体步骤如下。<br> （1）使用训练数据集训练一些监督机器学习（多类分类）模型（分类器）。<br> （2）它们将用于预测来自测试数据集的图像的标签。<br> （3）将预测的标签与基本真值标签进行比较，以评估分类器的性能。<br> 训练、预测和评估基本分类模型的步骤如下图所示。当在训练数据集上训练更多不同的模型（可能是使用不同的算法，或者使用相同的算法但算法具有不同的超参数值）时，为了选择最好的模型，需要第三个数据集，也就是验证数据集（训练数据集分为两部分，一部分用于训练，另一部分用于验证），用于模型选择和超参调优。<br> <img src="https://images2.imgbox.com/66/d4/IxzxHtQE_o.jpg" alt="在这里插入图片描述"></p> 
<p>同样，先导入所需的库，如下面的代码所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>naive_bayes <span class="token keyword">import</span> MultinomialNB
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd 
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sn 
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>svm <span class="token keyword">import</span> SVC 
<span class="token keyword">import</span> time 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> BallTree 
<span class="token keyword">import</span> gzip<span class="token punctuation">,</span> os<span class="token punctuation">,</span> sys 
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np 
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">as</span> ureq
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>stats <span class="token keyword">import</span> multivariate_normal
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> mnist
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>utils <span class="token keyword">import</span> to_categorical
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> fetch_openml
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> fetch_openml
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span>  StandardScaler
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>utils <span class="token keyword">import</span> check_random_state
</code></pre> 
<h3><a id="_MNIST_36"></a>下载 MNIST（手写数字）数据集</h3> 
<p>从下载 MNIST 数据集开始。如下代码运用爬虫方法下载训练数据集和测试数据集：</p> 
<pre><code class="prism language-python"><span class="token comment"># Function that downloads a specified MNIST data file from Yann Le Cun's website </span>
<span class="token keyword">def</span> <span class="token function">download</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token operator">=</span><span class="token string">'http://yann.lecun.com/exdb/mnist/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Downloading %s"</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span> 
     ureq<span class="token punctuation">.</span>urlretrieve<span class="token punctuation">(</span>source <span class="token operator">+</span> filename<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> 
<span class="token comment"># Invokes download() if necessary, then reads in images </span>
<span class="token keyword">def</span> <span class="token function">load_mnist_images</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span> 
         download<span class="token punctuation">(</span>filename<span class="token punctuation">)</span> 
     <span class="token keyword">with</span> gzip<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span> 
         data <span class="token operator">=</span> np<span class="token punctuation">.</span>frombuffer<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span> 
     data <span class="token operator">=</span> data<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">784</span><span class="token punctuation">)</span> 
     <span class="token keyword">return</span> data 
<span class="token keyword">def</span> <span class="token function">load_mnist_labels</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span> 
         download<span class="token punctuation">(</span>filename<span class="token punctuation">)</span> 
     <span class="token keyword">with</span> gzip<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span> 
         data <span class="token operator">=</span> np<span class="token punctuation">.</span>frombuffer<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span> 
     <span class="token keyword">return</span> data 
<span class="token comment">## Load the training set </span>
train_data <span class="token operator">=</span> load_mnist_images<span class="token punctuation">(</span><span class="token string">'train-images-idx3-ubyte.gz'</span><span class="token punctuation">)</span> 
train_labels <span class="token operator">=</span> load_mnist_labels<span class="token punctuation">(</span><span class="token string">'train-labels-idx1-ubyte.gz'</span><span class="token punctuation">)</span> 
<span class="token comment">## Load the testing set </span>
test_data <span class="token operator">=</span> load_mnist_images<span class="token punctuation">(</span><span class="token string">'t10k-images-idx3-ubyte.gz'</span><span class="token punctuation">)</span> 
test_labels <span class="token operator">=</span> load_mnist_labels<span class="token punctuation">(</span><span class="token string">'t10k-labels-idx1-ubyte.gz'</span><span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span>train_data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> 
<span class="token comment"># (60000, 784) ## 60k 28x28 handwritten digits </span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test_data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> 
<span class="token comment"># (10000, 784) ## 10k 2bx28 handwritten digits</span>
</code></pre> 
<h3><a id="_69"></a>可视化数据集</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">show_digit</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     pylab<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span> 
     pylab<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>pylab<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span> 
     pylab<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Label '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>label <span class="token punctuation">)</span><span class="token punctuation">)</span>
pylab<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
     pylab<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     show_digit<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> 
     pylab<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span> 
pylab<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">import</span> time 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> BallTree 
<span class="token comment">## Build nearest neighbor structure on training data </span>
t_before <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> 

</code></pre> 
<p>在训练数据集上训练的 KNN 分类器对这个未知的测试数据集的标签进行预测，并将预测的标签与基本真值标签进行比较，以评价分类器的准确性。<br> <img src="https://images2.imgbox.com/05/c2/rCVeXG6C_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_KNN_SVM__MNIST__90"></a>通过训练 KNN、高斯贝叶斯和 SVM 模型对 MNIST 数据集分类</h3> 
<p>scikit-learn 库函数实现以下分类器：k 最近邻分类算法、朴树贝叶斯分类器（生成模型）、随机森林、支持向量机分类器。从 k 最近邻分类器开始介绍。</p> 
<h4><a id="1___k__92"></a>1 k 最近邻分类器</h4> 
<p>该分类器用于接收手写数字图像，并使用一种称为最近邻分类器的特别简单的策略输出标签（0～9）。预测看不见的测试数字图像的方法是非常简<br> 单的。首先，只需要从训练数据集中找到离测试图像最近的 k 个实例；其次，只需要简单地使用多数投票来计算测试图像的标签，也就是说，来自 k 个最近的训练数据点的大部分数据点的标签将被分配给测试图像（任意断开连接）。<br> （1）计算欧氏距离平方。欲计算数据集中的最近邻，必须计算数据点之间的距离。自然距离函数是欧氏距离，对于两个向量 x, y∈Rd,其欧氏距离定义为：<br> <img src="https://images2.imgbox.com/96/81/TD3VlJUJ_o.jpg" alt="在这里插入图片描述"></p> 
<p>通常省略平方根，只计算欧氏距离的平方。对于最近邻计算，这两个是等价的：对于 3 个向量 x, y, z∈Rd，当且仅当||x − y||2 ≤ ||x − z||2时，才有||x − y|| ≤ ||x − z||成立。因此，现在只需要计算欧氏距离的平方。<br> （2）计算最近邻。k 最近邻的一个简单实现就是扫描每个测试图像的每个训练图像。以这种方式实施的最近邻分类需要遍历训练集才能对单个点进行分类。如果在 Rd 中有 N个训练点，时间花费将为 O (Nd)，这是非常缓慢的。幸运的是，如果愿意花一些时间对训练集进行预处理，就有更快的方法来执行最近邻查找。scikit-learn 库有两个有用的最近邻数据结构的快速实现：球树和 k-d 树。如下代码展示了如何在训练时创建一个球树数据结构，然后在测试 1 − NN（k = 1）时将其用于快速最近邻计算：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> BallTree 
<span class="token comment">## Build nearest neighbor structure on training data </span>
t_before <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> 
ball_tree <span class="token operator">=</span> BallTree<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span> 
t_after <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">## Compute training time </span>
t_training <span class="token operator">=</span> t_after <span class="token operator">-</span> t_before 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Time to build data structure (seconds): "</span><span class="token punctuation">,</span> t_training<span class="token punctuation">)</span> 
<span class="token comment">## Get nearest neighbor predictions on testing data </span>
t_before <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> 
test_neighbors <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>ball_tree<span class="token punctuation">.</span>query<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>return_distance<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment"># test_predictions = train_labels[test_neighbors] </span>
t_after <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">## Compute testing time </span>
t_testing <span class="token operator">=</span> t_after <span class="token operator">-</span> t_before 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Time to classify test set (seconds): "</span><span class="token punctuation">,</span> t_testing<span class="token punctuation">)</span> 
<span class="token comment"># Time to build data structure (seconds): 20.65474772453308 </span>
<span class="token comment"># Time to classify test set (seconds): 532.3929145336151</span>
运行结果如下
</code></pre> 
<p><img src="https://images2.imgbox.com/80/a3/qnHcNQ1o_o.jpg" alt="在这里插入图片描述"><br> （3）评估分类器的性能。接下来将评估分类器在测试数据集上的性能。如下代码展示了如何实现这一点：</p> 
<pre><code class="prism language-python">font1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">,</span>
<span class="token string">'weight'</span><span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
<span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
<span class="token comment"># fontdict = {'family':'Times New Roman', 'size':19}</span>
cm <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>test_labels<span class="token punctuation">,</span>test_predictions<span class="token punctuation">)</span> 
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>font<span class="token operator">=</span><span class="token string">"Times New Roman"</span><span class="token punctuation">)</span><span class="token comment">#for label size </span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>dpi<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/KNN"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
<span class="token comment"># plt.rc('font',family='Times New Roman',size=12)</span>
t_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">==</span> test_labels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">)</span> 
t_accuracy 
</code></pre> 
<p>运行上述代码，输出混淆矩阵，如图 所示。可以看到，虽然训练数据集的整体准确率达到 96.9%，但仍存在一些错误分类的测试图像。当 K-NN 预测标签和 True 标签均为 0 时，预测成功；当 K-NN 预测标签为 2，True 标签为 3 时，预测失败.<br> <img src="https://images2.imgbox.com/61/e2/qQRpQXN7_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="2_144"></a>2．贝叶斯分类器（高斯生成模型）</h4> 
<p>正如我们在上一小节所看到的，K-NN 分类器对手写数字 MNIST 数据集的测试错误率为 3.09%。现在，我们将构建一个高斯生成模型，使其几乎可以达到同样的效果，但明显更快、更紧凑。同样，必须像上次一样首先加载 MNIST 训练数据集和测试数据集，然后将高斯生成模型拟合到训练数据集中。<br> （1）训练生成模型—计算高斯参数的最大似然估计。下面定义了一个函数<br> fit_generative_model()，它接收一个训练集（x 数据和 y 标签）作为输入，并将高斯生成模型与之匹配。对于每个标签 j = 0,1,…,9，返回以下几种生成模型的参数。<br> • πj：标签的频率（即优先的）；<br> • μj：784 维均值向量；<br> • ∑j：784 × 784 协方差矩阵。<br> 这意味着π是 10 × 1、μ是 10 × 784、∑是 10 × 784 × 784 的矩阵。最大似然估计（Maximum Likelihood Estimation，MLE）为经验估计，如下图 所示。<br> <img src="https://images2.imgbox.com/17/77/N4WkS571_o.jpg" alt="在这里插入图片描述"><br> 经验协方差很可能是奇异的（或接近奇异），这意味着不能用它们来进行计算，因此对这些矩阵进行正则化是很重要的。这样做的标准方法是加上 c*I，其中 c 是一个常数，I是 784 维单位矩阵（换言之，先计算经验协方差，然后将它们的对角元素增加某个常数 c）。对于任何 c &gt; 0，无论 c 多么小，这样修改可以确保产生非奇异的协方差矩阵。现在c 成为一个（正则化）参数，适当地设置它，可以提高模型的性能。为此，应该选择一<br> 个好的 c 值。然而至关重要的是需要单独使用训练集来完成，通过将部分训练集作为验证集，或者使用某种交叉验证。这将作为练习留给读者完成。需要特别注意的是，display_char()函数将用于可视化前 3 位数字的高斯均值，如下面的代码所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">display_char</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span> 
     plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>，
     plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fit_generative_model</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     k <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment"># labels 0,1,...,k-1 </span>
     d <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># number of features </span>
     mu <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     sigma <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>d<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     pi <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>k<span class="token punctuation">)</span> 
     c <span class="token operator">=</span> <span class="token number">3500</span> <span class="token comment">#10000 #1000 #100 #10 #0.1 #1e9 </span>
     <span class="token keyword">for</span> label <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> 
         indices <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">==</span> label<span class="token punctuation">)</span> 
         pi<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> 
         mu<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>x<span class="token punctuation">[</span>indices<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         sigma<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>cov<span class="token punctuation">(</span>x<span class="token punctuation">[</span>indices<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rowvar<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> c<span class="token operator">*</span>np<span class="token punctuation">.</span>eye<span class="token punctuation">(</span>d<span class="token punctuation">)</span> 
     <span class="token keyword">return</span> mu<span class="token punctuation">,</span> sigma<span class="token punctuation">,</span> pi 
mu<span class="token punctuation">,</span> sigma<span class="token punctuation">,</span> pi <span class="token operator">=</span> fit_generative_model<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span> 
display_char<span class="token punctuation">(</span>mu<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
display_char<span class="token punctuation">(</span>mu<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
display_char<span class="token punctuation">(</span>mu<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
</code></pre> 
<p>运行上述代码，输出前 3 位数字的均值的最大似然估计，如下图所示。<br> <img src="https://images2.imgbox.com/af/c5/wAPlw6hR_o.jpg" alt="在这里插入图片描述"><br> （2）计算后验概率，以对测试数据进行预测和模型评价。为了预测新图像的标签 x，需要找到标签 j，其后验概率 Pr(y = j|x)最大。可以用贝叶斯规则计算，如图。<br> <img src="https://images2.imgbox.com/63/eb/zeydBIrS_o.jpg" alt="在这里插入图片描述"><br> 如下代码展示了如何使用生成模型预测测试数据集的标签，以及如何计算模型在测试数据集上产生错误的数量。可以看出，测试数据集的准确率为 95.6%，略低于 K-NN 分类器。</p> 
<pre><code class="prism language-python">k <span class="token operator">=</span> <span class="token number">10</span> 
score <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> label <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     rv <span class="token operator">=</span> multivariate_normal<span class="token punctuation">(</span>mean<span class="token operator">=</span>mu<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> cov<span class="token operator">=</span>sigma<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span> 
     <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
         score<span class="token punctuation">[</span>i<span class="token punctuation">,</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pi<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> rv<span class="token punctuation">.</span>logpdf<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
test_predictions <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>score<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token comment"># Finally, tally up score </span>
errors <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">!=</span> test_labels<span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The generative model makes "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" errors out of 10000"</span><span class="token punctuation">)</span> 
<span class="token comment"># The generative model makes 438 errors out of 10000 </span>
t_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">==</span> test_labels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span> 
t_accuracy 
<span class="token comment"># 0.95620000000000005 </span>
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">)</span> 
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>font<span class="token operator">=</span><span class="token string">"Times New Roman"</span><span class="token punctuation">)</span><span class="token comment">#for label size </span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/Bayes"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3SVM__206"></a>3．SVM 分类器</h4> 
<p>本节将使用 MNIST 训练数据集训练（多类）支持向量机（SVM）分类器，然后用它预测来自 MNIST 测试数据集的图像的标签。支持向量机是一种非常复杂的二值分类器，它使用二次规划来最大化分离超平面之间的边界。利用 1∶全部或 1∶1 技术，将二值 SVM 分类器扩展到处理多类分类问题,svm分类原理见下图。使用 scikit-learn 的实现 SVC()，后者具有多项式核（degree 为 2），利用训练数据集来拟合（训练）软边缘（核化）SVM 分类器，然后用 score()函数预测测试图像的标签。如下代码展示了如何使用 MNIST 数据集训练、预测和评估 SVM 分类器。可以看到，使用该分类器在测试数据集上所得到的准确率提高到了 98%。<br> <img src="https://images2.imgbox.com/c6/92/DaY0gIEB_o.jpg" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">clf <span class="token operator">=</span> SVC<span class="token punctuation">(</span>C<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> kernel<span class="token operator">=</span><span class="token string">'poly'</span><span class="token punctuation">,</span> degree<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> 
clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_labels<span class="token punctuation">)</span> 
test_predictions <span class="token operator">=</span> clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span> 
cm <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>test_labels<span class="token punctuation">,</span>test_predictions<span class="token punctuation">)</span> 
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">)</span> 
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/SVC"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
t_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">==</span> test_labels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span> 
t_accuracy 
</code></pre> 
<h4><a id="3__223"></a>3． 随机森林分类器</h4> 
<ol><li>简介:<br> 随机森林就是通过集成学习的Bagging思想将多棵树集成的一种算法：它的基本单元就是决策树。随机森林的名称中有两个关键词，一个是“随机”，一个就是“森林”。“森林”很好理解，一棵叫做树，那么成百上千棵就可以叫做森林了，其实这也是随机森林的主要思想–集成思想的体现。“随机”的含义我们会在下面讲到。我们要将一个输入样本进行分类，就需要将它输入到每棵树中进行分类。将若干个弱分类器的分类结果进行投票选择，从而组成一个强分类器，这就是随机森林bagging的思想：<br> <img src="https://images2.imgbox.com/67/6e/LJ14qPki_o.jpg" alt="在这里插入图片描述"><br> 每棵树的按照如下规则生成：</li></ol> 
<p>（1）如果训练集大小为N，对于每棵树而言，随机且有放回地从训练集中的抽取N个训练样本（就是bootstrap sample方法, 拔靴法采样）作为该树的训练集；从这里我们可以知道：每棵树的训练集都是不同的，而且里面包含重复的训练样本。</p> 
<p>（2）如果存在M个特征，则在每个节点分裂的时候，从M中随机选择m个特征维度（m &lt;&lt; M），使用这些m个特征维度中最佳特征(最大化信息增益)来分割节点。在森林生长期间，m的值保持不变。</p> 
<p>一开始我们提到的随机森林中的“随机”就是指的这里的两个随机性。两个随机性的引入对随机森林的分类性能至关重要。由于它们的引入，使得随机森林不容易陷入过拟合，并且具有很好得抗噪能力（比如：对缺省值不敏感）。<br> 随机森林分类效果（错误率）与两个因素有关：1，森林中任意两棵树的相关性：相关性越大，错误率越大；（弱分类器应该good且different）2，森林中每棵树的分类能力：每棵树的分类能力越强，整个森林的错误率越低。（弱分类器应该good且different）</p> 
<p>减小特征选择个数m，树的相关性和分类能力也会相应的降低；增大m，两者也会随之增大。所以关键问题是如何选择最优的m，这也是随机森林的一个重要参数。</p> 
<ol start="2"><li>OOB (袋外错误率)<br> 上面我们提到，构建随机森林的关键问题就是如何选择最优的特征数m这个参数，要解决这个问题主要依据计算袋外错误率OOB error（out-of-bag error）。</li></ol> 
<p>随机森林有一个重要的优点就是，没有必要对它进行交叉验证或者用一个独立的测试集来获得误差的一个无偏估计。它可以在内部进行评估，也就是说在生成的过程中就可以对误差建立一个无偏估计。</p> 
<p>我们知道，在构建每棵树时，我们对训练集使用了不同的bootstrap sample（随机且有放回地抽取）。所以对于每棵树而言（假设对于第k棵树），大约有1/3的训练实例没有参与第k棵树的生成，它们称为第k棵树的oob样本。而这样的采样特点就允许我们进行oob估计，它的计算方式如下：</p> 
<p>对每个样本，计算它作为oob样本的树对它的分类情况（约1/3的树）；<br> 然后以简单多数投票作为该样本的分类结果；<br> 最后用误分个数占样本总数的比率作为随机森林的oob误分率。<br> oob误分率是随机森林泛化误差的一个无偏估计，它的结果近似于需要大量计算的k折交叉验证。这样，就可以通过比较oob误分率来选择一个最好的特征数m。</p> 
<ol start="3"><li>随机森林参数<br> 在scikit-learn中，RF的分类器是RandomForestClassifier，回归器是RandomForestRegressor。RF的参数也包括两部分，第一部分是Bagging框架的参数，第二部分是一棵CART决策树的参数。具体的参数参考随机森林分类器的函数原型：</li></ol> 
<pre><code class="prism language-python">sklearn<span class="token punctuation">.</span>ensemble<span class="token punctuation">.</span>RandomForestClassifier<span class="token punctuation">(</span>
        n_estimators<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> criterion<span class="token operator">=</span><span class="token string">'gini'</span><span class="token punctuation">,</span>
        max_depth<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>min_samples_split<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> 
        min_samples_leaf<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> min_weight_fraction_leaf<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        max_features<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">,</span> max_leaf_nodes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        min_impurity_split<span class="token operator">=</span><span class="token number">1e-07</span><span class="token punctuation">,</span>bootstrap<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        oob_score<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
        random_state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        warm_start<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> class_weight<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<p>3.1 Bagging框架参数</p> 
<p>下面来看看RF重要的Bagging框架的参数，由于RandomForestClassifier和RandomForestRegressor参数绝大部分相同，这里会将它们一起讲，不同点会指出。</p> 
<ol><li> <p>n_estimators: 弱学习器（决策树）的个数。一般来说n_estimators太小，容易欠拟合，n_estimators太大，计算量会太大，并且n_estimators到一定的数量后，再增大n_estimators获得的模型提升会很小，所以一般选择一个适中的数值。默认是100。</p> </li><li> <p>oob_score:即是否采用袋外样本来评估模型的好坏。默认False。推荐设置为True，因为袋外分数反应了一个模型拟合后的泛化能力。</p> </li><li> <p>criterion: 即CART树做划分时对特征的评价标准。分类模型和回归模型的损失函数是不一样的。分类RF对应的CART分类树默认是基尼系数gini,另一个可选择的标准是信息增益(information gain)。回归RF对应的CART回归树默认是均方差mse，另一个可以选择的标准是绝对值差mae。一般来说选择默认的标准就已经很好的。</p> </li></ol> 
<p>从上面可以看出, RF重要的框架参数比较少，主要需要关注的是 n_estimators，即森林中决策树的个数。</p> 
<p>3.2 决策树参数</p> 
<p>下面我们再来看RF的决策树参数:</p> 
<ol><li> <p>RF划分时考虑的最大特征数 max_features: 就是之前提到的“在每个节点处，从M中随机选择m个特征维度”中的那个m。默认是"auto",意味着每个节点在划分时随机考虑 个特征；如果是"log2"意味着划分时随机考虑 个特征；如果是整数，代表考虑的特征绝对数。如果是浮点数，代表考虑特征百分比，即考虑百分比*总特征维度数取整后的特征数。一般用默认的"auto"就可以了；如果特征数非常多，可以灵活使用刚才描述的其他取值来控制划分时考虑的最大特征数，以控制决策树的生成时间。</p> </li><li> <p>决策树最大深度max_depth: 默认可以不输入，如果不输入的话，决策树在建立子树的时候不会限制子树的深度。一般来说，数据少或者特征少的时候可以不管这个值。如果模型样本量多，特征也多的情况下，推荐限制这个最大深度，具体的取值取决于数据的分布。常用的可以取值10-100之间。</p> </li><li> <p>内部节点再划分所需最小样本数min_samples_split: 这个值限制了子树继续划分的条件，如果某节点的样本数少于min_samples_split，则不会继续再划分。默认是2。如果样本量数量级非常大，则推荐增大这个值。</p> </li><li> <p>叶子节点最少样本数min_samples_leaf: 这个值限制了叶子节点最少的样本数，如果某叶子节点数目小于样本数，则会和兄弟节点一起被剪枝，只保留原来的父节点。默认是1。如果样本量数量级非常大，则推荐增大这个值。</p> </li></ol> 
<p>5）叶子节点最小的样本权重和min_weight_fraction_leaf：这个值限制了叶子节点所有样本权重和的最小值，如果小于这个值，则会和兄弟节点一起被剪枝，只保留原来的父节点。 默认是0，就是不考虑权重问题。如果我们有较多样本有缺失值，或者分类树样本的分布类别非常不平衡，就会引入样本权重，这时我们就要注意这个值了。</p> 
<ol start="6"><li> <p>最大叶子节点数max_leaf_nodes: 通过限制最大叶子节点数，可以防止过拟合，默认是"None”，即不限制最大的叶子节点数。如果加了限制，算法会建立在最大叶子节点数内最优的决策树。如果特征非常多的话，可以加以限制，具体的值可以通过交叉验证得到。</p> </li><li> <p>节点划分最小不纯度min_impurity_split: 这个值限制了决策树的增长，如果某节点的不纯度(基于基尼系数，均方差)小于这个阈值，则该节点不再生成子节点。即为叶子节点 。一般不推荐改动，默认值1e-7。</p> </li></ol> 
<p>上面决策树参数中最重要的包括最大特征数max_features， 最大深度max_depth， 内部节点再划分所需最小样本数min_samples_split和叶子节点最少样本数min_samples_leaf,这里我们运用随机森林API对 MNIST 训练,代码如下:</p> 
<pre><code class="prism language-python">rf <span class="token operator">=</span> RandomForestClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
rf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_labels<span class="token punctuation">)</span>
test_predictions <span class="token operator">=</span> rf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span> 
cm <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>test_labels<span class="token punctuation">,</span>test_predictions<span class="token punctuation">)</span> 
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">)</span> 
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/RF"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
t_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">==</span> test_labels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span> 
t_accuracy 
<span class="token comment"># plt.rc('font',family='Times New Roman',size=12)</span>
</code></pre> 
<h3><a id="_310"></a>代码完整版总结``</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>naive_bayes <span class="token keyword">import</span> MultinomialNB
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd 
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sn 
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>svm <span class="token keyword">import</span> SVC 
<span class="token keyword">import</span> time 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> BallTree 
<span class="token keyword">import</span> gzip<span class="token punctuation">,</span> os<span class="token punctuation">,</span> sys 
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np 
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">as</span> ureq
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>stats <span class="token keyword">import</span> multivariate_normal
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> mnist
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>utils <span class="token keyword">import</span> to_categorical
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> fetch_openml
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> fetch_openml
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span>  StandardScaler
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>utils <span class="token keyword">import</span> check_random_state
font1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">,</span>
<span class="token string">'weight'</span><span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
<span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
<span class="token comment"># fontdict = {'family':'Times New Roman', 'size':19}</span>
cm <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>test_labels<span class="token punctuation">,</span>test_predictions<span class="token punctuation">)</span> 
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>font<span class="token operator">=</span><span class="token string">"Times New Roman"</span><span class="token punctuation">)</span><span class="token comment">#for label size </span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>dpi<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/KNN"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
<span class="token comment"># plt.rc('font',family='Times New Roman',size=12)</span>
<span class="token keyword">def</span> <span class="token function">display_char</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span> 
     plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>，
     plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fit_generative_model</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     k <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment"># labels 0,1,...,k-1 </span>
     d <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># number of features </span>
     mu <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     sigma <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>d<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     pi <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>k<span class="token punctuation">)</span> 
     c <span class="token operator">=</span> <span class="token number">3500</span> <span class="token comment">#10000 #1000 #100 #10 #0.1 #1e9 </span>
     <span class="token keyword">for</span> label <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> 
         indices <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">==</span> label<span class="token punctuation">)</span> 
         pi<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> 
         mu<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>x<span class="token punctuation">[</span>indices<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         sigma<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>cov<span class="token punctuation">(</span>x<span class="token punctuation">[</span>indices<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rowvar<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> c<span class="token operator">*</span>np<span class="token punctuation">.</span>eye<span class="token punctuation">(</span>d<span class="token punctuation">)</span> 
     <span class="token keyword">return</span> mu<span class="token punctuation">,</span> sigma<span class="token punctuation">,</span> pi 
mu<span class="token punctuation">,</span> sigma<span class="token punctuation">,</span> pi <span class="token operator">=</span> fit_generative_model<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span> 
display_char<span class="token punctuation">(</span>mu<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
display_char<span class="token punctuation">(</span>mu<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
display_char<span class="token punctuation">(</span>mu<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token comment"># Compute log Pr(label|image) for each [test image,label] pair. </span>
k <span class="token operator">=</span> <span class="token number">10</span> 
score <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> label <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> 
     rv <span class="token operator">=</span> multivariate_normal<span class="token punctuation">(</span>mean<span class="token operator">=</span>mu<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> cov<span class="token operator">=</span>sigma<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span> 
     <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
         score<span class="token punctuation">[</span>i<span class="token punctuation">,</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pi<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> rv<span class="token punctuation">.</span>logpdf<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
test_predictions <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>score<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token comment"># Finally, tally up score </span>
errors <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">!=</span> test_labels<span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The generative model makes "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" errors out of 10000"</span><span class="token punctuation">)</span> 
<span class="token comment"># The generative model makes 438 errors out of 10000 </span>
t_accuracy <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>test_predictions <span class="token operator">==</span> test_labels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span> 
t_accuracy 
<span class="token comment"># 0.95620000000000005 </span>
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">)</span> 
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>font<span class="token operator">=</span><span class="token string">"Times New Roman"</span><span class="token punctuation">)</span><span class="token comment">#for label size </span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/Bayes"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
<span class="token comment"># mlb = MultinomialNB(alpha=1.0)</span>
<span class="token comment"># mlb.fit(train_data, train_labels)</span>
<span class="token comment"># y_predict = mlb.predict(x_test)</span>
<span class="token comment"># cm = metrics.confusion_matrix(test_labels,test_prediction) </span>
<span class="token comment"># df_cm = pd.DataFrame(cm) </span>
<span class="token comment"># sn.set(font_scale=0.5,font="Times New Roman")#for label size </span>
<span class="token comment"># plt.subplot(2,2,2)</span>
<span class="token comment"># ax=sn.heatmap(df_cm, annot=True,annot_kws={"size": 5,'family': 'Times New Roman'}, fmt="g",cmap="Greens",linewidths=0.05) </span>
<span class="token comment"># ax.set_title("Confusion Matrix/Bayes",fontdict=font1)</span>
<span class="token comment"># plt.rc('font',family='Times New Roman',size=12)</span>
<span class="token comment"># from sklearn.svm import SVC </span>
clf <span class="token operator">=</span> SVC<span class="token punctuation">(</span>C<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> kernel<span class="token operator">=</span><span class="token string">'poly'</span><span class="token punctuation">,</span> degree<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> 
clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_labels<span class="token punctuation">)</span> 
test_predictions <span class="token operator">=</span> clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span> 
cm <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>test_labels<span class="token punctuation">,</span>test_predictions<span class="token punctuation">)</span> 
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">)</span> 
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/SVC"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
<span class="token comment"># plt.rc('font',family='Times New Roman',size=12)</span>
rf <span class="token operator">=</span> RandomForestClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
rf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_labels<span class="token punctuation">)</span>
test_predictions <span class="token operator">=</span> rf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span> 
cm <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>test_labels<span class="token punctuation">,</span>test_predictions<span class="token punctuation">)</span> 
df_cm <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cm<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
sn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>font_scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">)</span> 
ax<span class="token operator">=</span>sn<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>df_cm<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>annot_kws<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'family'</span><span class="token punctuation">:</span> <span class="token string">'Times New Roman'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">"Greens"</span><span class="token punctuation">,</span>linewidths<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix/RF"</span><span class="token punctuation">,</span>fontdict<span class="token operator">=</span>font1<span class="token punctuation">)</span>
<span class="token comment"># plt.rc('font',family='Times New Roman',size=12)</span>
pylab<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment"># plt.subplots_adjust(left=0, right=1, bottom=0, top=1, hspace=0.05, wspace=0.05) </span>
</code></pre> 
<p>运行结果如下:<br> <img src="https://images2.imgbox.com/53/25/hzqVKbm4_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2b3cb4e37149a8b8fc1a0a9b301ca631/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ajax异步、同步问题——Ajax和JavaScript执行顺序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3acf1ecb4f5ea1681d3a749ab61d3e63/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于图像分割与颜色量化的 k 均值聚类算法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>