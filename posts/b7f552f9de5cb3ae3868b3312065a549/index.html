<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>运用limma对基因进行差异分析 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="运用limma对基因进行差异分析" />
<meta property="og:description" content="此次案例我们是要比较ARID1A这个基因突变与不突变两亚类肝癌病人哪些基因的表达存在差异（寻找差异基因）。
在之前的三篇TCGA的数据采集文章中，我们已经采集到了所需要的所有数据，具体见下：
那么接下来我们就要对这些数据进行差异分析，采用的工具为R语言，所需要的包有limma、edgeR。
运用limma对基因进行差异分析 第一部分：安装及加载edgeR、limma包第二部分：导入数据，设置分组，构建DGEList对象第三部分：过滤低表达的基因，进行标准化处理第四部分：估算离散值第五部分：差异分析获取代码 第一部分：安装及加载edgeR、limma包 edgeR的安装我们可以用先前的方法用Bioconductor进行安装。由于edgeR和limma互为依赖关系，所以limma也会在同时安装：
BiocManager::install(“edgeR”) library(limma) library(edgeR) library(statmod) 第二部分：导入数据，设置分组，构建DGEList对象 此次样本数据中我们选择了83个肝癌病人的数据，其中56个属于未突变组，27个属于突变组。
targets &lt;- as.matrix(read.csv(&#34;F:/公众号/图文素材/运用limma对基因进行差异分析/limma_data.csv&#34;, header = TRUE, row.names = 1)) group &lt;- rep(c(&#39;C1&#39;, &#39;C2&#39;), each = 56, length.out = 83) #C1是未突变组，C2是突变组 再根据基因表达量矩阵以及样本分组信息，构建DGEList对象。
dgelist &lt;- DGEList(counts = targets, group = group) 第三部分：过滤低表达的基因，进行标准化处理 输入的基因表达量矩阵文件中，可能会含有一些低表达量的基因（甚至还有一些被忽略的全部为0值的行），需要在执行差异分析前将它们剔除。原因在于，这些基因未表达到具有生物学意义的程度（从生物学角度，有生物学意义的基因的表达量必须高于某一个阈值）；并且低表达量的基因受到随机因素影响比较大，故其统计结果也不可靠，还会影响p值校正过程；此外，过滤后的数据量降低，也能加快运行速率。
过滤的方法有很多种，在这里我们根据CPM值进行过滤，如果有对标准化方法有兴趣的小伙伴可以阅读“Comparing the normalization methods for the differential analysis of Illumina high-throughput RNA-Seq data”, 了解不同标准化方法之间的差异。
keep &lt;- rowSums(cpm(dgelist) &gt; 1 ) &gt;= 2 #过滤 dgelist &lt;- dgelist[keep, ,keep." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/b7f552f9de5cb3ae3868b3312065a549/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-09T14:56:25+08:00" />
<meta property="article:modified_time" content="2020-05-09T14:56:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">运用limma对基因进行差异分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>此次案例我们是要比较ARID1A这个基因突变与不突变两亚类肝癌病人哪些基因的表达存在差异（寻找差异基因）。<br> 在之前的三篇TCGA的数据采集文章中，我们已经采集到了所需要的所有数据，具体见下：<br> <img src="https://images2.imgbox.com/74/46/2H7c1rlE_o.png" alt="在这里插入图片描述"><br> 那么接下来我们就要对这些数据进行差异分析，采用的工具为R语言，所需要的包有limma、edgeR。<br> </p> 
<div class="toc"> 
 <h4>运用limma对基因进行差异分析</h4> 
 <ul><li><a href="#edgeRlimma_5" rel="nofollow">第一部分：安装及加载edgeR、limma包</a></li><li><a href="#DGEList_13" rel="nofollow">第二部分：导入数据，设置分组，构建DGEList对象</a></li><li><a href="#_28" rel="nofollow">第三部分：过滤低表达的基因，进行标准化处理</a></li><li><a href="#_50" rel="nofollow">第四部分：估算离散值</a></li><li><a href="#_67" rel="nofollow">第五部分：差异分析</a></li><li><a href="#_102" rel="nofollow">获取代码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="edgeRlimma_5"></a>第一部分：安装及加载edgeR、limma包</h2> 
<p>edgeR的安装我们可以用先前的方法用Bioconductor进行安装。由于edgeR和limma互为依赖关系，所以limma也会在同时安装：</p> 
<pre><code class="prism language-python">BiocManager<span class="token punctuation">:</span><span class="token punctuation">:</span>install<span class="token punctuation">(</span>“edgeR”<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>limma<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>edgeR<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>statmod<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="DGEList_13"></a>第二部分：导入数据，设置分组，构建DGEList对象</h2> 
<p>此次样本数据中我们选择了83个肝癌病人的数据，其中56个属于未突变组，27个属于突变组。</p> 
<pre><code class="prism language-python">targets <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">as</span><span class="token punctuation">.</span>matrix<span class="token punctuation">(</span>read<span class="token punctuation">.</span>csv<span class="token punctuation">(</span><span class="token string">"F:/公众号/图文素材/运用limma对基因进行差异分析/limma_data.csv"</span><span class="token punctuation">,</span> header <span class="token operator">=</span> TRUE<span class="token punctuation">,</span> row<span class="token punctuation">.</span>names <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/87/40/SUn6qHna_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">group <span class="token operator">&lt;</span><span class="token operator">-</span> rep<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token string">'C1'</span><span class="token punctuation">,</span> <span class="token string">'C2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each <span class="token operator">=</span> <span class="token number">56</span><span class="token punctuation">,</span> length<span class="token punctuation">.</span>out <span class="token operator">=</span> <span class="token number">83</span><span class="token punctuation">)</span> <span class="token comment">#C1是未突变组，C2是突变组</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/17/6c/7WSfyqva_o.png" alt="在这里插入图片描述"><br> 再根据基因表达量矩阵以及样本分组信息，构建DGEList对象。</p> 
<pre><code class="prism language-python">dgelist <span class="token operator">&lt;</span><span class="token operator">-</span> DGEList<span class="token punctuation">(</span>counts <span class="token operator">=</span> targets<span class="token punctuation">,</span> group <span class="token operator">=</span> group<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b5/7c/iaGJXqFj_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_28"></a>第三部分：过滤低表达的基因，进行标准化处理</h2> 
<p>输入的基因表达量矩阵文件中，可能会含有一些低表达量的基因（甚至还有一些被忽略的全部为0值的行），需要在执行差异分析前将它们剔除。原因在于，这些基因未表达到具有生物学意义的程度（从生物学角度，有生物学意义的基因的表达量必须高于某一个阈值）；并且低表达量的基因受到随机因素影响比较大，故其统计结果也不可靠，还会影响p值校正过程；此外，过滤后的数据量降低，也能加快运行速率。<br> 过滤的方法有很多种，在这里我们根据CPM值进行过滤，如果有对标准化方法有兴趣的小伙伴可以阅读“<a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-015-0778-7" rel="nofollow">Comparing the normalization methods for the differential analysis of Illumina high-throughput RNA-Seq data</a>”, 了解不同标准化方法之间的差异。</p> 
<pre><code class="prism language-python">keep <span class="token operator">&lt;</span><span class="token operator">-</span> rowSums<span class="token punctuation">(</span>cpm<span class="token punctuation">(</span>dgelist<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token comment">#过滤</span>
dgelist <span class="token operator">&lt;</span><span class="token operator">-</span> dgelist<span class="token punctuation">[</span>keep<span class="token punctuation">,</span> <span class="token punctuation">,</span>keep<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>sizes <span class="token operator">=</span> FALSE<span class="token punctuation">]</span>
</code></pre> 
<p>使用edgeR中的calcNormFactors()函数对数据标准化，以消除由于样品制备或建库测序过程中带来的影响。这里以TMM标准化方法为例：</p> 
<pre><code class="prism language-python">dgelist_norm <span class="token operator">&lt;</span><span class="token operator">-</span> calcNormFactors<span class="token punctuation">(</span>dgelist<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">'TMM'</span><span class="token punctuation">)</span>  <span class="token comment">#TMM标准化</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cd/5b/7eiuij3M_o.png" alt="在这里插入图片描述"><br> <em>说明：<br> calcNormFactors()的方法有"TMM"、“RLE”、"upperquartile"三个，其它参数设置可参考：http://www.biostatistic.net/thread-10332-1-1.html</em></p> 
<p>计算得到的归一化系数被用作样本大小的缩放系数。标准化后的DGEList对象中，增添了标准化因子信息。</p> 
<p>然后，可以利用limma包中plotMDS()，绘制MDS图，使用无监督聚类方法展示出了样品间的相似性（或差异）。可据此查看各样本是否能够很好地按照分组聚类，评估试验效果，判别离群点，追踪误差的来源等。</p> 
<pre><code class="prism language-python">plotMDS<span class="token punctuation">(</span>dgelist_norm<span class="token punctuation">,</span> col <span class="token operator">=</span> rep<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/83/NaWvc7ru_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_50"></a>第四部分：估算离散值</h2> 
<p>负二项分布（negative binomial，NB）模型需要均值和离散值两个参数。首先需要根据样本分组，或者说根据实验设计、目的，构建一个分组矩阵。然后使用该分组矩阵，通过加权似然经验贝叶斯（weighted likelihood empirical Bayes）模型，估算每个基因的负二项离散Tagwise（即经验贝叶斯稳健离散值）、Common（即经验贝叶斯稳健离散值的均值）、Trended（即经验贝叶斯稳健离散值的拟合值）。<br> edgeR中，分组矩阵使用model.matrix()获得，并可以通过estimateDisp()估算离散值。<a href="http://www.bioconductor.org/packages/release/bioc/html/edgeR.html" rel="nofollow">edgeR具体说明</a>：</p> 
<pre><code class="prism language-python">design <span class="token operator">&lt;</span><span class="token operator">-</span> model<span class="token punctuation">.</span>matrix<span class="token punctuation">(</span><span class="token operator">~</span>group<span class="token punctuation">)</span>    <span class="token comment">#构建分组矩阵</span>
dge <span class="token operator">&lt;</span><span class="token operator">-</span> estimateDisp<span class="token punctuation">(</span>dgelist_norm<span class="token punctuation">,</span> design<span class="token punctuation">,</span> robust <span class="token operator">=</span> TRUE<span class="token punctuation">)</span> <span class="token comment">#估算离散值</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/76/20/0XXYGHkl_o.png" alt="在这里插入图片描述"><br> 对于两个分组，分别标识为0和1，比方说上图中，对于各样本是否属于“C2分组”（groupC2），前56个样本标识为0意为不属于“C2分组”，后27个标识为1意为属于“C2分组”。</p> 
<p>需要注意，标识好0、1类型后，后面的差异分析将以“分组1”的基因表达量相较于“分组0”是上调还是下调为准进行统计。因此在本示例中，后续分析获得的基因表达量上调/下调均为“分组C2”相较于“分组C1”而言的。实际的分析中，切记不要搞反了。</p> 
<p>使用plotBCV()展示估算的离散值</p> 
<pre><code class="prism language-python">plotBCV<span class="token punctuation">(</span>dge<span class="token punctuation">)</span> <span class="token comment">#作图查看</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1d/b7/0rH934OO_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_67"></a>第五部分：差异分析</h2> 
<p>edgeR和limma包中提供了多种计算差异基因的方法，建立在不同模型的基础上，本文采用的为负二项式广义对数线性模型（edgeR）。</p> 
<p>首先拟合负二项式广义对数线性模型（negative binomial generalized log-linear model），获取差异基因。这种方法大致可以这样理解，如果某个基因的表达值偏离这个分布模型，那么该基因即为差异表达基因。</p> 
<p>使用edgeR包中的函数glmFit()和glmLRT()实现，其中glmFit()用于将每个基因的read count值拟合到模型中，glmLRT()用于对给定系数进行统计检验。</p> 
<pre><code class="prism language-python">fit <span class="token operator">&lt;</span><span class="token operator">-</span> glmFit<span class="token punctuation">(</span>dge<span class="token punctuation">,</span> design<span class="token punctuation">,</span> robust <span class="token operator">=</span> TRUE<span class="token punctuation">)</span>     <span class="token comment">#拟合模型</span>
lrt <span class="token operator">&lt;</span><span class="token operator">-</span> glmLRT<span class="token punctuation">(</span>fit<span class="token punctuation">)</span>   <span class="token comment">#统计检验</span>
topTags<span class="token punctuation">(</span>lrt<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/59/54/AVCghWjO_o.png" alt="在这里插入图片描述"><br> topTags(lrt)简要展示了分析结果，其中：logFC即log2转化后的 Fold Change值，但是要注意，这里不是简单的将基因的read count值直接对比，而是分别计算了基因在两组中的CPM值，然后据此计算的logFC；logCPM是log2转化后的CPM值；LR，似然比统计；PValue，差异表达的p值；FDR，FDR校正后的p值。</p> 
<pre><code class="prism language-python">write<span class="token punctuation">.</span>csv<span class="token punctuation">(</span>topTags<span class="token punctuation">(</span>lrt<span class="token punctuation">,</span> n <span class="token operator">=</span> nrow<span class="token punctuation">(</span>dgelist$counts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">' F:/公众号/图文素材/运用limma对基因进行差异分析/glmLRT.csv'</span><span class="token punctuation">,</span> quote <span class="token operator">=</span> FALSE<span class="token punctuation">)</span> <span class="token comment">#输出主要结果</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/49/15/u7qoNskP_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">dge_de <span class="token operator">&lt;</span><span class="token operator">-</span> decideTestsDGE<span class="token punctuation">(</span>lrt<span class="token punctuation">,</span> adjust<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'fdr'</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0.05</span><span class="token punctuation">)</span>  <span class="token comment">#查看默认方法获得的差异基因</span>
summary<span class="token punctuation">(</span>dge_de<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b6/b8/gY7hh8OL_o.png" alt="在这里插入图片描述"><br> decideTestsDGE()可用于统计差异基因数量，屏幕输出了其默认值（供参考，大多数情况下我们还是优先根据Fold Change值以及p值等手动去筛选，而不会在意这个程序自己判断的数值），-1表示下调基因数量，1表示上调基因数量，0表示无差异基因数量。注意，对于这里的示例数据，基因表达量上调/下调均为“分组C2”相较于“分组C1”而言的。</p> 
<p>plotMD()是limma包中的方法，可以初步绘制火山图观测差异基因分析结果。下图为程序默认的差异分析结果，对应了decideTestsDGE()统计的差异基因数量。纵轴为log2 Fold Change值；横轴为log2 CPM值，反映了基因表达量信息；蓝色的点表示上调基因，红色的点表示下调基因，黑色的点为无差异基因。我们也可以据此<a href="https://blog.csdn.net/FightingBob/article/details/106161956">绘制火山图和热图</a></p> 
<pre><code class="prism language-python">plotMD<span class="token punctuation">(</span>lrt<span class="token punctuation">,</span> status <span class="token operator">=</span> dge_de<span class="token punctuation">,</span> values <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#作图观测</span>
abline<span class="token punctuation">(</span>h <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col <span class="token operator">=</span> <span class="token string">'gray'</span><span class="token punctuation">,</span> lty <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/a1/2pfCJr4V_o.png" alt="在这里插入图片描述"><br> <strong>参考文章：</strong><br> 1、代码及解释主要参考于刘尧老师的文章：<a href="http://blog.sciencenet.cn/blog-3406804-1188480.html" rel="nofollow">http://blog.sciencenet.cn/blog-3406804-1188480.html</a><br> 2、edgeR包详细说明：<a href="http://www.bioconductor.org/packages/release/bioc/html/edgeR.html" rel="nofollow">http://www.bioconductor.org/packages/release/bioc/html/edgeR.html</a><br> 3、Comparing the normalization methods for the differential analysis of Illumina high-throughput RNA-Seq data ：<a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-015-0778-7" rel="nofollow">https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-015-0778-7</a></p> 
<h2><a id="_102"></a>获取代码</h2> 
<p>以下是我的个人公众号，该篇的数据及代码可在公众号中回复“<strong>差异基因分析</strong>”即可获得，谢谢大家支持。<br> <img src="https://images2.imgbox.com/97/07/nMFVplTy_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/36e68b9e45e7b52d7ac0fb2db597537f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">openlayers 给Feature提供修改撤销功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e4d79648d42db5834a53be12a53934fd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Pydroid 3第三方库安装失败的解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>