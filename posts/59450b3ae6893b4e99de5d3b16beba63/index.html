<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RoboScript #4 - RS3 Patterns to the Rescue - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RoboScript #4 - RS3 Patterns to the Rescue" />
<meta property="og:description" content="RoboScript #4 - RS3 Patterns to the Rescue | Codewarshttps://www.codewars.com/kata/594b898169c1d644f900002e/java
题目概括： 背景是开发一个操纵机器人行动的脚本语言RoboScript， 实现以下语言标准
F - Move forward by 1 step in the direction that it is currently pointing. Initially, the robot faces to the right.L - Turn &#34;left&#34; (i.e. rotate 90 degrees anticlockwise)R - Turn &#34;right&#34; (i.e. rotate 90 degrees clockwise)Fn - Execute the F command n times (NOTE: n may be more than 1 digit long!)Ln - Execute L n timesRn - Execute R n times (SEQUENCE_OF_COMMANDS)n ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/59450b3ae6893b4e99de5d3b16beba63/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-09T19:22:09+08:00" />
<meta property="article:modified_time" content="2023-07-09T19:22:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RoboScript #4 - RS3 Patterns to the Rescue</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><a class="has-card" href="https://www.codewars.com/kata/594b898169c1d644f900002e/java" rel="nofollow" title="RoboScript #4 - RS3 Patterns to the Rescue | Codewars"><span class="link-card-box"><span class="link-title">RoboScript #4 - RS3 Patterns to the Rescue | Codewars</span><span class="link-link"><img alt="" class="link-link-icon" src="https://images2.imgbox.com/1a/65/2p6uu1kd_o.png">https://www.codewars.com/kata/594b898169c1d644f900002e/java</span></span></a></p> 
<h2><img alt="" height="167" src="https://images2.imgbox.com/a9/6d/QEDZlwy9_o.png" width="930"></h2> 
<p></p> 
<h2>题目概括：</h2> 
<p>背景是开发一个操纵机器人行动的脚本语言RoboScript， 实现以下语言标准<br>  </p> 
<ul><li><code>F</code> - Move forward by 1 step in the direction that it is currently pointing. Initially, the robot faces to the right.</li><li><code>L</code> - Turn "left" (i.e. <strong>rotate</strong> 90 degrees <strong>anticlockwise</strong>)</li><li><code>R</code> - Turn "right" (i.e. <strong>rotate</strong> 90 degrees <strong>clockwise</strong>)</li><li><code>Fn</code> - Execute the <code>F</code> command <code>n</code> times (NOTE: <code>n</code> <em>may</em> be more than 1 digit long!)</li><li><code>Ln</code> - Execute <code>L</code> n times</li><li><code>Rn</code> - Execute <code>R</code> n times</li><li> <pre>(SEQUENCE_OF_COMMANDS)n ... is equivalent to ...SEQUENCE_OF_COMMANDS...SEQUENCE_OF_COMMANDS (repeatedly executed "n" times)</pre> </li><li> <pre>p(n)&lt;CODE_HERE&gt;q 
WHERE：
</pre> 
  <ul><li><code>p</code> is a "keyword" that declares the beginning of a pattern definition (much like the <code>function</code> keyword in JavaScript or the <code>def</code> keyword in Python)</li><li><code>(n)</code> is any non-negative integer (without the round brackets) which acts as a unique identifier for the pattern (much like a function/method name)</li><li><code>&lt;CODE_HERE&gt;</code> is any valid RoboScript code (without the angled brackets)</li><li><code>q</code> is a "keyword" that marks the end of a pattern definition (like the <code>end</code> keyword in Ruby)</li></ul></li></ul> 
<h2>难点：</h2> 
<p>1、嵌套括号的处理，例如p312(F2LF2R)2qP312((F2R3)3)</p> 
<p>2、题目中的要实现类似函数功能的`pattern`，这类似于函数，可在指令序列的任意地方声明和调用，极大增加了代码结构的复杂性</p> 
<p>3、解析指令序列后，要求输出Robot的行动轨迹，需要一点技巧</p> 
<p>4、OOP编程的抽象能力</p> 
<h2>思路：</h2> 
<p>1、<strong>解释</strong>：采集字符串的数据格式化为指令类，但把p指令单独看待，将p声明的pattern放入Map&lt;Integer, Sentence&gt; patternPool中，以便P指令调用</p> 
<p>2、<strong>执行</strong>：定义Sentence类，储存语句类型（FLR，或者FLR组成的序列），执行次数n。定义execute方法调用n次相应的指令类的execute方法。<br> 2、<strong>画图</strong>：定义Position类， 将Robot走过的position放入HashSet中，同时记录Robot走过的上下左右边界。有了走过的坐标和走过的区域边界就能模拟出Robot的活动路径了。<br> 边界值用两层检查坐标有没有在HashSet内， 有则StringBuider append “*”，没有则append “空格”。</p> 
<h2>提交时发现的错误以及处理方式：</h2> 
<p><strong>1、爆内存</strong></p> 
<p>傻傻的定义了巨无霸二维数组来模拟走过的路径，后改用HashSet只记录已走过的点坐标得到解决</p> 
<p><strong>1、StackOverflowError</strong></p> 
<p><img alt="" height="140" src="https://images2.imgbox.com/9d/f3/3blSMZNO_o.png" width="456"></p> 
<p>好的家伙这12个样例没有过，点开错误一看，奥原来是StackOverflowError，<s>痛骂样例嵌套了了几千层括号祸害我</s>。<br> 再仔细一看，奥原来是无限套娃调用要抛出异常 :)</p> 
<p><img alt="" height="419" src="https://images2.imgbox.com/09/21/rFgQGKkm_o.png" width="648"></p> 
<p>故在P类中添加该checkAndPreventLoop方法检查是否有套娃现象。解决！</p> 
<pre><code class="language-java">    private static class P implements Instruction {
        @Override
        public void execute(int args) {
            if (!patternPool.containsKey(args))
                throw new RuntimeException("Unknown pattern: " + args);

            checkAndPreventLoop(args, new HashSet&lt;&gt;());

            patternPool.get(args).execute();
        }

        private void checkAndPreventLoop(int patternId, Set&lt;Integer&gt; visitedPatterns) {
            if (visitedPatterns.contains(patternId)) {
                throw new RuntimeException("Pattern recursion loop detected: " + patternId);
            }

            visitedPatterns.add(patternId);

            Sentence pattern = patternPool.get(patternId);
            for (Sentence s : pattern.nestedSentences) {
                if (s.instructionType == InstructionType.P) {
                    checkAndPreventLoop(s.arg, new HashSet&lt;&gt;(visitedPatterns));
                }
            }
        }
    }</code></pre> 
<p>绿油油的很好！下一个！</p> 
<p><img alt="" height="961" src="https://images2.imgbox.com/ca/4e/jj7YnwGm_o.png" width="1200"></p> 
<p></p> 
<h2> 最终代码：</h2> 
<pre><code class="language-java">import java.util.*;

public class RoboScript3 {
    private static final Map&lt;InstructionType, Instruction&gt; instructionMap = new EnumMap&lt;&gt;(InstructionType.class);
    private static final Map&lt;Integer, Sentence&gt; patternPool = new HashMap&lt;&gt;();
    private static Direction movingDirection = Direction.E;
    private static final Set&lt;Position&gt; visitedPositions = new HashSet&lt;&gt;();
    private static final int[] position = {0, 0};
    private static int minX = 0, minY = 0, maxX = 0, maxY = 0;
    enum Direction {S, W, N, E};
    enum InstructionType {F, L, R, P}

    static {
        instructionMap.put(InstructionType.F, new F());
        instructionMap.put(InstructionType.L, new L());
        instructionMap.put(InstructionType.R, new R());
        instructionMap.put(InstructionType.P, new P());
    }

    public static String execute(String code) {
        movingDirection = Direction.E;
        visitedPositions.clear();
        patternPool.clear();
        position[0] = position[1] = 0;
        minX = minY = 0;
        maxX = maxY = 0;
        visitedPositions.add(new Position(0, 0));

        List&lt;Sentence&gt; program = compile(code);
        for (Sentence s : program) {
            s.execute();
        }

        return drawRoutine();
    }

    private static List&lt;Sentence&gt; compile(String code) {
        List&lt;Sentence&gt; sentenceList = new ArrayList&lt;&gt;();
        int i = 0;
        while (i &lt; code.length()) {
            if (code.charAt(i) == '(') {
                int j = i;
                int bracketCounter = 0;
                while (j &lt; code.length()) {
                    if (code.charAt(j) == '(') {
                        bracketCounter++;
                    } else if (code.charAt(j) == ')') {
                        bracketCounter--;
                        if (bracketCounter == 0) {
                            break;
                        }
                    }
                    j++;
                }
                int k = j + 1;
                while (k &lt; code.length() &amp;&amp; Character.isDigit(code.charAt(k))) {
                    k++;
                }
                int repeat = k &gt; j + 1 ? Integer.parseInt(code.substring(j + 1, k)) : 1;
                sentenceList.add(new Sentence(compile(code.substring(i + 1, j)), repeat));
                i = k;
            } else if (code.charAt(i) == 'p') { //pn&lt;sentence&gt;q
                // Declare pattern
                int j = i + 1; // skip 'p'
                while (j &lt; code.length() &amp;&amp; Character.isDigit(code.charAt(j))) {
                    j++;
                }
//                if (j &lt;= i + 1 || j + 1 &gt;= code.length())
//                    throw new RuntimeException("Syntax Error: pn&lt;sentence&gt;q");
                int patternId = Integer.parseInt(code.substring(i + 1, j));

                // Find q position
                int q = j;
                while (q &lt; code.length() &amp;&amp; code.charAt(q) != 'q') {
                    q++;
                }
                if (patternPool.containsKey(patternId))
                    throw new RuntimeException("The pattern " + patternId + " has been defined before");
                patternPool.put(patternId, new Sentence(compile(code.substring(j, q)), 1));
                i = q + 1;
            } else {
                int j = i + 1;
                while (j &lt; code.length() &amp;&amp; Character.isDigit(code.charAt(j))) {
                    j++;
                }
                int repeat = j &gt; i + 1 ? Integer.parseInt(code.substring(i + 1, j)) : 1;
                sentenceList.add(new Sentence(InstructionType.valueOf(String.valueOf(code.charAt(i))), repeat));
                i = j;
            }
        }
        return sentenceList;
    }

    private static String drawRoutine() {
        StringBuilder builder = new StringBuilder((maxY - minY + 1) * (maxX - minX + 2));
        for (int i = minX; i &lt;= maxX; i++) {
            for (int j = minY; j &lt;= maxY; j++) {
                if (visitedPositions.contains(new Position(i, j))) {
                    builder.append('*');
                } else {
                    builder.append(' ');
                }
            }
            builder.append("\r\n");
        }
        return builder.toString().replaceAll("\r\n$", "");
    }
    private static class Sentence {
        private final InstructionType instructionType;
        private final List&lt;Sentence&gt; nestedSentences;
        private final int arg;

        public Sentence(InstructionType instructionType, int arg) {
            this.instructionType = instructionType;
            this.nestedSentences = null;
            this.arg = arg;
        }

        public Sentence(List&lt;Sentence&gt; nestedSentences, int arg) {
            this.instructionType = null;
            this.nestedSentences = nestedSentences;
            this.arg = arg;
        }

        public void execute() {
            if (instructionType != null) {
                Instruction instruction = instructionMap.get(instructionType);
                instruction.execute(arg);
            } else {
                for (int i = 0; i &lt; arg; i++) {
                    for (Sentence sentence : nestedSentences) {
                        sentence.execute();
                    }
                }
            }
        }
    }

    interface Instruction {
        void execute(int args);
    }

    private static class F implements Instruction {
        @Override
        public void execute(int args) {
            for (int i = 0; i &lt; args; i++) {
                switch (movingDirection) {
                    case E:
                        position[1]++;
                        break;
                    case N:
                        position[0]--;
                        break;
                    case S:
                        position[0]++;
                        break;
                    case W:
                        position[1]--;
                }
                visitedPositions.add(new Position(position[0], position[1]));
                maxX = Math.max(maxX, position[0]);
                minX = Math.min(minX, position[0]);
                maxY = Math.max(maxY, position[1]);
                minY = Math.min(minY, position[1]);
            }
        }
    }

    private static class R implements Instruction {
        @Override
        public void execute(int args) {
            Direction[] directions = Direction.values();
            int newIndex = (movingDirection.ordinal() + args) % 4;
            movingDirection = directions[newIndex];
        }
    }

    private static class L implements Instruction {
        @Override
        public void execute(int args) {
            Direction[] directions = Direction.values();
            int newIndex = Math.floorMod(movingDirection.ordinal() - args, 4);
            movingDirection = directions[newIndex];
        }
    }

    private static class P implements Instruction {
        @Override
        public void execute(int args) {
            if (!patternPool.containsKey(args))
                throw new RuntimeException("Unknown pattern: " + args);

            checkAndPreventLoop(args, new HashSet&lt;&gt;());

            patternPool.get(args).execute();
        }

        private void checkAndPreventLoop(int patternId, Set&lt;Integer&gt; visitedPatterns) {
            if (visitedPatterns.contains(patternId)) {
                throw new RuntimeException("Pattern recursion loop detected: " + patternId);
            }

            visitedPatterns.add(patternId);

            Sentence pattern = patternPool.get(patternId);
            for (Sentence s : pattern.nestedSentences) {
                if (s.instructionType == InstructionType.P) {
                    checkAndPreventLoop(s.arg, new HashSet&lt;&gt;(visitedPatterns));
                }
            }
        }
    }


//    private static class P implements Instruction {
//        @Override
//        public void execute(int args) {
//            if (!patternPool.containsKey(args))
//                throw new RuntimeException("Unknown pattern: " + args);
//
//            patternPool.get(args).execute();
//        }
//    }

    private static class Position {
        private final int x;
        private final int y;

        public Position(int x, int y) {
            this.x = x;
            this.y = y;
        }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            Position position = (Position) o;
            return x == position.x &amp;&amp; y == position.y;
        }

        @Override
        public int hashCode() {
            return Objects.hash(x, y);
        }
    }
}
</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b5d17b6366822d325440579b7b935546/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Latex-Texlive和Texstudio的安装和初步使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/101b8b9c482506b18bdde3f0390d45fe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">树莓派VNC server设置开机自启动</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>