<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV中的Mat类 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenCV中的Mat类" />
<meta property="og:description" content="什么是Mat类 在OpenCV中，Mat类是用来存放图像的基本类，它是用来保存图像矩阵类型的数据信息，包括向量、矩阵、灰度或彩色图像等数据。
Mat类主要包含有两部分（并不是两个）数据：一部分是矩阵头（matrix header），这部分的大小是固定的，包含矩阵的大小，存储的方式，矩阵存储的地址和引用次数等；另一个部分是一个指向像素矩阵的指针（指针变量）（data）。
在绝大多数情况下矩阵头的大小远小于像素矩阵中数据量的大小，小了好多个数量级，因此图像复制和传递过程中主要的开销是存放矩阵数据。为了解决这个问题，在OpenCV中复制和传递图像时，只是复制了矩阵头和指向存储数据的指针，因此在创建Mat类时可以先创建矩阵头后赋值数据。
总之，是把Mat类中的成员数据分成了两部分：矩阵头和指向像素矩阵的指针变量。很多时候为便于理解，干脆直接把Mat类的对象理解成矩阵头，也即指向像素矩阵的指针在矩阵头中（一句话，Mat类的实例化对象就是矩阵头，矩阵头中包含：矩阵的大小、存储的方式、矩阵存储的地址和引用次数等、指向像素矩阵的指针），看了很多博客，感觉这样是最好理解的，很多时候不必死磕概念，或许概念本身界定都不太清晰！这样理解，矩阵头就是Mat类的实例化对象，看了Mat类定义的源码发现，指向像素矩阵的指针就存在于Mat类中，也即存在于矩阵头中。如图：
Mat类的关键部分定义（以opencv 4.1.0为例，opencv文件夹 -&gt; bulid文件夹 -&gt; include文件夹 -&gt; opencv2文件夹 -&gt; core文件夹 -&gt; mat.hpp中788行），指向像素矩阵的指针（uchar* data）大概在2085行
class CV_EXPORTS Mat { public: // 一系列函数 ... /* flag 参数中包含许多关于矩阵的信息，如： -Mat 的标识 -数据是否连续 -深度 -通道数目 */ int flags; // 矩阵的维数，取值应该大于或等于 2 int dims; // 矩阵的行数和列数，如果矩阵超过 2 维，这两个变量的值都为-1 int rows, cols; // 指向数据的指针:大概在2085行 uchar* data; // 指向引用计数的指针 // 如果数据是由用户分配的，则为 NULL int* refcount; // 其他成员变量和成员函数 ... } 下面我们通过读取一张本地图片返回一个Mat结构:
cv::Mat a; //仅创建了矩阵头a a = cv::imread(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/7d9a97af09711138496edc61e8908c78/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-10T15:00:52+08:00" />
<meta property="article:modified_time" content="2023-02-10T15:00:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV中的Mat类</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Mat_0"></a>什么是Mat类</h2> 
<p>在OpenCV中，Mat类是用来存放图像的基本类，它是用来保存图像矩阵类型的数据信息，包括向量、矩阵、灰度或彩色图像等数据。</p> 
<p>Mat类主要包含有<strong>两部分</strong>（并不是两个）数据：一部分是<strong>矩阵头</strong>（matrix header），这部分的大小是固定的，包含矩阵的大小，存储的方式，矩阵存储的地址和引用次数等；另一个部分是一个指向像素矩阵的<strong>指针（指针变量）</strong>（data）。</p> 
<p>在绝大多数情况下矩阵头的大小远小于像素矩阵中数据量的大小，小了好多个数量级，因此图像复制和传递过程中主要的开销是存放矩阵数据。为了解决这个问题，在OpenCV中复制和传递图像时，只是复制了矩阵头和指向存储数据的指针，因此在创建Mat类时可以先创建矩阵头后赋值数据。</p> 
<p>总之，是把Mat类中的成员数据分成了两部分：矩阵头和指向像素矩阵的指针变量。<strong>很多时候为便于理解，干脆直接把Mat类的对象理解成矩阵头，也即指向像素矩阵的指针在矩阵头中（一句话，Mat类的实例化对象就是矩阵头，矩阵头中包含：矩阵的大小、存储的方式、矩阵存储的地址和引用次数等、指向像素矩阵的指针）</strong>，看了很多博客，感觉这样是最好理解的，很多时候不必死磕概念，或许概念本身界定都不太清晰！这样理解，矩阵头就是Mat类的实例化对象，看了Mat类定义的源码发现，指向像素矩阵的指针就存在于Mat类中，也即存在于矩阵头中。如图：<br> <img src="https://images2.imgbox.com/00/3e/siIEcpYq_o.jpg" alt="在这里插入图片描述"><br> Mat类的关键部分定义（以opencv 4.1.0为例，opencv文件夹 -&gt; bulid文件夹 -&gt; include文件夹 -&gt; opencv2文件夹 -&gt; core文件夹 -&gt; mat.hpp中788行），指向像素矩阵的指针（uchar* data）大概在2085行</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">CV_EXPORTS</span> Mat
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 一系列函数</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token comment">/* flag 参数中包含许多关于矩阵的信息，如：
    -Mat 的标识
    -数据是否连续
    -深度
    -通道数目
    */</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    
    <span class="token comment">// 矩阵的维数，取值应该大于或等于 2</span>
    <span class="token keyword">int</span> dims<span class="token punctuation">;</span>
    
    <span class="token comment">// 矩阵的行数和列数，如果矩阵超过 2 维，这两个变量的值都为-1</span>
    <span class="token keyword">int</span> rows<span class="token punctuation">,</span> cols<span class="token punctuation">;</span>
    
    <span class="token comment">// 指向数据的指针:大概在2085行</span>
    uchar<span class="token operator">*</span> data<span class="token punctuation">;</span>
    
    <span class="token comment">// 指向引用计数的指针</span>
    <span class="token comment">// 如果数据是由用户分配的，则为 NULL</span>
    <span class="token keyword">int</span><span class="token operator">*</span> refcount<span class="token punctuation">;</span>
    
    <span class="token comment">// 其他成员变量和成员函数</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面我们通过读取一张本地图片返回一个Mat结构:</p> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Mat a<span class="token punctuation">;</span> <span class="token comment">//仅创建了矩阵头a</span>
a <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"test.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token double-colon punctuation">::</span>Mat b <span class="token operator">=</span> a<span class="token punctuation">;</span>
</code></pre> 
<p>上面这段代码首先创建了一个名为a的矩阵头，之后读入一张图像并将a中的矩阵指针指向该图像的像素数据，最后将a矩阵头中的内容复制到b矩阵头中。虽然a、b有各自的矩阵头，但是其矩阵指针指向的是同一个矩阵数据，通过任意一个矩阵头修改矩阵中的数据，另一个矩阵头指向的数据也会跟着发生改变。但是当删除a变量时，b变量并不会指向一个空数据，只有当两个变量都删除后，才会释放矩阵数据。因为在OpenCV的设计中，矩阵头中引用次数标记了引用某个矩阵数据的次数，只有当矩阵数据引用次数为0的时候才会真正释放矩阵数据。</p> 
<blockquote> 
 <p>采用引用次数来释放存储内容是C++中常见的方式，用这种方式可以避免仍有某个变量引用数据时将这个数据删除造成程序崩溃的问题，同时极大的缩减了程序运行时所占用的内存。</p> 
</blockquote> 
<h2><a id="_52"></a>图解分析</h2> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Mat a<span class="token punctuation">;</span> <span class="token comment">//仅创建了矩阵头a</span>
a <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"test.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token double-colon punctuation">::</span>Mat b <span class="token operator">=</span> a<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_58"></a>第一句</h5> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Mat a<span class="token punctuation">;</span><span class="token comment">//仅创建了矩阵头，此时矩阵头a中的指针data为NULL</span>
</code></pre> 
<ul><li>图解<br> <img src="https://images2.imgbox.com/1a/9d/wEPoDoVX_o.jpg" alt="在这里插入图片描述"></li><li>单步调试<br> <img src="https://images2.imgbox.com/c5/90/V0oJIR5H_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="_67"></a>第二句</h5> 
<pre><code class="prism language-cpp">a <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"test.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为像素矩阵开辟内存，矩阵头a中的指针变量data存放的是像素矩阵的起始地址，指针data指向像素矩阵</span>
</code></pre> 
<ul><li>图解<br> <img src="https://images2.imgbox.com/f0/fa/H4JQhoGQ_o.jpg" alt="在这里插入图片描述"></li><li>单步调试<br> <img src="https://images2.imgbox.com/a9/46/TA5PP9mr_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="_75"></a>第三句</h5> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Mat b <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token comment">//浅拷贝，仅仅把矩阵头a中的内容拷贝给矩阵头b，故矩阵头a和矩阵头b中的指向像素矩阵的指针变量所存放的地址相同，故指针都指向同一块内存</span>
</code></pre> 
<ul><li>图解<br> <img src="https://images2.imgbox.com/f6/27/MxEqkfrS_o.jpg" alt="在这里插入图片描述"></li><li>单步调试<br> <img src="https://images2.imgbox.com/cf/fd/xcnfxwu7_o.png" alt="在这里插入图片描述"><br> a中的指向像素矩阵的指针变量中存放的地址，与b中的指向像素矩阵的指针变量中存放的地址相同，并且像素矩阵的起始地址和结束地址都相同，如下：<br> <img src="https://images2.imgbox.com/be/a3/RRGbC0UO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/28/n88W4zp0_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="_87"></a>最后，单步调试的程序</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;opencv2\opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	cv<span class="token double-colon punctuation">::</span>Mat a<span class="token punctuation">;</span><span class="token comment">//第一句</span>
	<span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//</span>
	c <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//</span>
	a <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/Administrator/Desktop/test.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第二句</span>
	c <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//</span>
	cv<span class="token double-colon punctuation">::</span>Mat b <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token comment">//第三句</span>
	c <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="httpsjuejincnpost7103897282600239111_107"></a><a href="https://juejin.cn/post/7103897282600239111" rel="nofollow">参考资料</a></h5>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/89c810e3056089268883c0f7b29930b1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WPF中实现图像的缩放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1ab9922e838987ce070c1340bf67a902/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">sqlserver去除空格</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>