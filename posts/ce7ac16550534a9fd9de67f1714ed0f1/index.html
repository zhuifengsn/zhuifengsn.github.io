<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Pandas 02-基础 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Pandas 02-基础" />
<meta property="og:description" content="Pandas 02-基础 import numpy as np import pandas as pd pd.__version__ &#39;1.1.5&#39; 在开始学习前，请保证 pandas 的版本号不低于1.1.4，否则请务必升级！
一、文件的读取和写入 1. 文件读取 pandas可以读取的文件格式有很多，这里主要介绍读取csv, excel, txt文件。
df_csv = pd.read_csv(&#39;../data/my_csv.csv&#39;) df_csv col1col2col3col4col502a1.4apple2020/1/113b3.4banana2020/1/226c2.5orange2020/1/535d3.2lemon2020/1/7 df_txt = pd.read_table(&#39;../data/my_table.txt&#39;) df_txt col1col2col3col402a1.4apple 2020/1/113b3.4banana 2020/1/226c2.5orange 2020/1/535d3.2lemon 2020/1/7 df_excel = pd.read_excel(&#39;../data/my_excel.xlsx&#39;) df_excel col1col2col3col4col502a1.4apple2020/1/113b3.4banana2020/1/226c2.5orange2020/1/535d3.2lemon2020/1/7 这里有一些常用的公共参数，header=None表示第一行不作为列名，index_col表示把某一列或几列作为索引，索引的内容将会在第三章进行详述，usecols表示读取列的集合，默认读取所有的列，parse_dates表示需要转化为时间的列，关于时间序列的有关内容在第十章，nrows表示读取的数据行数。上面这些参数在上述的三个函数里都可以使用。
pd.read_table(&#39;../data/my_table.txt&#39;, header=None) 01230col1col2col3col412a1.4apple 2020/1/123b3.4banana 2020/1/236c2.5orange 2020/1/545d3.2lemon 2020/1/7 pd.read_csv(&#39;../data/my_csv.csv&#39;, index_col=[&#39;col1&#39;, &#39;col2&#39;]) col3col4col5col1col22a1.4apple2020/1/13b3.4banana2020/1/26c2.5orange2020/1/55d3.2lemon2020/1/7 pd.read_table(&#39;../data/my_table.txt&#39;, usecols=[&#39;col1&#39;, &#39;col2&#39;]) col1col202a13b26c35d pd.read_csv(&#39;../data/my_csv.csv&#39;, parse_dates=[&#39;col5&#39;]) col1col2col3col4col502a1.4apple2020-01-0113b3.4banana2020-01-0226c2.5orange2020-01-0535d3.2lemon2020-01-07 pd.read_excel(&#39;../data/my_excel.xlsx&#39;, nrows=2) col1col2col3col4col502a1.4apple2020/1/113b3.4banana2020/1/2 在读取txt文件时，经常遇到分隔符非空格的情况，read_table有一个分割参数sep，它使得用户可以自定义分割符号，进行txt数据的读取。例如，下面的读取的表以||||为分割：
pd.read_table(&#39;../data/my_table_special_sep.txt&#39;) col1 |||| col20TS |||| This is an apple." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/ce7ac16550534a9fd9de67f1714ed0f1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-19T00:32:36+08:00" />
<meta property="article:modified_time" content="2020-12-19T00:32:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Pandas 02-基础</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <center> 
 <h2>Pandas 02-基础</h2> 
</center> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
pd<span class="token punctuation">.</span>__version__
</code></pre> 
<pre><code>'1.1.5'
</code></pre> 
<p>在开始学习前，请保证 pandas 的版本号不低于1.1.4，否则请务必升级！</p> 
<h3><a id="_18"></a>一、文件的读取和写入</h3> 
<h4><a id="1__19"></a>1. 文件读取</h4> 
<p><code>pandas</code>可以读取的文件格式有很多，这里主要介绍读取<code>csv, excel, txt</code>文件。</p> 
<pre><code class="prism language-python">df_csv <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../data/my_csv.csv'</span><span class="token punctuation">)</span>
df_csv
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th><th>col3</th><th>col4</th><th>col5</th></tr></thead><tbody><tr><th>0</th><td>2</td><td>a</td><td>1.4</td><td>apple</td><td>2020/1/1</td></tr><tr><th>1</th><td>3</td><td>b</td><td>3.4</td><td>banana</td><td>2020/1/2</td></tr><tr><th>2</th><td>6</td><td>c</td><td>2.5</td><td>orange</td><td>2020/1/5</td></tr><tr><th>3</th><td>5</td><td>d</td><td>3.2</td><td>lemon</td><td>2020/1/7</td></tr></tbody></table> 
<pre><code class="prism language-python">df_txt <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_table<span class="token punctuation">(</span><span class="token string">'../data/my_table.txt'</span><span class="token punctuation">)</span>
df_txt
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th><th>col3</th><th>col4</th></tr></thead><tbody><tr><th>0</th><td>2</td><td>a</td><td>1.4</td><td>apple 2020/1/1</td></tr><tr><th>1</th><td>3</td><td>b</td><td>3.4</td><td>banana 2020/1/2</td></tr><tr><th>2</th><td>6</td><td>c</td><td>2.5</td><td>orange 2020/1/5</td></tr><tr><th>3</th><td>5</td><td>d</td><td>3.2</td><td>lemon 2020/1/7</td></tr></tbody></table> 
<pre><code class="prism language-python">df_excel <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'../data/my_excel.xlsx'</span><span class="token punctuation">)</span>
df_excel
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th><th>col3</th><th>col4</th><th>col5</th></tr></thead><tbody><tr><th>0</th><td>2</td><td>a</td><td>1.4</td><td>apple</td><td>2020/1/1</td></tr><tr><th>1</th><td>3</td><td>b</td><td>3.4</td><td>banana</td><td>2020/1/2</td></tr><tr><th>2</th><td>6</td><td>c</td><td>2.5</td><td>orange</td><td>2020/1/5</td></tr><tr><th>3</th><td>5</td><td>d</td><td>3.2</td><td>lemon</td><td>2020/1/7</td></tr></tbody></table> 
<p>这里有一些常用的公共参数，<code>header=None</code>表示第一行不作为列名，<code>index_col</code>表示把某一列或几列作为索引，索引的内容将会在第三章进行详述，<code>usecols</code>表示读取列的集合，默认读取所有的列，<code>parse_dates</code>表示需要转化为时间的列，关于时间序列的有关内容在第十章，<code>nrows</code>表示读取的数据行数。上面这些参数在上述的三个函数里都可以使用。</p> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_table<span class="token punctuation">(</span><span class="token string">'../data/my_table.txt'</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><th>0</th><td>col1</td><td>col2</td><td>col3</td><td>col4</td></tr><tr><th>1</th><td>2</td><td>a</td><td>1.4</td><td>apple 2020/1/1</td></tr><tr><th>2</th><td>3</td><td>b</td><td>3.4</td><td>banana 2020/1/2</td></tr><tr><th>3</th><td>6</td><td>c</td><td>2.5</td><td>orange 2020/1/5</td></tr><tr><th>4</th><td>5</td><td>d</td><td>3.2</td><td>lemon 2020/1/7</td></tr></tbody></table> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../data/my_csv.csv'</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'col1'</span><span class="token punctuation">,</span> <span class="token string">'col2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th></th><th>col3</th><th>col4</th><th>col5</th></tr><tr><th>col1</th><th>col2</th><th></th><th></th><th></th></tr></thead><tbody><tr><th>2</th><th>a</th><td>1.4</td><td>apple</td><td>2020/1/1</td></tr><tr><th>3</th><th>b</th><td>3.4</td><td>banana</td><td>2020/1/2</td></tr><tr><th>6</th><th>c</th><td>2.5</td><td>orange</td><td>2020/1/5</td></tr><tr><th>5</th><th>d</th><td>3.2</td><td>lemon</td><td>2020/1/7</td></tr></tbody></table> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_table<span class="token punctuation">(</span><span class="token string">'../data/my_table.txt'</span><span class="token punctuation">,</span> usecols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'col1'</span><span class="token punctuation">,</span> <span class="token string">'col2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th></tr></thead><tbody><tr><th>0</th><td>2</td><td>a</td></tr><tr><th>1</th><td>3</td><td>b</td></tr><tr><th>2</th><td>6</td><td>c</td></tr><tr><th>3</th><td>5</td><td>d</td></tr></tbody></table> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../data/my_csv.csv'</span><span class="token punctuation">,</span> parse_dates<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'col5'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th><th>col3</th><th>col4</th><th>col5</th></tr></thead><tbody><tr><th>0</th><td>2</td><td>a</td><td>1.4</td><td>apple</td><td>2020-01-01</td></tr><tr><th>1</th><td>3</td><td>b</td><td>3.4</td><td>banana</td><td>2020-01-02</td></tr><tr><th>2</th><td>6</td><td>c</td><td>2.5</td><td>orange</td><td>2020-01-05</td></tr><tr><th>3</th><td>5</td><td>d</td><td>3.2</td><td>lemon</td><td>2020-01-07</td></tr></tbody></table> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'../data/my_excel.xlsx'</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th><th>col3</th><th>col4</th><th>col5</th></tr></thead><tbody><tr><th>0</th><td>2</td><td>a</td><td>1.4</td><td>apple</td><td>2020/1/1</td></tr><tr><th>1</th><td>3</td><td>b</td><td>3.4</td><td>banana</td><td>2020/1/2</td></tr></tbody></table> 
<p>在读取<code>txt</code>文件时，经常遇到分隔符非空格的情况，<code>read_table</code>有一个分割参数<code>sep</code>，它使得用户可以自定义分割符号，进行<code>txt</code>数据的读取。例如，下面的读取的表以<code>||||</code>为分割：</p> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_table<span class="token punctuation">(</span><span class="token string">'../data/my_table_special_sep.txt'</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1 |||| col2</th></tr></thead><tbody><tr><th>0</th><td>TS |||| This is an apple.</td></tr><tr><th>1</th><td>GQ |||| My name is Bob.</td></tr><tr><th>2</th><td>WT |||| Well done!</td></tr><tr><th>3</th><td>PT |||| May I help you?</td></tr></tbody></table> 
<p>上面的结果显然不是理想的，这时可以使用<code>sep</code>，同时需要指定引擎为<code>python</code>：</p> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>read_table<span class="token punctuation">(</span><span class="token string">'../data/my_table_special_sep.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\|\|\|\|'</span><span class="token punctuation">,</span> engine<span class="token operator">=</span><span class="token string">'python'</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col1</th><th>col2</th></tr></thead><tbody><tr><th>0</th><td>TS</td><td>This is an apple.</td></tr><tr><th>1</th><td>GQ</td><td>My name is Bob.</td></tr><tr><th>2</th><td>WT</td><td>Well done!</td></tr><tr><th>3</th><td>PT</td><td>May I help you?</td></tr></tbody></table> 
<h5><a id="WARNINGsep_685"></a>【WARNING】<code>sep</code>是正则参数</h5> 
<p>在使用<code>read_table</code>的时候需要注意，参数<code>sep</code>中使用的是正则表达式，因此需要对<code>|</code>进行转义变成<code>\|</code>，否则无法读取到正确的结果。有关正则表达式的基本内容可以参考第八章或者其他相关资料。</p> 
<h5><a id="END_689"></a>【END】</h5> 
<h4><a id="2__691"></a>2. 数据写入</h4> 
<p>一般在数据写入中，最常用的操作是把<code>index</code>设置为<code>False</code>，特别当索引没有特殊意义的时候，这样的行为能把索引在保存的时候去除。</p> 
<pre><code class="prism language-python">df_csv<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'../data/my_csv_saved.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
df_excel<span class="token punctuation">.</span>to_excel<span class="token punctuation">(</span><span class="token string">'../data/my_excel_saved.xlsx'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>pandas</code>中没有定义<code>to_table</code>函数，但是<code>to_csv</code>可以保存为<code>txt</code>文件，并且允许自定义分隔符，常用制表符<code>\t</code>分割：</p> 
<pre><code class="prism language-python">df_txt<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'../data/my_txt_saved.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果想要把表格快速转换为<code>markdown</code>和<code>latex</code>语言，可以使用<code>to_markdown</code>和<code>to_latex</code>函数，此处需要安装<code>tabulate</code>包。</p> 
<pre><code class="prism language-python">!pip install tabulate
</code></pre> 
<pre><code>Collecting tabulate
  Downloading https://files.pythonhosted.org/packages/c4/f4/770ae9385990f5a19a91431163d262182d3203662ea2b5739d0fcfc080f1/tabulate-0.8.7-py3-none-any.whl
Installing collected packages: tabulate
Successfully installed tabulate-0.8.7
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>df_csv<span class="token punctuation">.</span>to_markdown<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>|    |   col1 | col2   |   col3 | col4   | col5     |
|---:|-------:|:-------|-------:|:-------|:---------|
|  0 |      2 | a      |    1.4 | apple  | 2020/1/1 |
|  1 |      3 | b      |    3.4 | banana | 2020/1/2 |
|  2 |      6 | c      |    2.5 | orange | 2020/1/5 |
|  3 |      5 | d      |    3.2 | lemon  | 2020/1/7 |
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>df_csv<span class="token punctuation">.</span>to_latex<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>\begin{tabular}{lrlrll}
\toprule
{} &amp;  col1 &amp; col2 &amp;  col3 &amp;    col4 &amp;      col5 \\
\midrule
0 &amp;     2 &amp;    a &amp;   1.4 &amp;   apple &amp;  2020/1/1 \\
1 &amp;     3 &amp;    b &amp;   3.4 &amp;  banana &amp;  2020/1/2 \\
2 &amp;     6 &amp;    c &amp;   2.5 &amp;  orange &amp;  2020/1/5 \\
3 &amp;     5 &amp;    d &amp;   3.2 &amp;   lemon &amp;  2020/1/7 \\
\bottomrule
\end{tabular}
</code></pre> 
<h3><a id="_752"></a>二、基本数据结构</h3> 
<p><code>pandas</code>中具有两种基本的数据存储结构，存储一维<code>values</code>的<code>Series</code>和存储二维<code>values</code>的<code>DataFrame</code>，在这两种结构上定义了很多的属性和方法。</p> 
<h4><a id="1_Series_755"></a>1. Series</h4> 
<p><code>Series</code>一般由四个部分组成，分别是序列的值<code>data</code>、索引<code>index</code>、存储类型<code>dtype</code>、序列的名字<code>name</code>。其中，索引也可以指定它的名字，默认为空。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'dic1'</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              index <span class="token operator">=</span> pd<span class="token punctuation">.</span>Index<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id1'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'third'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'my_idx'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              dtype <span class="token operator">=</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
              name <span class="token operator">=</span> <span class="token string">'my_name'</span><span class="token punctuation">)</span>
s
</code></pre> 
<pre><code>my_idx
id1              100
20                 a
third    {'dic1': 5}
Name: my_name, dtype: object
</code></pre> 
<h5><a id="NOTEobject_778"></a>【NOTE】<code>object</code>类型</h5> 
<p><code>object</code>代表了一种混合类型，正如上面的例子中存储了整数、字符串以及<code>Python</code>的字典数据结构。此外，目前<code>pandas</code>把纯字符串序列也默认认为是一种<code>object</code>类型的序列，但它也可以用<code>string</code>类型存储，文本序列的内容会在第八章中讨论。</p> 
<h5><a id="END_782"></a>【END】</h5> 
<p>对于这些属性，可以通过 . 的方式来获取：</p> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>values
</code></pre> 
<pre><code>array([100, 'a', {'dic1': 5}], dtype=object)
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>index
</code></pre> 
<pre><code>Index(['id1', 20, 'third'], dtype='object', name='my_idx')
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>dtype
</code></pre> 
<pre><code>dtype('O')
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>name
</code></pre> 
<pre><code>'my_name'
</code></pre> 
<p>利用<code>.shape</code>可以获取序列的长度：</p> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code>(3,)
</code></pre> 
<p>索引是<code>pandas</code>中最重要的概念之一，它将在第三章中被详细地讨论。如果想要取出单个索引对应的值，可以通过<code>[index_item]</code>可以取出。</p> 
<h4><a id="2_DataFrame_850"></a>2. DataFrame</h4> 
<p><code>DataFrame</code>在<code>Series</code>的基础上增加了列索引，一个数据框可以由二维的<code>data</code>与行列索引来构造：</p> 
<pre><code class="prism language-python">data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data <span class="token operator">=</span> data<span class="token punctuation">,</span>
                  index <span class="token operator">=</span> <span class="token punctuation">[</span>f<span class="token string">'row_{i}'</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                  columns<span class="token operator">=</span><span class="token punctuation">[</span>f<span class="token string">'col_{i}'</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col_0</th><th>col_1</th><th>col_2</th></tr></thead><tbody><tr><th>row_0</th><td>1</td><td>a</td><td>1.2</td></tr><tr><th>row_1</th><td>2</td><td>b</td><td>2.2</td></tr><tr><th>row_2</th><td>3</td><td>c</td><td>3.2</td></tr></tbody></table> 
<p>但一般而言，更多的时候会采用从列索引名到数据的映射来构造数据框，同时再加上行索引：</p> 
<pre><code class="prism language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'col_0'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          <span class="token string">'col_1'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token string">'abc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          <span class="token string">'col_2'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                  index <span class="token operator">=</span> <span class="token punctuation">[</span>f<span class="token string">'row_{i}'</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col_0</th><th>col_1</th><th>col_2</th></tr></thead><tbody><tr><th>row_0</th><td>1</td><td>a</td><td>1.2</td></tr><tr><th>row_1</th><td>2</td><td>b</td><td>2.2</td></tr><tr><th>row_2</th><td>3</td><td>c</td><td>3.2</td></tr></tbody></table> 
<p>由于这种映射关系，在<code>DataFrame</code>中可以用<code>[col_name]</code>与<code>[col_list]</code>来取出相应的列与由多个列组成的表，结果分别为<code>Series</code>和<code>DataFrame</code>：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'col_0'</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>row_0    1
row_1    2
row_2    3
Name: col_0, dtype: int64
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'col_0'</span><span class="token punctuation">,</span> <span class="token string">'col_1'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>col_0</th><th>col_1</th></tr></thead><tbody><tr><th>row_0</th><td>1</td><td>a</td></tr><tr><th>row_1</th><td>2</td><td>b</td></tr><tr><th>row_2</th><td>3</td><td>c</td></tr></tbody></table> 
<p>与<code>Series</code>类似，在数据框中同样可以取出相应的属性：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>values
</code></pre> 
<pre><code>array([[1, 'a', 1.2],
       [2, 'b', 2.2],
       [3, 'c', 3.2]], dtype=object)
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>index
</code></pre> 
<pre><code>Index(['row_0', 'row_1', 'row_2'], dtype='object')
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>columns
</code></pre> 
<pre><code>Index(['col_0', 'col_1', 'col_2'], dtype='object')
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>dtypes <span class="token comment"># 返回的是值为相应列数据类型的Series</span>
</code></pre> 
<pre><code>col_0      int64
col_1     object
col_2    float64
dtype: object
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code>(3, 3)
</code></pre> 
<p>通过<code>.T</code>可以把<code>DataFrame</code>进行转置：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>T
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>row_0</th><th>row_1</th><th>row_2</th></tr></thead><tbody><tr><th>col_0</th><td>1</td><td>2</td><td>3</td></tr><tr><th>col_1</th><td>a</td><td>b</td><td>c</td></tr><tr><th>col_2</th><td>1.2</td><td>2.2</td><td>3.2</td></tr></tbody></table> 
<h3><a id="_1169"></a>三、常用基本函数</h3> 
<p>为了进行举例说明，在接下来的部分和其余章节都将会使用一份<code>learn_pandas.csv</code>的虚拟数据集，它记录了四所学校学生的体测个人信息。</p> 
<pre><code class="prism language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../data/learn_pandas.csv'</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>columns
</code></pre> 
<pre><code>Index(['School', 'Grade', 'Name', 'Gender', 'Height', 'Weight', 'Transfer',
       'Test_Number', 'Test_Date', 'Time_Record'],
      dtype='object')
</code></pre> 
<p>上述列名依次代表学校、年级、姓名、性别、身高、体重、是否为转系生、体测场次、测试时间、1000米成绩，本章只需使用其中的前七列。</p> 
<pre><code class="prism language-python">df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="1__1194"></a>1. 汇总函数</h4> 
<p><code>head, tail</code>函数分别表示返回表或者序列的前<code>n</code>行和后<code>n</code>行，其中<code>n</code>默认为<code>5</code>：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>School</th><th>Grade</th><th>Name</th><th>Gender</th><th>Height</th><th>Weight</th><th>Transfer</th></tr></thead><tbody><tr><th>0</th><td>Shanghai Jiao Tong University</td><td>Freshman</td><td>Gaopeng Yang</td><td>Female</td><td>158.9</td><td>46.0</td><td>N</td></tr><tr><th>1</th><td>Peking University</td><td>Freshman</td><td>Changqiang You</td><td>Male</td><td>166.5</td><td>70.0</td><td>N</td></tr></tbody></table> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>School</th><th>Grade</th><th>Name</th><th>Gender</th><th>Height</th><th>Weight</th><th>Transfer</th></tr></thead><tbody><tr><th>197</th><td>Shanghai Jiao Tong University</td><td>Senior</td><td>Chengqiang Chu</td><td>Female</td><td>153.9</td><td>45.0</td><td>N</td></tr><tr><th>198</th><td>Shanghai Jiao Tong University</td><td>Senior</td><td>Chengmei Shen</td><td>Male</td><td>175.3</td><td>71.0</td><td>N</td></tr><tr><th>199</th><td>Tsinghua University</td><td>Sophomore</td><td>Chunpeng Lv</td><td>Male</td><td>155.7</td><td>51.0</td><td>N</td></tr></tbody></table> 
<p><code>info, describe</code>分别返回表的信息概况和表中数值列对应的主要统计量 ：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 200 entries, 0 to 199
Data columns (total 7 columns):
 #   Column    Non-Null Count  Dtype  
---  ------    --------------  -----  
 0   School    200 non-null    object 
 1   Grade     200 non-null    object 
 2   Name      200 non-null    object 
 3   Gender    200 non-null    object 
 4   Height    183 non-null    float64
 5   Weight    189 non-null    float64
 6   Transfer  188 non-null    object 
dtypes: float64(2), object(5)
memory usage: 11.1+ KB
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Height</th><th>Weight</th></tr></thead><tbody><tr><th>count</th><td>183.000000</td><td>189.000000</td></tr><tr><th>mean</th><td>163.218033</td><td>55.015873</td></tr><tr><th>std</th><td>8.608879</td><td>12.824294</td></tr><tr><th>min</th><td>145.400000</td><td>34.000000</td></tr><tr><th>25%</th><td>157.150000</td><td>46.000000</td></tr><tr><th>50%</th><td>161.900000</td><td>51.000000</td></tr><tr><th>75%</th><td>167.500000</td><td>65.000000</td></tr><tr><th>max</th><td>193.900000</td><td>89.000000</td></tr></tbody></table> 
<h5><a id="NOTE_1431"></a>【NOTE】更全面的数据汇总</h5> 
<p><code>info, describe</code>只能实现较少信息的展示，如果想要对一份数据集进行全面且有效的观察，特别是在列较多的情况下，推荐使用<a href="https://pandas-profiling.github.io/pandas-profiling/docs/" rel="nofollow">pandas-profiling</a>包，它将在第十一章被再次提到。</p> 
<h5><a id="END_1435"></a>【END】</h5> 
<h4><a id="2__1437"></a>2. 特征统计函数</h4> 
<p>在<code>Series</code>和<code>DataFrame</code>上定义了许多统计函数，最常见的是<code>sum, mean, median, var, std, max, min</code>。例如，选出身高和体重列进行演示：</p> 
<pre><code class="prism language-python">df_demo <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Height'</span><span class="token punctuation">,</span> <span class="token string">'Weight'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
df_demo<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height    163.218033
Weight     55.015873
dtype: float64
</code></pre> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height    193.9
Weight     89.0
dtype: float64
</code></pre> 
<p>此外，需要介绍的是<code>quantile, count, idxmax</code>这三个函数，它们分别返回的是分位数、非缺失值个数、最大值对应的索引：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>quantile<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height    157.15
Weight     46.00
Name: 0.25, dtype: float64
</code></pre> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height    183
Weight    189
dtype: int64
</code></pre> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>idxmax<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># idxmin函数是对应的索引</span>
</code></pre> 
<pre><code>Height    193
Weight      2
dtype: int64
</code></pre> 
<p>上面这些所有的函数，由于操作后返回的是标量，所以又称为聚合函数，它们有一个公共参数<code>axis</code>，默认为0代表逐列聚合，如果设置为1则表示逐行聚合：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 在这个数据集上体重和身高的均值并没有意义</span>
</code></pre> 
<pre><code>0    102.45
1    118.25
2    138.95
3     41.00
4    124.00
dtype: float64
</code></pre> 
<h4><a id="3__1532"></a>3. 唯一值函数</h4> 
<p>对序列使用<code>unique</code>和<code>nunique</code>可以分别得到其唯一值组成的列表和唯一值的个数：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'School'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array(['Shanghai Jiao Tong University', 'Peking University',
       'Fudan University', 'Tsinghua University'], dtype=object)
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'School'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>4
</code></pre> 
<p><code>value_counts</code>可以得到唯一值和其对应出现的频数：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'School'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Tsinghua University              69
Shanghai Jiao Tong University    57
Fudan University                 40
Peking University                34
Name: School, dtype: int64
</code></pre> 
<p>如果想要观察多个列组合的唯一值，可以使用<code>drop_duplicates</code>。其中的关键参数是<code>keep</code>，默认值<code>first</code>表示每个组合保留第一次出现的所在行，<code>last</code>表示保留最后一次出现的所在行，<code>False</code>表示把所有重复组合所在的行剔除。</p> 
<pre><code class="prism language-python">df_demo <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Gender'</span><span class="token punctuation">,</span><span class="token string">'Transfer'</span><span class="token punctuation">,</span><span class="token string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
df_demo<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Gender'</span><span class="token punctuation">,</span> <span class="token string">'Transfer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Gender</th><th>Transfer</th><th>Name</th></tr></thead><tbody><tr><th>0</th><td>Female</td><td>N</td><td>Gaopeng Yang</td></tr><tr><th>1</th><td>Male</td><td>N</td><td>Changqiang You</td></tr><tr><th>12</th><td>Female</td><td>NaN</td><td>Peng You</td></tr><tr><th>21</th><td>Male</td><td>NaN</td><td>Xiaopeng Shen</td></tr><tr><th>36</th><td>Male</td><td>Y</td><td>Xiaojuan Qin</td></tr><tr><th>43</th><td>Female</td><td>Y</td><td>Gaoli Feng</td></tr></tbody></table> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Gender'</span><span class="token punctuation">,</span> <span class="token string">'Transfer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keep<span class="token operator">=</span><span class="token string">'last'</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Gender</th><th>Transfer</th><th>Name</th></tr></thead><tbody><tr><th>147</th><td>Male</td><td>NaN</td><td>Juan You</td></tr><tr><th>150</th><td>Male</td><td>Y</td><td>Chengpeng You</td></tr><tr><th>169</th><td>Female</td><td>Y</td><td>Chengquan Qin</td></tr><tr><th>194</th><td>Female</td><td>NaN</td><td>Yanmei Qian</td></tr><tr><th>197</th><td>Female</td><td>N</td><td>Chengqiang Chu</td></tr><tr><th>199</th><td>Male</td><td>N</td><td>Chunpeng Lv</td></tr></tbody></table> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">,</span> <span class="token string">'Gender'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keep<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 保留只出现过一次的性别和姓名组合</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Gender</th><th>Transfer</th><th>Name</th></tr></thead><tbody><tr><th>0</th><td>Female</td><td>N</td><td>Gaopeng Yang</td></tr><tr><th>1</th><td>Male</td><td>N</td><td>Changqiang You</td></tr><tr><th>2</th><td>Male</td><td>N</td><td>Mei Sun</td></tr><tr><th>4</th><td>Male</td><td>N</td><td>Gaojuan You</td></tr><tr><th>5</th><td>Female</td><td>N</td><td>Xiaoli Qian</td></tr></tbody></table> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'School'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 在Series上也可以使用</span>
</code></pre> 
<pre><code>0    Shanghai Jiao Tong University
1                Peking University
3                 Fudan University
5              Tsinghua University
Name: School, dtype: object
</code></pre> 
<p>此外，<code>duplicated</code>和<code>drop_duplicates</code>的功能类似，但前者返回了是否为唯一值的布尔列表，其<code>keep</code>参数与后者一致。其返回的序列，把重复元素设为<code>True</code>，否则为<code>False</code>。 <code>drop_duplicates</code>等价于把<code>duplicated</code>为<code>True</code>的对应行剔除。</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>duplicated<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Gender'</span><span class="token punctuation">,</span> <span class="token string">'Transfer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    False
1    False
2     True
3     True
4     True
dtype: bool
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'School'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>duplicated<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 在Series上也可以使用</span>
</code></pre> 
<pre><code>0    False
1    False
2     True
3    False
4     True
Name: School, dtype: bool
</code></pre> 
<h4><a id="4__1849"></a>4. 替换函数</h4> 
<p>一般而言，替换操作是针对某一个列进行的，因此下面的例子都以<code>Series</code>举例。<code>pandas</code>中的替换函数可以归纳为三类：映射替换、逻辑替换、数值替换。其中映射替换包含<code>replace</code>方法、第八章中的<code>str.replace</code>方法以及第九章中的<code>cat.codes</code>方法，此处介绍<code>replace</code>的用法。</p> 
<p>在<code>replace</code>中，可以通过字典构造，或者传入两个列表来进行替换：</p> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'Gender'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'Female'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Male'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    0
1    1
2    1
3    0
4    1
Name: Gender, dtype: int64
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'Gender'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Female'</span><span class="token punctuation">,</span> <span class="token string">'Male'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    0
1    1
2    1
3    0
4    1
Name: Gender, dtype: int64
</code></pre> 
<p>另外，<code>replace</code>还有一种特殊的方向替换，指定<code>method</code>参数为<code>ffill</code>则为用前面一个最近的未被替换的值进行替换，<code>bfill</code>则使用后面最近的未被替换的值进行替换。从下面的例子可以看到，它们的结果是不同的：</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'ffill'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    a
1    a
2    b
3    b
4    b
5    b
6    a
dtype: object
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'bfill'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    a
1    b
2    b
3    a
4    a
5    a
6    a
dtype: object
</code></pre> 
<h5><a id="WARNINGstrreplace_1929"></a>【WARNING】正则替换请使用<code>str.replace</code></h5> 
<p>虽然对于<code>replace</code>而言可以使用正则替换，但是当前版本下对于<code>string</code>类型的正则替换还存在<code>bug</code>，因此如有此需求，请选择<code>str.replace</code>进行替换操作，具体的方式将在第八章中讲解。</p> 
<h5><a id="END_1933"></a>【END】</h5> 
<p>逻辑替换包括了<code>where</code>和<code>mask</code>，这两个函数是完全对称的：<code>where</code>函数在传入条件为<code>False</code>的对应行进行替换，而<code>mask</code>在传入条件为<code>True</code>的对应行进行替换，当不指定替换值时，替换为缺失值。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1.2345</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>where<span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    -1.0
1     NaN
2     NaN
3   -50.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>where<span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     -1.0
1    100.0
2    100.0
3    -50.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>mask<span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0         NaN
1      1.2345
2    100.0000
3         NaN
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>mask<span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    -50.0000
1      1.2345
2    100.0000
3    -50.0000
dtype: float64
</code></pre> 
<p>需要注意的是，传入的条件只需是与被调用的<code>Series</code>索引一致的布尔序列即可：</p> 
<pre><code class="prism language-python">s_condition<span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">]</span><span class="token punctuation">,</span>index<span class="token operator">=</span>s<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>mask<span class="token punctuation">(</span>s_condition<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    -50.0000
1      1.2345
2    100.0000
3    -50.0000
dtype: float64
</code></pre> 
<p>数值替换包含了<code>round, abs, clip</code>方法，它们分别表示取整、取绝对值和截断：</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1.2345</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     -1.00
1      1.23
2    100.00
3    -50.00
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0      1.0000
1      1.2345
2    100.0000
3     50.0000
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># 前两个数分别表示上下截断边界</span>
</code></pre> 
<h3><a id="__01_2061"></a>【练一练 - 01】</h3> 
<p>在 clip 中，超过边界的只能截断为边界值，如果要把超出边界的替换为自定义的值，应当如何做？</p> 
<h6><a id="My_solution__2065"></a>My solution :</h6> 
<ul><li>可以用逻辑替换<code>where</code>或<code>mask</code>代替<code>clip</code> , 先用<code>condition</code>分别筛选出截断边界以外的值 , 再替换</li></ul> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1.2345</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>s<span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    -1.0000
1     1.2345
2    20.0000
3    20.0000
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>mask<span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    -1.0000
1     1.2345
2    20.0000
3    20.0000
dtype: float64
</code></pre> 
<h5><a id="END_2101"></a>【END】</h5> 
<h4><a id="5__2103"></a>5. 排序函数</h4> 
<p>排序共有两种方式，其一为值排序，其二为索引排序，对应的函数是<code>sort_values</code>和<code>sort_index</code>。</p> 
<p>为了演示排序函数，下面先利用<code>set_index</code>方法把年级和姓名两列作为索引，多级索引的内容和索引设置的方法将在第三章进行详细讲解。</p> 
<pre><code class="prism language-python">df_demo <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Grade'</span><span class="token punctuation">,</span> <span class="token string">'Name'</span><span class="token punctuation">,</span> <span class="token string">'Height'</span><span class="token punctuation">,</span> <span class="token string">'Weight'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Grade'</span><span class="token punctuation">,</span><span class="token string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df_demo<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th></th><th>Height</th><th>Weight</th></tr><tr><th>Grade</th><th>Name</th><th></th><th></th></tr></thead><tbody><tr><th rowspan="2">Freshman</th><th>Gaopeng Yang</th><td>158.9</td><td>46.0</td></tr><tr><th>Changqiang You</th><td>166.5</td><td>70.0</td></tr><tr><th>Senior</th><th>Mei Sun</th><td>188.9</td><td>89.0</td></tr></tbody></table> 
<p>对身高进行排序，默认参数<code>ascending=True</code>为升序：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'Height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th></th><th>Height</th><th>Weight</th></tr><tr><th>Grade</th><th>Name</th><th></th><th></th></tr></thead><tbody><tr><th>Junior</th><th>Xiaoli Chu</th><td>145.4</td><td>34.0</td></tr><tr><th>Senior</th><th>Gaomei Lv</th><td>147.3</td><td>34.0</td></tr><tr><th>Sophomore</th><th>Peng Han</th><td>147.8</td><td>34.0</td></tr><tr><th>Senior</th><th>Changli Lv</th><td>148.7</td><td>41.0</td></tr><tr><th>Sophomore</th><th>Changjuan You</th><td>150.5</td><td>40.0</td></tr></tbody></table> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'Height'</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th></th><th>Height</th><th>Weight</th></tr><tr><th>Grade</th><th>Name</th><th></th><th></th></tr></thead><tbody><tr><th rowspan="3">Senior</th><th>Xiaoqiang Qin</th><td>193.9</td><td>79.0</td></tr><tr><th>Mei Sun</th><td>188.9</td><td>89.0</td></tr><tr><th>Gaoli Zhao</th><td>186.5</td><td>83.0</td></tr><tr><th>Freshman</th><th>Qiang Han</th><td>185.3</td><td>87.0</td></tr><tr><th>Senior</th><th>Qiang Zheng</th><td>183.9</td><td>87.0</td></tr></tbody></table> 
<p>在排序中，经常遇到多列排序的问题，比如在体重相同的情况下，对身高进行排序，并且保持身高降序排列，体重升序排列：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Weight'</span><span class="token punctuation">,</span><span class="token string">'Height'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ascending<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th></th><th>Height</th><th>Weight</th></tr><tr><th>Grade</th><th>Name</th><th></th><th></th></tr></thead><tbody><tr><th>Sophomore</th><th>Peng Han</th><td>147.8</td><td>34.0</td></tr><tr><th>Senior</th><th>Gaomei Lv</th><td>147.3</td><td>34.0</td></tr><tr><th>Junior</th><th>Xiaoli Chu</th><td>145.4</td><td>34.0</td></tr><tr><th>Sophomore</th><th>Qiang Zhou</th><td>150.5</td><td>36.0</td></tr><tr><th>Freshman</th><th>Yanqiang Xu</th><td>152.4</td><td>38.0</td></tr></tbody></table> 
<p>索引排序的用法和值排序完全一致，只不过元素的值在索引中，此时需要指定索引层的名字或者层号，用参数<code>level</code>表示。另外，需要注意的是字符串的排列顺序由字母顺序决定。</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span>level<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Grade'</span><span class="token punctuation">,</span><span class="token string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ascending<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th></th><th>Height</th><th>Weight</th></tr><tr><th>Grade</th><th>Name</th><th></th><th></th></tr></thead><tbody><tr><th rowspan="5">Freshman</th><th>Yanquan Wang</th><td>163.5</td><td>55.0</td></tr><tr><th>Yanqiang Xu</th><td>152.4</td><td>38.0</td></tr><tr><th>Yanqiang Feng</th><td>162.3</td><td>51.0</td></tr><tr><th>Yanpeng Lv</th><td>NaN</td><td>65.0</td></tr><tr><th>Yanli Zhang</th><td>165.1</td><td>52.0</td></tr></tbody></table> 
<h4><a id="6_apply_2466"></a>6. apply方法</h4> 
<p><code>apply</code>方法常用于<code>DataFrame</code>的行迭代或者列迭代，它的<code>axis</code>含义与第2小节中的统计聚合函数一致，<code>apply</code>的参数往往是一个以序列为输入的函数。例如对于<code>.mean()</code>，使用<code>apply</code>可以如下地写出：</p> 
<pre><code class="prism language-python">df_demo <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Height'</span><span class="token punctuation">,</span> <span class="token string">'Weight'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">my_mean</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
     res <span class="token operator">=</span> x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> res
df_demo<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>my_mean<span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height    163.218033
Weight     55.015873
dtype: float64
</code></pre> 
<p>同样的，可以利用<code>lambda</code>表达式使得书写简洁，这里的<code>x</code>就指代被调用的<code>df_demo</code>表中逐个输入的序列：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height    163.218033
Weight     55.015873
dtype: float64
</code></pre> 
<p>若指定<code>axis=1</code>，那么每次传入函数的就是行元素组成的<code>Series</code>，其结果与之前的逐行均值结果一致。</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    102.45
1    118.25
2    138.95
3     41.00
4    124.00
dtype: float64
</code></pre> 
<p>这里再举一个例子：<code>mad</code>(Mean Absolute Deviation)函数返回的是一个序列中偏离该序列均值的绝对值大小的均值，例如序列1,3,7,10中，均值为5.25，每一个元素偏离的绝对值为4.25,2.25,1.75,4.75，这个偏离序列的均值为3.25。现在利用<code>apply</code>计算升高和体重的<code>mad</code>指标：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span>x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height     6.707229
Weight    10.391870
dtype: float64
</code></pre> 
<p>这与使用内置的<code>mad</code>函数计算结果一致：</p> 
<pre><code class="prism language-python">df_demo<span class="token punctuation">.</span>mad<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Height     6.707229
Weight    10.391870
dtype: float64
</code></pre> 
<h5><a id="WARNINGapply_2554"></a>【WARNING】谨慎使用<code>apply</code></h5> 
<p>得益于传入自定义函数的处理，<code>apply</code>的自由度很高，但这是以性能为代价的。一般而言，使用<code>pandas</code>的内置函数处理和<code>apply</code>来处理同一个任务，其速度会相差较多，因此只有在确实存在自定义需求的情境下才考虑使用<code>apply</code>。</p> 
<h5><a id="END_2558"></a>【END】</h5> 
<h3><a id="_2560"></a>四、窗口对象</h3> 
<p><code>pandas</code>中有3类窗口，分别是滑动窗口<code>rolling</code>、扩张窗口<code>expanding</code>以及指数加权窗口<code>ewm</code>(Exponentially Weighted Moving)。需要说明的是，以日期偏置为窗口大小的滑动窗口将在第十章讨论，指数加权窗口见本章练习。</p> 
<h4><a id="1__2563"></a>1. 滑窗对象</h4> 
<p>要使用滑窗函数，就必须先要对一个序列使用<code>.rolling</code>得到滑窗对象，其最重要的参数为窗口大小<code>window</code>。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
roller <span class="token operator">=</span> s<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
roller
</code></pre> 
<pre><code>Rolling [window=3,center=False,axis=0]
</code></pre> 
<p>在得到了滑窗对象后，能够使用相应的聚合函数进行计算，需要注意的是窗口包含当前行所在的元素，例如在第四个位置进行均值运算时，应当计算(2+3+4)/3，而不是(1+2+3)/3：</p> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    NaN
1    NaN
2    2.0
3    3.0
4    4.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     NaN
1     NaN
2     6.0
3     9.0
4    12.0
dtype: float64
</code></pre> 
<p>对于滑动相关系数或滑动协方差的计算，可以如下写出：</p> 
<pre><code class="prism language-python">s2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
roller<span class="token punctuation">.</span>cov<span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     NaN
1     NaN
2     2.5
3     7.0
4    12.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span>corr<span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0         NaN
1         NaN
2    0.944911
3    0.970725
4    0.995402
dtype: float64
</code></pre> 
<p>此外，还支持使用<code>apply</code>传入自定义函数，其传入值是对应窗口的<code>Series</code>，例如上述的均值函数可以等效表示：</p> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    NaN
1    NaN
2    2.0
3    3.0
4    4.0
dtype: float64
</code></pre> 
<p><code>shift, diff, pct_change</code>是一组类滑窗函数，它们的公共参数为<code>periods=n</code>，默认为1，分别表示取向前第<code>n</code>个元素的值、与向前第<code>n</code>个元素做差（与<code>Numpy</code>中不同，后者表示<code>n</code>阶差分）、与向前第<code>n</code>个元素相比计算增长率。这里的<code>n</code>可以为负，表示反方向的类似操作。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    NaN
1    NaN
2    1.0
3    3.0
4    6.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     NaN
1     NaN
2     NaN
3     9.0
4    12.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0         NaN
1    2.000000
2    1.000000
3    0.666667
4    0.500000
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     3.0
1     6.0
2    10.0
3    15.0
4     NaN
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0   -5.0
1   -7.0
2   -9.0
3    NaN
4    NaN
dtype: float64
</code></pre> 
<p>将其视作类滑窗函数的原因是，它们的功能可以用窗口大小为<code>n+1</code>的<code>rolling</code>方法等价代替：</p> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token operator">*</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># s.shift(2)</span>
</code></pre> 
<pre><code>0    NaN
1    NaN
2    1.0
3    3.0
4    6.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python"> s<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token operator">*</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token operator">*</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># s.diff(3)</span>
</code></pre> 
<pre><code>0     NaN
1     NaN
2     NaN
3     9.0
4    12.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">my_pct</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
     L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>x<span class="token punctuation">]</span>
     <span class="token keyword">return</span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">/</span>L<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span>
s<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>my_pct<span class="token punctuation">)</span> <span class="token comment"># s.pct_change()</span>
</code></pre> 
<pre><code>0         NaN
1    2.000000
2    1.000000
3    0.666667
4    0.500000
dtype: float64
</code></pre> 
<h3><a id="__02_2816"></a>【练一练 - 02】</h3> 
<p><code>rolling</code>对象的默认窗口方向都是向前的，某些情况下用户需要向后的窗口，例如对1,2,3设定向后窗口为2的<code>sum</code>操作，结果为3,5,NaN，此时应该如何实现向后的滑窗操作？（提示：使用<code>shift</code>）</p> 
<h6><a id="My_solution__2820"></a>My_solution :</h6> 
<p>方法一 :</p> 
<ul><li><code>shift</code>操作相当于偏移取数 , 并且是按原数组长度取 , 只取一次</li><li><code>rolling</code>相当于滑动取数 , 每一次滑动就是一个<code>shift</code>操作 , 但是要按<code>window</code>数目截断 , 这样的偏移截断取数总共要取<code>lenth</code>(数组的长度)次 , 生成的<code>roller</code>对象是一个<code>window*lenth</code>的二维数表</li><li>先构造一个向后<code>lenth</code>次<code>shift</code>的表 :</li></ul> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>i <span class="token punctuation">:</span> s<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
df
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th></tr></thead><tbody><tr><th>0</th><td>1</td><td>2.0</td><td>3.0</td><td>4.0</td><td>5.0</td></tr><tr><th>1</th><td>2</td><td>3.0</td><td>4.0</td><td>5.0</td><td>NaN</td></tr><tr><th>2</th><td>3</td><td>4.0</td><td>5.0</td><td>NaN</td><td>NaN</td></tr><tr><th>3</th><td>4</td><td>5.0</td><td>NaN</td><td>NaN</td><td>NaN</td></tr><tr><th>4</th><td>5</td><td>NaN</td><td>NaN</td><td>NaN</td><td>NaN</td></tr></tbody></table> 
<ul><li>再按window数目截断 :</li></ul> 
<pre><code class="prism language-python">window <span class="token operator">=</span> <span class="token number">3</span>
roller <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">:</span>window<span class="token punctuation">]</span>
roller
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th></tr></thead><tbody><tr><th>0</th><td>1</td><td>2.0</td><td>3.0</td><td>4.0</td><td>5.0</td></tr><tr><th>1</th><td>2</td><td>3.0</td><td>4.0</td><td>5.0</td><td>NaN</td></tr><tr><th>2</th><td>3</td><td>4.0</td><td>5.0</td><td>NaN</td><td>NaN</td></tr></tbody></table> 
<ul><li>按理说 , 这时候只要调一下sum函数 , 就能实现求和 , 但是这里有个坑</li><li>由于内置<code>rolling</code>方法调用的<code>sum</code>默认参数是<code>not skip NaN</code>的 , 而<code>Dataframe</code>调用<code>sum</code>是<code>skip NaN</code>的</li><li>这样就导致自定义的<code>roller</code>调用<code>sum</code>会把<code>NaN</code>当成<code>0</code>计算 , 如下 :</li></ul> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     6.0
1     9.0
2    12.0
3     9.0
4     5.0
dtype: float64
</code></pre> 
<ul><li>此时有两种方法可以实现内置<code>rolling</code>的计算效果</li><li> 
  <ol><li>将<code>sum</code>参数<code>skipna</code>设置为<code>False</code></li></ol> </li><li> 
  <ol start="2"><li>将<code>sum</code>参数<code>min_count</code>设置为<code>window</code>数目</li></ol> </li></ul> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>skipna <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     6.0
1     9.0
2    12.0
3     NaN
4     NaN
dtype: float64
</code></pre> 
<pre><code class="prism language-python">roller<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>min_count <span class="token operator">=</span> window<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     6.0
1     9.0
2    12.0
3     NaN
4     NaN
dtype: float64
</code></pre> 
<ul><li>将上述过程封装成方法 :</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">back_rolling</span><span class="token punctuation">(</span>s <span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>i <span class="token punctuation">:</span> s<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>window<span class="token punctuation">]</span>
roller <span class="token operator">=</span> back_rolling<span class="token punctuation">(</span>s <span class="token punctuation">,</span> window<span class="token punctuation">)</span>
roller<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>skipna <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     6.0
1     9.0
2    12.0
3     NaN
4     NaN
dtype: float64
</code></pre> 
<p>方法二 :</p> 
<ul><li>还有一种更简便的思路 , 内置<code>rolling</code>方法是向前滑窗的 , 根据加引号的<code>"相对论"</code> , 我们只要把<code>series</code>倒过来 , 那么相对<code>rolling</code>来说就是向后滑窗的 , 但要记得<code>rolling</code>完事再倒回来</li></ul> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
roller <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
roller<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>0     6.0
1     9.0
2    12.0
3     NaN
4     NaN
dtype: float64
</code></pre> 
<h5><a id="END_3079"></a>【END】</h5> 
<h4><a id="2__3081"></a>2. 扩张窗口</h4> 
<p>扩张窗口又称累计窗口，可以理解为一个动态长度的窗口，其窗口的大小就是从序列开始处到具体操作的对应位置，其使用的聚合函数会作用于这些逐步扩张的窗口上。具体地说，设序列为a1, a2, a3, a4，则其每个位置对应的窗口即[a1]、[a1, a2]、[a1, a2, a3]、[a1, a2, a3, a4]。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>expanding<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    1.000000
1    2.000000
2    3.333333
3    5.000000
dtype: float64
</code></pre> 
<h3><a id="__03_3101"></a>【练一练 - 03】</h3> 
<p><code>cummax, cumsum, cumprod</code>函数是典型的类扩张窗口函数，请使用<code>expanding</code>对象依次实现它们。</p> 
<h6><a id="My_solution__3105"></a>My solution :</h6> 
<ul><li>根据<code>cummax</code> , <code>cumsum</code> , <code>cumprod</code>的定义 , 就是将序列先<code>expanding</code>再分别求<code>max</code> , <code>sum</code> , <code>prod</code></li><li>因此只需将<code>expanding</code>后的对象继续调用相应的聚合函数即可</li></ul> 
<pre><code class="prism language-python">s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>expanding<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    1.0
1    2.0
2    5.0
3    5.0
4    5.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>expanding<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0     1.0
1     3.0
2     8.0
3    11.0
4    15.0
dtype: float64
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    s<span class="token punctuation">.</span>expanding<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
</code></pre> 
<pre><code>'Expanding' object has no attribute 'prod'
</code></pre> 
<ul><li>糟糕 , <code>expanding</code>对象里没有<code>prod</code>方法 , 那就先转成<code>DataFrame</code>就有了 :</li></ul> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">*</span>s<span class="token punctuation">.</span>expanding<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0      1.0
1      2.0
2     10.0
3     30.0
4    120.0
dtype: float64
</code></pre> 
<h5><a id="END_3174"></a>【END】</h5> 
<h3><a id="_3176"></a>五、练习</h3> 
<h4><a id="Ex1_3177"></a>Ex1：口袋妖怪数据集</h4> 
<p>现有一份口袋妖怪的数据集，下面进行一些背景说明：</p> 
<ul><li> <p><code>#</code>代表全国图鉴编号，不同行存在相同数字则表示为该妖怪的不同状态</p> </li><li> <p>妖怪具有单属性和双属性两种，对于单属性的妖怪，<code>Type 2</code>为缺失值</p> </li><li> <p><code>Total, HP, Attack, Defense, Sp. Atk, Sp. Def, Speed</code>分别代表种族值、体力、物攻、防御、特攻、特防、速度，其中种族值为后6项之和</p> </li></ul> 
<pre><code class="prism language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../data/pokemon.csv'</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>#</th><th>Name</th><th>Type 1</th><th>Type 2</th><th>Total</th><th>HP</th><th>Attack</th><th>Defense</th><th>Sp. Atk</th><th>Sp. Def</th><th>Speed</th></tr></thead><tbody><tr><th>0</th><td>1</td><td>Bulbasaur</td><td>Grass</td><td>Poison</td><td>318</td><td>45</td><td>49</td><td>49</td><td>65</td><td>65</td><td>45</td></tr><tr><th>1</th><td>2</td><td>Ivysaur</td><td>Grass</td><td>Poison</td><td>405</td><td>60</td><td>62</td><td>63</td><td>80</td><td>80</td><td>60</td></tr><tr><th>2</th><td>3</td><td>Venusaur</td><td>Grass</td><td>Poison</td><td>525</td><td>80</td><td>82</td><td>83</td><td>100</td><td>100</td><td>80</td></tr></tbody></table> 
<ol><li> <p>对<code>HP, Attack, Defense, Sp. Atk, Sp. Def, Speed</code>进行加总，验证是否为<code>Total</code>值。</p> </li><li> <p>对于<code>#</code>重复的妖怪只保留第一条记录，解决以下问题：</p> </li></ol> 
<ul><li>求第一属性的种类数量和前三多数量对应的种类</li><li>求第一属性和第二属性的组合种类</li><li>求尚未出现过的属性组合</li></ul> 
<ol start="3"><li>按照下述要求，构造<code>Series</code>：</li></ol> 
<ul><li>取出物攻，超过120的替换为<code>high</code>，不足50的替换为<code>low</code>，否则设为<code>mid</code></li><li>取出第一属性，分别用<code>replace</code>和<code>apply</code>替换所有字母为大写</li><li>求每个妖怪六项能力的离差，即所有能力中偏离中位数最大的值，添加到<code>df</code>并从大到小排序</li></ul> 
<h6><a id="My_solution__3288"></a>My solution :</h6> 
<ol><li>取出对应<code>columns</code>的列 , 按列求和后与<code>Total</code>作不等于比较 , 结果应全为<code>False</code></li></ol> 
<ul><li><code>False</code>的真值为<code>0</code> , 求和后若值为<code>0</code> , 则所有行加和都与<code>Total</code>相同 , 否则为<code>True</code>的个数 , 也是不等于<code>Total</code>的个数</li><li>经验证 , 合为<code>0</code> , 是<code>Total</code>值</li></ul> 
<pre><code class="prism language-python"><span class="token punctuation">(</span>df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> df<span class="token punctuation">[</span><span class="token string">'Total'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0
</code></pre> 
<pre><code class="prism language-python">df_2 <span class="token operator">=</span> df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
df_2<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>18
</code></pre> 
<pre><code class="prism language-python">df_2<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>Water     105
Normal     93
Grass      66
Name: Type 1, dtype: int64
</code></pre> 
<ul><li>对<code>Type 1</code>和<code>Type 2</code>两列合并去重 , 得到<code>143</code>种组合</li></ul> 
<pre><code class="prism language-python">df_2_2 <span class="token operator">=</span> df_2<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">,</span><span class="token string">'Type 2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">,</span><span class="token string">'Type 2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
df_2_2<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code>(143, 2)
</code></pre> 
<ul><li>分别对<code>Type 1</code>和<code>Type 2</code>取唯一值后排列组合所有不同技能组合</li><li>其中<code>Type 1</code>唯一值<code>18</code>种 , <code>Type 2</code>唯一值<code>19</code>种(含一个<code>NaN</code>) , 组合后的全部种类数为<code>18*19-18=324</code></li><li>将已经存在的<code>143</code>种组合与所有组合拼接去重且不保留重复值 , 剩下的就是没有出现过的组合 , 共<code>324-143=181</code>种</li></ul> 
<pre><code class="prism language-python">all_com <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span>j<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> df_2<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> df_2<span class="token punctuation">[</span><span class="token string">'Type 2'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> i<span class="token operator">!=</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">,</span><span class="token string">'Type 2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>all_com<span class="token punctuation">,</span>df_2_2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>keep <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Type 1</th><th>Type 2</th></tr></thead><tbody><tr><th>9</th><td>Grass</td><td>Rock</td></tr><tr><th>10</th><td>Grass</td><td>Water</td></tr><tr><th>11</th><td>Grass</td><td>Electric</td></tr><tr><th>12</th><td>Grass</td><td>Fire</td></tr><tr><th>13</th><td>Grass</td><td>Dragon</td></tr><tr><th>...</th><td>...</td><td>...</td></tr><tr><th>318</th><td>Flying</td><td>Fire</td></tr><tr><th>320</th><td>Flying</td><td>Dark</td></tr><tr><th>321</th><td>Flying</td><td>Ghost</td></tr><tr><th>322</th><td>Flying</td><td>Bug</td></tr><tr><th>323</th><td>Flying</td><td>Normal</td></tr></tbody></table> 
<p>181 rows × 2 columns</p> 
<ul><li>用<code>mask</code>或<code>where</code>都可以逻辑替换</li></ul> 
<pre><code class="prism language-python">a <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Attack'</span><span class="token punctuation">]</span>
a<span class="token punctuation">.</span>mask<span class="token punctuation">(</span>a<span class="token operator">&gt;</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token string">'high'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mask<span class="token punctuation">(</span>a<span class="token operator">&lt;</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">'low'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mask<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">&lt;=</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>a<span class="token operator">&gt;=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'mid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    low
1    mid
2    mid
3    mid
4    mid
Name: Attack, dtype: object
</code></pre> 
<ul><li>对<code>type 1</code>中每个唯一值映射</li></ul> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>df<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    GRASS
1    GRASS
2    GRASS
3    GRASS
4     FIRE
Name: Type 1, dtype: object
</code></pre> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'Type 1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0    GRASS
1    GRASS
2    GRASS
3    GRASS
4     FIRE
Name: Type 1, dtype: object
</code></pre> 
<ul><li>取出六项能力 , 按<code>apply</code>方法依次对每行求中位数 , 做差 , 绝对值 , 最大值 , 再排序</li></ul> 
<pre><code class="prism language-python">df<span class="token punctuation">[</span><span class="token string">'Deviation'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token builtin">abs</span><span class="token punctuation">(</span>x<span class="token operator">-</span>x<span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'Deviation'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>230    215.0
121    207.5
261    190.0
333    155.0
224    145.0
Name: Deviation, dtype: float64
</code></pre> 
<h4><a id="Ex2_3522"></a>Ex2：指数加权窗口</h4> 
<ol><li>作为扩张窗口的<code>ewm</code>窗口</li></ol> 
<p>在扩张窗口中，用户可以使用各类函数进行历史的累计指标统计，但这些内置的统计函数往往把窗口中的所有元素赋予了同样的权重。事实上，可以给出不同的权重来赋给窗口中的元素，指数加权窗口就是这样一种特殊的扩张窗口。</p> 
<p>其中，最重要的参数是<code>alpha</code>，它决定了默认情况下的窗口权重为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          i 
         
        
       
         = 
        
       
         ( 
        
       
         1 
        
       
         − 
        
       
         α 
        
        
        
          ) 
         
        
          i 
         
        
       
         , 
        
       
         i 
        
       
         ∈ 
        
       
         { 
        
       
         0 
        
       
         , 
        
       
         1 
        
       
         , 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         , 
        
       
         t 
        
       
         } 
        
       
      
        w_i=(1−\alpha)^i,i\in\{0,1,...,t\} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.07466em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">{<!-- --></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">t</span><span class="mclose">}</span></span></span></span></span>，其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
         = 
        
       
         0 
        
       
      
        i=0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">0</span></span></span></span></span>表示当前元素，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
         = 
        
       
         t 
        
       
      
        i=t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.61508em; vertical-align: 0em;"></span><span class="mord mathdefault">t</span></span></span></span></span>表示序列的第一个元素。</p> 
<p>从权重公式可以看出，离开当前值越远则权重越小，若记原序列为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
      
        x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">x</span></span></span></span></span>，更新后的当前元素为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          y 
         
        
          t 
         
        
       
      
        y_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，此时通过加权公式归一化后可知：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           y 
          
         
           t 
          
         
        
          = 
         
         
          
           
           
             ∑ 
            
            
            
              i 
             
            
              = 
             
            
              0 
             
            
           
             t 
            
           
           
           
             w 
            
           
             i 
            
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              i 
             
            
           
          
          
           
           
             ∑ 
            
            
            
              i 
             
            
              = 
             
            
              0 
             
            
           
             t 
            
           
           
           
             w 
            
           
             i 
            
           
          
         
         
        
          = 
         
         
          
           
           
             x 
            
           
             t 
            
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
          
            ) 
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              1 
             
            
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
           
             2 
            
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              2 
             
            
           
          
            + 
           
          
            . 
           
          
            . 
           
          
            . 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
           
             t 
            
           
           
           
             x 
            
           
             0 
            
           
          
          
          
            1 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
          
            ) 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
           
             2 
            
           
          
            + 
           
          
            . 
           
          
            . 
           
          
            . 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
           
             t 
            
           
          
         
        
       
         y_t =\frac{\sum_{i=0}^{t} w_i x_{t-i}}{\sum_{i=0}^{t} w_i} \\ =\frac{x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...+ (1 - \alpha)^{t} x_{0}}{1 + (1 - \alpha) + (1 - \alpha)^2 + ...+ (1 - \alpha)^{t}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.74633em; vertical-align: -1.12317em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.62317em;"><span class="" style="top: -2.17654em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: -5e-06em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.933456em;"><span class="" style="top: -2.40029em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.29971em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.68971em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: -5e-06em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.933456em;"><span class="" style="top: -2.40029em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.29971em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.12317em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height: 0.36687em; vertical-align: 0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.42711em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.49111em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.719556em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.793556em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>对于<code>Series</code>而言，可以用<code>ewm</code>对象如下计算指数平滑后的序列：</p> 
<pre><code class="prism language-python">np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0   -1
1   -1
2   -2
3   -2
4   -2
dtype: int32
</code></pre> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>ewm<span class="token punctuation">(</span>alpha<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0   -1.000000
1   -1.000000
2   -1.409836
3   -1.609756
4   -1.725845
dtype: float64
</code></pre> 
<p>请用<code>expanding</code>窗口实现。</p> 
<ol start="2"><li>作为滑动窗口的<code>ewm</code>窗口</li></ol> 
<p>从第1问中可以看到，<code>ewm</code>作为一种扩张窗口的特例，只能从序列的第一个元素开始加权。现在希望给定一个限制窗口<code>n</code>，只对包含自身最近的<code>n</code>个窗口进行滑动加权平滑。请根据滑窗函数，给出新的<code>wi</code>与<code>yt</code>的更新公式，并通过<code>rolling</code>窗口实现这一功能。</p> 
<h6><a id="My_solution__3580"></a>My solution :</h6> 
<ol><li><code>expanding</code>得到序列的扩张对象 , 为其加权即可 , 可以用<code>np.average</code>求加权平均数</li></ol> 
<ul><li>其中<code>weight</code>是一系列<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
        
          − 
         
        
          α 
         
        
       
         1-\alpha 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span></span></span>的整数幂 , 由于权重值随序列索引值增加而增加 , <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
        
          − 
         
        
          α 
         
        
          &lt; 
         
        
          0 
         
        
       
         1-\alpha&lt;0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">0</span></span></span></span></span> , 所以幂指数值应当随序列的索引值增加而减小</li><li>幂指数值恰好与序列索引的逆序相同 , 因此有三种思路分别为 : 把序列索引值逆序后当成幂指数值 , 或按序列顺序值生成<code>weight</code>后再逆序 , 或直接把序列逆序 , 都可以得出加权平均结果</li></ul> 
<pre><code class="prism language-python">alpha <span class="token operator">=</span> <span class="token number">0.2</span>
s<span class="token punctuation">.</span>expanding<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>np<span class="token punctuation">.</span>average<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>weights <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>alpha<span class="token punctuation">)</span><span class="token operator">**</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0   -1.000000
1   -1.000000
2   -1.409836
3   -1.609756
4   -1.725845
dtype: float64
</code></pre> 
<ol start="2"><li><code>expanding</code>得到的是扩张对象 , 序列长度呈阶梯式增加 , <code>rolling</code>窗口为固定长度的序列</li></ol> 
<ul><li>而指数加权方式不变 , 仅仅是需要加权的序列改变 , 因此只需将<code>expanding</code>改为<code>rolling</code>即可</li><li><code>wi</code>与<code>yt</code>的更新公式则分两种情况 , 设窗口为<code>n</code> , 当<code>t &lt; n</code>时 , 序列长度不够 , 可以更新为<code>NaN</code> , 也可以用<code>expanding</code>更新</li><li>当<code>t &gt;= n</code>时 , 更新长度由<code>t</code>变为<code>n</code> , 更新后的<code>yt</code>为 :</li></ul> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           y 
          
         
           t 
          
         
        
          = 
         
         
          
           
           
             ∑ 
            
            
            
              i 
             
            
              = 
             
            
              0 
             
            
            
            
              n 
             
            
              − 
             
            
              1 
             
            
           
           
           
             w 
            
           
             i 
            
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              i 
             
            
           
          
          
           
           
             ∑ 
            
            
            
              i 
             
            
              = 
             
            
              0 
             
            
            
            
              n 
             
            
              − 
             
            
              1 
             
            
           
           
           
             w 
            
           
             i 
            
           
          
         
         
        
          = 
         
         
          
           
           
             x 
            
           
             t 
            
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
          
            ) 
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              1 
             
            
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
           
             2 
            
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              2 
             
            
           
          
            + 
           
          
            . 
           
          
            . 
           
          
            . 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
            
            
              n 
             
            
              − 
             
            
              1 
             
            
           
           
           
             x 
            
            
            
              t 
             
            
              − 
             
            
              n 
             
            
              + 
             
            
              1 
             
            
           
          
          
          
            1 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
          
            ) 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
           
             2 
            
           
          
            + 
           
          
            . 
           
          
            . 
           
          
            . 
           
          
            + 
           
          
            ( 
           
          
            1 
           
          
            − 
           
          
            α 
           
           
           
             ) 
            
            
            
              n 
             
            
              − 
             
            
              1 
             
            
           
          
         
        
       
         y_t =\frac{\sum_{i=0}^{n-1} w_i x_{t-i}}{\sum_{i=0}^{n-1} w_i} \\ =\frac{x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...+ (1 - \alpha)^{n-1} x_{t-n+1}}{1 + (1 - \alpha) + (1 - \alpha)^2 + ...+ (1 - \alpha)^{n-1}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.78744em; vertical-align: -1.14372em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.64372em;"><span class="" style="top: -2.15599em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: -5e-06em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.954008em;"><span class="" style="top: -2.40029em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.29971em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.68971em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: -5e-06em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.954008em;"><span class="" style="top: -2.40029em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.29971em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.14372em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height: 0.36687em; vertical-align: 0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.42711em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.49111em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<pre><code class="prism language-python">s<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> np<span class="token punctuation">.</span>average<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>weights <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>alpha<span class="token punctuation">)</span><span class="token operator">**</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0         NaN
1         NaN
2         NaN
3         NaN
4   -1.725845
dtype: float64
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e5777558c362b75f866f0430ec518a03/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# ——【关键字：并发编程】TASK常见用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f6955a9be3e51b705e1dbc556f3142d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">输入一个字符串并判断英文字母个数、中文字母个数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>