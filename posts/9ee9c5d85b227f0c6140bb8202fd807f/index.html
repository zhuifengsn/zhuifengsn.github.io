<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【C语言】动态内存管理 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【C语言】动态内存管理" />
<meta property="og:description" content="大家好，我是苏貝，本篇博客带大家了解动态内存管理，如果你觉得我写的还不错的话，可以给我一个赞👍吗，感谢❤️
目录 一. 为什么存在动态内存分配二. 动态内存函数的介绍2.1 malloc和free2.2 calloc2.3 realloc 三. 常见的动态内存错误四. 几个经典的笔试题4.14.24.34.4 五. C/C&#43;&#43;程序的内存开辟六. 柔性数组6.1 柔性数组的特点6.3 柔性数组的优势 一. 为什么存在动态内存分配 我们已经掌握的内存开辟方式有：
int val = 20; 在栈空间上开辟四个字节
char arr[10] = {0}; 在栈空间上开辟10个字节的连续空间
但是上述的开辟空间的方式有两个特点：
空间开辟大小是固定的。数组在申明的时候，必须指定数组的长度，它所需要的内存在编译时分配。 但是对于空间的需求，不仅仅是上述的情况。有时候我们需要的空间大小在程序运行的时候才能知道，那数组的编译时开辟空间的方式就不能满足了。这时候就只能试试动态存开辟了
二. 动态内存函数的介绍 2.1 malloc和free C语言提供了一个动态内存开辟的函数:
这个函数向内存申请一块连续可用的空间，并返回指向这块空间的指针。
○如果开辟成功，则返回一个指向开辟好空间的指针
○如果开辟失败，则返回一个NULL指针，因此malloc的返回值一定要做检查。
○返回值的类型是 void* ，所以malloc函数并不知道开辟空间的类型，具体在使用的时候使用者自己来决定。
○如果参数 size 为0，malloc的行为是标准是未定义的，取决于编译器
○使用malloc函数后，一定要记得判断malloc函数的返回值是否为NULL
○要记得对malloc函数开辟的空间进行释放
C语言提供了另外一个函数free，专门是用来做动态内存的释放和回收的，函数原型如下：
free函数用来释放动态开辟的内存。
○如果参数 ptr 指向的空间不是动态开辟的，那free函数的行为是未定义的。
○如果参数 ptr 是NULL指针，则函数什么事都不做
malloc和free都声明在 stdlib.h 头文件中
示例1：
int main() { //申请一块空间，用来存放10个整型 int* p = (int*)malloc(10 * sizeof(int)); //int* p = (int*)malloc(40);也可 if (p == NULL) { perror(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/9ee9c5d85b227f0c6140bb8202fd807f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-03T07:21:14+08:00" />
<meta property="article:modified_time" content="2023-11-03T07:21:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【C语言】动态内存管理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>大家好，我是苏貝，本篇博客带大家了解动态内存管理，如果你觉得我写的还不错的话，可以给我一个赞👍吗，感谢❤️<br> <img src="https://images2.imgbox.com/53/14/kgzlmIVL_o.jpg" alt="在这里插入图片描述"></p> 
</blockquote> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#__7" rel="nofollow">一. 为什么存在动态内存分配</a></li><li><a href="#__19" rel="nofollow">二. 动态内存函数的介绍</a></li><li><ul><li><a href="#21_mallocfree_21" rel="nofollow">2.1 malloc和free</a></li><li><a href="#22_calloc_104" rel="nofollow">2.2 calloc</a></li><li><a href="#23_realloc_118" rel="nofollow">2.3 realloc</a></li></ul> 
  </li><li><a href="#__161" rel="nofollow">三. 常见的动态内存错误</a></li><li><a href="#__262" rel="nofollow">四. 几个经典的笔试题</a></li><li><ul><li><a href="#41_264" rel="nofollow">4.1</a></li><li><a href="#42_315" rel="nofollow">4.2</a></li><li><a href="#43_342" rel="nofollow">4.3</a></li><li><a href="#44_368" rel="nofollow">4.4</a></li></ul> 
  </li><li><a href="#_CC_394" rel="nofollow">五. C/C++程序的内存开辟</a></li><li><a href="#___409" rel="nofollow">六. 柔性数组</a></li><li><ul><li><a href="#61__431" rel="nofollow">6.1 柔性数组的特点</a></li><li><a href="#63__485" rel="nofollow">6.3 柔性数组的优势</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="__7"></a>一. 为什么存在动态内存分配</h2> 
<p>我们已经掌握的内存开辟方式有：</p> 
<blockquote> 
 <p>int val = 20; 在栈空间上开辟四个字节<br> char arr[10] = {0}; 在栈空间上开辟10个字节的连续空间</p> 
</blockquote> 
<p>但是上述的开辟空间的方式有两个特点：</p> 
<ol><li>空间开辟大小是固定的。</li><li>数组在申明的时候，必须指定数组的长度，它所需要的内存在编译时分配。</li></ol> 
<p>但是对于空间的需求，不仅仅是上述的情况。有时候我们需要的空间大小在程序运行的时候才能知道，那数组的编译时开辟空间的方式就不能满足了。这时候就只能试试动态存开辟了</p> 
<hr> 
<h2><a id="__19"></a>二. 动态内存函数的介绍</h2> 
<h3><a id="21_mallocfree_21"></a>2.1 malloc和free</h3> 
<p>C语言提供了一个动态内存开辟的函数:<br> <img src="https://images2.imgbox.com/0d/5c/KS6zPWW4_o.png" alt="在这里插入图片描述"></p> 
<p>这个函数向内存申请一块<strong>连续可用</strong>的空间，并返回指向这块空间的指针。</p> 
<p>○如果开辟成功，则返回一个<strong>指向开辟好空间的指针</strong><br> ○如果开辟失败，则返回一个<strong>NULL指针</strong>，因此malloc的返回值一定要做检查。<br> ○返回值的类型是 void* ，所以malloc函数并不知道开辟空间的类型，具体在使用的时候使用者自己来决定。<br> ○如果参数 size 为0，malloc的行为是标准是未定义的，取决于编译器<br> ○使用malloc函数后，一定要记得判断malloc函数的返回值是否为NULL<br> ○要记得对malloc函数开辟的空间进行释放</p> 
<p>C语言提供了另外一个函数free，专门是用来做动态内存的释放和回收的，函数原型如下：<br> <img src="https://images2.imgbox.com/09/d4/nlWwxajT_o.png" alt="在这里插入图片描述"></p> 
<p>free函数用来释放动态开辟的内存。<br> ○如果参数 ptr 指向的空间不是动态开辟的，那free函数的行为是未定义的。<br> ○如果参数 ptr 是NULL指针，则函数什么事都不做</p> 
<p>malloc和free都声明在 stdlib.h 头文件中</p> 
<p><mark><font face="微软雅黑" size="3" color="#666FF">示例1：</font></mark></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//申请一块空间，用来存放10个整型</span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//int* p = (int*)malloc(40);也可</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//释放空间</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/d9/SJfewV6l_o.png" alt="在这里插入图片描述"></p> 
<p><mark><font face="微软雅黑" size="3" color="#666FF">示例2：</font></mark><br> 有些人可能会有疑问，malloc函数的返回值真的可能为NULL吗？一写代码便知</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;limits.h&gt;</span><span class="token comment">//INT_MAX的头文件</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> INT_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//...</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5f/58/qjXZep7P_o.png" alt="在这里插入图片描述"></p> 
<p><strong>malloc函数释放的空间是怎么释放的呢？</strong><br> 1.free函数释放-----主动释放（最好选择free函数释放）<br> 2.程序退出后，malloc函数申请的空间会被操作系统回收-----被动<br> 正常情况下，谁申请的空间谁释放。万一自己没有释放，也要叫别人释放</p> 
<p>释放空间后，记得将原先指向这块空间的起始位置的指针变为NULL指针，否则释放空间结束后，该指针就成为野指针</p> 
<hr> 
<h3><a id="22_calloc_104"></a>2.2 calloc</h3> 
<p>C语言还提供了一个函数叫 calloc ， calloc 函数也用来动态内存分配。原型如下：<br> <img src="https://images2.imgbox.com/97/74/f5IsyvJQ_o.png" alt="在这里插入图片描述"><br> ○函数的功能是为 num 个大小为 size 的元素开辟一块空间，并且把空间的每个字节初始化为0。<br> ○与函数 malloc 的区别只在于 calloc 会在返回地址之前把申请的空间的每个字节全部<strong>初始化为0</strong><br> <img src="https://images2.imgbox.com/4c/65/kNmf91eO_o.png" alt="在这里插入图片描述"><br> 所以我们如果想动态开辟一块空间，可以使用malloc或calloc函数。如果我们对申请的内存空间的内容要求初始化，那么可以很方便的使用calloc函数来完成任务</p> 
<p><mark><font face="微软雅黑" size="3" color="#666FF">示例：</font></mark><br> 下面我们来证明一下calloc函数会将每个字节初始化为0</p> 
<p><img src="https://images2.imgbox.com/e6/93/1FmjMCHW_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="23_realloc_118"></a>2.3 realloc</h3> 
<p>realloc函数的出现让动态内存管理更加灵活。有时会我们发现过去申请的空间太小了，有时候我们又会觉得申请的空间过大了，那为了合理的使用内存，我们一定会对内存的大小做灵活的调整。那 realloc 函数就可以做到对动态开辟内存大小的调整。函数原型如下<br> <img src="https://images2.imgbox.com/1c/d6/elqazANF_o.png" alt="在这里插入图片描述"><br> ptr 是要调整的内存地址，size 调整之后的新大小，返回值为调整之后的内存起始位置。这个函数调整原内存空间大小的基础上，可能还会将原来内存中的数据移动到新的空间。<br> 即：realloc在调整内存空间的是存在两种情况：<br> ○1：原有空间之后有足够大的空间<br> ○2：原有空间之后没有足够大的空间</p> 
<p><img src="https://images2.imgbox.com/23/ba/BXyoRbto_o.png" alt="在这里插入图片描述"></p> 
<p>情况1：后面有足够空间时，要扩展内存就直接原有内存之后直接追加空间，原来空间的数据不发生变化。<br> 情况2：后面没有足够多的空间时，扩展的方法是：在堆空间上另找一个合适大小的连续空间来使用。此时会将旧的空间中的数据拷贝到新的空间中，再将旧的空间释放掉，再返回新的空间的起始地址</p> 
<p><img src="https://images2.imgbox.com/28/f9/l9VugnFX_o.png" alt="在这里插入图片描述"></p> 
<p><mark><font face="微软雅黑" size="3" color="#666FF">示例：</font></mark><br> 一开始我们动态内存开辟了16个字节的空间，后面发现不够，需要开辟40个字节的空间</p> 
<p><font face="微软雅黑" size="3" color="#666FF">注意：</font><br> realloc函数也可能会开辟空间失败，因此它的返回值也可能是NULL，所以<strong>不要用指针p直接接收</strong>函数返回值，否则p可能变成NULL指针</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"calloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//...</span>
	<span class="token keyword">int</span><span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">realloc</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		p <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h2><a id="__161"></a>三. 常见的动态内存错误</h2> 
<p><strong>1.对NULL指针的解引用操作</strong><br> 如果p的值是NULL，就是对NULL指针解引用，这是非法的。所以一定要记得在使用malloc函数后，判断返回值是否为NULL指针</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2.对动态开辟空间的越界访问</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">//当i是10的时候越界访问</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3.对非动态开辟内存使用free释放</strong><br> 非动态开辟的内存空间不能用free函数释放</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4.使用free释放一块动态开辟内存的一部分</strong><br> 到最后free函数释放空间时，指针p指向的是第6个元素，所以只释放从第6个元素开始到空间末尾的空间，而第6个元素之前的元素所在的空间没有被free函数释放，这样并不好。所以我们最好一直让p指向开辟空间的起始位置</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>p <span class="token operator">=</span> i<span class="token punctuation">;</span>
		p<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>5.对同一块动态内存多次释放</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重复释放</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>6.动态开辟内存忘记释放（内存泄漏）</strong><br> 在函数调用结束前未释放动态开辟的内存</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> p<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h2><a id="__262"></a>四. 几个经典的笔试题</h2> 
<p>请问运行下面的Test 函数会有什么样的结果？</p> 
<h3><a id="41_264"></a>4.1</h3> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">GetMemory</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ok</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7e/38/VRnhoisL_o.png" alt="在这里插入图片描述"><br> 程序崩溃了。test函数中，将str指针作为实参调用GetMenory函数，指针变量p是str的一份临时拷贝，它也是NULL。动态内存开辟空间，若开辟成功，p中存放的是开辟的空间的起始地址。出GetMenory，指针变量p的空间被释放。这次调用函数没有改变指针变量str，str仍是NULL，后面非法对NULL进行解引用操作，程序崩溃。这段代码还有一个问题，在退出程序前未释放开辟的空间，造成内存泄漏。</p> 
<p>有人可能会对printf(str);这条语句的正确性产生质疑，其实该语句是正确的，只是我们平时确实不太用。解释：printf(“haha”);这条语句我们都知道是正确的，实际上这是将常量字符串haha的首元素h的地址传给printf函数，打印从该地址开始往后直到遇见\0停止的字符。那printf(str);就是打印从str指向位置开始往后直到遇见\0停止的字符。所以该语句是正确的</p> 
<p>现在对上面代码修改使之成为正确的代码</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/17/ab/5NZCobrM_o.png" alt="在这里插入图片描述"></p> 
<p>这段代码调用GetMemory函数时，将值传递变为地址传递，*p就是str指针，动态开辟了100个字节的空间后，将空间起始地址传给str指针，再调用strcpy函数，最后释放空间</p> 
<hr> 
<h3><a id="42_315"></a>4.2</h3> 
<pre><code class="prism language-c"><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> p<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	str <span class="token operator">=</span> <span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/d0/SvoLjfiN_o.png" alt="在这里插入图片描述"><br> 打印的是乱码。原因：GetMemory函数无参数，在函数里面定义的p数组在出函数时所占的空间被释放，即使返回了p数组的首元素地址并赋值给str，因为数组空间被释放，所以str是野指针</p> 
<hr> 
<h3><a id="43_342"></a>4.3</h3> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> p<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">GetMemory</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e3/ad/fgxGsGlD_o.png" alt="在这里插入图片描述"><br> 根据我们对上面2段代码的解释，这段代码只是没有主动释放malloc开辟的空间，内存泄漏，所以如果要修改的话，只要free(str);str=NULL;</p> 
<hr> 
<h3><a id="44_368"></a>4.4</h3> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">strcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码中，用malloc开辟了100个字节的空间，如果开辟成功的话返回的是开辟的空间的起始地址，再调用strcpy函数，然后释放掉开辟的空间。虽然开辟的空间被释放了，但是指针变量str仍然指向开辟空间的起始地址，此时str就是野指针，因为不是NULL，所以会调用strcpy函数，会对野指针进行操作，非法访问内存</p> 
<hr> 
<h2><a id="_CC_394"></a>五. C/C++程序的内存开辟</h2> 
<p><img src="https://images2.imgbox.com/e6/64/xx2HJKwk_o.png" alt="在这里插入图片描述"></p> 
<p>C/C++程序内存分配的几个区域：</p> 
<ol><li>栈区（stack）：在执行函数时，函数内局部变量的存储单元都可以在栈上创建，函数执行结束时这些存储单元自动被释放。栈内存分配运算内置于处理器的指令集中，效率很高，但是分配的内存容量有限。 栈区主要存放运行函数而分配的局部变量、函数参数、返回数据、返回地址等。</li><li>堆区（heap）：一般由程序员分配释放， 若程序员不释放，程序结束时可能由OS(操作系统)回收 。分配方式类似于链表。</li><li>数据段（静态区):（static）存放全局变量、静态数据。程序结束后由系统释放。</li><li>代码段：存放函数体（类成员函数和全局函数）的二进制代码</li></ol> 
<p>有了这幅图，我们就可以更好的理解之前讲的static关键字修饰局部变量的例子了。<br> 实际上普通的局部变量是在栈区分配空间的，栈区的特点是在上面创建的变量出了作用域就销毁。但是被static修饰的变量存放在数据段（静态区），数据段的特点是在上面创建的变量，直到程序结束才销毁，所以生命周期变长。</p> 
<hr> 
<h2><a id="___409"></a>六. 柔性数组</h2> 
<blockquote> 
 <p>也许你从来没有听说过柔性数组（flexible array）这个概念，但是它确实是存在的。<br> C99 中，结构中的<strong>最后一个元素</strong>允许是未知大小的数组，这就叫做『柔性数组』成员</p> 
</blockquote> 
<p>例如：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sa</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//柔性数组成员</span>
<span class="token punctuation">}</span>sa<span class="token punctuation">;</span>
</code></pre> 
<p>有些编译器会报错无法编译可以改成：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sa</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//柔性数组成员</span>
<span class="token punctuation">}</span>sa<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="61__431"></a>6.1 柔性数组的特点</h3> 
<p>1.结构中的柔性数组成员前面必须至少一个其他成员。<br> 2.sizeof 返回的这种结构体大小不包括柔性数组的内存。<br> 3.包含柔性数组成员的结构用malloc ()函数进行内存的动态分配，并且分配的内存应该大于结构的大小，以适应柔性数组的预期大小。</p> 
<p><mark><font face="微软雅黑" size="3" color="#666FF">示例1：</font></mark></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sa</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> c<span class="token punctuation">;</span><span class="token comment">//1</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token comment">//4</span>
	<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//柔性数组成员</span>
<span class="token punctuation">}</span>sa<span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7a/4e/iFQ7gvam_o.png" alt="在这里插入图片描述"><br> 根据结构体内存对齐，结构体的前两个元素就占了8个字节，结构体大小不包括柔性数组的内存。所以这也说明了第一个特点：结构中的柔性数组成员前面必须至少一个其他成员。</p> 
<p><mark><font face="微软雅黑" size="3" color="#666FF">示例2：</font></mark></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sa</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> c<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//柔性数组成员</span>
<span class="token punctuation">}</span>sa<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	sa<span class="token operator">*</span> pc <span class="token operator">=</span> <span class="token punctuation">(</span>sa<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		pc<span class="token operator">-&gt;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> pc<span class="token operator">-&gt;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pc<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/31/10/uXZ3EbcI_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="63__485"></a>6.3 柔性数组的优势</h3> 
<p>上面示例2的代码如果不想写成柔性数组的形式，又要可变的话，那也可以写成下面这种形式。但这种形式需要2次malloc，2次free，所以不如柔性数组方便</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sa</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> c<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>sa<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	sa<span class="token operator">*</span> pc <span class="token operator">=</span> <span class="token punctuation">(</span>sa<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	pc<span class="token operator">-&gt;</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pc<span class="token operator">-&gt;</span>a <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		pc<span class="token operator">-&gt;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> pc<span class="token operator">-&gt;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//释放</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pc<span class="token operator">-&gt;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pc<span class="token operator">-&gt;</span>a <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f5/55/fn9yjOHf_o.png" alt="在这里插入图片描述"></p> 
<p><strong>柔性数组的好处：</strong><br> 1：方便内存释放<br> 如果我们的代码是在一个给别人用的函数中，你在里面做了二次内存分配，并把整个结构体返回给用户。用户调用free可以释放结构体，但是用户并不知道这个结构体内的成员也需要free，所以你不能指望用户来发现这个事。所以，如果我们把结构体的内存以及其成员要的内存一次性分配好了，并返回给用户一个结构体指针，用户做一次free就可以把所有的内存也给释放掉。<br> 2：这样有利于访问速度，连续的内存有益于提高访问速度，也有益于减少内存碎片</p> 
<hr> 
<p><font face="微软雅黑" size="4" color="#666FF">好了，那么本篇博客就到此结束了，如果你觉得本篇博客对你有些帮助，可以给个大大的赞👍吗，感谢看到这里，我们下篇博客见❤️</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2a0b54b1bdde8c9f77c5faacb4b862e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue项目没有路径别名智能提示如何解决</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c3d41af9d6d19b98dd37cb2be1adb3aa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HashMap源码详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>