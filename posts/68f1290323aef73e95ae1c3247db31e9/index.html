<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>è®¡ç®—æœºè®¾è®¡å¤§èµ› æ·±åº¦å­¦ä¹ å«æ˜Ÿé¥æ„Ÿå›¾åƒæ£€æµ‹ä¸è¯†åˆ« -opencv python ç›®æ ‡æ£€æµ‹ - è¿½é£å°‘å¹´çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="è®¡ç®—æœºè®¾è®¡å¤§èµ› æ·±åº¦å­¦ä¹ å«æ˜Ÿé¥æ„Ÿå›¾åƒæ£€æµ‹ä¸è¯†åˆ« -opencv python ç›®æ ‡æ£€æµ‹" />
<meta property="og:description" content="æ–‡ç« ç›®å½• 0 å‰è¨€1 è¯¾é¢˜èƒŒæ™¯2 å®ç°æ•ˆæœ3 Yolov5ç®—æ³•4 æ•°æ®å¤„ç†å’Œè®­ç»ƒ5 æœ€å 0 å‰è¨€ ğŸ”¥ ä¼˜è´¨ç«èµ›é¡¹ç›®ç³»åˆ—ï¼Œä»Šå¤©è¦åˆ†äº«çš„æ˜¯
ğŸš© **æ·±åº¦å­¦ä¹ å«æ˜Ÿé¥æ„Ÿå›¾åƒæ£€æµ‹ä¸è¯†åˆ« **
è¯¥é¡¹ç›®è¾ƒä¸ºæ–°é¢–ï¼Œé€‚åˆä½œä¸ºç«èµ›è¯¾é¢˜æ–¹å‘ï¼Œå­¦é•¿éå¸¸æ¨èï¼
ğŸ¥‡å­¦é•¿è¿™é‡Œç»™ä¸€ä¸ªé¢˜ç›®ç»¼åˆè¯„åˆ†(æ¯é¡¹æ»¡åˆ†5åˆ†)
éš¾åº¦ç³»æ•°ï¼š3åˆ†å·¥ä½œé‡ï¼š3åˆ†åˆ›æ–°ç‚¹ï¼š5åˆ† ğŸ§¿ æ›´å¤šèµ„æ–™, é¡¹ç›®åˆ†äº«ï¼š
https://gitee.com/dancheng-senior/postgraduate
1 è¯¾é¢˜èƒŒæ™¯ è¿‘å¹´æ¥,ä¸–ç•Œå„å›½å¤§åŠ›å‘å±•èˆªç©ºèˆªå¤©äº‹ä¸š,å«æ˜Ÿå›¾åƒçš„ç›®æ ‡æ£€æµ‹åœ¨å„è¡Œå„ä¸šçš„åº”ç”¨å¾—åˆ°äº†å¿«é€Ÿçš„å‘å±•,ç‰¹åˆ«æ˜¯å†›äº‹ä¾¦æŸ¥ã€æµ·æ´‹èˆ¹èˆ¶å’Œæ¸”ä¸šç®¡ç†ç­‰é¢†åŸŸã€‚ç”±äºå«æ˜Ÿå›¾åƒä¸­æœ‰ä»·å€¼çš„ä¿¡æ¯æå°‘,å«æ˜Ÿå›¾åƒæ•°æ®è§„æ¨¡å·¨å¤§,è¿™è¿«åˆ‡éœ€è¦æ™ºèƒ½è¾…åŠ©å·¥å…·å¸®åŠ©ç›¸å…³ä»ä¸šäººå‘˜ä»å«æ˜Ÿå›¾åƒä¸­é«˜æ•ˆè·å–ç²¾ç¡®ç›´è§‚çš„ä¿¡æ¯ã€‚
æœ¬æ–‡åˆ©ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼ŒåŸºäºYolov5ç®—æ³•æ¡†æ¶å®ç°å«æ˜Ÿå›¾åƒç›®æ ‡æ£€æµ‹é—®é¢˜ã€‚
2 å®ç°æ•ˆæœ å®ç°æ•ˆæœå¦‚ä¸‹ï¼šå¯ä»¥çœ‹å‡ºå¯¹èˆ¹åªã€é£æœºç­‰è¯†åˆ«æ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„ã€‚
3 Yolov5ç®—æ³• ç®€ä»‹
ä¸‹å›¾æ‰€ç¤ºä¸º YOLOv5 çš„ç½‘ç»œç»“æ„å›¾ï¼Œåˆ†ä¸ºè¾“å…¥ç«¯ï¼ŒBackboneï¼ŒNeck å’Œ Prediction å››ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­ï¼Œ
è¾“å…¥ç«¯åŒ…æ‹¬ Mosaic æ•°æ®å¢å¼ºã€è‡ªé€‚åº”å›¾ç‰‡ç¼©æ”¾ã€è‡ªé€‚åº”é”šæ¡†è®¡ç®—ï¼ŒBackbone åŒ…æ‹¬ Focus ç»“æ„ã€CSP
ç»“ æ„ï¼ŒNeck åŒ… æ‹¬ FPN&#43;PAN ç»“ æ„ï¼ŒPrediction åŒ… æ‹¬GIOU_Loss ç»“æ„ã€‚
ç›¸å…³ä»£ç 
â€‹
class Yolo(object): def __init__(self, weights_file, verbose=True): self.verbose = verbose # detection params self.S = 7 # cell size self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/68f1290323aef73e95ae1c3247db31e9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-21T21:25:48+08:00" />
<meta property="article:modified_time" content="2024-02-21T21:25:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="è¿½é£å°‘å¹´çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">è¿½é£å°‘å¹´çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">è®¡ç®—æœºè®¾è®¡å¤§èµ› æ·±åº¦å­¦ä¹ å«æ˜Ÿé¥æ„Ÿå›¾åƒæ£€æµ‹ä¸è¯†åˆ« -opencv python ç›®æ ‡æ£€æµ‹</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>æ–‡ç« ç›®å½•</h4> 
 <ul><li><a href="#0__2" rel="nofollow">0 å‰è¨€</a></li><li><a href="#1__22" rel="nofollow">1 è¯¾é¢˜èƒŒæ™¯</a></li><li><a href="#2__27" rel="nofollow">2 å®ç°æ•ˆæœ</a></li><li><a href="#3_Yolov5_36" rel="nofollow">3 Yolov5ç®—æ³•</a></li><li><a href="#4__76" rel="nofollow">4 æ•°æ®å¤„ç†å’Œè®­ç»ƒ</a></li><li><a href="#5__190" rel="nofollow">5 æœ€å</a></li></ul> 
</div> 
<p></p> 
<h2><a id="0__2"></a>0 å‰è¨€</h2> 
<p>ğŸ”¥ ä¼˜è´¨ç«èµ›é¡¹ç›®ç³»åˆ—ï¼Œä»Šå¤©è¦åˆ†äº«çš„æ˜¯</p> 
<p>ğŸš© **æ·±åº¦å­¦ä¹ å«æ˜Ÿé¥æ„Ÿå›¾åƒæ£€æµ‹ä¸è¯†åˆ« **</p> 
<p>è¯¥é¡¹ç›®è¾ƒä¸ºæ–°é¢–ï¼Œé€‚åˆä½œä¸ºç«èµ›è¯¾é¢˜æ–¹å‘ï¼Œå­¦é•¿éå¸¸æ¨èï¼</p> 
<p>ğŸ¥‡å­¦é•¿è¿™é‡Œç»™ä¸€ä¸ªé¢˜ç›®ç»¼åˆè¯„åˆ†(æ¯é¡¹æ»¡åˆ†5åˆ†)</p> 
<ul><li>éš¾åº¦ç³»æ•°ï¼š3åˆ†</li><li>å·¥ä½œé‡ï¼š3åˆ†</li><li>åˆ›æ–°ç‚¹ï¼š5åˆ†</li></ul> 
<p>ğŸ§¿ <strong>æ›´å¤šèµ„æ–™, é¡¹ç›®åˆ†äº«ï¼š</strong></p> 
<p><a href="https://gitee.com/dancheng-senior/postgraduate" rel="nofollow">https://gitee.com/dancheng-senior/postgraduate</a></p> 
<p><img src="https://images2.imgbox.com/9d/19/u5woB5DX_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h2><a id="1__22"></a>1 è¯¾é¢˜èƒŒæ™¯</h2> 
<p>è¿‘å¹´æ¥,ä¸–ç•Œå„å›½å¤§åŠ›å‘å±•èˆªç©ºèˆªå¤©äº‹ä¸š,å«æ˜Ÿå›¾åƒçš„ç›®æ ‡æ£€æµ‹åœ¨å„è¡Œå„ä¸šçš„åº”ç”¨å¾—åˆ°äº†å¿«é€Ÿçš„å‘å±•,ç‰¹åˆ«æ˜¯å†›äº‹ä¾¦æŸ¥ã€æµ·æ´‹èˆ¹èˆ¶å’Œæ¸”ä¸šç®¡ç†ç­‰é¢†åŸŸã€‚ç”±äºå«æ˜Ÿå›¾åƒä¸­æœ‰ä»·å€¼çš„ä¿¡æ¯æå°‘,å«æ˜Ÿå›¾åƒæ•°æ®è§„æ¨¡å·¨å¤§,è¿™è¿«åˆ‡éœ€è¦æ™ºèƒ½è¾…åŠ©å·¥å…·å¸®åŠ©ç›¸å…³ä»ä¸šäººå‘˜ä»å«æ˜Ÿå›¾åƒä¸­é«˜æ•ˆè·å–ç²¾ç¡®ç›´è§‚çš„ä¿¡æ¯ã€‚<br> æœ¬æ–‡åˆ©ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼ŒåŸºäºYolov5ç®—æ³•æ¡†æ¶å®ç°å«æ˜Ÿå›¾åƒç›®æ ‡æ£€æµ‹é—®é¢˜ã€‚</p> 
<h2><a id="2__27"></a>2 å®ç°æ•ˆæœ</h2> 
<p>å®ç°æ•ˆæœå¦‚ä¸‹ï¼šå¯ä»¥çœ‹å‡ºå¯¹èˆ¹åªã€é£æœºç­‰è¯†åˆ«æ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„ã€‚</p> 
<p><img src="https://images2.imgbox.com/eb/66/y0KaeRng_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/be/93/TLKzRg6e_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/b3/50/JhCV4jjK_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/4f/dc/gOeXi6SE_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h2><a id="3_Yolov5_36"></a>3 Yolov5ç®—æ³•</h2> 
<p><strong>ç®€ä»‹</strong><br> ä¸‹å›¾æ‰€ç¤ºä¸º YOLOv5 çš„ç½‘ç»œç»“æ„å›¾ï¼Œåˆ†ä¸ºè¾“å…¥ç«¯ï¼ŒBackboneï¼ŒNeck å’Œ Prediction å››ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­ï¼Œ<br> è¾“å…¥ç«¯åŒ…æ‹¬ Mosaic æ•°æ®å¢å¼ºã€è‡ªé€‚åº”å›¾ç‰‡ç¼©æ”¾ã€è‡ªé€‚åº”é”šæ¡†è®¡ç®—ï¼ŒBackbone åŒ…æ‹¬ Focus ç»“æ„ã€CSP<br> ç»“ æ„ï¼ŒNeck åŒ… æ‹¬ FPN+PAN ç»“ æ„ï¼ŒPrediction åŒ… æ‹¬GIOU_Loss ç»“æ„ã€‚<br> <img src="https://images2.imgbox.com/ff/2a/wZkByMlr_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> ç›¸å…³ä»£ç </p> 
<p>â€‹</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Yolo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> weights_file<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>verbose <span class="token operator">=</span> verbose
        <span class="token comment"># detection params</span>
        self<span class="token punctuation">.</span>S <span class="token operator">=</span> <span class="token number">7</span>  <span class="token comment"># cell size</span>
        self<span class="token punctuation">.</span>B <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment"># boxes_per_cell</span>
        self<span class="token punctuation">.</span>classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"aeroplane"</span><span class="token punctuation">,</span> <span class="token string">"bicycle"</span><span class="token punctuation">,</span> <span class="token string">"bird"</span><span class="token punctuation">,</span> <span class="token string">"boat"</span><span class="token punctuation">,</span> <span class="token string">"bottle"</span><span class="token punctuation">,</span>
                        <span class="token string">"bus"</span><span class="token punctuation">,</span> <span class="token string">"car"</span><span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"chair"</span><span class="token punctuation">,</span> <span class="token string">"cow"</span><span class="token punctuation">,</span> <span class="token string">"diningtable"</span><span class="token punctuation">,</span>
                        <span class="token string">"dog"</span><span class="token punctuation">,</span> <span class="token string">"horse"</span><span class="token punctuation">,</span> <span class="token string">"motorbike"</span><span class="token punctuation">,</span> <span class="token string">"person"</span><span class="token punctuation">,</span> <span class="token string">"pottedplant"</span><span class="token punctuation">,</span>
                        <span class="token string">"sheep"</span><span class="token punctuation">,</span> <span class="token string">"sofa"</span><span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">,</span><span class="token string">"tvmonitor"</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>C <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span> <span class="token comment"># number of classes</span>
        <span class="token comment"># offset for box center (top left point of each cell)</span>
        self<span class="token punctuation">.</span>x_offset <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>self<span class="token punctuation">.</span>S<span class="token operator">*</span>self<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              <span class="token punctuation">[</span>self<span class="token punctuation">.</span>B<span class="token punctuation">,</span> self<span class="token punctuation">.</span>S<span class="token punctuation">,</span> self<span class="token punctuation">.</span>S<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>y_offset <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x_offset<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>threshold <span class="token operator">=</span> <span class="token number">0.2</span>  <span class="token comment"># confidence scores threhold</span>
        self<span class="token punctuation">.</span>iou_threshold <span class="token operator">=</span> <span class="token number">0.4</span>
        <span class="token comment">#  the maximum number of boxes to be selected by non max suppression</span>
        self<span class="token punctuation">.</span>max_output_size <span class="token operator">=</span> <span class="token number">10</span>

        self<span class="token punctuation">.</span>sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_build_net<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_build_detector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_load_weights<span class="token punctuation">(</span>weights_file<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4__76"></a>4 æ•°æ®å¤„ç†å’Œè®­ç»ƒ</h2> 
<p><strong>æ•°æ®é›†</strong><br> æœ¬é¡¹ç›®ä½¿ç”¨ DOTA æ•°æ®é›†ï¼ŒåŸæ•°æ®é›†ä¸­å¾…æ£€æµ‹çš„ç›®æ ‡å¦‚ä¸‹<br> <img src="https://images2.imgbox.com/88/6b/4UsK1O3W_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> åŸæ•°æ®é›†ä¸­çš„æ ‡ç­¾å¦‚ä¸‹<br> <img src="https://images2.imgbox.com/73/81/tAjrPkX6_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <strong>å›¾åƒåˆ†å‰²å’Œå°ºå¯¸è°ƒæ•´</strong><br> YOLO æ¨¡å‹çš„å›¾åƒè¾“å…¥å°ºå¯¸æ˜¯å›ºå®šçš„ï¼Œç”±äºåŸæ•°æ®é›†ä¸­çš„å›¾åƒå°ºå¯¸ä¸ä¸€ï¼Œæˆ‘ä»¬å°†åŸæ•°æ®é›†ä¸­çš„å›¾åƒæŒ‰ç›®æ ‡åˆ†å¸ƒçš„ä½ç½®åˆ†å‰²æˆä¸€ä¸ªä¸ªåŒ…å«ç›®æ ‡çš„å­å›¾ï¼Œå¹¶å°†æ¯ä¸ªå­å›¾å°ºå¯¸è°ƒæ•´ä¸º<br> 1024Ã—1024ã€‚åˆ†å‰²å‰åçš„å›¾åƒå¦‚æ‰€ç¤ºã€‚<br> åˆ†å‰²å‰<br> <img src="https://images2.imgbox.com/bd/42/tOPbnlqE_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> åˆ†å‰²å<br> <img src="https://images2.imgbox.com/db/de/hgEHIpLI_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <strong>æ¨¡å‹è®­ç»ƒ</strong><br> åœ¨ yolov5/ ç›®å½•ï¼Œè¿è¡Œ train.py æ–‡ä»¶å¼€å§‹è®­ç»ƒï¼š</p> 
<p>â€‹</p> 
<pre><code class="prism language-python">python train<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>weight weights<span class="token operator">/</span>yolov5s<span class="token punctuation">.</span>pt <span class="token operator">-</span><span class="token operator">-</span>batch <span class="token number">16</span> <span class="token operator">-</span><span class="token operator">-</span>epochs <span class="token number">100</span> <span class="token operator">-</span><span class="token operator">-</span>cache
</code></pre> 
<p>å…¶ä¸­çš„å‚æ•°è¯´æ˜ï¼š</p> 
<ul><li>weightï¼šä½¿ç”¨çš„é¢„è®­ç»ƒæƒé‡ï¼Œè¿™é‡Œç¤ºèŒƒä½¿ç”¨çš„æ˜¯ yolov5s æ¨¡å‹çš„é¢„è®­ç»ƒæƒé‡</li><li>batchï¼šmini-batch çš„å¤§å°ï¼Œè¿™é‡Œä½¿ç”¨ 16</li><li>epochsï¼šè®­ç»ƒçš„è¿­ä»£æ¬¡æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬è®­ç»ƒ 100 ä¸ª epoch</li><li>cacheï¼šä½¿ç”¨æ•°æ®ç¼“å­˜ï¼ŒåŠ é€Ÿè®­ç»ƒè¿›ç¨‹</li></ul> 
<p>ç›¸å…³ä»£ç </p> 
<p>â€‹</p> 
<pre><code class="prism language-python"><span class="token comment">#éƒ¨åˆ†ä»£ç </span>
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> device<span class="token punctuation">,</span> tb_writer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Hyperparameters </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>hyp<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    log_dir <span class="token operator">=</span> Path<span class="token punctuation">(</span>tb_writer<span class="token punctuation">.</span>log_dir<span class="token punctuation">)</span> <span class="token keyword">if</span> tb_writer <span class="token keyword">else</span> Path<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>logdir<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token string">'evolve'</span>  <span class="token comment"># logging directory</span>
    wdir <span class="token operator">=</span> log_dir <span class="token operator">/</span> <span class="token string">'weights'</span>  <span class="token comment"># weights directory</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>wdir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    last <span class="token operator">=</span> wdir <span class="token operator">/</span> <span class="token string">'last.pt'</span>
    best <span class="token operator">=</span> wdir <span class="token operator">/</span> <span class="token string">'best.pt'</span>
    results_file <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>log_dir <span class="token operator">/</span> <span class="token string">'results.txt'</span><span class="token punctuation">)</span>
    epochs<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> total_batch_size<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> rank <span class="token operator">=</span> \
        opt<span class="token punctuation">.</span>epochs<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>total_batch_size<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>global_rank

    <span class="token comment"># Save run settings</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_dir <span class="token operator">/</span> <span class="token string">'hyp.yaml'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        yaml<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> f<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_dir <span class="token operator">/</span> <span class="token string">'opt.yaml'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        yaml<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token builtin">vars</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># Configure</span>
    cuda <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">!=</span> <span class="token string">'cpu'</span>
    init_seeds<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> rank<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data_dict <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>FullLoader<span class="token punctuation">)</span>  <span class="token comment"># data dict</span>
    <span class="token keyword">with</span> torch_distributed_zero_first<span class="token punctuation">(</span>rank<span class="token punctuation">)</span><span class="token punctuation">:</span>
        check_dataset<span class="token punctuation">(</span>data_dict<span class="token punctuation">)</span>  <span class="token comment"># check</span>
    train_path <span class="token operator">=</span> data_dict<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span>
    test_path <span class="token operator">=</span> data_dict<span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span>
    nc<span class="token punctuation">,</span> names <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'item'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> opt<span class="token punctuation">.</span>single_cls <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'nc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_dict<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># number classes, names</span>
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span> <span class="token operator">==</span> nc<span class="token punctuation">,</span> <span class="token string">'%g names found for nc=%g dataset in %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span> nc<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  <span class="token comment"># check</span>

    <span class="token comment"># Model</span>
    pretrained <span class="token operator">=</span> weights<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.pt'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span>
        <span class="token keyword">with</span> torch_distributed_zero_first<span class="token punctuation">(</span>rank<span class="token punctuation">)</span><span class="token punctuation">:</span>
            attempt_download<span class="token punctuation">(</span>weights<span class="token punctuation">)</span>  <span class="token comment"># download if not found locally</span>
        ckpt <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># load checkpoint</span>
        <span class="token keyword">if</span> <span class="token string">'anchors'</span> <span class="token keyword">in</span> hyp <span class="token keyword">and</span> hyp<span class="token punctuation">[</span><span class="token string">'anchors'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>yaml<span class="token punctuation">[</span><span class="token string">'anchors'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span><span class="token string">'anchors'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># force autoanchor</span>
        model <span class="token operator">=</span> Model<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>cfg <span class="token keyword">or</span> ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>yaml<span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># create</span>
        exclude <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'anchor'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> opt<span class="token punctuation">.</span>cfg <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># exclude keys</span>
        state_dict <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># to FP32</span>
        state_dict <span class="token operator">=</span> intersect_dicts<span class="token punctuation">(</span>state_dict<span class="token punctuation">,</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exclude<span class="token operator">=</span>exclude<span class="token punctuation">)</span>  <span class="token comment"># intersect</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>state_dict<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># load</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Transferred %g/%g items from %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>state_dict<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weights<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># report</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> Model<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>cfg<span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># create</span>

    <span class="token comment"># Freeze</span>
    freeze <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>  <span class="token comment"># parameter names to freeze (full or partial)</span>
    <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>freeze<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>x <span class="token keyword">in</span> k <span class="token keyword">for</span> x <span class="token keyword">in</span> freeze<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'freezing %s'</span> <span class="token operator">%</span> k<span class="token punctuation">)</span>
                v<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># Optimizer</span>
    nbs <span class="token operator">=</span> <span class="token number">64</span>  <span class="token comment"># nominal batch size</span>
    accumulate <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>nbs <span class="token operator">/</span> total_batch_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># accumulate loss before optimizing</span>
    hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> total_batch_size <span class="token operator">*</span> accumulate <span class="token operator">/</span> nbs  <span class="token comment"># scale weight_decay</span>

    pg0<span class="token punctuation">,</span> pg1<span class="token punctuation">,</span> pg2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># optimizer parameter groups</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        v<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">if</span> <span class="token string">'.bias'</span> <span class="token keyword">in</span> k<span class="token punctuation">:</span>
            pg2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>  <span class="token comment"># biases</span>
        <span class="token keyword">elif</span> <span class="token string">'.weight'</span> <span class="token keyword">in</span> k <span class="token keyword">and</span> <span class="token string">'.bn'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> k<span class="token punctuation">:</span>
            pg1<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>  <span class="token comment"># apply weight decay</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            pg0<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>  <span class="token comment"># all else</span>
</code></pre> 
<p>â€‹</p> 
<p>è®­ç»ƒå¼€å§‹æ—¶çš„æ—¥å¿—ä¿¡æ¯<br> <img src="https://images2.imgbox.com/df/08/gTt6zTaX_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/a1/43/zttieue3_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h2><a id="5__190"></a>5 æœ€å</h2> 
<p>ğŸ§¿ <strong>æ›´å¤šèµ„æ–™, é¡¹ç›®åˆ†äº«ï¼š</strong></p> 
<p><a href="https://gitee.com/dancheng-senior/postgraduate" rel="nofollow">https://gitee.com/dancheng-senior/postgraduate</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/564236510b293d9a0a686ca21bea7274/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Fiddlerå·¥å…· â€” 19.FiddleræŠ“åŒ…HTTPSè¯·æ±‚ï¼ˆäºŒï¼‰</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1007720d5d1c99eeb387e140e3ed0961/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">HarmonyOSâ€”LocalStorageï¼šé¡µé¢çº§UIçŠ¶æ€å­˜å‚¨</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 è¿½é£å°‘å¹´çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>