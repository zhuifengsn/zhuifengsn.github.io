<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>树莓派-内核开发-说明 下载代码 编译 替换内核 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="树莓派-内核开发-说明 下载代码 编译 替换内核" />
<meta property="og:description" content="原文地址：http://nicekwell.net/blog/20171108/shu-mei-pai-nei-he-kai-fa-shuo-ming-xia-zai-dai-ma-bian-yi-ti-huan-nei-he.html
树莓派运行linux系统，内核代码开源，我们可以自己修改内核代码、编写驱动。
本文介绍如何获取linux内核代码，并完成编译、内核替换。
一、概述 树莓派的github主页：https://github.com/raspberrypi，里面包含了linux源码、交叉编译工具链等内容。
对于我们要用到的有两个仓库：
https://github.com/raspberrypi/linux 内核源码
https://github.com/raspberrypi/tools 交叉编译工具链（仅在交叉编译时用到）
注： 1、树莓派里安装的系统镜像版本要和kernel代码对应。因为树莓派系统是在不断开发和升级的，如果你的树莓派使用的是某个时间的系统镜像，那么最好也使用当时的kernel代码。 2、关于内核编译方法，官网有很详细的介绍：https://www.raspberrypi.org/documentation/linux/kernel/building.md，这里算是翻译和补充。 3、以下编译过程在树莓派1和树莓派3B上测试ok。
二、ubuntu里交叉编译 1、获取交叉编译工具和源码 源码：git clone git@github.com:raspberrypi/linux
交叉编译工具：git clone git@github.com:raspberrypi/tools
2、配置编译环境变量 2.1 手动配置环境变量 编译工具下载后，在64位ubuntu上编译我们需要的编译工具bin文件在：tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin 目录下，将此目录添加到环境变量PATH中，添加方法：
PATH=$PATH:/home/nicek/githubProjects/raspberrypi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin
如果是在32位系统中编译则要选择32位的交叉编译工具。
配置完成之后可以用编译工具命令查看到版本号： arm-linux-gnueabihf-gcc -v
之后，所有的make命令都要指明一些环境变量： ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7
ARCH=arm 指明当前要编译arm，虽然树莓派是64位的，这里仍然选择arm，而不是arm64。 CROSS_COMPILE 指明交叉工具链名称。 KERNEL 指明kernel类型，树莓派1设置为kernel，树莓派2、3设置为kernel7。 每次make都需要指明这些环境变量，如： ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make menuconfig ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make -j4 zImage
2.2 自动配置环境变量 上面这些环境变量每次命令都要写很麻烦，可以通过export一次设置： export PATH=$PATH:/home/nicek/githubProjects/raspberrypi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 之后在本终端里执行的所有命令都带有这些环境变量信息。
此 export 命令可以写成一个脚本，然后在编译前在终端里source一下这个脚本即可设置好所有的环境变量。就像android编译前也要先source一下envsetup.sh一样。
1 2 3 4 #!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/1fa8a77ab940274657868e9181f08ade/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-11-08T20:31:59+08:00" />
<meta property="article:modified_time" content="2017-11-08T20:31:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">树莓派-内核开发-说明 下载代码 编译 替换内核</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><br> </p> 
<p>原文地址：<a target="_blank" href="http://nicekwell.net/blog/20171108/shu-mei-pai-nei-he-kai-fa-shuo-ming-xia-zai-dai-ma-bian-yi-ti-huan-nei-he.html" rel="nofollow noopener noreferrer">http://nicekwell.net/blog/20171108/shu-mei-pai-nei-he-kai-fa-shuo-ming-xia-zai-dai-ma-bian-yi-ti-huan-nei-he.html</a></p> 
<p><br> </p> 
<p></p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 树莓派运行linux系统，内核代码开源，我们可以自己修改内核代码、编写驱动。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 本文介绍如何获取linux内核代码，并完成编译、内核替换。</p> 
<h2 id="section" style='margin:32px 0px 12px; font-size:36px; font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51)'> 一、概述</h2> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 树莓派的github主页：<a target="_blank" href="https://github.com/raspberrypi" style="background-color:transparent; color:rgb(51,122,183)" rel="noopener noreferrer">https://github.com/raspberrypi</a>，里面包含了linux源码、交叉编译工具链等内容。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 对于我们要用到的有两个仓库：</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <a target="_blank" href="https://github.com/raspberrypi/linux" style="background-color:transparent; color:rgb(51,122,183)" rel="noopener noreferrer">https://github.com/raspberrypi/linux</a> 内核源码</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <a target="_blank" href="https://github.com/raspberrypi/tools" style="background-color:transparent; color:rgb(51,122,183)" rel="noopener noreferrer">https://github.com/raspberrypi/tools</a> 交叉编译工具链（仅在交叉编译时用到）</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 注：<br style=""> 1、树莓派里安装的系统镜像版本要和kernel代码对应。因为树莓派系统是在不断开发和升级的，如果你的树莓派使用的是某个时间的系统镜像，那么最好也使用当时的kernel代码。<br style=""> 2、关于内核编译方法，官网有很详细的介绍：<a target="_blank" href="https://www.raspberrypi.org/documentation/linux/kernel/building.md" rel="nofollow noopener noreferrer" style="background-color:transparent; color:rgb(51,122,183)">https://www.raspberrypi.org/documentation/linux/kernel/building.md</a>，这里算是翻译和补充。<br style=""> 3、以下编译过程在树莓派1和树莓派3B上测试ok。</p> 
<h2 id="ubuntu" style='margin:32px 0px 12px; font-size:36px; font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51)'> 二、ubuntu里交叉编译</h2> 
<h3 id="section-1" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 1、获取交叉编译工具和源码</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 源码：<span style="font-weight:700">git clone git@github.com:raspberrypi/linux</span></p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 交叉编译工具：<span style="font-weight:700">git clone git@github.com:raspberrypi/tools</span></p> 
<h3 id="section-2" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 2、配置编译环境变量</h3> 
<h4 id="section-3" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:24px'> 2.1 手动配置环境变量</h4> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 编译工具下载后，在64位ubuntu上编译我们需要的编译工具bin文件在：tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin 目录下，将此目录添加到环境变量PATH中，添加方法：</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">PATH=$PATH:/home/nicek/githubProjects/raspberrypi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin</span></p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 如果是在32位系统中编译则要选择32位的交叉编译工具。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 配置完成之后可以用编译工具命令查看到版本号：<br style=""> arm-linux-gnueabihf-gcc -v</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 之后，所有的make命令都要指明一些环境变量：<br style=""> <span style="font-weight:700">ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7</span></p> 
<table style='border-spacing:0px; border-collapse:collapse; border-style:solid; border-width:1px; border-color:rgb(231,227,231); color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'><tbody style=""><tr style=""><td style="padding:0px 3px; border-style:dashed; border-width:1px; border-color:rgb(231,227,231)"> ARCH=arm</td><td style="padding:0px 3px; border-style:dashed; border-width:1px; border-color:rgb(231,227,231)"> 指明当前要编译arm，虽然树莓派是64位的，这里仍然选择arm，而不是arm64。</td></tr><tr style=""><td style="padding:0px 3px; border-style:dashed; border-width:1px; border-color:rgb(231,227,231)"> CROSS_COMPILE</td><td style="padding:0px 3px; border-style:dashed; border-width:1px; border-color:rgb(231,227,231)"> 指明交叉工具链名称。</td></tr><tr style=""><td style="padding:0px 3px; border-style:dashed; border-width:1px; border-color:rgb(231,227,231)"> KERNEL</td><td style="padding:0px 3px; border-style:dashed; border-width:1px; border-color:rgb(231,227,231)"> 指明kernel类型，<span style="font-weight:700">树莓派1设置为kernel，树莓派2、3设置为kernel7。</span></td></tr></tbody></table> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 每次make都需要指明这些环境变量，如：<br style=""> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make menuconfig<br style=""> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make -j4 zImage</p> 
<h4 id="section-4" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:24px'> 2.2 自动配置环境变量</h4> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 上面这些环境变量每次命令都要写很麻烦，可以通过export一次设置：<br style=""> export PATH=$PATH:/home/nicek/githubProjects/raspberrypi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7<br style=""> 之后在本终端里执行的所有命令都带有这些环境变量信息。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 此 export 命令可以写成一个脚本，然后在编译前在终端里source一下这个脚本即可设置好所有的环境变量。就像android编译前也要先source一下envsetup.sh一样。</p> 
<span style=""></span> 
<div class="highlight" style="margin-bottom:0px; overflow-y:hidden; overflow-x:auto; border-top:1px solid rgb(221,221,221)"> 
 <table style="border-spacing:0px; border-collapse:collapse; background-color:transparent"><tbody style=""><tr style=""><td class="gutter" style="padding:0px"> <pre class="line-numbers" style='overflow:auto; font-family:Menlo,Monaco,Consolas,"Courier New",monospace; font-size:13px; padding:1em 0.8em 0.8em; margin-top:0px; margin-bottom:0px; line-height:1.45em; color:rgb(51,51,51); word-break:break-all; word-wrap:break-word; border-top:none; border-bottom:none; border-left:none; text-align:right; border-right:1px solid rgb(235,228,206)!important'><span class="line-number" style="color:rgb(147,161,161)!important">1</span>
<span class="line-number" style="color:rgb(147,161,161)!important">2</span>
<span class="line-number" style="color:rgb(147,161,161)!important">3</span>
<span class="line-number" style="color:rgb(147,161,161)!important">4</span>
</pre> </td><td class="code" style="padding:0px; width:815px"> <pre style='overflow:auto; font-family:Menlo,Monaco,Consolas,"Courier New",monospace; font-size:13px; padding:0px; margin-top:0px; margin-bottom:0px; line-height:1.42857; color:rgb(51,51,51); word-break:break-all; word-wrap:break-word; background:none; border:none'><code class="bash" style='font-size:undefined; padding:0.8em; background:rgb(0,0,0); overflow-y:hidden; display:block; overflow-x:auto; line-height:1.45em; font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace!important; color:rgb(88,110,117)!important'><span class="line" style=""><span class="c" style="color:rgb(147,161,161)!important; font-style:italic!important">#!/bin/bash</span>
</span><span class="line" style=""><span class="nv" style="color:rgb(38,139,210)!important">DIR</span><span class="o" style="font-weight:bold!important">=</span><span class="s2" style="color:rgb(42,161,152)!important">"$( cd "</span><span class="k" style="color:rgb(203,75,22)!important">$(</span> dirname <span class="s2" style="color:rgb(42,161,152)!important">"${BASH_SOURCE[0]}"</span> <span class="k" style="color:rgb(203,75,22)!important">)</span><span class="s2" style="color:rgb(42,161,152)!important">" &amp;&amp; pwd )"</span>
</span><span class="line" style=""><span class="nb" style="color:rgb(133,153,0)!important">export </span><span class="nv" style="color:rgb(38,139,210)!important">PATH</span><span class="o" style="font-weight:bold!important">=</span><span class="s2" style="color:rgb(42,161,152)!important">"$PATH:$DIR/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/"</span>
</span><span class="line" style=""><span class="nb" style="color:rgb(133,153,0)!important">export </span><span class="nv" style="color:rgb(38,139,210)!important">ARCH</span><span class="o" style="font-weight:bold!important">=</span>arm <span class="nv" style="color:rgb(38,139,210)!important">CROSS_COMPILE</span><span class="o" style="font-weight:bold!important">=</span>arm-linux-gnueabihf- <span class="nv" style="color:rgb(38,139,210)!important">KERNEL</span><span class="o" style="font-weight:bold!important">=</span>kernel7
</span></code></pre> </td></tr></tbody></table> 
</div> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 上述命令中的路径可能和你实际不同，注意修改。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> export环境变量后，在本终端里的后续命令都可以不用再指明这些环境变量，如：<br style=""> 配置之前的命令：ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make menuconfig<br style=""> 配置之后的命令：make menuconfig</p> 
<h3 id="config" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 3、配置config</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> linux源码中有很多工程：<br style=""> 树莓派1的工程是<span style="font-weight:700">bcmrpi_defconfig</span>；<br style=""> 树莓派2、3的工程是<span style="font-weight:700">bcm2709_defconfig</span>。</p> 
<h4 id="config-1" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:24px'> 3.1 使用源码里自带的config</h4> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make bcm2709_defconfig</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 此命令功能是获取bcm2709_defconfig的配置到 .config里。<br style=""> 我们可以直接用工程里的配置，但这样的话可能会丢失原来使用的树莓派的配置，这里提供一个方法可以获取当前正在使用的树莓派的config。</p> 
<h4 id="config-2" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:24px'> 3.2 获取当前树莓派的config</h4> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 已经开机的树莓派上会有这个节点：<span style="font-weight:700">/proc/config.gz</span>，从这个节点可以获取本树莓派的config。<br style=""> 如果没有这个节点的话则需要先加载模块：<span style="font-weight:700">sudo modprobe configs</span></p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 把 config.gz 内容复制到要编译的电脑上：<br style=""> scp pi@[ip]:/proc/config.gz .</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 解压，保存为.confg文件。<br style=""> zcat config.gz &gt; .config<br style=""> 注：必须在linux环境下解压，在mac下会乱码。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 把此config文件复制到linux源码的根目录。</p> 
<h3 id="section-5" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 4、编译</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 安装必要的库：<br style=""> sudo apt-get install bc<br style=""> sudo apt-get install libncurses5-dev libncursesw5-dev<br style=""> sudo apt-get install zlib1g:i386<br style=""> sudo apt-get install libc6-i386 lib32stdc++6 lib32gcc1 lib32ncurses5</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">1、执行menuconfig</span><br style=""> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 <span style="font-weight:700">make menuconfig</span><br style=""> 如果没什么改的就不用执行这一步。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">2、编译</span><br style=""> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 <span style="font-weight:700">make -j4 zImage modules dtbs</span> 2&gt;&amp;1 | tee build.log<br style=""> 以n进程编译。不指明几进程的话则默认以单进程编译。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">3、打包zImage文件</span><br style=""> 直接用linux源码包里的工具：<br style=""> ./scripts/mkknlimg arch/arm/boot/zImage ./kernel_new.img<br style=""> 在本目录生成一个kernel_new.img文件，这个文件就是要放到sd卡中的文件。<br style=""> 注：网上很多地方说的用 tools/mkimage/imagetool-uncompressd.py 的方法不行！！</p> 
<h3 id="sddirectly-sd" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 5、挂载树莓派sd卡，并安装编译出的DIRECTLY 到sd卡</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 把树莓派的sd卡插入ubuntu系统电脑，树莓派的sd卡有两个分区：<br style=""> 一个fat分区，是boot相关的内容，kernel的img文件就放在这个分区里；<br style=""> 一个是ext4分区，也就是系统的根目录分区。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 我们生成的文件涉及到这两个分区的内容，一般插入ubuntu后会自动挂载，fat分区可以不用root权限操作，ext4分区需要root权限操作。<br style=""> </p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 两个分区具体挂载在什么地方可以自己决定，以下用[fat]表示boot挂载的路径，[ext4]表示ext4挂载的路径。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">1、安装modules</span><br style=""> sudo ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KERNEL=kernel7 make INSTALL_MOD_PATH=[ext4] modules_install<br style=""> 操作ext4分区，需要root权限。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">2、更新 kernel.img 文件</span><br style=""> 前面已经用 mkknlimg 工具打包了kernel_new.img文件了，把它复制到boot分区并配置使用即可：<br style=""> cp kernel_new.img [fat]/<br style=""> 编辑 [fat]/config.txt 文件，在最后加入一行：<br style=""> kernel=kernel_new.img</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> <span style="font-weight:700">3、复制其他相关文件</span><br style=""> cp arch/arm/boot/dts/<span style="">.dtb [fat]/<br style=""> cp arch/arm/boot/dts/overlays/</span>.dtb* [fat]/overlays/<br style=""> cp arch/arm/boot/dts/overlays/README [fat]/overlays/</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 更新完成后插回树莓派即可开机，开机后可以用 uname -a 命令查看kernel信息已经改变。</p> 
<h2 id="section-6" style='margin:32px 0px 12px; font-size:36px; font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51)'> 三、树莓派本地编译</h2> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 树莓派上本地编译和上面交叉编译原理基本相同，由于是本地编译，在编译工具和环境变量配置方面还简单一些。<br style=""> 树莓派上编一次内核花了将近2小时。</p> 
<h3 id="section-7" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 1、获取源码</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> git clone git@github.com:raspberrypi/linux</p> 
<h3 id="section-8" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 2、配置编译环境</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 在ubuntu里交叉编译时需要配置的环境变量有：</p> 
<ul style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'><li style="">PATH: 添加交叉工具链的目录</li><li style="">ARCH: 配置成arm</li><li style="">CROSS_COMPILE: 配置成ubuntu上使用的交叉工具链arm-linux-gnueabihf- KERNEL=kernel7</li><li style="">KERNEL: 配置成kernel7</li></ul> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 而在树莓派本地编译：<br style=""> 关于交叉工具链，本身的编译工具就可以编译给自己使用，所以不用配置；<br style=""> 只需要配置 KERNEL=kernel7 即可。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 和上面相同，可以用 export KERNEL=kernel7，一次设置之后此终端里所有命令都带有此环境变量。<br style=""> 也可以更进一步写成脚本，不过这里这一行命令很简单，不写脚本也可以。</p> 
<h3 id="config-3" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 3、配置config</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 和上面一样，<br style=""> 树莓派1使用的是 <span style="font-weight:700">bcmrpi_defconfig</span>，<br style=""> 树莓派2、3使用的是 <span style="font-weight:700">bcm2709_defconfig</span>。<br style=""> 例：KERNEL=kernel7 make bcm2709_defconfig</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 如果要使用树莓派自带的config的话：<br style=""> <span style="font-weight:700">sudo modprobe configs</span> # 加载模块<br style=""> <span style="font-weight:700">zcat config.gz &gt; .config</span> # 获取配置</p> 
<h3 id="section-9" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 4、编译</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 安装必要的库：<br style=""> sudo apt-get install bc<br style=""> sudo apt-get install libncurses5-dev libncursesw5-dev<br style=""> sudo apt-get install zlib1g<br style=""> sudo apt-get install libc6</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 1、执行menuconfig<br style=""> <span style="font-weight:700">KERNEL=kernel7 make menuconfig</span><br style=""> 没什么要改的话就不用执行这一步。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 2、编译<br style=""> <span style="font-weight:700">KERNEL=kernel7 make -j4 zImage modules dtbs 2&gt;&amp;1 | tee build.log</span><br style=""> 以n进程编译。不指明几进程的话则默认以单进程编译。</p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 3、打包zImage文件<br style=""> 直接用linux源码包里的工具：<br style=""> <span style="font-weight:700">./scripts/mkknlimg arch/arm/boot/zImage ./kernel_new.img</span><br style=""> 在本目录生成一个kernel_new.img文件，这个文件就是要放到sd卡中的文件。</p> 
<h3 id="section-10" style='font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; line-height:1.3; color:rgb(51,51,51); margin-top:32px; margin-bottom:12px; font-size:30px'> 5、更新系统</h3> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 1、安装模块<br style=""> <span style="font-weight:700">sudo make modules_install</span></p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 2、复制dtb文件<br style=""> <span style="font-weight:700">sudo cp arch/arm/boot/dts/<span style="">.dtb /boot/ sudo cp arch/arm/boot/dts/overlays/</span>.dtb* /boot/overlays/ sudo cp arch/arm/boot/dts/overlays/README /boot/overlays/</span></p> 
<p style='margin-top:0px; margin-bottom:10px; color:rgb(51,51,51); font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-size:16px'> 3、更新kernel.img文件<br style=""> <span style="font-weight:700">sudo cp arch/arm/boot/zImage /boot/$KERNEL.img</span></p> 
<br> 
<p><br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4bcb5b157dbfb353393ed43ca3108f46/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">图像处理技术上的空间域和空间频率域</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aaede4ef7e0e0caaecee2a730ff625d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">字符集&amp;字符编码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>