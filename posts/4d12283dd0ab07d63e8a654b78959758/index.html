<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Centos7安装Redis(超详细)与Redis的使用 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Centos7安装Redis(超详细)与Redis的使用" />
<meta property="og:description" content="简介 ​ Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。从2013年5月开始，Redis的开发由Pivotal赞助。
​ 下载地址：https://github.com/microsoftarchive/redis/releases
安装 第一步，先在Windows上下载 Redis, 下载地址：https://redis.io/download&gt;，传输到Centos的/data/redis目录下，或者在/data/redis目录下使用wget命令：wget https://download.redis.io/releases/redis-7.0.2.tar.gz
mkdir -r /data/redis cd /data/redis wget https://download.redis.io/releases/redis-7.0.2.tar.gz 第二步，解压，然后进入到解压目录，执行如下命令：
tar -zxvf redis-7.0.2.tar.gz 第三步，进入到redis-7.0.2目录下执行如下命令，编译并检查安装环境：
cd /data/redis/redis-7.0.2 make 如果执行 make令报错，redis是由C语言开发，因此安装之前必须要确保服务器已经安装了gcc，那么执行如下命令，安装 c 语言的编译器：
yum install -y cpp binutils glibc glibc-kernheaders glibc-common glibc-devel gcc 执行完如上命令，再试着执行 make 命令，如果还是报错，再执行如下命令：
yum -y install centos-release-scl yum -y install devtoolset-9-gcc devtoolset-9-gcc-c&#43;&#43; devtoolset-9-binutils scl enable devtoolset-9 bash 执行完如上的命令，再执行 make 命令，还是报错，就执行如下命令：
make MALLOC=libc 解决如上的问题的方式参照网址：https://blog.csdn.net/realize_dream/article/details/106483499
第四步，执行如下命令进行安装：
make install PREFIX=/data/redis ## 注意PREFIX=/data/redis指定安装目录，可指定可不指定，如果不指定默认是在/data/redis/redis-7.0.2/src/目录下,如果指定则会在/data/redis目录下创建一个bin文件夹，会安装在/data/redis/bin目录下 第五步，验证是否安装成功：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/4d12283dd0ab07d63e8a654b78959758/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-03T20:19:18+08:00" />
<meta property="article:modified_time" content="2023-09-03T20:19:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Centos7安装Redis(超详细)与Redis的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>简介</h2> 
<p><img src="https://images2.imgbox.com/a7/36/YU6yUOfo_o.png" alt="在这里插入图片描述"></p> 
<p>​ Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，<em>Redis</em>的开发工作由VMware主持。从2013年5月开始，<em>Redis</em>的开发由Pivotal赞助。</p> 
<p>​ 下载地址：<a href="https://github.com/microsoftarchive/redis/releases">https://github.com/microsoftarchive/redis/releases</a></p> 
<h2><a id="_6"></a>安装</h2> 
<p>第一步，先在Windows上下载 Redis, 下载地址：https://redis.io/download&gt;，传输到Centos的/data/redis目录下，或者在/data/redis目录下使用wget命令：wget https://download.redis.io/releases/redis-7.0.2.tar.gz</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-r</span> /data/redis
<span class="token builtin class-name">cd</span> /data/redis
<span class="token function">wget</span> https://download.redis.io/releases/redis-7.0.2.tar.gz
</code></pre> 
<p>第二步，解压，然后进入到解压目录，执行如下命令：</p> 
<pre><code class="prism language-bash"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> redis-7.0.2.tar.gz
</code></pre> 
<p>第三步，进入到redis-7.0.2目录下执行如下命令，编译并检查安装环境：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">make</span>
</code></pre> 
<p>如果执行 make令报错，redis是由C语言开发，因此安装之前必须要确保服务器已经安装了gcc，那么执行如下命令，安装 c 语言的编译器：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> cpp binutils glibc glibc-kernheaders glibc-common glibc-devel  gcc
</code></pre> 
<p>执行完如上命令，再试着执行 make 命令，如果还是报错，再执行如下命令：</p> 
<pre><code class="prism language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> centos-release-scl
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils
scl <span class="token builtin class-name">enable</span> devtoolset-9 <span class="token function">bash</span>
</code></pre> 
<p>执行完如上的命令，再执行 make 命令，还是报错，就执行如下命令：</p> 
<pre><code class="prism language-bash"><span class="token function">make</span> <span class="token assign-left variable">MALLOC</span><span class="token operator">=</span>libc
</code></pre> 
<p><code>解决如上的问题的方式参照网址：https://blog.csdn.net/realize_dream/article/details/106483499</code></p> 
<p>第四步，执行如下命令进行安装：</p> 
<pre><code class="prism language-bash"><span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/data/redis
<span class="token comment">## 注意PREFIX=/data/redis指定安装目录，可指定可不指定，如果不指定默认是在/data/redis/redis-7.0.2/src/目录下,如果指定则会在/data/redis目录下创建一个bin文件夹，会安装在/data/redis/bin目录下</span>
</code></pre> 
<p>第五步，验证是否安装成功：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 启动redis：进入src目录下执行如下命令</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src/
./redis-server
<span class="token comment"># 如果想让redis的日志在后台进行运行，进入src目录下执行执行如下命令</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src/
./redis-server <span class="token operator">&amp;</span>
<span class="token comment"># 指定配置配置文件的方式启动redis，进入src目录下执行执行如下命令</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src/
./redis-server ./redis.conf
<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 启动完成后连接进入redis，进入src目录下执行执行如下命令</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src/
./redis-cli
<span class="token comment"># 启动完成后远程连接进入redis，进入src目录下执行执行如下命令</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src/
./redis-cli <span class="token parameter variable">-a</span> password <span class="token parameter variable">-h</span> <span class="token function">ip</span>
<span class="token comment"># 进入redis后退出，执行执行如下命令</span>
quit
<span class="token comment"># 关闭redis服务，进入src目录下执行执行如下命令</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src/
./redis-cli <span class="token function">shutdown</span>
</code></pre> 
<p>第六步：配置环境变量(如果想在任何位置下启动redis，可进行此步骤，如果只想在<code>/data/redis/redis-7.0.2/src/</code>目录下启动可忽略此步骤)</p> 
<pre><code class="prism language-bash"><span class="token function">cp</span> /etc/profile /etc/profile.back
<span class="token function">vim</span> /etc/profile
<span class="token comment">## 在文件末尾添加如下内容</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REDIS_HOME</span><span class="token operator">=</span>/data/redis/redis-7.0.2/src
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$REDIS_HOME</span>
</code></pre> 
<p>执行完上述命令后，可在任意目录下执行如下命令进行校验环境变量是否配置成功</p> 
<pre><code class="prism language-bash">redis-server /data/redis/redis-7.0.2/redis.conf <span class="token operator">&amp;</span>
redis-cli
redis-cli <span class="token function">shutdown</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/7a/suth4jPo_o.png" alt="在这里插入图片描述"><br> 第七步，设置开机自启，编辑/etc/systemd/system/redis.service文件，执行如下命令，该步骤根据需要配置</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/systemd/system/redis.service
<span class="token comment">## 在文件末尾添加如下内容</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>redis-server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
 
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/redis/redis-7.0.2/src/redis-server /data/redis/redis-7.0.2/redis.conf
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true
 
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> 
<p>第八步，远程客户端连接，redis配置文件中只允许在本机中访问(redis服务在哪台机器上启动就只能在哪台机器上访问)不允许远程连接，如果需要远程访问执行如下命令</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>在vim状态下直接输入/bind查找bind字符串,找到<code>bind 127.0.0.1 -::1</code>,将其修改为</p> 
<pre><code class="prism language-bash"><span class="token comment">#bind 127.0.0.1 -::1</span>
<span class="token comment">## 允许任何IP访问</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
</code></pre> 
<p>开放redis的<code>6379</code>端口，并重新加载防火墙</p> 
<pre><code class="prism language-bash">firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">6379</span>/tcp <span class="token parameter variable">--permanent</span> <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre> 
<h2><a id="_122"></a>使用</h2> 
<h3><a id="Redis_123"></a>Redis的优势</h3> 
<p><strong>快</strong>：Redis非常快，每秒可执行大约110000次的设置(SET)操作，每秒大约可执行81000次的读取/获取(GET)操作。</p> 
<p><strong>支持丰富的数据类型</strong>：Redis支持开发人员常用的大多数数据类型，例如列表，集合，排序集和散列等等。这使得Redis很容易被用来解决各种问题，因为我们知道哪些问题可以更好使用地哪些数据类型来处理解决。</p> 
<p><strong>操作的原子性</strong>：所有Redis操作都是原子操作，这确保如果两个客户端并发访问，Redis服务器能接收更新的值。</p> 
<p><strong>很多使用工具</strong>：Redis是一个多实用工具，可用于多种用例，如：缓存，消息队列(Redis本地支持发布/订阅)，应用程序中的任何短期数据，例如，web应用程序中的会话，网页命中计数等。</p> 
<h3><a id="_132"></a>数据类型</h3> 
<p>一共有九种，常见的有五种</p> 
<pre><code class="prism language-bash">A. 字符串类型 <span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">(</span>字符串的值，最大长度为512M<span class="token punctuation">)</span>
<span class="token comment">## [特点：一个redis的key只对应一个value]</span>
<span class="token comment">## [应用场景：点击数量、访问人数、手机号验证码]</span>

B. 列表类型<span class="token punctuation">(</span>List<span class="token punctuation">)</span> <span class="token punctuation">(</span>列表的最大长度为2^32 -1个元素，大概40亿<span class="token punctuation">)</span>
<span class="token comment">## [特点：value有序(有序是指：按存入的顺序)，数据可以重复，一个redis的key可以对应多个value]</span>
<span class="token comment">## [应用场景：评论功能]</span>

C. 集合类型<span class="token punctuation">(</span>Set<span class="token punctuation">)</span>  
<span class="token comment">## [特点：value是无序的(无序是指：没有按存入的顺序)，value不可以重复，一个redis的key可以对应多个value]</span>
<span class="token comment">## [应用场景：点赞功能]</span>

D. 有序集合类型<span class="token punctuation">(</span>zset<span class="token punctuation">)</span>
<span class="token comment">## [特点：对value进行了排序，value不可以重复，一个redis的key可以对应多个value]</span>
<span class="token comment">## [应用场景：排行榜、百度热搜]</span>

E. 散列类型<span class="token punctuation">(</span>Hash<span class="token punctuation">)</span>  <span class="token punctuation">(</span>map<span class="token punctuation">)</span>
<span class="token comment">## [特点：一个redis的key可以对应多个value，每个value有是以K-V键值对的形式存在]</span>
<span class="token comment">## [应用场景：对象信息的存储]</span>

F.存储地理位置信息<span class="token punctuation">(</span>Geo<span class="token punctuation">)</span>  <span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_157"></a>常用数据类型的操作</h4> 
<pre><code class="prism language-bash">keys * <span class="token builtin class-name">:</span> 获取数据库的所有的键。   ***

exists key: 判断某个键是否存在，返回表示存在，0表示部存在。

<span class="token builtin class-name">type</span> key: 获取键的类型<span class="token punctuation">(</span>string，hash，list，set，zset<span class="token punctuation">)</span>

<span class="token builtin class-name">help</span> @string/list/set/zset/hash 查看某种数据类型的所有相关命令的使用

<span class="token keyword">select</span> <span class="token punctuation">[</span><span class="token number">0</span> ~ <span class="token number">16</span><span class="token punctuation">]</span> 选择redis的数据库，redis有16个数据库，不选择的话默认使用的是第一个数据库0

flushall:清空所有的的数据
</code></pre> 
<h4><a id="String_171"></a>String类型的操作</h4> 
<pre><code class="prism language-bash"><span class="token builtin class-name">set</span> key value: 设置或者覆盖值
get key:  根据键取值
del key <span class="token punctuation">[</span>key1, key2,key3,<span class="token punctuation">..</span>.<span class="token punctuation">]</span>: 删除某个键                                          
incr key <span class="token builtin class-name">:</span> 将对应的键的值，递增1，前提是该value必须是个整数
decr key <span class="token builtin class-name">:</span> 将对应的键的值，递减1，前提是该value必须是个整数     
expire key 时间<span class="token punctuation">(</span>秒<span class="token punctuation">)</span>：设置key的存活时间，单位为秒
<span class="token builtin class-name">set</span> key value EX <span class="token number">60</span>: 表示给key设置value，然后指定过期时间是60S
ttl code: 查看存活时间。 <span class="token punctuation">(</span>TTL  Time To Live<span class="token punctuation">)</span>
setnx key value: 如果不存在就设置。<span class="token punctuation">(</span>redis设置分布式锁<span class="token punctuation">)</span>
<span class="token builtin class-name">set</span> key value EX 秒 NX: 如果不存在就设置值，并且指定过期时间
</code></pre> 
<h4><a id="List_185"></a>List类型的操作</h4> 
<pre><code class="prism language-bash">lpush key value: 往左侧中设置值
rpush key value: 往右侧插入值
lrange key start end: 取集合中索引在<span class="token punctuation">[</span>start, end<span class="token punctuation">]</span>之间的值
例：lrange aa <span class="token number">0</span> <span class="token number">2</span>   lrange aa <span class="token number">0</span> <span class="token parameter variable">-1</span>
llen key: 获取集合的长度
lpop key: 移除并返回首元素
rpop key: 移除并返回尾元素
lrem key count value: 移除列表中count个值为value的数据。当count为0，移除所有。（了解）
ltrim key start end: 保留指定区域的元素，其他全部删除。  （了解）
lset key index value: 设置索引为index的值为value. <span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
lindex key index: 获取索引为index的元素。<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Set_200"></a>Set类型的操作</h4> 
<pre><code class="prism language-bash">sadd key member <span class="token punctuation">[</span>memerb<span class="token punctuation">..</span><span class="token punctuation">]</span>: 往集合中添加元素，返回添加成功的个数
smembers key: 返回集合中所有的元素
srem key member: 删除元素
sismember key member: 判断member是否存在, 存在返回1，不存在返回0
scard key: 返回集合中的个数
srandmember key: 从集合中随机返回一个值<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
spop key: 移除并返回一个随机的member<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
smove src destination member: 将src中member元素移动到destination中<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
sinter key key: 对集合求交集<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
sunion key key: 对两个集合求并集<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
sdiffstore destination key1 key2:  差集运算并存储到集合中<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
sinterstore destination key1 key2: 交集存储到集合中<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
sunionstore destionation key1 key2: 并集存储到集合中<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Zset_217"></a>Zset类型的操作</h4> 
<pre><code class="prism language-bash">zadd key score value <span class="token punctuation">[</span>score1 value1<span class="token punctuation">]</span>: 添加<span class="token punctuation">(</span>每个value添加的时候需要给出一个对应的分数score,zset是依据这个分数对value进行排序的<span class="token punctuation">)</span>
zscore key value: 获取分数
zrange key start end: 获取索引从start开始，到end结束的所有的元素
zrange key start end withscores: 查询索引从start开始，到end结束的所有元素名和分数
zrange key <span class="token number">0</span> <span class="token number">100</span> byscore withscores limit <span class="token number">0</span> <span class="token number">2</span>:  查询分数在 <span class="token punctuation">[</span><span class="token number">0,100</span><span class="token punctuation">]</span> 之间所有的元素，然后分页（背）
zcard key: 获取元素的个数
zcount key min max: 获取在指定分数范围内的元素的个数。闭区间<span class="token punctuation">[</span>min, max<span class="token punctuation">]</span>
zrem key value1 <span class="token punctuation">[</span>value2<span class="token punctuation">]</span>: 删除元素
zrank key value: 返回value在key中的下标
zincrby key num value: 给value对应的score的原有值的基础上增长num<span class="token punctuation">[</span>新的score<span class="token operator">=</span>原有的score+num<span class="token punctuation">]</span>
zrevrange key <span class="token number">2</span> <span class="token number">3</span>: 倒序排列，然后去取下标在<span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>区间的元素
zrangebyscore key min max limit index length<span class="token punctuation">;</span> 分页,min是最低分，max最高分，index是索引，length是长度。 <span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
zrangebyscore key begin end: 查询分数在<span class="token punctuation">[</span>begin,end<span class="token punctuation">]</span>区间的所有值，根据分数排序。<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
zremrangebyscore key min max:  移除分数在<span class="token punctuation">[</span>min,max<span class="token punctuation">]</span>之间的数据，返回移除的个数。<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
zremrangebyrank key begin end: 移除索引在<span class="token punctuation">[</span>begin,end<span class="token punctuation">]</span>之间的数据。<span class="token punctuation">(</span>了解<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Hash_236"></a>Hash类型的操作</h4> 
<pre><code class="prism language-bash">hset key field value: 设置值, 如果存在相同的Key，对应的值会覆盖之前的
hmset key field value filed value: 设置多个值
hget key field: 取值
hexists key field: 是否存在
hgetall key: 获取集合中所有的元素
hdel key field: 删除字段
hkeys key: 获取所有的key
hvals key: 获取所有的字段值
hlen key: 获取字段的数量
hsetnx key field value <span class="token builtin class-name">:</span> 不存在的时候设置值
</code></pre> 
<h3><a id="_250"></a>配置</h3> 
<h4><a id="_251"></a>配置密码</h4> 
<p>第一步，打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步，在vim状态下直接输入/requirepass查找requirepass,找到<code>#requirepass foobared</code>,在下面一行插入如下命令保存并退出</p> 
<pre><code class="prism language-bash">requirepass password
</code></pre> 
<h4><a id="_261"></a>启动</h4> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src
./redis-server /data/redis/redis-7.0.2/redis.conf <span class="token operator">&amp;</span>
</code></pre> 
<h4><a id="_266"></a>连接（进入）</h4> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2/src
<span class="token comment">## [本机连接,没有-h默认指向的是本机127.0.0.1]</span>
./redis-cli <span class="token parameter variable">-a</span> password
<span class="token comment">## [远程连接]</span>
./redis-cli <span class="token parameter variable">-a</span> password <span class="token parameter variable">-h</span> <span class="token function">ip</span>
</code></pre> 
<h3><a id="_274"></a>持久化</h3> 
<p>Redis有两种数据持久化策略：​RDB(Redis DataBase)和 AOF (Append Only File)，所谓的持久化是将内存中的数据写入到磁盘中，即在指定目录下生成一个dump.rdb文件。</p> 
<h4><a id="RDBRedis_DataBase_276"></a>RDB(Redis DataBase)策略</h4> 
<p>RDB 是 Redis 默认的持久化方案。在指定的时间间隔内，执行指定次数的写操作，则会将内存中的数据写入到磁盘中。即在指定目录下生成一个dump.rdb文件。Redis 重启后会通过加载dump.rdb文件来恢复数据。<strong>RDB存的是数据:name-&gt;张三</strong></p> 
<p><code>如果需要修改RDB(Redis DataBase)策略，请按照如下命令执行&gt;&gt;&gt;&gt;注意：此处不建议修改，默认的策略即可保障我们的需求</code></p> 
<h4><a id="RedisRDB_281"></a>Redis进行RDB持久化的命令有两种：</h4> 
<p>1、save<br> 该命令会阻塞当前Redis服务器，执行save命令期间，Redis不能处理其他命令，直到RDB过程完成为止。<br> 显然该命令对于内存比较大的实例会造成长时间阻塞，这是致命的缺陷，为了解决此问题，Redis提供了第二种方式。</p> 
<p>2、bgsave</p> 
<p>执行该命令时，Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。具体操作是Redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，一般时间很短。fork 会消耗一定时间，并且父子进程所占据的内存是相同的，当 Redis 键值较大时，fork 的时间会很长，这段时间内 Redis 是无法响应其他命令的。<br> 　　<br> 基本上 Redis 内部所有的RDB操作都是采用 bgsave 命令。Redis 会单独创建（fork）一个子进程进行持久化，会先将数据写入一个临时文件中，待持久化过程结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程不进行任何 IO 操作，这就确保的极高的性能。如果需要大规模的数据的恢复，且对数据恢复的完整性不是非常敏感，那 RDB 方式要比 AOF 方式更加高效。RDB 唯一的缺点是最后一次持久化的数据可能会丢失。</p> 
<p><a href="https://blog.csdn.net/dl962454/article/details/109787652">可参考1</a>,<a href="https://www.cnblogs.com/lee0527/p/12248756.html" rel="nofollow">可参考2</a></p> 
<h5><a id="_294"></a>修改数据持久化方案</h5> 
<p>第一步，打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步，在vim状态下直接输入/Save the DB to disk查找Save the DB to disk字符串,找到后在<code># save 3600 1 300 100 60 10000</code>下一行插入如下命令</p> 
<pre><code class="prism language-bash"><span class="token comment">## [save 秒 数据发生改变的条数]</span>
<span class="token comment">## [save 60秒 5条数据发生改变]</span>
save <span class="token number">60</span> <span class="token number">5</span>
<span class="token comment">## [在60秒内如果有5条数据发生改变就进行一次持久化(将数据写入到磁盘中)]</span>
</code></pre> 
<h5><a id="RDB_307"></a>修改RDB数据持久化位置</h5> 
<p>第一步，打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步，在vim状态下直接输入/dbfilename查找dbfilename字符串,找到后将<code>dbfilename dump.rdb</code>修改为如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment">## [dbfilename 文件名]</span>
dbfilename myfile.rdb
<span class="token comment">## redis的默认工作目录是"./"即"redis.conf"所在的目录</span>
<span class="token comment">## 在vim状态下输入/The working directory可以查看</span>
</code></pre> 
<h4><a id="AOFAppend_Only_File_322"></a>AOF(Append Only File)策略</h4> 
<p>AOF是Redis的另一种数据持久化方案，默认是不开启的。它的出现是为了弥补RDB的不足(数据的不一致性——内存中的数据和磁盘中的数据不一致)，它所采用的是日志的形式来记录每个写操作，并追加到日志文件中。Redis重启后，会根据日志文件中的内容将所有的写指令从前往后的执行一次来完成数据的恢复。<strong>AOF存的是命令(操作):set name zhangsan</strong></p> 
<h5><a id="AOF_325"></a>开启AOF数据持久化策略</h5> 
<p>第一步，打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步，在vim状态下直接输入/appendonly查找appendonly字符串,找到后将<code>appendonly no</code>修改为如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment"># appendonly no</span>
appendonly <span class="token function">yes</span>
</code></pre> 
<h5><a id="AOF_336"></a>修改AOF数据持久化位置</h5> 
<p><code>如果需要修改AOF数据化持久化位置，请按照如下命令执行&gt;&gt;&gt;&gt;注意：此处不建议修改，默认文件位置是Redis的工作目录</code><br> 第一步，打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步，在vim状态下直接输入/appendfilename查找appendfilename字符串,找到后将<code>appendfilename "appendonly.aof"</code>修改为如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment"># appendfilename "appendonly.aof"</span>
appendfilename <span class="token string">"my.aof"</span>
<span class="token comment">## redis的默认工作目录是"./"即"redis.conf"所在的目录</span>
<span class="token comment">## 在vim状态下输入/The working directory可以查看</span>
</code></pre> 
<h5><a id="AOF_350"></a>修改AOF数据持久化方案</h5> 
<p>第一步，打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步，在vim状态下直接输入/appendfsync查找appendfsync字符串,找到后将<code>appendfilename "appendonly.aof"</code>修改为如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment"># appendfsync always [每一次的写操作都同步追加到.aof文件中,即写一个追加一个,每一次的数据变化都会立刻追加到到磁盘文件中。优点:安全,能较好地保证数据的完整性和一致性(内存和磁盘中的数据一致),缺点:性能较差]</span>
<span class="token comment"># appendfsync everysec [redis默认和推荐的方式,每秒追加一次,即到了一秒就将用户在这一秒内所有的写操作追加到.aof文件中,没到一秒不会追加。优点:比always性能好,缺点:还是会有数据丢失的风险(如果时间没到一秒,redis发生宕机,那么在这一秒内用户所有的写操作都不会被追加),写操作和追加操作是异步的]</span>
<span class="token comment"># appendfsync no [不同步,无意义,和不开启AOF没啥区别]</span>
<span class="token comment"># appendfsync [ always | every | no ]三选一</span>
appendfsync everysec
</code></pre> 
<p><img src="https://images2.imgbox.com/ec/56/sMlPmqWO_o.png" alt="在这里插入图片描述"><br> <code>任何一种策略不可能无懈可击，都各自有各自的风险</code></p> 
<p><img src="https://images2.imgbox.com/2b/2c/Xbd4jkl3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="AOF_370"></a>AOF的瘦身机制</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 尽情期待，小编正在整理ing</span>
</code></pre> 
<h3><a id="_376"></a>灾难备份</h3> 
<p>redis的灾难备份：将Redis的Master机器的数据备份到Slave机器上</p> 
<p>第一步：在Master机器上打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步：在vim状态下直接输入/bind查找bind字符串,换行添加如下内容:：</p> 
<pre><code class="prism language-bash"><span class="token comment"># bind 192.168.1.100 10.0.0.1</span>
<span class="token comment"># bind 127.0.0.1 ::1</span>
<span class="token comment"># bind 0.0.0.0表示任何机器都可以连接</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
</code></pre> 
<p>第三步：在vim状态下直接输入/requirepass查找requirepass字符串,找到后换行添加如下内容:，配置密码：</p> 
<pre><code class="prism language-bash"><span class="token comment"># requirepass 密码</span>
<span class="token comment"># 密码，三台redis的密码必须是一致：1.应用本身需要配置密码；2.从节点同步数据需要密码，因为节点的身份会发生变化。</span>
requirepass password
</code></pre> 
<p><strong>从节点：</strong></p> 
<p>第一步：在Slave机器上打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步：在vim状态下直接输入/replicaof查找replicaof字符串,找到后换行添加如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment">## [replicaof Master机器IP Master机器redis端口]</span>
<span class="token comment">## replicaof表示***的副本</span>
replicaof <span class="token number">192.168</span>.1.100 <span class="token number">6379</span>
</code></pre> 
<p>第三步：设置访问Master所需的密码，在vim状态下直接输入/masterauth查找masterauth字符串,找到后换行添加如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment">## [masterauth 密码]</span>
masterauth password
</code></pre> 
<h3><a id="Redis_417"></a>Redis的高可用</h3> 
<p><strong>高可用性：</strong> 指的是通过尽量缩短日常维护操作和突发的系统崩溃所导致的停机时间，以提高系统和应用的可用性。Redis出现故障后不会影响到整个项目的正常运行。高可用一般来说有两个含义：一是数据尽量不丢失，二是保证服务尽可能可用。</p> 
<p>Redis作为内存数据库，本身的特点就是必须保证高可用。如果部署一台机器，是非常容易出现单台机器挂掉的情况，一旦挂掉就会导致整个项目的不可用。在现实的使用过程当中，Redis为了实现高可用，通常的做法有三种部署模式：主从模式，哨兵模式，集群模式。</p> 
<h4><a id="_421"></a>主从复制</h4> 
<p>Redis的主从复制类似于Redis的灾难备份，通过将Master节点中的数据备份到Slave机器上。主从复制模式中，一旦主节点由于故障不能提供服务，需要人工将从节点晋升为主节点，同时还要通知应用方更新主节点地址，以此来保证Redis一台机器出故障后不会影响到整个项目的正常运行。</p> 
<p>主从复制包括全量复制，增量复制两种。一般当slave第一次启动连接master，或者认为是第一次连接，就采用全量复制然后继续判断，当后续发现出现了master节点的数据变化以后，就会将相关的指令发送到slave，从而在slave节点将指令在执行一遍，从而实现增量复制</p> 
<p>Redis主从复制结构如下图所示，主节点（master）负责读写，从节点（slave）负责读。这个系统的运行依靠三个主要的机制：</p> 
<ul><li>当一个 master 实例和一个 slave 实例连接正常时， master 会发送一连串的命令流来保持对 slave的更新，以便于将自身数据集的改变复制给 slave ，包括客户端的写入、key 的过期或被逐出等等。</li><li>当 master 和 slave 之间的连接断开之后，因为网络问题、或者是主从意识到连接超时， slave 重新连接上 master并会尝试进行部分重同步：这意味着它会尝试只获取在断开连接期间内丢失的命令流。</li><li>当无法进行部分重同步时， slave 会请求进行全量重同步。这会涉及到一个更复杂的过程，例如 master需要创建所有数据的快照，将之发送给 slave ，之后在数据集更改时持续发送命令流到 slave 。</li></ul> 
<p><img src="https://images2.imgbox.com/94/ca/pde8WCF1_o.png" alt="在这里插入图片描述"></p> 
<p><strong>主从模式优点：</strong></p> 
<ol><li>实现读写分离，降低master节点的读数据压力，提高系统的性能。写操作交给master节点，读操作交给slave节点，提供多个副本。</li><li>配置简单，容易搭建。只需要在slave节点上维护master节点的地址信息就可实现。</li><li>数据拥有备份，一定程度上保障了数据的安全性和可靠性</li></ol> 
<p><strong>主从模式缺点：</strong></p> 
<ol><li>当master节点宕机时，由于无法选择哪一个slave节点当master节点，人工将从节点晋升为主节点，同时还要通知应用方更新主节点地址，无法达到真正意义上的高可用。</li><li>所有的写数据的压力都集中在master节点，没有解决master节点写的压力。</li></ol> 
<h5><a id="_446"></a>配置主从模式</h5> 
<p><strong>主节点：</strong><br> 第一步：在Master机器上打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步：在vim状态下直接输入/bind查找bind字符串,找到后换行添加如下内容:：</p> 
<pre><code class="prism language-bash"><span class="token comment"># bind 192.168.1.100 10.0.0.1</span>
<span class="token comment"># bind 127.0.0.1 -::1</span>
<span class="token comment"># bind 0.0.0.0表示任何机器都可以连接</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
</code></pre> 
<p>第三步：在vim状态下直接输入/requirepass查找requirepass字符串,找到后换行添加如下内容，配置密码：</p> 
<pre><code class="prism language-bash"><span class="token comment"># requirepass 密码</span>
<span class="token comment"># 密码，三台redis的密码必须是一致：1.应用本身需要配置密码；2.从节点同步数据需要密码，因为节点的身份会发生变化。</span>
requirepass password
</code></pre> 
<p>第四步：由于主节点的身份会发生变化，还需配置认证主节点的密码(虽然当前的身份用不上，但是身份如果变为从节点后，连接主节点的话是需要认证密码的)，在vim状态下直接输入/masterauth查找masterauth字符串,找到修改为如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 认证主节点的密码，原因在于它的身份可能会发生变化</span>
<span class="token comment"># masterauth 主节点密码</span>
masterauth password
</code></pre> 
<p><strong>从节点：</strong></p> 
<p>注意：<code>从节点的配置都一样</code></p> 
<p>第一步：在Slave机器上打开/data/redis/redis-7.0.2/redis.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> redis.conf
</code></pre> 
<p>第二步：由于从节点的身份可能会变为主节点，还需将从节点配置为任何机器都可连接，在vim状态下直接输入/bind查找bind字符串,找到后换行添加如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># bind 192.168.1.100 10.0.0.1</span>
<span class="token comment"># bind 127.0.0.1 ::1</span>
<span class="token comment"># bind 0.0.0.0表示任何机器都可以连接</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
</code></pre> 
<p>第三步：由于从节点的身份可能会变为主节点，还需配置从节点的密码(当从节点变成主节点后，其他节点连接需要密码认证)，在vim状态下直接输入/requirepass查找requirepass字符串,找到后换行添加如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># requirepass 密码</span>
<span class="token comment"># 密码，三台redis的密码必须是一致：1.应用本身需要配置密码；2.从节点同步数据需要密码，因为节点的身份会发生变化。</span>
requirepass password
</code></pre> 
<p>第六步：设置访问Master所需的密码，在vim状态下直接输入/masterauth查找masterauth字符串,找到后换行添加如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment">## [masterauth 密码]</span>
masterauth password
</code></pre> 
<p>第五步：在vim状态下直接输入/replicaof查找replicaof字符串,找到后换行添加如下内容</p> 
<pre><code class="prism language-bash"><span class="token comment">## [replicaof Master机器IP Master机器redis端口]</span>
<span class="token comment">## replicaof表示***的副本</span>
replicaof <span class="token number">192.168</span>.1.100 <span class="token number">6379</span>
</code></pre> 
<p>第六步：查看并验证主节点、从节点的信息</p> 
<pre><code class="prism language-bash"><span class="token comment"># 第一步：连接到redis</span>
src/redis-cli  <span class="token parameter variable">-p</span>  <span class="token number">6379</span>
<span class="token comment"># 第二步：查看主节点、从节点的信息</span>
info replication
</code></pre> 
<p><img src="https://images2.imgbox.com/74/39/Aqm4c6Aa_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_524"></a>哨兵模式</h4> 
<p>为了解决<code>主从复制模式中，一旦主节点由于故障不能提供服务，需要人工将从节点晋升为主节点，同时还要通知应用方更新主节点地址</code>，Redis从2.8开始正式提供了Redis Sentinel（哨兵）哨兵模式，它可以记录所有主节点和从节点的信息并监视所有主节点和从节点的状态，当被监视的主节点出现故障时，会通过投票机制，将某个从节点升级为新的主节点，并将所有的从节点连接到主节点。</p> 
<p>哨兵模式的三个作用：</p> 
<ul><li>监控(Monitoring)：不断地检查master和salve是否运行正常。master存活检测、master和slave运行情况检测。</li><li>通知(Notification)：当被监控的某个节点出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li><li>自动故障转移(Automaticfailover)：断开master与slave之间的连接，选取一个salve作为master，将其他slave连接到新的master，并告知客户端新的节点地址</li></ul> 
<p><img src="https://images2.imgbox.com/28/b1/R1QYyZoz_o.png" alt="在这里插入图片描述"></p> 
<p>一个哨兵对Redis节点进行监控，一旦哨兵发生故障，主节点也出现故障，就无法选举出新的主节点从而导致整个项目的不可运行，因此，可以使用多个哨兵来进行监控Redis节点，并且各个哨兵之间还会进行监控。</p> 
<p><strong>对等节点集群理论：</strong></p> 
<ul><li>集群的节点为奇数个，<code>可以最快的实现主节点的选举(偶数会较大程度出现打平状态)</code>。</li><li>在绝大多数的应用进行集群部署的时候，底层都秉持一个观点：集群中超过半数(包括半数)的节点不可用，那么整个集群是不可用的。1台和2台效果相同；3和4台效果一样。</li></ul> 
<h5><a id="_543"></a>配置哨兵</h5> 
<p>注意:<code>三个哨兵在地位上是对等的，配置也是一样的</code></p> 
<p>第一步：打开/data/redis/redis-7.0.2/sentinel.conf文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
<span class="token function">vim</span> sentinel.conf
</code></pre> 
<p>第二步：在vim状态下直接输入/bind查找bind字符串,找到后换行添加如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># bind 192.168.1.100 10.0.0.1</span>
<span class="token comment"># bind 127.0.0.1 ::1</span>
<span class="token comment"># bind 0.0.0.0表示任何机器都可以连接</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
</code></pre> 
<p>第三步：在vim状态下直接输入/sentinel monitor mymaster查找sentinel monitor mymaster字符串,找到后换行添加如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 哨兵最原始状态下，要监听的主节点的: </span>
<span class="token comment">#    mymaster 是redis给主节点的取的默认的别名[由于在配置文件中引用了该别名，不建议修改，一旦修改其他引用的地方都必须修改]</span>
<span class="token comment">#    192.168.1.100 6379 主接地那的ip和端口</span>
<span class="token comment">#    2 表示至少有两台sentinel同意你是主， 那么才能成为主节点</span>
sentinel monitor mymaster <span class="token number">192.168</span>.1.100 <span class="token number">6379</span> <span class="token number">2</span>
</code></pre> 
<p>第三步：由于需要监视主节点，还需配置认证主节点的密码，在vim状态下直接输入/auth-pass查找auth-pass字符串,找到后换行添加如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 主节点的密码</span>
sentinel auth-pass mymaster password
</code></pre> 
<h5><a id="_577"></a>开启哨兵</h5> 
<p>第一步：进入到redis的工作目录</p> 
<pre><code class="prism language-bash"><span class="token comment"># redis的工作目录是redis.conf所在的目录</span>
<span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
</code></pre> 
<p>第二步：执行如下命令</p> 
<pre><code class="prism language-bash">./redis-sentinel ./sentinel.conf <span class="token operator">&amp;</span>
</code></pre> 
<p>第三步：查看并验证哨兵信息中的主节点、从节点的信息</p> 
<pre><code class="prism language-bash"><span class="token comment"># 第一步：连接哨兵</span>
src/redis-cli  <span class="token parameter variable">-p</span>  <span class="token number">26379</span>
<span class="token comment"># 第二步：查看哨兵信息</span>
info sentinel
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/98/3KGKQEqs_o.jpg" alt="在这里插入图片描述"></p> 
<h6><a id="_597"></a>哨兵模式下的问题：</h6> 
<p><strong>脑裂问题</strong><br> 脑裂就是redis集群中出现多个master，导致出现该问题的原因在于 sentinel 与之前的 master 出现网络隔离，但是有应用还是可以和之前的master进行数据的读写；因为sentinel和之前的master出现网路隔离，他们会选举出一个新的master，就出现脑裂问题。如果之前的master网络问题被解决之后，sentinel会将其作为新选举出的master的slave存在，可能到数据不一致。<br> <img src="https://images2.imgbox.com/96/73/ryJlfwNi_o.png" alt="在这里插入图片描述"><br> 解决方案：设置——需要在每个哨兵中都去配置至少需要几个从节点才能成为主节点写入数据</p> 
<pre><code class="prism language-bash"> <span class="token comment"># 当前节点如果为主节点，至少需要一台从节点；如果它是master, 但是它没有从节点，只能读不能写</span>
 min-replicas-to-write <span class="token number">1</span>
 <span class="token comment"># 表示主节点查找自己从节点的时间，目的是为了避免查找从节点的时间过长</span>
 min-replicas-max-lag <span class="token number">10</span>
</code></pre> 
<p><strong>容量问题</strong><br> <strong><code>哨兵模式下，数据的存储上限取决于Master的容量</code></strong><br> 解决方案：集群——水平扩容</p> 
<p>https://www.cnblogs.com/cfzy/p/15502994.html</p> 
<h4><a id="_613"></a>集群模式</h4> 
<p>Redis3.0加入了Redis的集群模式，实现了数据的分布式存储，对数据进行分片，将不同的数据存储在不同的master节点上面，从而解决了海量数据的存储问题。</p> 
<p>Cluster 群集由多个redis服务器组成的分布式网络服 务群集，群集之中有多个master主节点，每一个主节点都可读可写，节点之间会相互通信，两两相连，redis群集无中心节点。</p> 
<p>Redis也内置了高可用机制，支持N个master节点，每个master节点都可以挂载多个slave节点，当master节点挂掉时，集群会提升它的某个slave节点作为新的master节点。<br> <img src="https://images2.imgbox.com/66/12/nadLuvw8_o.png" alt="在这里插入图片描述"></p> 
<p><strong>哈希槽概念：</strong> Redis集群中引入了哈希槽的概念，Redis集群有16384个哈希槽，进行set操作时，每个key会通过CRC16校验后再对16384取模来决定放置在哪个槽，搭建Redis集群时会先给集群中每个master节点分配一部分哈希槽。比如当前集群有3个master节点，master1节点包含0 ~ 5500号哈希槽，master2节点包含5501~ 11000号哈希槽，master3节点包含11001~16384号哈希槽，当我们执行存取数据时，集群会对使用CRC16算法对key进行计算并对16384取模，假如 CRC16(key) % 16384 = 777，那么这个key就分配在master1节点上，然后直接到这个对应的节点上进行存取操作。<br> <img src="https://images2.imgbox.com/33/3f/YYHyN03S_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_625"></a>配置集群</h5> 
<p>以192.168.1.100这台机器为例子，来创建两台redis服务，需要在 $REDIS_HOME 目录下创建两个配置文件，分别是：</p> 
<ul><li>redis-6379.conf 作为本机上Redis的主节点的配置文件</li></ul> 
<pre><code class="prism language-bash"><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
<span class="token comment"># 端口是默认端口 6379</span>
<span class="token comment"># 要保证每台机器的密码都是一样，因为主节点间要相互认证；主从的间的身份也可能会发生变化；</span>
requirepass admin
<span class="token comment"># 认证主节点，因为主节点的身份可能会发生变化</span>
masterauth admin
<span class="token comment"># rdb文件的文件名，因为每台机器有两台redis，所以名字一定不能一样</span>
dbfilename dump-6379.rdb
<span class="token comment"># 表示开启集群</span>
cluster-enabled <span class="token function">yes</span>
<span class="token comment"># 集群的信息，一台机器的两台redis不能相同,内容包含其它节点的状态，持久化变量等，会自动生成在上面配置的dir目录下</span>
<span class="token comment"># 当Redis节点以集群模式启动时，会首先寻找是否有集群配置文件，如果有则使用文件中的配置启动，如果没有，则初始化配置并将配置保存到文件中。集群配置文件由Redis节点维护，不需要人工修改。</span>
cluster-config-file nodes-6379.conf
</code></pre> 
<ul><li>redis-6389.conf作为192.168.1.102这台机器上的Redis的从节点的配置文件。</li></ul> 
<pre><code class="prism language-bash"><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
<span class="token comment"># 端口</span>
port <span class="token number">6389</span>
<span class="token comment"># 要保证每台机器的密码都是一样，因为主节点间要相互认证；主从的间的身份也可能会发生变化；</span>
requirepass admin
<span class="token comment"># 认证主节点，因为主节点的身份可能会发生变化</span>
masterauth admin
<span class="token comment"># rdb文件的文件名，因为每台机器有两台redis，所以名字一定不能一样</span>
dbfilename dump-6389.rdb
<span class="token comment"># 表示开启集群</span>
cluster-enabled <span class="token function">yes</span>
<span class="token comment"># 集群的信息，一台机器的两台redis不能相同,内容包含其它节点的状态，持久化变量等，会自动生成在上面配置的dir目录下</span>
<span class="token comment"># 当Redis节点以集群模式启动时，会首先寻找是否有集群配置文件，如果有则使用文件中的配置启动，如果没有，则初始化配置并将配置保存到文件中。集群配置文件由Redis节点维护，不需要人工修改。</span>
cluster-config-file nodes-6389.conf
</code></pre> 
<h5><a id="_662"></a>开启集群</h5> 
<p>上述配置文件配置好之后，依次启动6个Redis服务</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /data/redis/redis-7.0.2
./redis-server redis-6379.conf 
./redis-server redis-6389.conf 
</code></pre> 
<p>上面虽然启动了6台redis，但是他们之间是独立运行的服务，并没有去构成集群，所有需要来创建集群，创建集群的命令如下所示：</p> 
<pre><code class="prism language-bash">src/redis-cli <span class="token parameter variable">-a</span> admin <span class="token parameter variable">--cluster</span> create <span class="token number">192.168</span>.213.100:6379 <span class="token number">192.168</span>.213.101:6379 <span class="token number">192.168</span>.213.102:6379 <span class="token number">192.168</span>.213.100:6389 <span class="token number">192.168</span>.213.101:6389  <span class="token number">192.168</span>.213.102:6389 --cluster-replicas <span class="token number">1</span>
</code></pre> 
<p>进入到 redis 的客户端，然后可以查看 redis 的集群信息：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 进入到redis, -c是因为目前是集群模式</span>
src/redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-a</span> admin

<span class="token comment"># 查看集群信息</span>
cluster nodes
</code></pre> 
<p>https://blog.csdn.net/a745233700/article/details/112691126</p> 
<h3><a id="Redis_686"></a>Redis+数据库</h3> 
<p>思路：查询数据时，先去Redis中查询，如果Redis中有直接将结果返回给前端，如果Redis中没有再去数据库中查询，将从数据库中查询到的数据放入Redis，再将查询到的数据返回给前端。</p> 
<h4><a id="_689"></a>缓存击穿</h4> 
<p><strong>缓存击穿：</strong> 有大量用户同时去请求一个Redis中没有的热点数据，那么所有的查询都会打到数据库，造成数据库压力过大。<code>[缓存中没有，数据库有]</code></p> 
<p><strong>解决方案：</strong> 控制并发，只让一个查询打到数据库，将从数据库中查询到的数据放入Redis。[控制并发，只能让一个人查询数据库]</p> 
<h4><a id="_694"></a>缓存穿透</h4> 
<p><strong>缓存穿透：</strong> 就算控制住并发，第一个用户从数据库中查询到的还是null，Redis中依然没有该数据，那么其他的查询还是都会打到数据库，造成数据库压力过大。<code>[Redis中没有，数据库中也没有]</code></p> 
<p><strong>解决方案：</strong> 将数据库中查询到的数据放一个 “null” 字符串到Redis中，但是这样可能会导致一个问题，就是redis中存在大量的 “null” 字符串的问题，利用布隆过滤器来解决。</p> 
<h4><a id="_698"></a>缓存雪崩</h4> 
<p><strong>缓存雪崩：</strong> 同一时间大量的key同时过期，某一高峰期又有大量的请求查询已经过期的key，导致所有的数据查询都打到数据库去了。<code>[同一时间缓存大量失效]</code><br> <strong>解决方案：</strong> key的过期时间不要设置成固定值，让key的失效时间随机。expire key random(34)</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">//先组装redis的key</span>
	<span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token constant">TEST</span># <span class="token operator">+</span> id <span class="token punctuation">;</span>
	<span class="token comment">//先从redis中查找</span>
	<span class="token class-name">String</span> info <span class="token operator">=</span> stringRedisTempleate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//如果redis中没查询到结果从数据库中查询</span>
	<span class="token comment">//缓存击穿--控制并发  //缓存穿透--设置"null"字符串 //缓存雪崩--设置随机过期时间</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//如何控制并发</span>
		<span class="token comment">//为什么不能用this,如果使用this就会将所有调用该方法的线程阻塞</span>
		<span class="token keyword">synchronized</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//intern()方法是将调用该方法的字符串指向字符串常量池</span>
			<span class="token comment">//经典的双空判断--因为是高并发场景，如果第一个线程执行到if，时间片段到了，第二个线程进来，执行到if时间片段也到了...那么就有大量的线程拿到的info是null，到时候就会有大量的线程会打到数据库中查询，因此需要再进行一次空判断</span>
			<span class="token comment">//再从redis中查一遍</span>
			info <span class="token operator">=</span> stringRedisTempleate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> infoMap <span class="token operator">=</span> infoService<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//如果查询到结果就再redis中放一份，如果没查到就放一个"null"字符串</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>infoMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					stringRedisTempleate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span><span class="token string">"null"</span><span class="token punctuation">,</span><span class="token string">"随机过期时间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
					<span class="token class-name">String</span> result<span class="token operator">=</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>infoMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
					stringRedisTempleate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span>result<span class="token punctuation">,</span><span class="token string">"随机过期时间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> result<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> info<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Redis_736"></a>Redis内存淘汰策略</h3> 
<h4><a id="_737"></a>过期键删除策略</h4> 
<p>redis会将所有设置了过期淘汰的键存储到一个集合中，对于这种需要到期删除的key，redis是通过过期键删除的两种策略: 1. 定时删除；2. 惰性删除；</p> 
<ul><li> <p><strong>定时删除策略：</strong></p> <pre><code> 1、redis的底层有一个线程，该线程每100毫秒会扫描一次集合；
  
 2、每次从集合中随机抽取20个key，然后判断是否已经过期，如果过期就删除；
  
 3、如果从随机抽取的20个key中，有超过1/4的key过期，再重复第二步;
 
 4、直到随机抽取的20个key中，过期的key的数量少于1/4时，才会等100毫秒后再重复第一步.
</code></pre> </li></ul> 
<p><code>定时删除，使用随机的方式是因为，如果每次进行一个全部key的判断，会导致CPU性能损耗过大。 </code></p> 
<ul><li> <p><strong>惰性删除策略：</strong></p> <pre><code> 1、因为定时删除肯定存在着有些key过期没有被删除掉，于是就有了惰性删除；
  
 2、所谓的惰性删除就是当用户使用的时候再去判断当前的key是否过期，如果过期就直接删除掉
</code></pre> </li></ul> 
<h4><a id="_757"></a>内存淘汰策略</h4> 
<p>定时删除和惰性删除这两种配合的情况下，可能会导致有些键过期还是没有被删除(既没扫描到，也没有使用的key)；于是就有了内存的淘汰策略，总共有八种</p> 
<p><code>八种内存淘汰策略的前提是在redis配置中设置了最大内存: maxmemory</code></p> 
<p>内存淘汰策略主要是值这样的一个场景：当达到redis的最大内存限制，添加新的数据已经添加不进去的时候，redis会按照一定的策略将一些数据淘汰掉，为新增的数据腾位置</p> 
<pre><code>1、直接报错，啥也不干:

no-eviction: 添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，就返回error，然后啥也不干

2、从所有的key中淘汰一些最近未使用的key:

allkeys-lru:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，就会扫描所有的key，淘汰一些最近未使用的key

3、从设置了过期时间的key中淘汰一些最近未使用的key:

volatile-lru:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，扫描那些设置里过期时间的key，淘汰一些最近未使用的key

4、从所有的key中随机淘汰一些key:

allkeys-random:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，就会扫描所有的key，随机淘汰一些key

5、从设置了过期时间的key中随机淘汰一些key:

volatile-random:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，扫描那些设置里过期时间的key，随机淘汰一些key

6、从设置了过期时间的key中淘汰一些将要过期的key:

volatile-ttl:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，扫描那些设置里过期时间的key，淘汰一些即将过期的key

7、对所的key使用LFU算法淘汰一些key:

volatile-lfu:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，就会淘汰一些设置了过期时间的，使用LFU算法淘汰一些key（有些key虽然最近没有被使用，在接下来可能会被使用，就不会删除）

8、对设置了过期时间的key使用LFU算法淘汰一些key:

allkeys-lfu:添加数据时，如果redis判断该操作会导致占用内存大小超过内存限制，就会扫描所有的key，使用 LFU这种算法淘汰一些key（有些key虽然最近没有被使用，在接下来可能会被使用，就不会删除）
</code></pre> 
<pre><code class="prism language-xml">整理：

默认的是当新的添加数据会导致超出redis最大内存限制，不会删除任何key, 直接报错；

还有就是对所有的key：淘汰最近未使用的、随机淘汰、LFU算法淘汰

还有就是对设置了过期时间的key：淘汰最近未使用的、随机淘汰、淘汰将要过期的、LFU算法
</code></pre> 
<h4><a id="_807"></a>布隆过滤器</h4> 
<p>布隆过滤器解决的问题：为了解决缓存穿透的问题，数据库中没有的数据我们会在redis中存入"null"字符串，布隆过滤器的出现就是为了解决redis中出现大量"null"字符串的问题。</p> 
<p>布隆过滤器原理：<br> <img src="https://images2.imgbox.com/ec/11/wfFMQIDt_o.png" alt="在这里插入图片描述"><br> 使用布隆过滤器：<br> 第一步，先导依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>30.1.1-jre<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>第二步，将数据库中的数据根据id或者主键提前做好映射</p> 
<pre><code class="prism language-java"><span class="token comment">//第二个参数:bloomFilter的长度</span>
<span class="token comment">//第三个参数:bloomFilter的误判率,误判率越低hash的次数越多</span>
<span class="token keyword">private</span> <span class="token class-name">BloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CharSequence</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> <span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">stringFunnel</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">,</span> <span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
* @PostConstruct相当于 init-method=""
* 在spring中凡是碰到方法名中带有Post的，都表示在XXXX之后
* 典型代表：BeanPostProcessor、BeanFactoryPostProcessor
*/</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initBloomFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">//查询所有的id得到一个集合，如果数据量过大可采用分页查询的方式</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> productInforMationService<span class="token punctuation">.</span><span class="token function">selectAllId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ids<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>id <span class="token operator">-</span> <span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
		bloomFilter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span>toString<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第三步，通过布隆过滤器判断是否存在，如果存在就按照Redis那一套正常的流程走，如果不存在就返回空<br> <code>注意：bloomFilter中有不能说明数据库中一定有，存在误判情况：不同的值hash出来的结果对应的桶位可能一样</code></p> 
<pre><code class="prism language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体可参考：https://zhuanlan.zhihu.com/p/419610569</p> 
<h3><a id="_854"></a>布隆过滤器+分布式锁整合</h3> 
<h4><a id="_855"></a>一、原生的分布式锁</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>pagination<span class="token punctuation">.</span></span><span class="token class-name">Page</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">ProductMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">ProductModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>hash<span class="token punctuation">.</span></span><span class="token class-name">BloomFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>hash<span class="token punctuation">.</span></span><span class="token class-name">Funnels</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductMapper</span> productMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token comment">//StringRedisTemplate和RedisTemplate的区别</span>
        <span class="token comment">//StringRedisTemplate是按String方式序列化的，是可以直接识别的</span>
        <span class="token comment">//RedisTemplate是按JDK的方式序列化的，是以字节数组显示不可直接识别的</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">BloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> <span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">stringFunnel</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10000000</span><span class="token punctuation">,</span><span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//提前做好数据的映射</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initBloomFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> everyPageProductModels <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> everyPageProductModels<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProductModel</span> productModel <span class="token operator">:</span> records<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> productId <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>productModel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bloomFilter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findProductInfoById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"PRODUCT#INFO#"</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//1、通过布隆过滤器判断数据库中是否存在</span>
                <span class="token comment">//A、如果布隆过滤器中存在</span>
                    <span class="token comment">//1、从redis中查询</span>
                    <span class="token comment">//2、判断redis中是否存在</span>
                        <span class="token comment">//A、如果不存在，去数据库中查询</span>
                            <span class="token comment">//1、注意：去数据库中查询时要控制并发，防止缓存击穿</span>
                                <span class="token comment">//A、注意：如果项目部署在多个服务器上控制并发时还需使用分布式锁--setnx[如果不存在就添加，如果存在就不添加]</span>
                                <span class="token comment">//B、注意：为了防止死锁还需给锁设置过期时间</span>
                                <span class="token comment">//C、注意：为了防止程序在过期时间内还未执行完，还需用到一个看门狗watchDog程序给锁续命</span>
                                <span class="token comment">//D、注意：拿到锁后还需要从Redis中再获取一次数据，防止在等锁的过程中某个拿到锁的线程向Redis中存放了数据[经典的双空判断]</span>
                            <span class="token comment">//2、注意：由于boolmFilter存在误判，还需继续判断数据库中是否存在该数据</span>
                                <span class="token comment">//A、如果数据库中也没有需要在redis中存入一个”null“字符串，防止缓存穿透</span>
                                <span class="token comment">//B、如果数据库中存在就讲该值存入redis,并设置一个随机过期时间，防止缓存血崩</span>
                        <span class="token comment">//B、如果存在，直接将结果返回</span>
                <span class="token comment">//B、如果存在直接返回结果</span>
            <span class="token comment">//2、如果布隆过滤器中不存在，直接放回一个"null"</span>
            <span class="token class-name">String</span> productInfo <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> watchDog <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>productInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Boolean</span> hasLock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"LOCK#"</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasLock<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        watchDog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">"LOCK#"</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        watchDog<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commonCode</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                       <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
                           hasLock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"LOCK#"</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        watchDog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">"LOCK#"</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        watchDog<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commonCode</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    watchDog<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"LOCK#"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">commonCode</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> redisKey<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> productInfo <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>productInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ProductModel</span> productModel <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>productModel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span>productModel<span class="token punctuation">.</span><span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">43200</span><span class="token operator">+</span><span class="token number">43200</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> productModel<span class="token punctuation">.</span><span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span><span class="token string">"null"</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">43200</span><span class="token operator">+</span><span class="token number">43200</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Redisson_982"></a>二、Redisson提供的分布式锁</h4> 
<p>第一步、引入依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--============================================redis相关依赖开始============================================--&gt;</span>
        <span class="token comment">&lt;!-- redis的依赖 --&gt;</span>
<span class="token comment">&lt;!--        &lt;dependency&gt;--&gt;</span>
<span class="token comment">&lt;!--            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span>
<span class="token comment">&lt;!--            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;--&gt;</span>
<span class="token comment">&lt;!--        &lt;/dependency&gt;--&gt;</span>
        <span class="token comment">&lt;!-- redis连接池的依赖 --&gt;</span>
        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-pool2 --&gt;</span>
<span class="token comment">&lt;!--        &lt;dependency&gt;--&gt;</span>
<span class="token comment">&lt;!--            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;--&gt;</span>
<span class="token comment">&lt;!--            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;--&gt;</span>
<span class="token comment">&lt;!--            &lt;version&gt;2.7.0&lt;/version&gt;--&gt;</span>
<span class="token comment">&lt;!--        &lt;/dependency&gt;--&gt;</span>
        <span class="token comment">&lt;!-- redission依赖 有了redisson依赖需要将redis的依赖注释掉--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.20.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--============================================redis相关依赖结束============================================--&gt;</span>
</code></pre> 
<p>第二步、配置yml文件</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
<span class="token comment">#    host: 192.168.0.1</span>
<span class="token comment">#    password: password</span>
<span class="token comment">#    # lettuce 莴苣:这是redis的连接池</span>
<span class="token comment">#    lettuce.:</span>
<span class="token comment">#      pool:</span>
<span class="token comment">#        min-idle: 2</span>
<span class="token comment">#        max-active: 8</span>
    <span class="token key atrule">redisson</span><span class="token punctuation">:</span>
      <span class="token key atrule">file</span><span class="token punctuation">:</span> classPath<span class="token punctuation">:</span>redis<span class="token punctuation">-</span>singleServerConfig.yml
</code></pre> 
<p>第三步、新建一个redis-singleServerConfig.yml文件配置Redisson连接</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">singleServerConfig</span><span class="token punctuation">:</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token string">"redis://192.168.1.100:6379"</span>
  <span class="token key atrule">connectionMinimumIdleSize</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> redis123
<span class="token comment">#netty,底层用netty都是高性能的代名词</span>
<span class="token key atrule">nettyThreads</span><span class="token punctuation">:</span> <span class="token number">4</span>
<span class="token comment">#通信方式是nio</span>
<span class="token key atrule">transportMode</span><span class="token punctuation">:</span> NIO
</code></pre> 
<p>第四步、使用</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>pagination<span class="token punctuation">.</span></span><span class="token class-name">Page</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">ProductMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">ProductModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>hash<span class="token punctuation">.</span></span><span class="token class-name">BloomFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>hash<span class="token punctuation">.</span></span><span class="token class-name">Funnels</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RLock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissionService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductMapper</span> productMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">BloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> <span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">stringFunnel</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10000000</span><span class="token punctuation">,</span><span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initBloomFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> productModelPage <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> productModelPage<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>record <span class="token operator">-&gt;</span> bloomFilter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProductInfoById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"PRODUCT#INFO#"</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> productInfo <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>productInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//=========================重点！================================</span>
                <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//重点：lock方法是一个阻塞方法，如果没有获取到锁则会一直尝试获取锁</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//=========================重点！================================</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    productInfo <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>productInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductModel</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ProductModel</span> productModel <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        productInfo <span class="token operator">=</span> productModel<span class="token punctuation">.</span><span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>productInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span>productInfo<span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">43200</span><span class="token operator">+</span><span class="token number">43200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span><span class="token string">"null"</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">43200</span><span class="token operator">+</span><span class="token number">43200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>实现分布式锁的方式不只有Redisson，比如：<br> 1、可利用MySQL主键和唯一键的唯一性实现分布式锁。</p> 
<h3><a id="Redis_1119"></a>Redis的事物</h3> 
<p>参考：https://blog.csdn.net/shark_chili3007/article/details/120884205</p> 
<h3><a id="SpringBootRedis_1121"></a>SpringBoot整合Redis</h3> 
<p><strong>单机版：</strong><br> 第一步，先导依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- redis的依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
 	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- redis连接池的依赖 --&gt;</span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-pool2 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>第二步，在.yml文件中配置连接池</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  redis<span class="token operator">:</span>
    host<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span>
    password<span class="token operator">:</span> password
    # lettuce 莴苣<span class="token operator">:</span>这是redis的连接池
    lettuce<span class="token punctuation">.</span><span class="token punctuation">:</span>
      pool<span class="token operator">:</span>
        min<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">2</span>
        max<span class="token operator">-</span>active<span class="token operator">:</span> <span class="token number">8</span>
</code></pre> 
<p>第三步，代码中直接注入 RedisTemplate 、StringRedisTemplate 即可使用</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ListOperations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisService</span><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//stringRedisTemplate中5种常见的OpsFor分别是:opsForValue、opsForList、opsForHash、opsForSet、OpsForZSet</span>
        <span class="token class-name">ListOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> opsListOperations <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opsListOperations<span class="token punctuation">.</span><span class="token function">leftPush</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> opsListOperations<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>哨兵模式：</strong></p> 
<p>第一步：导入依赖</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
 	<span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-starter-data-redis<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>-- https://mvnrepository.com/artifact/org.apache.commons/commons-pool2 --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.commons<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>commons-pool<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.7</span>.<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>第二步：配置哨兵</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  redis<span class="token operator">:</span>
    sentinel<span class="token operator">:</span> 
    	nodes<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.120</span><span class="token operator">:</span><span class="token number">26379</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.121</span><span class="token operator">:</span><span class="token number">26379</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.122</span><span class="token operator">:</span><span class="token number">26379</span>
    	# 主节点会发生变化，用sentinel<span class="token punctuation">.</span>conf文件中的别名
    	master<span class="token operator">:</span> mymaster
    password： password
</code></pre> 
<p>第三步：代码中直接注入 RedisTemplate 、StringRedisTemplate 即可使用</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ListOperations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisService</span><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//stringRedisTemplate中5种常见的OpsFor分别是:opsForValue、opsForList、opsForHash、opsForSet、OpsForZSet</span>
        <span class="token class-name">ListOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> opsListOperations <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opsListOperations<span class="token punctuation">.</span><span class="token function">leftPush</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> opsListOperations<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>集群模式</strong><br> 第一步：导入依赖</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
 	<span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-starter-data-redis<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>-- https://mvnrepository.com/artifact/org.apache.commons/commons-pool2 --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.commons<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>commons-pool<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.7</span>.<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>第二步：配置集群</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  redis<span class="token operator">:</span>
    cluster<span class="token operator">:</span>
    	nodes<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.110</span><span class="token operator">:</span><span class="token number">6379</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.111</span><span class="token operator">:</span><span class="token number">6379</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.112</span><span class="token operator">:</span><span class="token number">6379</span>
    password： password
</code></pre> 
<p>第三步：代码中直接注入 RedisTemplate 、StringRedisTemplate 即可使用</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ListOperations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisService</span><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//stringRedisTemplate中5种常见的OpsFor分别是:opsForValue、opsForList、opsForHash、opsForSet、OpsForZSet</span>
        <span class="token class-name">ListOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> opsListOperations <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opsListOperations<span class="token punctuation">.</span><span class="token function">leftPush</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> opsListOperations<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Redisconfig_1277"></a>Redis.config配置文件说明</h3> 
<pre><code>bind 0.0.0.0 　　　　 　　　　　　　　  # 测试环节，任何地址都可连接
port 6379 　　　　　　 　　　　　　      # 修改成对应的端口号
daemonize yes 　　　　　　　　　　     # 后台运行
pidfile /var/run/redis_6379.pid 　　　　    # pid文件
logfile "./redis.log" 　　　　　　　　　　 # 日志
dir /usr/local/redis/data 　　　　　　        # 设置文件数据存储路径
rename-command FLUSHALL adminFLUSHALL 　　 # 禁止危险命令
rename-command FLUSHDB adminFLUSHDB 　　    # 禁止危险命令
# rename-command KEYS adminKEYS 　　　　　　 # 禁止危险命令
rename-command SCAN adminSCAN 　　　　　　   # 禁止危险命令
rename-command CONFIG "" 　　　　　　 # 信息安全：防止redis被非法连接后，使用config命令对操作系统进行控制；另：要求redis使用非root帐号运行
maxclients 100000 　　　　　　　　　　    # 集群支持的最大连接
timeout 60 　　　　　　　　　　　　　　   # 设置空闲连接超时时间
maxmemory 6000M 　　　　　　　　　　  # Redis默认无限使用服务器内存，为防止极端情况下导致系统内存耗 尽，建议所有的Redis进程都要配置maxmemory, 要保证机器本身有30%左右的闲置内存
maxmemory-policy volatile-lru 　　　　        # 内存剔除策略logfile “”  默认为空，则在控制台打印，否则输出日志到指定的log文件
save "" 　　　　　　　　　　　　　　　　 # 通用配置，关闭RDB持久化，只使用AOF。
appendonly yes 　　　　　　　　　　　　 # 开启 aop 备份
masterauth 0NZcyqRqLUteci7D 　　　　    # 设置 master 节点的认证密码
requirepass 0NZcyqRqLUteci7D 　　　　   # 设置 redis 连接密码
appendfilename "appendonly-8379.aof"       # 设置持久化文件名称
appendfsync always 　　　　　　　　　　 # 每写一条 备份 一次
cluster-enabled yes    　　　　　　　　　   # 开启 Redis Cluster
cluster-config-file nodes-6379.conf 　　　    # 记录集群信息，不用手动维护，Redis Cluster 会自动维护
cluster-node-timeout 2000 　　　　　　　   # Cluster 集群节点连接超时时间，如果集群规模小，都在同一个网络环境下，可以配置的短些，更快的做故障转移。
cluster-require-full-coverage no 　　　　      # 设置为no，默认为yes，故障发现到自动完成转移期间整个集群是不可用状态，对于大多数业务无法容忍这种情况，因此要设置为no，当主节点故障时只影 响它负责槽的相关命令执行，不会影响其他主节点的可用性。只要有结点宕机导致16384个槽没全被覆盖，整个集群就全部停止服务，所以一定要改为no
no-appendfsync-on-rewrite yes 　　　　      # 设置为yes表示rewrite期间对新写操作不fsync，暂时存在内存中，等rewrite完成后再写入，提高redis写入性能
protected-mode no 　　　　　　　　           # 允许外部主机访问

slowlog-log-slower-than 1000 　　　　　　  # 慢查询日志，用于性能分析，生产环境可设置为1000（微妙）
slowlog-max-len 1000 　　　　　　　　　   # 保存慢查询的队列长度 ，设置为1000
cluster-slave-validity-factor 0 　　　　　　   # 设置为0，如果master slave都挂掉, slave跟master失联又超过这个数值*timeout的数值, 就不会发起选举了。如果设置为0，就是永远都会尝试发起选举，尝试从slave变为mater
</code></pre> 
<p>参考：https://www.cnblogs.com/miaocbin/p/11356358.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8e99502844e78c880a0316c4655831fd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">对于视觉图像检测的认知，真的需要有所提高才行</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/928f68346e47f4c216c9b54e2fb113f7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OpenWAF配置SSL访问本地资源</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>