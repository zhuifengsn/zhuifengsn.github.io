<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>redis超详细篇7 redis哨兵模式 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="redis超详细篇7 redis哨兵模式" />
<meta property="og:description" content="上一篇我们讲了redis的主从复制以及三个特点， 我们有提到反客为主，不过那时候是用命令手动实现的，那么有没有办法自动实现呢？带着问题，我们来到这篇，那么当然有了。
开篇 哨兵模式：反客为主的自动版，能够后台检测主机是否故障，如果故障了，根据投票数，自动将从库变成主库
哨兵模式的实现 步骤：
1.先创建一个sentinel.conf文件（哨兵配置文件，名字绝对不能打错）
2.进行哨兵配置，填写内容
3.启动配置
sentinel.conf配置
我们还是在myredis目录下进行创建，输入以下命令
sentinel monitor mymaster 127.0.0.1 6379 1 这段代码含义：
sentinel:哨兵
monitor:监视器
mymaster ：自己随便取名，我这就叫mymaster
127.0.0.1 6379:是我这里的主服务器，你可以根据自己的情况自动修改
1：址少有多少个哨兵统一迁移的数量，这里可以根据你的实际情况填写
sentinel.conf启动
启动命令：
redis-sentinel sentinel.conf 测试前提：
我们老规矩，默认主机是6379，从机6380、6381
如何实现看哨兵的功能呢？
我们先把主服务器关闭，然后看看哨兵的变化，以及哪一台服务器自动从 从服务器变成了主服务器
实现步骤：
1.关闭主服务器6379
2.静静等待结果
3.可能遇到的问题
如果你用info replication 一直查看不到状态改变，或者有提示【206:X 14 Mar 2022 11:19:12.883 # &#43;failover-state-select-slave master mymaster 127.0.0.1 6379
3206:X 14 Mar 2022 11:19:12.967 # -failover-abort-no-good-slave master mymaster 127.0.0.1 6379
3206:X 14 Mar 2022 11:19:13.040 # Next failover delay: I will not start a failover before Mon Mar 14 11:25:13 2022" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/f4958f9357eb3d77057edcad28d67f4b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-14T14:56:33+08:00" />
<meta property="article:modified_time" content="2022-03-14T14:56:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">redis超详细篇7 redis哨兵模式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>上一篇我们讲了redis的主从复制以及三个特点， 我们有提到反客为主，不过那时候是用命令手动实现的，那么有没有办法自动实现呢？带着问题，我们来到这篇，那么当然有了。</p> 
<h2><a id="_2"></a>开篇</h2> 
<p><strong>哨兵模式</strong>：反客为主的自动版，能够后台检测主机是否故障，如果故障了，根据投票数，自动将从库变成主库</p> 
<h2><a id="_5"></a>哨兵模式的实现</h2> 
<p>步骤：<br> 1.先创建一个sentinel.conf文件（哨兵配置文件，名字绝对不能打错）<br> 2.进行哨兵配置，填写内容<br> 3.启动配置</p> 
<p><strong>sentinel.conf配置</strong><br> 我们还是在myredis目录下进行创建，输入以下命令</p> 
<pre><code class="prism language-bash">sentinel monitor mymaster 127.0.0.1 6379 1
</code></pre> 
<p>这段代码含义：<br> sentinel:哨兵<br> monitor:监视器<br> mymaster ：自己随便取名，我这就叫mymaster<br> 127.0.0.1 6379:是我这里的主服务器，你可以根据自己的情况自动修改<br> 1：址少有多少个哨兵统一迁移的数量，这里可以根据你的实际情况填写</p> 
<p><strong>sentinel.conf启动</strong></p> 
<p>启动命令：</p> 
<pre><code class="prism language-bash">redis-sentinel sentinel.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/ac/82/1bYRaK4m_o.png" alt="在这里插入图片描述"><br> <strong>测试前提：</strong><br> 我们老规矩，默认主机是6379，从机6380、6381<br> <img src="https://images2.imgbox.com/13/60/f1IJpE1Z_o.png" alt="在这里插入图片描述"><br> 如何实现看哨兵的功能呢？<br> 我们先把主服务器关闭，然后看看哨兵的变化，以及哪一台服务器自动从 <strong>从服务器</strong>变成了<strong>主服务器</strong></p> 
<p>实现步骤：<br> <strong>1.关闭主服务器6379</strong><br> <img src="https://images2.imgbox.com/94/da/ywzZ7AmM_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2.静静等待结果</strong></p> 
<p><img src="https://images2.imgbox.com/c9/de/GBntsCh7_o.png" alt="在这里插入图片描述"><br> <strong>3.可能遇到的问题</strong><br> 如果你用info replication 一直查看不到状态改变，或者有提示【206:X 14 Mar 2022 11:19:12.883 # +failover-state-select-slave master mymaster 127.0.0.1 6379<br> 3206:X 14 Mar 2022 11:19:12.967 # -failover-abort-no-good-slave master mymaster 127.0.0.1 6379<br> 3206:X 14 Mar 2022 11:19:13.040 # Next failover delay: I will not start a failover before Mon Mar 14 11:25:13 2022<br> 】</p> 
<p>可能需要有以下原因：<br> 1.未打开26379的端口防护墙<br> 解决如下：</p> 
<pre><code class="prism language-bash">firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span>6379/tcp --permanent
<span class="token function">service</span> firewalld restart
</code></pre> 
<p>2.哨兵监视器未设置主机的访问密码<br> 在sentinel monitor下面加上这一句</p> 
<pre><code class="prism language-bash">sentinel auth-pass mymaster 123456
</code></pre> 
<p>再次重新启动下配置文件，或者原来的步骤重新开始</p> 
<p>到这我们算成功了一小步。此刻我们来看原来设置sentinel.conf文件，发现它变了样子</p> 
<pre><code class="prism language-bash">sentinel monitor mymaster 127.0.0.1 6380 1
sentinel auth-pass mymaster 123456
<span class="token comment"># Generated by CONFIG REWRITE</span>
protected-mode no
port 26379
user default on nopass sanitize-payload ~* <span class="token operator">&amp;</span>* +@all
<span class="token function">dir</span> <span class="token string">"/root/microservice/myredis"</span>
sentinel myid 15a8a11a6c571369834a5cb9aebabda405ea4d42
sentinel config-epoch mymaster 9
sentinel leader-epoch mymaster 9
sentinel current-epoch 9
sentinel known-replica mymaster 127.0.0.1 6379
sentinel known-replica mymaster 127.0.0.1 6381

</code></pre> 
<p>它新增了很多东西</p> 
<p>有没有思考过一个问题：6379主机挂了之后，哨兵会自动选择一个从机来作为主机，那么如果6379重新恢复后，它是否能重新成为主机？还是？</p> 
<p>带着疑问我们来测试下，恢复6379<br> 恢复步骤</p> 
<pre><code class="prism language-bash">redis-server redis6379.conf
</code></pre> 
<p>启动链接</p> 
<pre><code class="prism language-bash">redis-cli -p 6379 -a 123456
</code></pre> 
<p>查看状态</p> 
<pre><code class="prism language-bash">info replication

</code></pre> 
<p>发现它已经变成了6380的从机了。<strong>也就是说主机挂了之后，再次恢复，不再是主机了，只能变成新主机的从机</strong><br> 如果你不好理解上面的话语，举个简单例子：宋代老皇帝被俘虏，新皇帝即位，即使老皇帝回来了，它也不再是皇帝了，得向新皇帝称臣。明白否？<br> <img src="https://images2.imgbox.com/ed/97/yMiP5vVo_o.png" alt="在这里插入图片描述"><br> 故障恢复机制：<br> 多个从服务器将其转成主服务器，选择条件依次为：<br> 1.选择优先级靠前的<br> 优先级在redis.conf中默认：replica-priority 100 值越小优先级越高<br> 2.选择偏移量最大的<br> 偏移量是指获得原主机数据最全的<br> 3.选择runid最小的服务器<br> 每个redis实例启动后都会随机生成一个40位的runid</p> 
<p>挑选出来的新服务器之后sentinel向源服务器的从服务器发送slave of 新主服务器命令，复制新的master</p> 
<p>当已下线的服务重新上显示，sentinel会向其发送slaveof命令，让其成为新主的从<br> <img src="https://images2.imgbox.com/f6/22/tm3CVszS_o.png" alt="在这里插入图片描述"></p> 
<p>我写的明白吗？动手试试吧，下篇我们继续，记得点击关注</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7b4a2b0d0427642f7e916d9d0b1662cd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">二进制、八进制、十进制、十六进制带小数的转换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0a4a9946b25321049943c4b9e91e2ad1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计组_程序计数器(PC/IAR/IP/program counter/instruction pointer/instruction address register)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>