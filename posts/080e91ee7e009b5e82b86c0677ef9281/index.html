<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vnc安装和开机自启设置 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="vnc安装和开机自启设置" />
<meta property="og:description" content="一、安装VNC 键入以下命令以在 Ubuntu 服务器上安装 TigerVNC ：
sudo apt install tigervnc-standalone-server tigervnc-common 现在安装了 VNC 服务器，下一步是运行 vncserver 命令，该命令将创建初始配置并设置密码。运行以下命令时不要使用 sudo ：
vncserver 在继续下一步之前，首先使用带有 -kill 选项和服务器编号作为参数的 vncserver 命令停止 VNC 实例。在我们的例子中，服务器在端口 5901 (:1)中运行，因此我们将使用以下命令停止它：
1.启动vnc服务：
vncserver -localhost no 2.查看vnc运行状态：
vncserver -list 3.关闭vncC显示器
vncserver -kill :1 4.查找 vnc
ps -ef | grep vnc ubuntu.desktop 5.查找端口
netstat -ano | grep 5901 二、设置开机自启 1、编写启动脚本 nano /usr/lib/python3/start_vncserver.sh 复制下面到脚本
#!/bin/bash echo &#34;start vncserver...oooooooooooooo&#34; nohup /usr/bin/vncserver -SecurityTypes=None -rfbport=5901 -localhost no --I-KNOW-THIS-IS-INSECURE &amp; #!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/080e91ee7e009b5e82b86c0677ef9281/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-22T14:25:11+08:00" />
<meta property="article:modified_time" content="2022-11-22T14:25:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vnc安装和开机自启设置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="VNC_2"></a>一、安装VNC</h3> 
<p>键入以下命令以在 Ubuntu 服务器上安装 TigerVNC ：</p> 
<pre><code>sudo apt install tigervnc-standalone-server tigervnc-common
</code></pre> 
<p>现在安装了 VNC 服务器，下一步是运行 vncserver 命令，该命令将创建初始配置并设置密码。运行以下命令时不要使用 sudo ：</p> 
<pre><code>vncserver
</code></pre> 
<p>在继续下一步之前，首先使用带有 -kill 选项和服务器编号作为参数的 vncserver 命令停止 VNC 实例。在我们的例子中，服务器在端口 5901 (:1)中运行，因此我们将使用以下命令停止它：</p> 
<p><strong>1.启动vnc服务：</strong></p> 
<pre><code>vncserver -localhost no 
</code></pre> 
<p><strong>2.查看vnc运行状态：</strong></p> 
<pre><code class="prism language-java">vncserver <span class="token operator">-</span>list
</code></pre> 
<p><strong>3.关闭vncC显示器</strong></p> 
<pre><code>vncserver -kill :1
</code></pre> 
<p><strong>4.查找 vnc</strong></p> 
<pre><code>ps -ef | grep vnc  ubuntu.desktop
</code></pre> 
<p><strong>5.查找端口</strong></p> 
<pre><code class="prism language-java">netstat <span class="token operator">-</span>ano <span class="token operator">|</span> grep <span class="token number">5901</span>
</code></pre> 
<h3><a id="_47"></a>二、设置开机自启</h3> 
<h4><a id="1_49"></a>1、编写启动脚本</h4> 
<pre><code class="prism language-java">nano <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>python3<span class="token operator">/</span>start_vncserver<span class="token punctuation">.</span>sh
</code></pre> 
<p><strong>复制下面到脚本</strong></p> 
<pre><code class="prism language-java">#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>bash
echo <span class="token string">"start vncserver...oooooooooooooo"</span>
nohup <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>vncserver <span class="token operator">-</span><span class="token class-name">SecurityTypes</span><span class="token operator">=</span><span class="token class-name">None</span> <span class="token operator">-</span>rfbport<span class="token operator">=</span><span class="token number">5901</span> <span class="token operator">-</span>localhost no <span class="token operator">--</span><span class="token class-name">I</span><span class="token operator">-</span><span class="token constant">KNOW</span><span class="token operator">-</span><span class="token constant">THIS</span><span class="token operator">-</span><span class="token constant">IS</span><span class="token operator">-</span><span class="token constant">INSECURE</span> <span class="token operator">&amp;</span>
</code></pre> 
<pre><code class="prism language-java">#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>bash
echo <span class="token string">"start vncserver...oooooooooooooo"</span>   
nohup tigervncserver <span class="token operator">-</span>xstartup <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>xterm <span class="token operator">-</span><span class="token class-name">SecurityTypes</span><span class="token operator">=</span><span class="token class-name">None</span> <span class="token operator">-</span>rfbport<span class="token operator">=</span><span class="token number">5901</span> <span class="token operator">-</span>localhost no <span class="token operator">--</span><span class="token class-name">I</span><span class="token operator">-</span><span class="token constant">KNOW</span><span class="token operator">-</span><span class="token constant">THIS</span><span class="token operator">-</span><span class="token constant">IS</span><span class="token operator">-</span><span class="token constant">INSECURE</span> <span class="token operator">&amp;</span> 
</code></pre> 
<h4><a id="2_69"></a>2、附加权限</h4> 
<pre><code>chmod u+x /usr/lib/python3/start_vncserver.sh
</code></pre> 
<h4><a id="3service_75"></a>3、编写.service脚本</h4> 
<pre><code class="prism language-java">sudo nano <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>tigervnc<span class="token punctuation">.</span>service
</code></pre> 
<p><strong>4.1.复制下面到脚本</strong></p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span><span class="token class-name">Unit</span><span class="token punctuation">]</span>
<span class="token class-name">Description</span><span class="token operator">=</span><span class="token class-name">TigerVNC</span>  <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token constant">VNC</span><span class="token punctuation">)</span>
<span class="token class-name">After</span><span class="token operator">=</span>syslog<span class="token punctuation">.</span>target network<span class="token punctuation">.</span>target


<span class="token punctuation">[</span><span class="token class-name">Service</span><span class="token punctuation">]</span>
<span class="token class-name">Type</span><span class="token operator">=</span>forking

<span class="token class-name">ExecStartPre</span><span class="token operator">=</span><span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token string">"exec pre"</span>
<span class="token class-name">ExecStartPre</span><span class="token operator">=</span><span class="token operator">/</span>sbin<span class="token operator">/</span>runuser <span class="token operator">-</span>l root <span class="token operator">-</span>c <span class="token string">"/bin/rm -rf /tmp/.X*"</span>
<span class="token class-name">ExecStart</span><span class="token operator">=</span><span class="token operator">/</span>sbin<span class="token operator">/</span>runuser <span class="token operator">-</span>l root <span class="token operator">-</span>c <span class="token string">"/usr/lib/python3/start_vncserver.sh"</span>


<span class="token punctuation">[</span><span class="token class-name">Install</span><span class="token punctuation">]</span>
<span class="token class-name">WantedBy</span><span class="token operator">=</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target

</code></pre> 
<p><strong>4.2.通知 systemd 我们创建了一个新的单元文件：</strong></p> 
<pre><code>sudo systemctl daemon-reload
</code></pre> 
<p><strong>4.3.启用单元文件：</strong></p> 
<pre><code>sudo systemctl enable tigervnc.service
</code></pre> 
<p><strong>4.4.执行以下命令启动 VNC 服务：</strong></p> 
<pre><code>sudo systemctl start tigervnc.service
</code></pre> 
<p><strong>4.5.验证服务是否已成功启动：</strong></p> 
<pre><code>sudo systemctl status tigervnc.service
</code></pre> 
<p><strong>4.6.重启服务器</strong></p> 
<pre><code class="prism language-java">sudo reboot
</code></pre> 
<pre><code class="prism language-java">journalctl <span class="token operator">-</span>u tigervnc
</code></pre> 
<p>在当前用户目录下创建可执行文件~/.vnc/xstartup，内容如下：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment">#unset SESSION_MANAGER</span>
<span class="token comment">#unset DBUS_SESSION_BUS_ADDRESS</span>
<span class="token comment">#exec startxfce4 </span>


<span class="token builtin class-name">unset</span> <span class="token environment constant">SESSION_MANAGER</span>
<span class="token comment">#unset DBUS_SESSION_BUS_ADDRESS #测试中发现如果去掉该行注释 桌面不会出现</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">XKL_XMODMAP_DISABLE</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">XDG_CURRENT_DESKTOP</span></span><span class="token operator">=</span><span class="token string">"GNOME-Flashback:GNOME"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">XDG_MENU_PREFIX</span></span><span class="token operator">=</span><span class="token string">"gnome-flashback-"</span>
<span class="token punctuation">[</span> <span class="token parameter variable">-x</span> /etc/vnc/xstartup <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exec</span> /etc/vnc/xstartup
<span class="token punctuation">[</span> <span class="token parameter variable">-r</span> <span class="token environment constant">$HOME</span>/.Xresources <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> xrdb <span class="token environment constant">$HOME</span>/.Xresources
xsetroot <span class="token parameter variable">-solid</span> grey    <span class="token comment">#设置背景色</span>
vncconfig <span class="token parameter variable">-iconic</span> <span class="token operator">&amp;</span>
gnome-terminal <span class="token operator">&amp;</span>        <span class="token comment">#连接后会直接打开一个terminal窗口</span>
nautilus <span class="token operator">&amp;</span>              <span class="token comment">#连接后会直接打开一个文件窗口</span>
gnome-session <span class="token parameter variable">--session</span><span class="token operator">=</span>gnome-flashback-metacity --disable-acceleration-check <span class="token operator">&amp;</span>
</code></pre> 
<p>对于exec值，请使用以下命令检查您的桌面会话：</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> /usr/share/xsessions/
</code></pre> 
<p>在那里您可以找到类似以下内容的.desktop文件：</p> 
<pre><code class="prism language-bash">zkhx@zkhx-desktop:/lib/aarch64-linux-gnu$ <span class="token function">ls</span> /usr/share/xsessions/
ubuntu.desktop  xfce.desktop
zkhx@zkhx-desktop:/lib/aarch64-linux-gnu$ <span class="token function">cat</span> /usr/share/xsessions/ubuntu.desktop 
<span class="token punctuation">[</span>Desktop Entry<span class="token punctuation">]</span>
<span class="token assign-left variable">Name</span><span class="token operator">=</span>Ubuntu
<span class="token assign-left variable">Comment</span><span class="token operator">=</span>This session logs you into Ubuntu
<span class="token assign-left variable">Exec</span><span class="token operator">=</span>env <span class="token assign-left variable">GNOME_SHELL_SESSION_MODE</span><span class="token operator">=</span>ubuntu /usr/bin/gnome-session <span class="token parameter variable">--systemd</span> <span class="token parameter variable">--session</span><span class="token operator">=</span>ubuntu
<span class="token assign-left variable">TryExec</span><span class="token operator">=</span>/usr/bin/gnome-shell
<span class="token assign-left variable">Type</span><span class="token operator">=</span>Application
<span class="token assign-left variable">DesktopNames</span><span class="token operator">=</span>ubuntu:GNOME
X-GDM-SessionRegisters<span class="token operator">=</span>true
X-Ubuntu-Gettext-Domain<span class="token operator">=</span>gnome-session-3.0
</code></pre> 
<p>打开你对vnc会话感兴趣的桌面环境的文件，并检查那里的Exec变量，对我来说它是cgnome-session。所以我的~/.vnc/xstartup是这样的：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment">#unset SESSION_MANAGER</span>
<span class="token comment">#unset DBUS_SESSION_BUS_ADDRESS</span>
<span class="token comment">#exec startxfce4 </span>


<span class="token builtin class-name">unset</span> <span class="token environment constant">SESSION_MANAGER</span>
<span class="token comment">#unset DBUS_SESSION_BUS_ADDRESS #测试中发现如果去掉该行注释 桌面不会出现</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">XKL_XMODMAP_DISABLE</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">XDG_CURRENT_DESKTOP</span></span><span class="token operator">=</span><span class="token string">"GNOME-Flashback:GNOME"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">XDG_MENU_PREFIX</span></span><span class="token operator">=</span><span class="token string">"gnome-flashback-"</span>
<span class="token punctuation">[</span> <span class="token parameter variable">-x</span> /etc/vnc/xstartup <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exec</span> /etc/vnc/xstartup
<span class="token punctuation">[</span> <span class="token parameter variable">-r</span> <span class="token environment constant">$HOME</span>/.Xresources <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> xrdb <span class="token environment constant">$HOME</span>/.Xresources
xsetroot <span class="token parameter variable">-solid</span> grey    <span class="token comment">#设置背景色</span>
vncconfig <span class="token parameter variable">-iconic</span> <span class="token operator">&amp;</span>
gnome-terminal <span class="token operator">&amp;</span>        <span class="token comment">#连接后会直接打开一个terminal窗口</span>
nautilus <span class="token operator">&amp;</span>              <span class="token comment">#连接后会直接打开一个文件窗口</span>
gnome-session <span class="token parameter variable">--session</span><span class="token operator">=</span>gnome-flashback-metacity --disable-acceleration-check <span class="token operator">&amp;</span>
</code></pre> 
<p><strong>之后使用vncserver -localhost no命令启动。</strong></p> 
<p><strong>这个没有或者写错了会出现黑屏或者启动失败的情况</strong></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-dAJZpZBw-1669098206972)(img/1668586327600.png)]</p> 
<p>开一个文件窗口<br> gnome-session --session=gnome-flashback-metacity --disable-acceleration-check &amp;</p> 
<pre><code>
**之后使用vncserver -localhost no命令启动。**

**这个没有或者写错了会出现黑屏或者启动失败的情况**

[外链图片转存中...(img-dAJZpZBw-1669098206972)]

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d6923ac12de13f9096a13205fefaab30/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">novnc安装和开机自启设置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3743fb9c94bb51129d2e2828a597392d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">离线安装Docker镜像</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>