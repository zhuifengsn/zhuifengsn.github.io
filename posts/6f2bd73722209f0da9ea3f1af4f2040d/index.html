<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何使用ChatGPT的API(七)一个客户服务助手 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何使用ChatGPT的API(七)一个客户服务助手" />
<meta property="og:description" content="在本篇文章中，我们将综合前面文章中所有知识，创建一个端到端的客户服务助理示例。我们将经历以下步骤：
首先，我们将通过Moderation API检查输入是否违规。
其次，如果没有，我们将提取产品列表。
第三，如果找到产品信息，我们将尝试查找它们。
第四，我们用模型回答用户的问题。
第五，我们将通过Moderation API对答案进行审核。如果回答没有违规，我们可以把它返回给用户。
第六，对模型的回答进行质量评估
示例代码：
def process_user_message(user_input, all_messages, debug=True): delimiter = &#34;```&#34; # Step 1: Check input to see if it flags the Moderation API or is a prompt injection response = openai.Moderation.create(input=user_input) moderation_output = response[&#34;results&#34;][0] if moderation_output[&#34;flagged&#34;]: print(&#34;Step 1: Input flagged by Moderation API.&#34;) return &#34;Sorry, we cannot process this request.&#34; if debug: print(&#34;Step 1: Input passed moderation check.&#34;) category_and_product_response = utils.find_category_and_product_only(user_input, utils.get_products_and_category()) #print(print(category_and_product_response) # Step 2: Extract the list of products category_and_product_list = utils." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/6f2bd73722209f0da9ea3f1af4f2040d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-12T21:25:14+08:00" />
<meta property="article:modified_time" content="2023-07-12T21:25:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何使用ChatGPT的API(七)一个客户服务助手</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在本篇文章中，我们将综合前面文章中所有知识，创建一个端到端的客户服务助理示例。我们将经历以下步骤：</p> 
<p>首先，我们将通过Moderation API检查输入是否违规。</p> 
<p>其次，如果没有，我们将提取产品列表。</p> 
<p>第三，如果找到产品信息，我们将尝试查找它们。</p> 
<p>第四，我们用模型回答用户的问题。</p> 
<p>第五，我们将通过Moderation API对答案进行审核。如果回答没有违规，我们可以把它返回给用户。</p> 
<p>第六，对模型的回答进行质量评估</p> 
<p>示例代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">process_user_message</span><span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> all_messages<span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delimiter <span class="token operator">=</span> <span class="token string">"```"</span>
    
    <span class="token comment"># Step 1: Check input to see if it flags the Moderation API or is a prompt injection</span>
    response <span class="token operator">=</span> openai<span class="token punctuation">.</span>Moderation<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span>user_input<span class="token punctuation">)</span>
    moderation_output <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token string">"results"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> moderation_output<span class="token punctuation">[</span><span class="token string">"flagged"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 1: Input flagged by Moderation API."</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">"Sorry, we cannot process this request."</span>

    <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 1: Input passed moderation check."</span><span class="token punctuation">)</span>
    
    category_and_product_response <span class="token operator">=</span> utils<span class="token punctuation">.</span>find_category_and_product_only<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> utils<span class="token punctuation">.</span>get_products_and_category<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#print(print(category_and_product_response)</span>
    <span class="token comment"># Step 2: Extract the list of products</span>
    category_and_product_list <span class="token operator">=</span> utils<span class="token punctuation">.</span>read_string_to_list<span class="token punctuation">(</span>category_and_product_response<span class="token punctuation">)</span>
    <span class="token comment">#print(category_and_product_list)</span>

    <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 2: Extracted list of products."</span><span class="token punctuation">)</span>

    <span class="token comment"># Step 3: If products are found, look them up</span>
    product_information <span class="token operator">=</span> utils<span class="token punctuation">.</span>generate_output_string<span class="token punctuation">(</span>category_and_product_list<span class="token punctuation">)</span>
    <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 3: Looked up product information."</span><span class="token punctuation">)</span>

    <span class="token comment"># Step 4: Answer the user question</span>
    system_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    You are a customer service assistant for a large electronic store. \
    Respond in a friendly and helpful tone, with concise answers. \
    Make sure to ask the user relevant follow-up questions.
    """</span></span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> system_message<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>delimiter<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user_input<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>delimiter<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Relevant product information:\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>product_information<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>

    final_response <span class="token operator">=</span> get_completion_from_messages<span class="token punctuation">(</span>all_messages <span class="token operator">+</span> messages<span class="token punctuation">)</span>
    <span class="token keyword">if</span> debug<span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 4: Generated response to user question."</span><span class="token punctuation">)</span>
    all_messages <span class="token operator">=</span> all_messages <span class="token operator">+</span> messages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token comment"># Step 5: Put the answer through the Moderation API</span>
    response <span class="token operator">=</span> openai<span class="token punctuation">.</span>Moderation<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span>final_response<span class="token punctuation">)</span>
    moderation_output <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token string">"results"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> moderation_output<span class="token punctuation">[</span><span class="token string">"flagged"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 5: Response flagged by Moderation API."</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">"Sorry, we cannot provide this information."</span>

    <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 5: Response passed moderation check."</span><span class="token punctuation">)</span>

    <span class="token comment"># Step 6: Ask the model if the response answers the initial user query well</span>
    user_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    Customer message: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>delimiter<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user_input<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>delimiter<span class="token punctuation">}</span></span><span class="token string">
    Agent response: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>delimiter<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>final_response<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>delimiter<span class="token punctuation">}</span></span><span class="token string">

    Does the response sufficiently answer the question?
    """</span></span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> system_message<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> user_message<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    evaluation_response <span class="token operator">=</span> get_completion_from_messages<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
    <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 6: Model evaluated the response."</span><span class="token punctuation">)</span>

    <span class="token comment"># Step 7: If yes, use this answer; if not, say that you will connect the user to a human</span>
    <span class="token keyword">if</span> <span class="token string">"Y"</span> <span class="token keyword">in</span> evaluation_response<span class="token punctuation">:</span>  <span class="token comment"># Using "in" instead of "==" to be safer for model output variation (e.g., "Y." or "Yes")</span>
        <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 7: Model approved the response."</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> final_response<span class="token punctuation">,</span> all_messages
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> debug<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step 7: Model disapproved the response."</span><span class="token punctuation">)</span>
        neg_str <span class="token operator">=</span> <span class="token string">"I'm unable to provide the information you're looking for. I'll connect you with a human representative for further assistance."</span>
        <span class="token keyword">return</span> neg_str<span class="token punctuation">,</span> all_messages

user_input <span class="token operator">=</span> <span class="token string">"tell me about the smartx pro phone and the fotosnap camera, the dslr one. Also what tell me about your tvs"</span>
response<span class="token punctuation">,</span>_ <span class="token operator">=</span> process_user_message<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</code></pre> 
<p>上面的示例代码中，我们正在按步骤回答用户问题。第一步是审核输入，第二步是提取产品列表。第三步是查询产品信息。</p> 
<p>当有了产品信息，模型则根据产品信息回答用户的问题。最后，它将回答再次给到Moderation API，以确保可以安全地显示给用户。</p> 
<p>当然，这里也添加了让模型去评估回答质量的功能。</p> 
<p>这些是我们之前文章知识的一个汇总。</p> 
<p>提取产品信息的辅助函数<code>utils.find_category_and_product_only</code>, <code>utils.read_string_to_list</code>和<code>utils.generate_output_string</code>这里没有列出来。可以在公众号《首飞》内输入“api”查看到完整的源码。</p> 
<p>参考：</p> 
<p><a href="https://learn.deeplearning.ai/chatgpt-building-system/lesson/8/evaluation" rel="nofollow">https://learn.deeplearning.ai/chatgpt-building-system/lesson/8/evaluation</a></p> 
<hr> 
<p><strong>觉得有用就点个赞吧！</strong></p> 
<p>我是首飞，一个帮大家填坑的工程师。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/26d81c38917cbaa88eb13ca748a2c192/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何使用ChatGPT的API(六)输出检测</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a202ae9cf8da3ee2b17cc5e58f1306e9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Sql Server数据库sql语句去除所有空格</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>