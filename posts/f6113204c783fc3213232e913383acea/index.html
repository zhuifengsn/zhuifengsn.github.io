<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CameraX 学习笔记 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CameraX 学习笔记" />
<meta property="og:description" content="由于项目中自定义的相机经常报奇葩bug，决定学习下 CameraX。通过查看谷歌的官方 Demo ，学到了不少知识，做了这份笔记。
下面是相机的使用步骤及方法解释等。
CameraX 使用 添加依赖 // CameraX core library def camerax_version = &#39;1.0.0-beta04&#39; implementation &#34;androidx.camera:camera-core:$camerax_version&#34; // CameraX Camera2 extensions implementation &#34;androidx.camera:camera-camera2:$camerax_version&#34; // CameraX Lifecycle library implementation &#34;androidx.camera:camera-lifecycle:$camerax_version&#34; // CameraX View class implementation &#39;androidx.camera:camera-view:1.0.0-alpha11&#39; xml 布局 &lt;!-- 建议宽高都用 match --&gt; &lt;androidx.camera.view.PreviewView android:id=&#34;@&#43;id/view_finder&#34; android:layout_width=&#34;match_parent&#34; android:layout_height=&#34;match_parent&#34; /&gt; // 设置预览界面的对齐方式，默认 FILL_CENTER 等比例铺满 previewView viewFinder.scaleType = PreviewView.ScaleType.FIT_CENTER 用到的主要类解释 开始的地方：创建 Camera 对象Camera = ProcessCameraProvider.bindToLifecycle(LifecycleOwner, CameraSelector, Preview, ImageCapture, ImageAnalysis); 涉及对象解释：
ProcessCameraProvider 一个单例，用于将相机的生命周期绑定到任何 {@link LifecycleOwner} 中。Camera 绑定用例后返回的camera对象，这个对象基本没用LifecycleOwner 与 activity/fragment 生命周期绑定CameraSelector 相机选择器，用于选择前后置相机Preview 相机预览，通过preview." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/f6113204c783fc3213232e913383acea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-28T15:42:55+08:00" />
<meta property="article:modified_time" content="2020-05-28T15:42:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CameraX 学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>由于项目中自定义的相机经常报奇葩bug，决定学习下 CameraX。通过查看谷歌的<a href="https://github.com/android/camera-samples/tree/master/CameraXBasic">官方 Demo</a> ，学到了不少知识，做了这份笔记。<br> 下面是相机的使用步骤及方法解释等。</p> 
<h3><a id="CameraX__3"></a>CameraX 使用</h3> 
<hr> 
<h4><a id="_6"></a>添加依赖</h4> 
<pre><code class="prism language-gradle">   // CameraX core library
    def camerax_version = '1.0.0-beta04'
    implementation "androidx.camera:camera-core:$camerax_version"
    // CameraX Camera2 extensions
    implementation "androidx.camera:camera-camera2:$camerax_version"
    // CameraX Lifecycle library
    implementation "androidx.camera:camera-lifecycle:$camerax_version"
    // CameraX View class
    implementation 'androidx.camera:camera-view:1.0.0-alpha11'
</code></pre> 
<h4><a id="xml__18"></a>xml 布局</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 建议宽高都用 match --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.camera.view.PreviewView</span>
       <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/view_finder<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token comment">// 设置预览界面的对齐方式，默认 FILL_CENTER 等比例铺满 previewView</span>
viewFinder<span class="token punctuation">.</span>scaleType <span class="token operator">=</span> PreviewView<span class="token punctuation">.</span>ScaleType<span class="token punctuation">.</span>FIT_CENTER
</code></pre> 
<h4><a id="_31"></a>用到的主要类解释</h4> 
<ul><li>开始的地方：创建 Camera 对象<pre><code class="prism language-kotlin">Camera <span class="token operator">=</span> ProcessCameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span>LifecycleOwner<span class="token punctuation">,</span> 
								CameraSelector<span class="token punctuation">,</span> Preview<span class="token punctuation">,</span> ImageCapture<span class="token punctuation">,</span> ImageAnalysis<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p>涉及对象解释：</p> 
<ul><li>ProcessCameraProvider 一个单例，用于将相机的生命周期绑定到任何 {@link LifecycleOwner} 中。</li><li>Camera 绑定用例后返回的camera对象，这个对象基本没用</li><li>LifecycleOwner 与 activity/fragment 生命周期绑定</li><li>CameraSelector 相机选择器，用于选择前后置相机</li><li>Preview 相机预览，通过preview.setSurfaceProvider() 与 PreviewView 绑定实现预览</li><li>ImageCapture 拍照，拍照由这个对象触发和监听</li><li>ImageAnalysis 数据解析，实时监听相机图像数据</li></ul> 
<h4><a id="_46"></a>各类的初始化</h4> 
<ul><li> <p>初始化 ProcessCameraProvider</p> <pre><code class="prism language-kotlin"><span class="token comment">// 要求指定compileOptions Java8, 否则这个方法会抛异常 </span>
<span class="token keyword">val</span> cameraProviderFuture<span class="token operator">:</span> ListenableFuture<span class="token operator">&lt;</span>ProcessCameraProvider<span class="token operator">!</span><span class="token operator">&gt;</span> <span class="token operator">=</span> ProcessCameraProvider<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<span class="token comment">// 当 ProcessCameraProvider 初始化完成会调用 listener</span>
cameraProviderFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>Runnable <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">val</span> cameraProvider<span class="token operator">:</span> ProcessCameraProvider <span class="token operator">=</span> cameraProviderFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 在绑定前先要解绑</span>
	cameraProvider<span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 这个方法建议try catch, 因为cameraSelector配置不对或重复绑定等都会抛异常</span>
	camera <span class="token operator">=</span> cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cameraSelector<span class="token punctuation">,</span> preview<span class="token punctuation">,</span> imageCapture<span class="token punctuation">,</span> imageAnalysis<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>初始化 CameraSelector</p> <pre><code class="prism language-kotlin"><span class="token keyword">val</span> cameraSelector <span class="token operator">=</span> CameraSelector<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requireLensFacing</span><span class="token punctuation">(</span>CameraSelector<span class="token punctuation">.</span>LENS_FACING_BACK<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>初始化 Preview</p> <pre><code class="prism language-kotlin"><span class="token keyword">val</span> preview <span class="token operator">=</span> Preview<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// 设置了宽高比率，不能再设置分辨率</span>
			<span class="token punctuation">.</span><span class="token function">setTargetAspectRatio</span><span class="token punctuation">(</span>AspectRatio<span class="token punctuation">.</span>RATIO_16_9<span class="token punctuation">)</span>
			<span class="token comment">// .setTargetResolution(Size(1080, 1920))</span>
			<span class="token comment">// 设置</span>
			<span class="token punctuation">.</span><span class="token function">setTargetRotation</span><span class="token punctuation">(</span>viewFinder<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//设置 SurfaceProvider</span>
preview<span class="token punctuation">.</span><span class="token function">setSurfaceProvider</span><span class="token punctuation">(</span>viewFinder<span class="token punctuation">.</span><span class="token function">createSurfaceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>初始化 ImageCapture</p> <pre><code class="prism language-kotlin"><span class="token keyword">val</span> imageCapture <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">setTargetAspect</span><span class="token punctuation">(</span>AspectRatio<span class="token punctuation">.</span>RATIO_16_9<span class="token punctuation">)</span>
				<span class="token comment">// .setTargetResolution(Size(1080, 1920))</span>
				<span class="token punctuation">.</span><span class="token function">setRotation</span><span class="token punctuation">(</span>viewFinder<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRataton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token comment">// 闪光灯默认关闭 </span>
				<span class="token punctuation">.</span><span class="token function">setFlashMode</span><span class="token punctuation">(</span>ImageCapture<span class="token punctuation">.</span>FLASH_MODE_AUTO<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 注意：这个方法可以做到预览与照片的比率和显示区域完全一致</span>
imageCapture<span class="token punctuation">.</span><span class="token function">setCropAspectRatio</span><span class="token punctuation">(</span><span class="token function">Rational</span><span class="token punctuation">(</span>viewFinder<span class="token punctuation">.</span>width<span class="token punctuation">,</span> viewFinder<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> </li><li> <p>初始化 ImageAnalysis</p> <pre><code class="prism language-kotlin"><span class="token keyword">val</span> imageAnalysis <span class="token operator">=</span> ImageAnalysis<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">setTargetAspect</span><span class="token punctuation">(</span>AspectRatio<span class="token punctuation">.</span>RATIO_16_9<span class="token punctuation">)</span>
				<span class="token comment">// .setTargetResolution(Size(1080, 1920))</span>
				<span class="token punctuation">.</span><span class="token function">setRotation</span><span class="token punctuation">(</span>viewFinder<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRataton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 第一个参数为线程池,指定 Analyzer 接口回调的线程；第二个参数 Analyzer 接口对象</span>
imageAnalysis<span class="token punctuation">.</span><span class="token function">setAnalyzer</span><span class="token punctuation">(</span>Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 实现 Analyzer 接口<span class="token punctuation">)</span>
</code></pre> </li></ul> 
<h4><a id="_ImageCapure_104"></a>拍照功能 ImageCapure</h4> 
<p>拍照有两种方式，一种直接将图片保存到指定位置； 另一种是通过拍照后返回的 ImageProxy 对象，里面包含图片信息。看下面代码演示：</p> 
<pre><code class="prism language-kotlin">
<span class="token comment">// 将图片保存到指定路径; 参数1: 指定输出的图片路径 + metadata等；</span>
<span class="token comment">// 参数2: 线程池，指定拍照成功或失败的回调线程； 参数3: 拍照成功或失败的回调</span>
imageCapture<span class="token punctuation">.</span><span class="token function">takePicture</span><span class="token punctuation">(</span>ImageCapture<span class="token punctuation">.</span>OutputFileOptions<span class="token punctuation">,</span> Executor<span class="token punctuation">,</span> ImageCapture<span class="token punctuation">.</span>OnImageSavedCallback<span class="token punctuation">)</span>
<span class="token comment">// 通过 ImageProxy 对象自己处理图片数据; 参数1: 线程池, 拍照成功或失败的回调在这个线程执行； 参数2: 拍照成功或失败的回调</span>
imageCapture<span class="token punctuation">.</span><span class="token function">takePicture</span><span class="token punctuation">(</span>Executor<span class="token punctuation">,</span> ImageCapture<span class="token punctuation">.</span>OnImageCapturedCallback<span class="token punctuation">)</span>
</code></pre> 
<p>下面分别对参数解释：</p> 
<ul><li> <p>初始化 ImageCapture.OutputFileOption</p> <pre><code class="prism language-kotlin"><span class="token comment">//创建存储路径</span>
<span class="token keyword">val</span> file <span class="token operator">=</span> <span class="token function">getPhotoFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">val</span> metadata <span class="token operator">=</span> ImageCature<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 当为前置摄像头时镜像；前置摄像头预览时默认就是镜像</span>
	isReversedHorizontal <span class="token operator">=</span> lensFacing <span class="token operator">==</span> CameraSelector<span class="token punctuation">.</span>LENS_FACING_FRONT
	<span class="token comment">// 还可设置 Location</span>
	<span class="token comment">// location = </span>
<span class="token punctuation">}</span>
<span class="token keyword">val</span> outputOption <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span>OutputFileOption<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>初始化 ImageCapture.OnImageSavedCallback</p> <pre><code class="prism language-kotlin"><span class="token keyword">val</span> callback <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span><span class="token function">OnImageSavedCallback</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onImageSaved</span><span class="token punctuation">(</span>output<span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       	<span class="token comment">// 通过 savedUri 获取拍照结果</span>
           <span class="token keyword">val</span> savedUri<span class="token operator">:</span> Uri <span class="token operator">=</span> output<span class="token punctuation">.</span>savedUri <span class="token operator">?:</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
           <span class="token comment">//注意：这个回调方法在子线程，即上面传入的 Executor 线程</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>exc<span class="token operator">:</span> ImageCaptureException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Photo capture failed: <span class="token interpolation"><span class="token delimiter variable">${<!-- --></span>exc<span class="token punctuation">.</span>message<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">,</span> exc<span class="token punctuation">)</span>
           Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">requireContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exc<span class="token punctuation">.</span>message<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
</code></pre> </li><li> <p>初始化 ImageCapture.OnImageCapturedCallback</p> <pre><code class="prism language-kotlin"><span class="token keyword">val</span> callback <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span><span class="token function">OnImageCapturedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCaptureSuccess</span><span class="token punctuation">(</span>image<span class="token operator">:</span> ImageProxy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 将 imageProxy 转为 byte数组</span>
              <span class="token keyword">val</span> buffer<span class="token operator">:</span> ByteBuffer <span class="token operator">=</span> image<span class="token punctuation">.</span>planes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buffer
              <span class="token comment">// 新建指定长度数组</span>
              <span class="token keyword">val</span> byteArray <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token comment">// 倒带到起始位置 0</span>
              buffer<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">// 数据复制到数组, 这个 byteArray 包含有 exif 相关信息，</span>
              <span class="token comment">// 由于 bitmap 对象不会包含 exif 信息，所以转为 bitmap 需要注意保存 exif 信息</span>
              buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span>
              <span class="token comment">// 获取照片 Exif 信息</span>
              <span class="token keyword">val</span> byteArrayInputStream <span class="token operator">=</span> <span class="token function">ByteArrayInputStream</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span>
              <span class="token keyword">val</span> orientation <span class="token operator">=</span> <span class="token function">ExifInterface</span><span class="token punctuation">(</span>byteArrayInputStream<span class="token punctuation">)</span>

              <span class="token keyword">val</span> imageView <span class="token operator">=</span> container<span class="token punctuation">.</span>findViewById<span class="token operator">&lt;</span>ImageView<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>image_view<span class="token punctuation">)</span>
              <span class="token comment">// 主线程更新 UI</span>
              imageView<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">{<!-- --></span>
                  Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>

              image<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>exc<span class="token operator">:</span> ImageCaptureException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Photo capture failed: <span class="token interpolation"><span class="token delimiter variable">${<!-- --></span>exc<span class="token punctuation">.</span>message<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">,</span> exc<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<h3><a id="_183"></a>额外知识</h3> 
<hr> 
<ul><li> <p>如果有依赖下载不下来可以用阿里的代理:</p> <pre><code class="prism language-gradle">maven { url 'https://maven.aliyun.com/repository/public' }
maven { url 'https://maven.aliyun.com/repository/google' }
maven { url 'https://maven.aliyun.com/repository/jcenter' }
</code></pre> </li><li> <p>需要注意的是, 拍的照片有可能在一些手机上发生照片旋转的情况.<br> 这是因为这些手机认为打开摄像头进行拍摄时手机就应该是横屏的, 因此回到竖屏的情况下就会发生 90 度的旋转. 可以使用下面的方法处理:</p> <pre><code class="prism language-java"><span class="token keyword">private</span> fun <span class="token function">rotateIfRequired</span><span class="token punctuation">(</span>bitmap<span class="token operator">:</span> <span class="token class-name">Bitmap</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Bitmap</span> <span class="token punctuation">{<!-- --></span>
	val exif <span class="token operator">=</span> <span class="token class-name">ExifInterface</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span>
	val orientation <span class="token operator">=</span> exif<span class="token punctuation">.</span><span class="token function">getAttributeInt</span><span class="token punctuation">(</span><span class="token class-name">ExifInterface</span><span class="token punctuation">.</span>TAG_ORIENTATION<span class="token punctuation">,</span> <span class="token class-name">ExifInterface</span><span class="token punctuation">.</span>ORIENTATION_NORMAL<span class="token punctuation">)</span>
	<span class="token keyword">return</span> when <span class="token punctuation">(</span>orientation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">ExifInterface</span><span class="token punctuation">.</span>ORIENTATION_ROTATE_90 <span class="token operator">-&gt;</span> <span class="token function">rotateBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>
		<span class="token class-name">ExifInterface</span><span class="token punctuation">.</span>ORIENTATION_ROTATE_180 <span class="token operator">-&gt;</span> <span class="token function">rotateBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span>
		<span class="token class-name">ExifInterface</span><span class="token punctuation">.</span>ORIENTATION_ROTATE_270 <span class="token operator">-&gt;</span> <span class="token function">rotateBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> <span class="token number">270</span><span class="token punctuation">)</span>
		<span class="token keyword">else</span> <span class="token operator">-&gt;</span> bitmap
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> fun <span class="token function">rotateBitmap</span><span class="token punctuation">(</span>bitmap<span class="token operator">:</span> <span class="token class-name">Bitmap</span><span class="token punctuation">,</span> degree<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Bitmap</span> <span class="token punctuation">{<!-- --></span>
	val matrix <span class="token operator">=</span> <span class="token class-name">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	matrix<span class="token punctuation">.</span><span class="token function">postRotate</span><span class="token punctuation">(</span>degree<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	val rotatedBitmap <span class="token operator">=</span> <span class="token class-name">Bitmap</span><span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>width<span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>height<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> rotatedBitmap
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>FragmentContainerView<br> 用于容纳动态添加的 Fragment 的容器，可替代使用 FrameLayout 等，因为它解决了动画 z 排序问题以及分派给 Fragment 的窗口边衬区的问题。</p> </li><li> <p>取消activity旋转动画<br> android:rotationAnimation=“seamless”</p> </li><li> <p>各个方法对于的目录：<code>当目录不存在时还会自动创建</code></p> <pre><code>//外部存储
getExternalCacheDirs: /storage/emulated/0/Android/data/com.example.cameraxstudy/cache
getObbDir: /storage/emulated/0/Android/obb/com.example.cameraxstudy
getExternalMediaDirs: /storage/emulated/0/Android/media/com.example.cameraxstudy
getExternalCacheDir: /storage/emulated/0/Android/data/com.example.cameraxstudy/cache
// 内部存储
getCacheDir: /data/user/0/com.example.cameraxstudy/cache
getFilesDir: /data/user/0/com.example.cameraxstudy/files
getDataDir: /data/user/0/com.example.cameraxstudy
getCodeCacheDir: /data/user/0/com.example.cameraxstudy/code_cache
getNoBackupFilesDir: /data/user/0/com.example.cameraxstudy/no_backup

</code></pre> </li><li> <p>分享图片</p> <pre><code class="prism language-kotlin"><span class="token keyword">var</span> mediaFile<span class="token operator">:</span> File <span class="token operator">=</span> <span class="token function">getMediaFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从文件扩展名推断媒体类型</span>
    <span class="token keyword">val</span> mediaType <span class="token operator">=</span> MimeTypeMap<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMimeTypeFromExtension</span><span class="token punctuation">(</span>mediaFile<span class="token punctuation">.</span>extension<span class="token punctuation">)</span>
    <span class="token comment">// 从我们的FileProvider实现中获取URI</span>
    <span class="token keyword">val</span> uri <span class="token operator">=</span> FileProvider<span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>
            view<span class="token punctuation">.</span>context<span class="token punctuation">,</span> BuildConfig<span class="token punctuation">.</span>APPLICATION_ID <span class="token operator">+</span> <span class="token string">".provider"</span><span class="token punctuation">,</span> mediaFile<span class="token punctuation">)</span>
    <span class="token comment">// 设置适当的 intent extra, type, action and flags</span>
    <span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_STREAM<span class="token punctuation">,</span> uri<span class="token punctuation">)</span>
    type <span class="token operator">=</span> mediaType
    action <span class="token operator">=</span> Intent<span class="token punctuation">.</span>ACTION_SEND
    flags <span class="token operator">=</span> Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION
<span class="token punctuation">}</span>

<span class="token comment">// 启动意图，让用户选择要共享的应用程序</span>
<span class="token function">startActivity</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span><span class="token function">createChooser</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>share_hint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5b9928ec81e344b6bd9d67d69c67986e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">macOSX 时间不准问题解决</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63eca9c0be7530c532be08fbfd302269/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">简单实现x的n次方（10 分）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>