<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CAS原理分析，解决银行转账ABA难题 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CAS原理分析，解决银行转账ABA难题" />
<meta property="og:description" content="​
编辑切换为居中
添加图片注释，不超过 140 字（可选）
什么是CAS
CAS即Compare And Swap的缩写，翻译成中文就是比较并交换，其作用是让CPU比较内存中某个值是否和预期的值相同，如果相同则将这个值更新为新值，不相同则不做更新，也就是CAS是原子性的操作(读和写两者同时具有原子性)，其实现方式是通过借助C/C&#43;&#43;调用CPU指令完成的，所以效率很高。
CAS的原理很简单，这里使用一段Java代码来描述
public boolean compareAndSwap(int value, int expect, int update) { //如果内存中的值value和期望值expect一样 则将值更新为新值update if (value == expect) { value = update; return true; } else { return false; } }
大致过程是将内存中的值、我们的期望值、新值交给CPU进行运算，如果内存中的值和我们的期望值相同则将值更新为新值，否则不做任何操作。这个过程是在CPU中完成的，这里不好描述CPU的工作过程，就拿Java代码来描述了。
Unsafe源码分析
Java是在Unsafe(sun.misc.Unsafe)类实现CAS的操作，而我们知道Java是无法直接访问操作系统底层的API的(原因是Java的跨平台性限制了Java不能和操作系统耦合)，所以Java并没有在Unsafe类直接实现CAS的操作，而是通过JDI(Java Native Interface) 本地调用C/C&#43;&#43;语言来实现CAS操作的。 Unsafe有很多个CAS操作的相关方法，这里举例几个
public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5); public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/e9ad794e77c61a2436dcdf7b98e78304/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-07T10:45:51+08:00" />
<meta property="article:modified_time" content="2022-12-07T10:45:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CAS原理分析，解决银行转账ABA难题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p class="img-center"><img alt="" src="https://images2.imgbox.com/3e/9f/edX7cHa0_o.jpg"></p> 
<p>​</p> 
<p>编辑切换为居中</p> 
<p>添加图片注释，不超过 140 字（可选）</p> 
<p></p> 
<h3></h3> 
<p>什么是CAS</p> 
<p>CAS即Compare And Swap的缩写，翻译成中文就是比较并交换，其作用是让CPU比较内存中某个值是否和预期的值相同，如果相同则将这个值更新为新值，不相同则不做更新，也就是CAS是原子性的操作(读和写两者同时具有原子性)，其实现方式是通过借助C/C++调用CPU指令完成的，所以效率很高。</p> 
<p>CAS的原理很简单，这里使用一段Java代码来描述</p> 
<pre></pre> 
<pre></pre> 
<p>public boolean compareAndSwap(int value, int expect, int update) { //如果内存中的值value和期望值expect一样 则将值更新为新值update if (value == expect) { value = update; return true; } else { return false; } }</p> 
<p>大致过程是将内存中的值、我们的期望值、新值交给CPU进行运算，如果内存中的值和我们的期望值相同则将值更新为新值，否则不做任何操作。这个过程是在CPU中完成的，这里不好描述CPU的工作过程，就拿Java代码来描述了。</p> 
<h3></h3> 
<p>Unsafe源码分析</p> 
<p>Java是在Unsafe(sun.misc.Unsafe)类实现CAS的操作，而我们知道Java是无法直接访问操作系统底层的API的(原因是Java的跨平台性限制了Java不能和操作系统耦合)，所以Java并没有在Unsafe类直接实现CAS的操作，而是通过JDI(Java Native Interface) 本地调用C/C++语言来实现CAS操作的。 Unsafe有很多个CAS操作的相关方法，这里举例几个</p> 
<pre></pre> 
<pre></pre> 
<p>public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5); public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6);</p> 
<p>我们拿public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);进行分析，这个方法是比较内存中的一个值(整型)和我们的期望值(var4)是否一样，如果一样则将内存中的这个值更新为var5，参数中的var1是值所在的对象，var2是值在对象(var1)中的内存偏移量，参数var1和参数var2是为了定位出值所在内存的地址。</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6b/99/9luoZtE9_o.jpg"></p> 
<p>​</p> 
<p>编辑切换为居中</p> 
<p>添加图片注释，不超过 140 字（可选）</p> 
<p></p> 
<p>Unsafe.java 在这里发挥的作用有：</p> 
<ol><li> <p>将对象引用、值在对象中的偏移量、期望的值和欲更新的新值传递给Unsafe.cpp</p> </li><li> <p>如果值更新成功则返回true给开发者，没有更新则返回false</p> </li></ol> 
<p>Unsafe.cpp 在这里发挥的作用有：</p> 
<ol><li> <p>接受从Unsafe传递过来的对象引用、偏移量、期望的值和欲更新的新值，根据对象引用和偏移量计算出值的地址，然后将值的地址、期望的值、欲更新的新值传递给CPU</p> </li><li> <p>如果值更新成功则返回true给Unsafe.java，没有更新则返回false</p> </li></ol> 
<p>CPU在这里发挥的作用：</p> 
<ol><li> <p>接受从Unsafe.cpp传递过来的地址、期望的值和欲更新的新值，执行指令cmpxchg，比较地址中的值是否和期望的值一样，一样则将值更新为新的值，不一样则不做任何操作</p> </li><li> <p>将操作结果返回给Unsafe.cpp</p> </li></ol> 
<h3></h3> 
<p>CAS的缺点</p> 
<p>CAS虽然高效的实现了原子性操作，但是也存在一些缺点，主要表现在以下三个方面。</p> 
<h3></h3> 
<p>ABA问题</p> 
<p>在多线程场景下CAS会出现ABA问题，关于ABA问题这里简单科普下，例如有2个线程同时对同一个值(初始值为A)进行CAS操作，这三个线程如下</p> 
<ol><li> <p>线程1，期望值为A，欲更新的值为B</p> </li><li> <p>线程2，期望值为A，欲更新的值为B</p> </li></ol> 
<p>线程1抢先获得CPU时间片，而线程2因为其他原因阻塞了，线程1取值与期望的A值比较，发现相等然后将值更新为B，然后这个时候出现了线程3，期望值为B，欲更新的值为A，线程3取值与期望的值B比较，发现相等则将值更新为A，此时线程2从阻塞中恢复，并且获得了CPU时间片，这时候线程2取值与期望的值A比较，发现相等则将值更新为B，虽然线程2也完成了操作，但是线程2并不知道值已经经过了A-&gt;B-&gt;A的变化过程。</p> 
<p>ABA问题带来的危害： 小明在提款机，提取了50元，因为提款机问题，有两个线程，同时把余额从100变为50 线程1（提款机）：获取当前值100，期望更新为50， 线程2（提款机）：获取当前值100，期望更新为50， 线程1成功执行，线程2某种原因block了，这时，某人给小明汇款50 线程3（默认）：获取当前值50，期望更新为100， 这时候线程3成功执行，余额变为100， 线程2从Block中恢复，获取到的也是100，compare之后，继续更新余额为50！！！ 此时可以看到，实际余额应该为100（100-50+50），但是实际上变为了50（100-50+50-50）这就是ABA问题带来的成功提交。</p> 
<p>解决方法：在变量前面加上版本号，每次变量更新的时候变量的版本号都+1，即A-&gt;B-&gt;A就变成了1A-&gt;2B-&gt;3A。</p> 
<h3></h3> 
<p>循环时间长开销大</p> 
<p>如果CAS操作失败，就需要循环进行CAS操作(循环同时将期望值更新为最新的)，如果长时间都不成功的话，那么会造成CPU极大的开销。</p> 
<blockquote> 
 <p>这种循环也称为自旋</p> 
</blockquote> 
<p>解决方法：限制自旋次数，防止进入死循环。</p> 
<h3></h3> 
<p>只能保证一个共享变量的原子操作</p> 
<p>CAS的原子操作只能针对一个共享变量。</p> 
<p>解决方法：如果需要对多个共享变量进行操作，可以使用加锁方式(悲观锁)保证原子性，或者可以把多个共享变量合并成一个共享变量进行CAS操作。</p> 
<h3></h3> 
<p>CAS的应用</p> 
<p>我们知道CAS操作是一种无锁操作，并不会锁住共享变量，也就是一种非阻塞的同步机制，CAS就是乐观锁的实现。</p> 
<ol><li> <p>乐观锁总是假设最好的情况，每次去操作数据都认为不会被别的线程修改数据，所以在每次操作数据的时候都不会给数据加锁，即在线程对数据进行操作的时候，别的线程不会阻塞仍然可以对数据进行操作，只有在需要更新数据的时候才会去判断数据是否被别的线程修改过，如果数据被修改过则会拒绝操作并且返回错误信息给用户。</p> </li><li> <p>悲观锁总是假设最坏的情况，每次去操作数据时候都认为会被的线程修改数据，所以在每次操作数据的时候都会给数据加锁，让别的线程无法操作这个数据，别的线程会一直阻塞直到获取到这个数据的锁。这样的话就会影响效率，比如当有个线程发生一个很耗时的操作的时候，别的线程只是想获取这个数据的值而已都要等待很久。</p> </li></ol> 
<p>Java利用CAS的乐观锁、原子性的特性高效解决了多线程的安全性问题，例如JDK1.8中的集合类ConcurrentHashMap、关键字volatile、ReentrantLock等。</p> 
<blockquote> 
 <h3>                                      资源获取：</h3> 
 <p>大家<strong>点赞、收藏、关注、评论</strong>啦 、<strong>查看</strong>👇🏻👇🏻👇🏻<strong>微信公众号获取联系方式</strong>👇🏻👇🏻👇🏻</p> 
 <p><strong> 精彩专栏推荐订阅：</strong>在<strong>下方专栏</strong>👇🏻👇🏻👇🏻👇🏻</p> 
 <p><a href="https://blog.csdn.net/m0_63437643/article/details/127276380?spm=1001.2014.3001.5501" title="每天学四小时：Java+Spring+JVM+分布式高并发，架构师指日可待">每天学四小时：Java+Spring+JVM+分布式高并发，架构师指日可待</a></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/63e691a52454d4ae49b629109c8d8d20/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux 下 chmod 777 修改权限</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/79f440c7538680818d29681c2ee178af/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">spring ioc解决循环依赖为什么需要用三级缓存</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>