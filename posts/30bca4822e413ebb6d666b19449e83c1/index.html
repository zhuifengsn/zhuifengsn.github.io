<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot(33) ——用户认证和授权 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot(33) ——用户认证和授权" />
<meta property="og:description" content="Spring Security 是针对Spring项目的安全框架，也是Spring Boot底层安全模块默认的技术选型，他可以实现强大的Web安全控制，对于安全控制，我们仅需要引入 spring-boot-starter-security 模块，进行少量的配置，即可实现强大的安全管理！
记住两个类和一个注解：
WebSecurityConfigurerAdapter：自定义Security策略AuthenticationManagerBuilder：自定义认证策略@EnableWebSecurity：开启WebSecurity模式 Spring Security的两个主要目标是 “认证” 和 “授权”(访问控制)
“认证”（Authentication）
身份验证就是验证您的身份凭据，如用户名/用户ID和密码，以验证您的身份是否合法身份验证通常通过用户名和密码完成，有时与身份验证因素结合使用 “授权” （Authorization）
授权发生在系统成功验证您的身份后(即你需要先通过认证证明你的身份合法性，spring security才会去检查你的身份对应的角色，spring security才会对你进行授权验证，对比你请求的资源是不是你对应的角色的权限范围内的，是就返回资源，不是就403) 这两个概念是通用的，而不是只在Spring Security 中存在
目录 1.导入依赖2.简单上手1.授权(Authorization/or)2.认证(Authentication/en) 3.小结4.补充：使用JDBC实现认证 1.导入依赖 导入依赖，只需要导入启动器即可，我们可以在原来有的启动器依赖上面修改即可导入，这是因为springBoot的启动器依赖格式都是spring-boot-starter-XXX &lt;!--Spring Security的依赖--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt; 我们可以观察一下这个依赖为我们导入的其他依赖
可以发现它导入了aop依赖和安全配置和安全web依赖 2.简单上手 spring securty官方doc
@EnableWebSecurity	//使用注解@EnableWebSecurity public class Config extends WebSecurityConfigurerAdapter {	//继承WebSecurityConfigurerAdapter @Override protected void configure(HttpSecurity http) throws Exception {	//覆写configure()即可 http .apply(customDsl()) .flag(true) .and() ...; } } 按照官方模板创建一个configpackage com.thhh.config; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/30bca4822e413ebb6d666b19449e83c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-03T09:47:56+08:00" />
<meta property="article:modified_time" content="2020-10-03T09:47:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot(33) ——用户认证和授权</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ul><li> <p>Spring Security 是针对Spring项目的安全框架，也是Spring Boot底层安全模块默认的技术选型，他可以实现强大的Web安全控制，对于安全控制，<mark>我们仅需要引入 spring-boot-starter-security 模块，进行少量的配置，即可实现强大的安全管理！</mark></p> </li><li> <p>记住两个类和一个注解：</p> 
  <ul><li>WebSecurityConfigurerAdapter：自定义Security策略</li><li>AuthenticationManagerBuilder：自定义认证策略</li><li>@EnableWebSecurity：开启WebSecurity模式</li></ul> </li><li> <p>Spring Security的两个主要目标是 “认证” 和 “授权”(访问控制)</p> 
  <ul><li> <p>“认证”（Authentication）</p> 
    <ul><li>身份验证就是验证您的身份凭据，如用户名/用户ID和密码，以验证您的身份是否合法</li><li>身份验证通常通过用户名和密码完成，有时与身份验证因素结合使用</li></ul> </li><li> <p>“授权” （Authorization）</p> 
    <ul><li><mark>授权发生在系统成功验证您的身份后</mark>(即你需要先通过认证证明你的身份合法性，spring security才会去检查你的身份对应的角色，spring security才会对你进行授权验证，对比你请求的资源是不是你对应的角色的权限范围内的，是就返回资源，不是就403)</li></ul> </li></ul> </li><li> <p>这两个概念是通用的，而不是只在Spring Security 中存在</p> </li></ul> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#1_18" rel="nofollow">1.导入依赖</a></li><li><a href="#2_31" rel="nofollow">2.简单上手</a></li><li><ul><li><a href="#1Authorizationor_64" rel="nofollow">1.授权(Authorization/or)</a></li><li><a href="#2Authenticationen_128" rel="nofollow">2.认证(Authentication/en)</a></li></ul> 
   </li><li><a href="#3_211" rel="nofollow">3.小结</a></li><li><a href="#4JDBC_219" rel="nofollow">4.补充：使用JDBC实现认证</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="1_18"></a>1.导入依赖</h3> 
<ul><li>导入依赖，只需要导入启动器即可，我们可以在原来有的启动器依赖上面修改即可导入，这是因为springBoot的启动器依赖格式都是spring-boot-starter-XXX<pre><code class="prism language-xml"> <span class="token comment">&lt;!--Spring Security的依赖--&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li>我们可以观察一下这个依赖为我们导入的其他依赖<br> <img src="https://images2.imgbox.com/75/b5/9TbZM96B_o.png" alt="在这里插入图片描述"></li><li>可以发现它导入了aop依赖和安全配置和安全web依赖</li></ul> 
<hr> 
<h3><a id="2_31"></a>2.简单上手</h3> 
<ul><li><a href="https://docs.spring.io/spring-security/site/docs/5.2.0.RELEASE/reference/htmlsingle/" rel="nofollow">spring securty官方doc</a><br> <img src="https://images2.imgbox.com/0a/9a/Q6v5QQNi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bc/05/9IITFHh0_o.png" alt="在这里插入图片描述"></li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>	<span class="token comment">//使用注解@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>	<span class="token comment">//继承WebSecurityConfigurerAdapter </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>HttpSecurity http<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>	<span class="token comment">//覆写configure()即可</span>
        http
            <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token function">customDsl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flag</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>按照官方模板创建一个config<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>thhh<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span>HttpSecurity<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>EnableWebSecurity<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>WebSecurityConfigurerAdapter<span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>HttpSecurity http<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<h4><a id="1Authorizationor_64"></a>1.授权(Authorization/or)</h4> 
<ul><li>需求：首页大家都可以访问，但是其他功能也只有有权限的人才能进行访问</li><li>注意：按照模板写的方法是对父类的方法的覆写，所以方法具体怎么实现我们可以去参照父类的实现<br> <img src="https://images2.imgbox.com/d3/86/At4LdLE2_o.png" alt="在这里插入图片描述"></li><li>照猫画虎实现覆写的方法<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>thhh<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span>HttpSecurity<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>EnableWebSecurity<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>WebSecurityConfigurerAdapter<span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//链式编程</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>HttpSecurity http<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//请求授权规则制定，即对于请求服务器上的资源的授权，antMatchers()用于指定哪些资源请求需要进行授权，</span>
        <span class="token comment">//permitAll()表示这个资源的请求开放给所有人；hasRole()用于在()中指定将antMatchers()中指定的资源的请求权限开放给指定的人</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               
        <span class="token comment">//添加请求验证，对于"/"的访问，允许所有人访问</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/level1/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">)</span>  
                           <span class="token comment">//添加请求验证，对于"/level1/**"的访问，只有角色为vip1的角色可以访问</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/level2/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"vip2"</span><span class="token punctuation">)</span>  <span class="token operator">/</span><span class="token operator">/</span>同理
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/level3/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"vip3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span>同理
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li>当用户在没有登陆的状态下去请求页面时，不应该被跳转4xx页面，而是应该跳转登录页，示意登陆用户账号之后再去访问，登陆之后如果请求了权限范围之外的页面，直接跳转403，提示权限不够，当然我们也可以定制403页面向用户具体显示提示信息；</li><li>在springSecurity中，让没有登陆的用户在请求资源的时候跳转登陆页面的方法实现其实很简单，只需要一行代码<pre><code class="prism language-java">http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li>这相当于一个开关，只要我们调用了这个方法，就可以开启spring security中实现让没有登陆的用户在请求资源的时候跳转登陆页面的功能<br> <img src="https://images2.imgbox.com/cd/7d/kocgysVS_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d0/ca/NTxq151m_o.png" alt="在这里插入图片描述"></li><li>我们可以阅读一下http.formLogin()的源码<pre><code class="prism language-java">	<span class="token comment">/**
	 * The most basic configuration defaults to automatically generating a login page at
	 * the URL "/login", redirecting to "/login?error" for authentication failure. The
	 * details of the login page can be found on
	 * {@link FormLoginConfigurer#loginPage(String)}

	 * 	=====Override===== 
	 * 可见源码的注释中为我们列举了覆写configure()方法的格式/我们可以使用http对象的哪些方法
	 * 
	 * 	protected void configure(HttpSecurity http) throws Exception {
	 * 		http.authorizeRequests().antMatchers("/**").hasRole("USER").and().formLogin()
	 * 			authorizeRequests 授权
	 * 				.usernameParameter("username") // default is username
	 * 				.passwordParameter("password") // default is password
	 * 				.loginPage("/authentication/login") // default is /login with an HTTP get
	 * 				.failureUrl("/authentication/login?failed") // default is /login?error
	 * 				.loginProcessingUrl("/authentication/login/process"); // default is /login
	 * 																		// with an HTTP
	 * 																		// post
	 */</span>
	<span class="token keyword">public</span> FormLoginConfigurer<span class="token generics function"><span class="token punctuation">&lt;</span>HttpSecurity<span class="token punctuation">&gt;</span></span> <span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">getOrApply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FormLoginConfigurer</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<p><img src="https://images2.imgbox.com/03/23/PllZu3AC_o.png" alt="在这里插入图片描述"></p> 
<ul><li>可以发现，源码指出：本来http.formLogin()也是http对象的一个方法，所以注释中就将一个比较完整的http链式编程的例子写了出来，而http.formLogin()只是作为了链式编程中使用and()拼接的一个功能开启</li></ul> 
<h4><a id="2Authenticationen_128"></a>2.认证(Authentication/en)</h4> 
<ul><li>上面我们对于用户的授权做出了spring security的限制，只要你没有登陆，点击请求任何资源都会被重定向到spring security自带的登陆页面，但是由于我们还没有编写认证，所以跳转登陆页面之后我们也登陆不上，所以需要配置spring security的认证功能</li><li>spring security的认证可以有两种形式：①内存存储认证信息(优点：认证速度快；缺点：占用内存，可用空间有限) ②数据库存储认证信息(优点：存储空间大；缺单：认证速度慢)</li><li>这里我们先使用内存存储认证信息的方式来实现认证</li><li>实现认证我们需要覆写WebSecurityConfigurerAdapter的又一个方法<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li>同理，去看父类怎么实现的这个方法，照猫画虎实现覆写方法<pre><code class="prism language-java">
 <span class="token operator">*</span> For example<span class="token punctuation">,</span> the following configuration could be used to register in memory
 <span class="token operator">*</span> authentication that exposes an in memory <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@link</span> UserDetailsService<span class="token punctuation">}</span><span class="token operator">:</span>
 <span class="token operator">*</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
 <span class="token operator">*</span>
 <span class="token operator">*</span> <span class="token generics function"><span class="token punctuation">&lt;</span>pre<span class="token punctuation">&gt;</span></span>
 <span class="token operator">*</span> <span class="token annotation punctuation">@Override</span>
 <span class="token operator">*</span> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token operator">*</span> 	auth
 <span class="token operator">*</span> 	<span class="token comment">// enable in memory based authentication with a user named</span>
 <span class="token operator">*</span> 	<span class="token comment">// &amp;quot;user&amp;quot; and &amp;quot;admin&amp;quot;</span>
 <span class="token operator">*</span> 	<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>user<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>password<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>USER<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">*</span> 			<span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>admin<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>password<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>USER<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>ADMIN<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>disableLocalConfigureAuthenticationBldr <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<p><img src="https://images2.imgbox.com/0e/84/uo5ZS9gh_o.png" alt="在这里插入图片描述"></p> 
<ul><li>覆写实现<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>  <span class="token comment">//AuthenticationManagerBuilder授权管理建造者</span>
        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//inMemoryAuthentication()在内存中存储授权信息</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip1,vip2,vip3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//授权用户1信息配置</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment">//授权用户2信息配置</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip2,vip3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//授权用户3信息配置</span>
    <span class="token punctuation">}</span>
</code></pre> </li></ul> 
<p><img src="https://images2.imgbox.com/0c/b1/LqPt2YoL_o.png" alt="在这里插入图片描述"></p> 
<ul><li>正常情况下，上面的登陆用户信息应该在数据库中去读取，但是这里直接在内存中虚拟了3个用户信息</li><li>测试<br> <img src="https://images2.imgbox.com/63/e8/TYpkLevN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9d/a0/EoWKFVUC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/38/75/a4MLX6pY_o.png" alt="在这里插入图片描述"></li><li>报错信息：There was an unexpected error (type=Internal Server Error, status=500)，即我们使用的密码没有编码/加密</li><li>这是由于spring security5.0+的版本中，强制要求密码需要使用加密算法进行加密，原因：明文密码不安全，反编译可以看到明文密码，所以需要进行加密</li><li>加密方式：在auth.inMemoryAuthentication()之后直接"."方法passwordEncoder()，查看这个方法需要的参数<pre><code class="prism language-java"><span class="token keyword">public</span> C <span class="token function">passwordEncoder</span><span class="token punctuation">(</span>PasswordEncoder passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li>显然这个方法需要一个PasswordEncoder接口的实现类，通过IDEA可以清楚的找打这个接口有哪些实现类<br> <img src="https://images2.imgbox.com/43/38/pfkrMaSk_o.png" alt="在这里插入图片描述"></li><li>官方推荐使用的加密方式为BCryptPasswordEncoder<br> <img src="https://images2.imgbox.com/28/c7/k7BTVmi2_o.png" alt="在这里插入图片描述"><pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>  <span class="token comment">//AuthenticationManagerBuilder授权管理建造者</span>
   auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//inMemoryAuthentication()在内存中存储授权信息</span>
           <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">,</span><span class="token string">"vip2"</span><span class="token punctuation">,</span><span class="token string">"vip3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//授权用户1信息配置</span>
           <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment">//授权用户2信息配置</span>
           <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip2"</span><span class="token punctuation">,</span><span class="token string">"vip3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token comment">//授权用户3信息配置</span>
           <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li>注意：roles()中的角色要与antMatchers().hasRole()中设置的角色对应；并且roles()中有多个角色时，每个角色一个"“引起来，不同角色之间使用”,“隔开，不要只使用一个”"，将所有用户角色都写在里面，下图中就出现了这个错误，在功能测试的时候才发现<br> <img src="https://images2.imgbox.com/8e/e4/QnU4SEzj_o.png" alt="在这里插入图片描述"></li><li>重启项目进行测试<br> <img src="https://images2.imgbox.com/06/bd/ducV00H3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/85/34/cselr81W_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/69/b1/S59UW1XD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8a/93/FyLx3w6v_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f8/c3/4jWCJSvt_o.png" alt="在这里插入图片描述"></li><li>换一个权限低的用户登陆<br> <img src="https://images2.imgbox.com/3f/d2/HMaoR4gr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d1/3b/icUroEsa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/85/6d/f7qjpm0h_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9c/fe/VRW7bedR_o.png" alt="在这里插入图片描述"></li><li>通过上面的测试我们就实现了对于用户的认证+授权访问，用户lisi就不截图了</li></ul> 
<hr> 
<h3><a id="3_211"></a>3.小结</h3> 
<ul><li>可见通过spring security实现认证+授权其实很简单，我们只是自己定义了一个confiig，使用注解@EnableWebSecurity标注了这个类，并且该类继承了WebSecurityConfigurerAdapter类，并在这个类中覆写了实现认证(protected void configure(AuthenticationManagerBuilder auth))和授权(protected void configure(HttpSecurity http))的两个config方法</li><li>我们并没有修改原来程序实现的任何代码，利用了spring security是通过AOP方式实现的特点将认证+授权加在了已经完成了的项目上</li><li>注意：spring security中方法的覆写都是通过链式编程实现的</li><li>认证就需要设置用户名+密码+用户角色</li><li>授权就需要设置需要授权的资源对应的请求url+可以请求到该资源的用户角色</li></ul> 
<hr> 
<h3><a id="4JDBC_219"></a>4.补充：使用JDBC实现认证</h3> 
<ul><li>You can find the updates to support JDBC based authentication. The example below assumes that you have already defined a DataSource within your application. The jdbc-javaconfig sample provides a complete example of using JDBC based authentication.</li><li>您可以找到支持基于JDBC的身份验证的更新，下面的示例假设您已经在应用程序中定义了一个数据源，jdbcjavaconfig示例提供了使用基于jdbc的身份验证的完整示例</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> DataSource dataSource<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configureGlobal</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ensure the passwords are encoded properly</span>
    UserBuilder users <span class="token operator">=</span> User<span class="token punctuation">.</span><span class="token function">withDefaultPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    auth
        <span class="token punctuation">.</span><span class="token function">jdbcAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withDefaultSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">,</span><span class="token string">"ADMIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/25/8a/7UdjIVZ3_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/074cbf21fc0f0c5afeecc3d659b752bf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MACOS 格式化后重装系统提示 无法与恢复服务器获得联系</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9bfb91574627dba86f3b0d1b5e5e34c4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">分位数的简单理解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>