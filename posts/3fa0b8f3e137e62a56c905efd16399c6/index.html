<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tomcat的Connector启动过程分析 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Tomcat的Connector启动过程分析" />
<meta property="og:description" content="一. 前言 前面分析了tomcat的整体架构和tomcat的启动过程，在分析启动过程的时候只讲了整体的启动过程，本篇来重点分析一下tomcat的Connector(连接器)组件的启动过程。
二.从Connector的构造开始 那么org.apache.catalina.connector.Connector是在什么时候被创建出来的呢？在上一篇tomcat的启动过程中我们跟进过了Digester解析tomcat的server.xml配置文件，在org.apache.catalina.startup.Catalina#createStartDigester方法中有一个段代码是：
// 此处使用的tomcat版本为8.0 digester.addRule(&#34;Server/Service/Connector&#34;, new ConnectorCreateRule()); 所以当解析到server.xml配置文件中的Connector标签之后，就会创建一个ConnectorCreateRule来执行Connector的相关操作。那么这个org.apache.catalina.startup.ConnectorCreateRule其实是一个org.apache.tomcat.util.digester.Rule，这个Rule接口主要是实现了在匹配相应的XML元素嵌套模式时要采取的操作，简单说就是他是规定XML解析的元素是如何被加载处理的，Rule有一个方法org.apache.tomcat.util.digester.Rule#begin，就是用来处理XML配置文件中的标签开头部分的，也就初始化之类的。
默认是空实现，所以我们来看org.apache.catalina.startup.ConnectorCreateRule的begin方法。
public void begin(String namespace, String name, Attributes attributes) throws Exception { Service svc = (Service)digester.peek(); Executor ex = null; if ( attributes.getValue(&#34;executor&#34;)!=null ) { ex = svc.getExecutor(attributes.getValue(&#34;executor&#34;)); } // 从配置文件中的Connector标签中获取protocol属性的值，那么默认我们的protocol值就是HTTP/1.1 Connector con = new Connector(attributes.getValue(&#34;protocol&#34;)); if (ex != null) { setExecutor(con, ex); } String sslImplementationName = attributes.getValue(&#34;sslImplementationName&#34;); if (sslImplementationName != null) { setSSLImplementationName(con, sslImplementationName); } digester.push(con); } 由上面这段代码注释可以知道是通过xml的配置内容进行Connector的创建的，那么跟进到org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/3fa0b8f3e137e62a56c905efd16399c6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-16T14:47:32+08:00" />
<meta property="article:modified_time" content="2023-03-16T14:47:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tomcat的Connector启动过程分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="__0"></a>一. 前言</h2> 
<p>前面分析了<a href="https://blog.csdn.net/qq_34203492/article/details/127528964">tomcat的整体架构</a>和<a href="https://blog.csdn.net/qq_34203492/article/details/127610014">tomcat的启动过程</a>，在分析启动过程的时候只讲了整体的启动过程，本篇来重点分析一下tomcat的Connector(连接器)组件的启动过程。</p> 
<h2><a id="Connector_3"></a>二.从Connector的构造开始</h2> 
<p>那么<code>org.apache.catalina.connector.Connector</code>是在什么时候被创建出来的呢？在上一篇<a href="https://blog.csdn.net/qq_34203492/article/details/127610014">tomcat的启动过程</a>中我们跟进过了<code>Digester</code>解析tomcat的<code>server.xml</code>配置文件，在<code>org.apache.catalina.startup.Catalina#createStartDigester</code>方法中有一个段代码是：</p> 
<pre><code class="prism language-java"><span class="token comment">// 此处使用的tomcat版本为8.0</span>
digester<span class="token punctuation">.</span><span class="token function">addRule</span><span class="token punctuation">(</span><span class="token string">"Server/Service/Connector"</span><span class="token punctuation">,</span>
                         <span class="token keyword">new</span> <span class="token class-name">ConnectorCreateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>所以当解析到<code>server.xml</code>配置文件中的<code>Connector</code>标签之后，就会创建一个<code>ConnectorCreateRule</code>来执行<code>Connector</code>的相关操作。那么这个<code>org.apache.catalina.startup.ConnectorCreateRule</code>其实是一个<code>org.apache.tomcat.util.digester.Rule</code>，这个<code>Rule</code>接口主要是实现了在匹配相应的XML元素嵌套模式时要采取的操作，简单说就是他是规定XML解析的元素是如何被加载处理的，<code>Rule</code>有一个方法<code>org.apache.tomcat.util.digester.Rule#begin</code>，就是用来处理XML配置文件中的标签开头部分的，也就初始化之类的。<br> <img src="https://images2.imgbox.com/72/11/T96zmBOs_o.png" alt="在这里插入图片描述"><br> 默认是空实现，所以我们来看<code>org.apache.catalina.startup.ConnectorCreateRule</code>的<code>begin</code>方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Attributes</span> attributes<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Service</span> svc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Service</span><span class="token punctuation">)</span>digester<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Executor</span> ex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> attributes<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"executor"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ex <span class="token operator">=</span> svc<span class="token punctuation">.</span><span class="token function">getExecutor</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"executor"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从配置文件中的Connector标签中获取protocol属性的值，那么默认我们的protocol值就是HTTP/1.1</span>
    <span class="token class-name">Connector</span> con <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connector</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"protocol"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setExecutor</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> sslImplementationName <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"sslImplementationName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sslImplementationName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setSSLImplementationName</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> sslImplementationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    digester<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由上面这段代码注释可以知道是通过xml的配置内容进行<code>Connector</code>的创建的，那么跟进到<code>org.apache.catalina.connector.Connector#Connector(java.lang.String)</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Connector</span><span class="token punctuation">(</span><span class="token class-name">String</span> protocol<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 从上面的跟进可以知道入参的protocol值为 HTTP/1.1</span>
	<span class="token comment">// 这个setProtocol就是根据入参去选择对应的Protocol  </span>
	<span class="token comment">// 那么由此可知最终是protocolHandlerClassName的值为org.apache.coyote.http11.Http11NioProtocol</span>
	<span class="token comment">// 也就是http1.1的nio方式</span>
    <span class="token function">setProtocol</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Instantiate protocol handler</span>
    <span class="token class-name">ProtocolHandler</span> p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>protocolHandlerClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处通过反射创建Http11NioProtocol</span>
        p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolHandler</span><span class="token punctuation">)</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                <span class="token string">"coyoteConnector.protocolHandlerInstantiationFailed"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>protocolHandler <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Globals</span><span class="token punctuation">.</span>STRICT_SERVLET_COMPLIANCE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        uriCharset <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>ISO_8859_1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        uriCharset <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Default for Connector depends on this (deprecated) system property</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        encodedSolidusHandling <span class="token operator">=</span> <span class="token class-name">EncodedSolidusHandling</span><span class="token punctuation">.</span>DECODE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过这段代码我们跟进到<code>org.apache.coyote.http11.Http11NioProtocol</code>的创建，来看<code>Http11NioProtocol</code>的继承结构<br> <img src="https://images2.imgbox.com/0d/57/2SrLkr9v_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Http11NioProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//创建了一个NioEndpoint</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NioEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>Http11NioProtocol</code>在构造时创建了一个<code>org.apache.tomcat.util.net.NioEndpoint</code>，这个其实就是NIO的默认实现。​<code>Endpoint</code>​​​负责网络通信，监听一个端口，循环接收​​socket​​​请求，读取网络字节流等<br> <img src="https://images2.imgbox.com/4f/79/5TbWHILy_o.png" alt="在这里插入图片描述"><br> 在<code>NioEndpoint</code>的父类<code>org.apache.tomcat.util.net.AbstractEndpoint</code>中有一个抽象内部类：<code>org.apache.tomcat.util.net.AbstractEndpoint.Acceptor</code>，而<code>NioEndpoint</code>中有一个<code>org.apache.tomcat.util.net.NioEndpoint.Acceptor</code>继承自它，并实现了他的<code>run()</code>方法，在这个run方法中就是在循环的调用<code>serverSock.accept()</code>接收请求到tomcat的链接，先有个大概了解，后续在详细分析接收请求的部分。</p> 
<p>回到<code>Http11NioProtocol</code>的创建</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Http11NioProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//创建了一个NioEndpoint</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NioEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进到父类的构造函数可以知道，最终是把这个new出来的 <code>NioEndpoint</code>赋值给了<code>org.apache.coyote.AbstractProtocol#AbstractProtocol</code>的<code>org.apache.coyote.AbstractProtocol#endpoint</code>属性。在父类<code>org.apache.coyote.http11.AbstractHttp11Protocol</code>构造器中：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">AbstractHttp11Protocol</span><span class="token punctuation">(</span><span class="token class-name">AbstractEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> endpoint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setConnectionTimeout</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_CONNECTION_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConnectionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> cHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setHandler</span><span class="token punctuation">(</span>cHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHandler</span><span class="token punctuation">(</span>cHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建了一个<code>org.apache.coyote.AbstractProtocol.ConnectionHandler</code>，然后把这个<code>ConnectionHandler</code>设置到前面创建的<code>NioEndpoint</code>中。</p> 
<p>然后就完成了<code>Connector</code>的创建。在<code>Connector</code>的创建过程中，我们要注意几个点：</p> 
<ol><li><code>Http11NioProtocol</code> 继承自<code>AbstractProtocol</code>和<code>AbstractHttp11Protocol</code>，他持有<code>NioEndpoint</code></li><li><code>NioEndpoint</code> 继承自<code>AbstractEndpoint</code>，持有<code>ConnectionHandler</code>，<code>NioEndpoint</code>的内部类<code>Acceptor</code>是真正的接收请求的地方</li><li><code>ConnectionHandler</code>是<code>NioEndpoint</code>的一个属性，它在后续会进行<code>NioEndpoint</code>接收的请求处理时使用</li></ol> 
<p>到目前为止只是创建了<code>Connector</code>，<code>Connector</code>也是一个<code>Lifecycle</code>，所以接下来就到了他的<code>initInternal</code>，所以我们直接来到：<code>org.apache.catalina.connector.Connector#initInternal</code>，不了解为啥会来到这里的同学请先看<a href="https://blog.csdn.net/qq_34203492/article/details/127610014">tomcat的启动过程</a>中对<code>Lifecycle</code>相关的内容。</p> 
<h2><a id="_Connectorinit_110"></a>三. Connector的init</h2> 
<p><code>Connector</code>实现了<code>Lifecycle</code>，所以init肯定是在<code>org.apache.catalina.connector.Connector#initInternal</code></p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LifecycleException</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize adapter</span>
    <span class="token comment">// 初始化一个CoyoteAdapter  CoyoteAdapter是Adapter接口的实现</span>
    adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoyoteAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    protocolHandler<span class="token punctuation">.</span><span class="token function">setAdapter</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make sure parseBodyMethodsSet has a default</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> parseBodyMethodsSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setParseBodyMethods</span><span class="token punctuation">(</span><span class="token function">getParseBodyMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocolHandler<span class="token punctuation">.</span><span class="token function">isAprRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">AprLifecycleListener</span><span class="token punctuation">.</span><span class="token function">isInstanceCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"coyoteConnector.protocolHandlerNoAprListener"</span><span class="token punctuation">,</span>
                <span class="token function">getProtocolHandlerClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocolHandler<span class="token punctuation">.</span><span class="token function">isAprRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">AprLifecycleListener</span><span class="token punctuation">.</span><span class="token function">isAprAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"coyoteConnector.protocolHandlerNoAprLibrary"</span><span class="token punctuation">,</span>
                <span class="token function">getProtocolHandlerClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AprLifecycleListener</span><span class="token punctuation">.</span><span class="token function">isAprAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">AprLifecycleListener</span><span class="token punctuation">.</span><span class="token function">getUseOpenSSL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            protocolHandler <span class="token keyword">instanceof</span> <span class="token class-name">AbstractHttp11JsseProtocol</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AbstractHttp11JsseProtocol</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> jsseProtocolHandler <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token class-name">AbstractHttp11JsseProtocol</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> protocolHandler<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jsseProtocolHandler<span class="token punctuation">.</span><span class="token function">isSSLEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                jsseProtocolHandler<span class="token punctuation">.</span><span class="token function">getSslImplementationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// OpenSSL is compatible with the JSSE configuration, so use it if APR is available</span>
            jsseProtocolHandler<span class="token punctuation">.</span><span class="token function">setSslImplementationName</span><span class="token punctuation">(</span><span class="token class-name">OpenSSLImplementation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// protocolHandler就是Http11NioProtocol</span>
        protocolHandler<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleException</span><span class="token punctuation">(</span>
                sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"coyoteConnector.protocolHandlerInitializationFailed"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进到<code>protocolHandler.init();</code>执行里面去，由于<code>Http11NioProtocol</code>集成了<code>AbstractHttp11Protocol</code>，这个<code>init()</code>方法就在<code>AbstractHttp11Protocol</code>中：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Upgrade protocols have to be configured first since the endpoint</span>
    <span class="token comment">// init (triggered via super.init() below) uses this list to configure</span>
    <span class="token comment">// the list of ALPN protocols to advertise</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UpgradeProtocol</span> upgradeProtocol <span class="token operator">:</span> upgradeProtocols<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">configureUpgradeProtocol</span><span class="token punctuation">(</span>upgradeProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 又调用了父类的init，也就是AbstractProtocol的init方法</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set the Http11Protocol (i.e. this) for any upgrade protocols once</span>
    <span class="token comment">// this has completed initialisation as the upgrade protocols may expect this</span>
    <span class="token comment">// to be initialised when the call is made</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UpgradeProtocol</span> upgradeProtocol <span class="token operator">:</span> upgradeProtocols<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeProtocol <span class="token keyword">instanceof</span> <span class="token class-name">Http2Protocol</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Http2Protocol</span><span class="token punctuation">)</span> upgradeProtocol<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHttp11Protocol</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进到<code>org.apache.coyote.AbstractProtocol#init</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"abstractProtocolHandler.init"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Component not pre-registered so register it</span>
        oname <span class="token operator">=</span> <span class="token function">createObjectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oname <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Registry</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oname<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>domain <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ObjectName</span> rgOname <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectName</span><span class="token punctuation">(</span>domain <span class="token operator">+</span> <span class="token string">":type=GlobalRequestProcessor,name="</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rgOname <span class="token operator">=</span> rgOname<span class="token punctuation">;</span>
        <span class="token class-name">Registry</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerComponent</span><span class="token punctuation">(</span>
                <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGlobal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rgOname<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> endpointName <span class="token operator">=</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里的endpoint就是NioEndpoint  此处给NioEndpoint设置了名字：http-nio-8080  和  domain：Catalina</span>
    endpoint<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>endpointName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> endpointName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    endpoint<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 然后继续执行自组件的init  也就是NioEndpoint的init</span>
    endpoint<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进这个<code>endpoint.init();</code>最终会来到：<code>org.apache.tomcat.util.net.AbstractEndpoint#init</code>，这个方法中我们重点关注其中的<code>bind();</code>方法，其他的代码这里就不贴出来了。<br> <code>bind()</code>方法是个抽象方法，留给子类实现了，所以来到：<code>org.apache.tomcat.util.net.NioEndpoint#bind</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*默认执行*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getUseInheritedChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 开启 ServerSocketChannel</span>
        serverSock <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socketProperties<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>serverSock<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InetSocketAddress</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">?</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// addr是：0.0.0.0/0.0.0.0:8080   其实就是绑定8080端口</span>
        <span class="token comment">// getAcceptCount()获取的是acceptCount 默认值为100 表示的是socket上请求的最大挂起连接数</span>
        serverSock<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span><span class="token function">getAcceptCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*从系统获取*/</span>
        <span class="token comment">// Retrieve the channel provided by the OS</span>
        <span class="token class-name">Channel</span> ic <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">inheritedChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ic <span class="token keyword">instanceof</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            serverSock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> ic<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSock <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"endpoint.init.bind.inherited"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置 ServerSocketChannel 为阻塞模式</span>
    serverSock<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//mimic APR behavior</span>

    <span class="token comment">// Initialize thread count defaults for acceptor, poller</span>
    <span class="token comment">//  设置了Poller和Acceptor的线程数量 在start中根据数量启动相对应数量的线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptorThreadCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// FIXME: Doesn't seem to work that well with multiple accept threads</span>
        acceptorThreadCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pollerThreadCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//minimum one poller thread</span>
        pollerThreadCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置</span>
    <span class="token function">setStopLatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>pollerThreadCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize SSL if needed</span>
    <span class="token function">initialiseSsl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 打开NioSelectorPool</span>
    selectorPool<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后<code>Connector</code>的init大致就完成了。<br> 在这个过程中主要是有：</p> 
<ol><li>创建了<code>CoyoteAdapter</code></li><li>执行<code>Http11NioProtocol</code>的init，在执行<code>endpoint的init</code></li><li>在<code>NioEndpoint</code>中开启了<code>ServerSocketChannel</code>并绑定端口</li><li>打开了一个<code>NioSelectorPool</code></li></ol> 
<h2><a id="_Connectorstart_267"></a>四. Connector的start</h2> 
<p>大致的了解了的一遍<code>Connector</code>的<code>init</code>之后，再来看<code>Connector</code>的<code>start</code>，从<code>org.apache.catalina.connector.Connector#startInternal</code>开始</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LifecycleException</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// Validate settings before starting</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                <span class="token string">"coyoteConnector.invalidPort"</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">LifecycleState</span><span class="token punctuation">.</span>STARTING<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// Http11NioProtocol的start</span>
        protocolHandler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleException</span><span class="token punctuation">(</span>
                sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"coyoteConnector.protocolHandlerStartFailed"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>根据代码跟进到：<code>org.apache.coyote.AbstractProtocol#start</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"abstractProtocolHandler.start"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// NioEndpoint的start</span>
    endpoint<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Start timeout thread</span>
    <span class="token comment">// 启动超时线程</span>
    asyncTimeout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> timeoutThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>asyncTimeout<span class="token punctuation">,</span> <span class="token function">getNameInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-AsyncTimeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> priority <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">getThreadPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>priority <span class="token operator">&lt;</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>MIN_PRIORITY <span class="token operator">||</span> priority <span class="token operator">&gt;</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>MAX_PRIORITY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        priority <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    timeoutThread<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeoutThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeoutThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进<code>endpoint.start();</code>会先来到<code>org.apache.tomcat.util.net.AbstractEndpoint#start</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 这个bindState在org.apache.tomcat.util.net.AbstractEndpoint#init中已经设置为BOUND_ON_INIT了  所以这里不会再进入这个if</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindState <span class="token operator">==</span> <span class="token class-name">BindState</span><span class="token punctuation">.</span>UNBOUND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindState <span class="token operator">=</span> <span class="token class-name">BindState</span><span class="token punctuation">.</span>BOUND_ON_START<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 跟进这个</span>
    <span class="token function">startInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进<code>startInternal()</code>到<code>org.apache.tomcat.util.net.NioEndpoint#startInternal</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>running<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        processorCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">SynchronizedStack</span><span class="token punctuation">.</span>DEFAULT_SIZE<span class="token punctuation">,</span>
                socketProperties<span class="token punctuation">.</span><span class="token function">getProcessorCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">SynchronizedStack</span><span class="token punctuation">.</span>DEFAULT_SIZE<span class="token punctuation">,</span>
                        socketProperties<span class="token punctuation">.</span><span class="token function">getEventCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nioChannels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">SynchronizedStack</span><span class="token punctuation">.</span>DEFAULT_SIZE<span class="token punctuation">,</span>
                socketProperties<span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create worker collection</span>
        <span class="token comment">/*创建工作线程池*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// tomcat自定义了线程池实现，并自定义了线程池队列  这个后续再分析</span>
            <span class="token function">createExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         <span class="token comment">//限流控制  tomcat自定义了一个LimitLatch用来实现限流控制</span>
        <span class="token function">initializeConnectionLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Start poller threads</span>
        <span class="token comment">// 启动Poller线程 </span>
        pollers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poller</span><span class="token punctuation">[</span><span class="token function">getPollerThreadCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>pollers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pollers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> pollerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>pollers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-ClientPoller-"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pollerThread<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>threadPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pollerThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pollerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 启动Acceptor线程</span>
        <span class="token function">startAcceptorThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>org.apache.tomcat.util.net.NioEndpoint#bind</code>中设置了<code>Poller</code>和<code>Acceptor</code>的数量</p> 
<p>那么至此start也就大致完成了，在这个过程中几个重点：</p> 
<ol><li>创建了工作线程池<code>org.apache.tomcat.util.threads.ThreadPoolExecutor</code></li><li>创建了限流<code>LimitLatch</code></li><li>启动了<code>Poller</code>线程</li><li>启动了<code>Acceptor</code>线程</li></ol> 
<p>到此位置，Connector的启动过程就大致分析完成了。在过程中涉及到了<code>Http11NioProtocol</code>、<code>NioEndpoint</code>、<code>ConnectionHandler</code>、<code>CoyoteAdapter</code>、<code>Acceptor</code>、<code>Poller</code>、<code>LimitLatch</code>、<code>org.apache.tomcat.util.threads.ThreadPoolExecutor</code>这些重要的类。这些都在后续的文章中详细分析吧，由于篇幅问题，本篇就先了解一个过程，算是抛砖引玉</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2957f834eec0c1d454194cc5411c5606/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">QT串口助手开发2之串口程序编写</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/30bdd51dbfe0540a521258177426ec39/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">异或与字符串反转</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>