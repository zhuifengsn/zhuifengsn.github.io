<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ClickHouse &amp; OLAP - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ClickHouse &amp; OLAP" />
<meta property="og:description" content="install docker installconnect by DBeaver connect error: cannot create driver instance 原因：DBeaver下载ClickHouse驱动失败解决方法：增加国内源的maven地址。窗口-&gt;首选项-&gt;DBeaver-&gt;驱动 -&gt; Maven。添加阿里云的maven地址http://maven.aliyun.com/nexus/content/groups/public/，并将其移到最上面，再次下载ok
语法 SQL语法官网文档 数据同步 MySQL 数据库同步 clickhouse创建db clickhouse db
CREATE database test_db;clickhouse db of MySQL engin
CREATE DATABASE db_name ENGINE = MySQL(&#39;ip:port&#39;, &#39;db_name&#39;, &#39;user_name&#39;, &#39;passwd&#39;) clickhouse创建table。查看clickhouse数据类型：select * from system.data_type_families where case_insensitive=1;同步
insert into test_db.test select * from mysql_db.test1 t优势 操作简单外表 劣势 当MySQL表数据量比较大时，很容易出现timeout无法增量导入数据在复杂查询中，特别是有JOIN的情况下，访问外表是相当慢的，甚至不可能完成 基于Altinity的工具 安装clickhouse-mysql: pip install clickhouse-mysql同步：cmd 或 shell下执行 clickhouse-mysql --src-host=mysql_ip --src-port=mysql_port --src-user=mysql_user --src-password=mysql_pwd --migrate-table --src-schema=mysql_schema --src-tables=mysql_table --src-tables-where-clauses=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/14c528a77c309dd6a20843094af7fe48/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-17T17:31:48+08:00" />
<meta property="article:modified_time" content="2020-08-17T17:31:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ClickHouse &amp; OLAP</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="install_0"></a>install</h4> 
<ul><li><a href="https://gitee.com/xiwanggit/docker_clickhouse" rel="nofollow">docker install</a></li><li>connect by DBeaver 
  <ul><li>connect error: <code>cannot create driver instance</code> 
    <ul><li>原因：DBeaver下载ClickHouse驱动失败</li><li>解决方法：增加国内源的maven地址。<code>窗口-&gt;首选项-&gt;DBeaver-&gt;驱动 -&gt; Maven</code>。添加阿里云的maven地址<code>http://maven.aliyun.com/nexus/content/groups/public/</code>，并将其移到最上面，再次下载ok<br> <img src="https://images2.imgbox.com/7f/83/3Vscn2Rt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9d/53/QR6wJYs9_o.png" alt="在这里插入图片描述"></li></ul> </li><li></ul> </li></ul> 
<h4><a id="_9"></a>语法</h4> 
<ul><li><a href="https://clickhouse.tech/docs/en/sql-reference/syntax/" rel="nofollow">SQL语法</a></li><li><a href="https://clickhouse.tech/docs" rel="nofollow">官网文档</a></li></ul> 
<h4><a id="_12"></a>数据同步</h4> 
<ul><li>MySQL 
  <ul><li>数据库同步 
    <ul><li>clickhouse创建db 
      <ul><li>clickhouse db<br> <code>CREATE database test_db;</code></li><li>clickhouse db of MySQL engin<br> <code>CREATE DATABASE db_name ENGINE = MySQL('ip:port', 'db_name', 'user_name', 'passwd')</code></li></ul> </li><li>clickhouse创建table。查看clickhouse数据类型：<code>select * from system.data_type_families where case_insensitive=1;</code></li><li>同步<br> <code>insert into test_db.test select * from mysql_db.test1 t</code></li><li>优势 
      <ul><li>操作简单</li><li>外表</li></ul> </li><li>劣势 
      <ul><li>当MySQL表数据量比较大时，很容易出现<code>timeout</code></li><li>无法增量导入数据</li><li>在复杂查询中，特别是有JOIN的情况下，访问外表是相当慢的，甚至不可能完成</li></ul> </li></ul> </li><li>基于Altinity的工具 
    <ul><li>安装<code>clickhouse-mysql</code>: <code>pip install clickhouse-mysql</code></li><li>同步：<code>cmd</code> 或 <code>shell</code>下执行 
      <ul><li><code>clickhouse-mysql --src-host=mysql_ip --src-port=mysql_port --src-user=mysql_user --src-password=mysql_pwd --migrate-table --src-schema=mysql_schema --src-tables=mysql_table --src-tables-where-clauses="1=1 and cinemaId is not null" --dst-host=ch_ip --dst-port=9011 --dst-user=ch_user --dst-password=ch_pwd --dst-schema=ch_schema --dst-create-table --dst-table=ch_table</code></li></ul> </li><li>优势 
      <ul><li>支持<code>--src-tables-where-clauses</code></li><li>支持大数据量同步</li><li>支持增量同步<code>--binlog-position-file</code></li></ul> </li><li>劣势 
      <ul><li>需要命令行执行</li><li>需要安装 <code>clickhouse-mysql</code></li><li>是否仅支持MySQL还需要验证</li></ul> </li></ul> </li></ul> </li><li></ul> 
<h4><a id="_43"></a>性能比较</h4> 
<ul><li>MySQL与clickhouse 
  <ul><li>MySQL，耗时：<code>2.046s</code><pre><code class="prism language-sql"><span class="token keyword">select</span> b<span class="token punctuation">.</span><span class="token keyword">month</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>cinemaName<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>total<span class="token punctuation">)</span> <span class="token keyword">as</span> total

<span class="token keyword">from</span> <span class="token punctuation">(</span>

<span class="token keyword">select</span> substr<span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">month</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>cinemaName<span class="token punctuation">,</span> a<span class="token punctuation">.</span>avgViewBox <span class="token operator">*</span> viewInfo <span class="token keyword">as</span> total
<span class="token keyword">from</span> <span class="token keyword">table</span> a
<span class="token keyword">where</span> a<span class="token punctuation">.</span>cinemaName <span class="token operator">!=</span> <span class="token string">'全国'</span>
<span class="token operator">and</span> a<span class="token punctuation">.</span>viewInfo <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">'%万'</span>

<span class="token keyword">union</span> <span class="token keyword">all</span>

<span class="token keyword">select</span> substr<span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">month</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>cinemaName<span class="token punctuation">,</span>
a<span class="token punctuation">.</span>avgViewBox <span class="token operator">*</span> SUBSTR<span class="token punctuation">(</span>a<span class="token punctuation">.</span>viewInfo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LENGTH<span class="token punctuation">(</span>a<span class="token punctuation">.</span>viewInfo<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span> <span class="token keyword">as</span> total
<span class="token keyword">from</span> <span class="token keyword">table</span> a
<span class="token keyword">where</span> a<span class="token punctuation">.</span>cinemaName <span class="token operator">!=</span> <span class="token string">'全国'</span>
<span class="token operator">and</span> a<span class="token punctuation">.</span>viewInfo <span class="token operator">like</span> <span class="token string">'%万'</span>

<span class="token punctuation">)</span> b

<span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span><span class="token keyword">month</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>cinemaName
</code></pre> </li><li>clickhouse，耗时：<code>48ms</code><pre><code class="prism language-sql"><span class="token keyword">select</span> b<span class="token punctuation">.</span>year_month<span class="token punctuation">,</span> b<span class="token punctuation">.</span>cinemaName<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>total_info<span class="token punctuation">)</span>

<span class="token keyword">from</span> <span class="token punctuation">(</span>

<span class="token keyword">select</span> substr<span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> year_month <span class="token punctuation">,</span> m<span class="token punctuation">.</span>cinemaName <span class="token punctuation">,</span> 
multiply<span class="token punctuation">(</span>toFloat32OrZero<span class="token punctuation">(</span>m<span class="token punctuation">.</span>avgViewBox<span class="token punctuation">)</span><span class="token punctuation">,</span> toInt32OrZero<span class="token punctuation">(</span>m<span class="token punctuation">.</span>viewInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_info
<span class="token keyword">from</span> test_db<span class="token punctuation">.</span><span class="token keyword">table</span> m 
<span class="token keyword">where</span> viewInfo <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">'%万'</span>
<span class="token operator">and</span> cinemaName <span class="token operator">!=</span> <span class="token string">'全国'</span>

<span class="token keyword">union</span> <span class="token keyword">all</span>

<span class="token keyword">select</span> substr<span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> year_month<span class="token punctuation">,</span> m<span class="token punctuation">.</span>cinemaName<span class="token punctuation">,</span>
multiply<span class="token punctuation">(</span>toFloat32OrZero<span class="token punctuation">(</span>m<span class="token punctuation">.</span>avgViewBox<span class="token punctuation">)</span><span class="token punctuation">,</span> 
oInt32<span class="token punctuation">(</span>multiply<span class="token punctuation">(</span>toFloat32OrZero<span class="token punctuation">(</span>substring<span class="token punctuation">(</span>m<span class="token punctuation">.</span>viewInfo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LENGTH<span class="token punctuation">(</span>m<span class="token punctuation">.</span>viewInfo<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_info
<span class="token keyword">from</span> test_db<span class="token punctuation">.</span><span class="token keyword">table</span> m 
<span class="token keyword">where</span> viewInfo <span class="token operator">like</span> <span class="token string">'%万'</span>
<span class="token operator">and</span> cinemaName <span class="token operator">!=</span> <span class="token string">'全国'</span>

<span class="token punctuation">)</span> b

<span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>year_month<span class="token punctuation">,</span> b<span class="token punctuation">.</span>cinemaName
</code></pre> </li><li></ul> </li></ul> 
<h4><a id="Pyhton_94"></a>Pyhton</h4> 
<ul><li>读取</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> clickhouse_driver <span class="token keyword">import</span> Client


ch_host <span class="token operator">=</span> ip
ch_port <span class="token operator">=</span> port
ch_user <span class="token operator">=</span> user
ch_passwd <span class="token operator">=</span> pwd

sql <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
select * from test_db.test
"""</span>
<span class="token comment"># sql = 'show databases;'</span>

client <span class="token operator">=</span> Client<span class="token punctuation">(</span>host<span class="token operator">=</span>ch_host<span class="token punctuation">,</span> port<span class="token operator">=</span>ch_port<span class="token punctuation">,</span> user<span class="token operator">=</span>ch_user<span class="token punctuation">,</span> password<span class="token operator">=</span>ch_passwd<span class="token punctuation">)</span>

res <span class="token operator">=</span> client<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token operator">=</span>sql<span class="token punctuation">)</span>  <span class="token comment">#  list</span>
</code></pre> 
<ul><li>批量插入</li></ul> 
<pre><code class="prism language-python">arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">]</span>

data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    client<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'INSERT INTO test_db.test  VALUES'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> types_check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'write data error: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="OLAP_127"></a>OLAP及实时数仓架构</h4> 
<p><img src="https://images2.imgbox.com/da/fc/15EkKIgp_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0f/13/QJbXX3W4_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li>ODS 层：保存原始数据，对非结构化的数据进行结构化处理，轻度清洗，几乎不删除原始数据。来源：binlog 日志、埋点日志和应用程序日志</li><li>DWD 层：实时明细数据层，以业务过程作为建模驱动，基于每个具体的业务过程特点，构建最细粒度的明细层事实表；可以结合企业的数据使用特点，将明细事实表的某些重要维度属性字段做适当冗余，也即宽表化处理；</li><li>DM 层：以数据域+业务域的理念建设公共汇总层，对于DM层比较复杂，需要综合考虑对于数据落地的要求以及具体的查询引擎来选择不同的存储方式，分为轻度汇总层和高度汇总层，同时产出，高度汇总层数据用于前端比较简单的KV查询， 提升查询性能，比如实时大屏，实时报表等，数据的时效性要求为秒级，轻度汇总层Kafka中宽表实时写入OLAP存储引擎，用于前端产品复杂的OLAP查询场景，满足自助分析和产出复杂报表的需求，对数据的时效性要求可容忍到分钟级</li><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/try-flink/python_table_api.html" rel="nofollow">pyflink</a></li></ul> 
<h4><a id="_134"></a>应用</h4> 
<ul><li><a href="https://mp.weixin.qq.com/s/_pXPDbhqC1B1HQWQQEfAGw" rel="nofollow">QQ音乐</a></li><li><a href="https://mp.weixin.qq.com/s/hqUCFSr8cu3x3u8HCA6WYg" rel="nofollow">字节跳动</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7ed50e44e88efafd2447ca2d9bcd87f6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">树莓派利用socket传图到pc端（Python）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/67ceb0e09dbc17061318d035cbec8eeb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">查询水果价格 (15分)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>