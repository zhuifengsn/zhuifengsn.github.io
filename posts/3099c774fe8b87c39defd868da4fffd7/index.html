<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>dicom worklist、pacs环境搭建 - 追风少年的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="dicom worklist、pacs环境搭建" />
<meta property="og:description" content="dcmtk的安装和使用 OFFIS DICOM 工具包 官网：dicom.offis.de - DICOM Software made by OFFIS - DCMTK - DICOM Toolkit
windows版本下载地址：https://dicom.offis.de/download/dcmtk/dcmtk366/bin/dcmtk-3.6.6-win64-dynamic.zip
部分工具包使用方法记录
wlmscpfs .exe 启动worklist管理的SCP服务工具🔗
相关命令：
wlmscpfs.exe -d -dfr -dfp wlistdb 104 -d 可以查看一些输出信息 -dfr 表示接受字段不完整的 DICOM 文件作为查询内容； -dfp wlistdb 表明 wlmscpfs.exe 搜索的文件夹的路径，可以为绝对路径； 104 为工作列表程序的端口号； wlistdb 文件夹下的 OFFIS 表示 AETITLE （AETITLE作为文件夹命名，文件夹下存放查询的wl文件，在该目录下新建一个lockfile的空文件）。 dump2dcm.exe 将ascii dump文件转换成dicom文件工具🔗
用于测试的dump文件可以拉dcmtk的源码 ：GitHub - DCMTK/dcmtk: Official DCMTK Github Mirror，然后在目录dcmwlm/data/wlistdb/OFFIS中查看，
这里选择wlist1.dump
对于dump文件，用记事本打开，可以看到一部分信息，其中比较重要的：
(0010,0010)（患者姓名）、(0010,0020)（患者编号）、(0010,0030)（出生日期）、(0010,0040)（性别）、(0020,000d)（检查号）、(0008,0060)（设备 Modality）、(0040,0001)（AE Title）、(0040,0002)（检查、预约日期）和 (0040,0003)（检查、预约时间）。
相关命令：
dump2dcm.exe wlist1.dump wlist1.wl --write-xfer-little ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuifengsn.github.io/posts/3099c774fe8b87c39defd868da4fffd7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-28T11:16:41+08:00" />
<meta property="article:modified_time" content="2021-12-28T11:16:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="追风少年的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">追风少年的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">dicom worklist、pacs环境搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>dcmtk的安装和使用</h3> 
<p>OFFIS DICOM 工具包 官网：<a href="https://www.dcmtk.org/dcmtk.php.en" rel="nofollow" title="dicom.offis.de - DICOM Software made by OFFIS - DCMTK - DICOM Toolkit">dicom.offis.de - DICOM Software made by OFFIS - DCMTK - DICOM Toolkit</a></p> 
<p>windows版本下载地址：<a href="https://dicom.offis.de/download/dcmtk/dcmtk366/bin/dcmtk-3.6.6-win64-dynamic.zip" rel="nofollow" title="https://dicom.offis.de/download/dcmtk/dcmtk366/bin/dcmtk-3.6.6-win64-dynamic.zip">https://dicom.offis.de/download/dcmtk/dcmtk366/bin/dcmtk-3.6.6-win64-dynamic.zip</a></p> 
<p>部分工具包使用方法记录</p> 
<h4>wlmscpfs .exe</h4> 
<p>启动worklist管理的SCP服务工具<a href="https://support.dcmtk.org/docs/wlmscpfs.html" rel="nofollow" title="🔗">🔗</a></p> 
<p>相关命令：</p> 
<pre><code>wlmscpfs.exe -d -dfr -dfp wlistdb 104

-d 可以查看一些输出信息
-dfr 表示接受字段不完整的 DICOM 文件作为查询内容；
-dfp wlistdb 表明 wlmscpfs.exe 搜索的文件夹的路径，可以为绝对路径；
104  为工作列表程序的端口号；
wlistdb 文件夹下的 OFFIS 表示 AETITLE （AETITLE作为文件夹命名，文件夹下存放查询的wl文件，在该目录下新建一个lockfile的空文件）。</code></pre> 
<h4>dump2dcm.exe</h4> 
<p>将ascii dump文件转换成dicom文件工具<a href="https://support.dcmtk.org/docs/dump2dcm.html" rel="nofollow" title="🔗">🔗</a></p> 
<p>用于测试的dump文件可以拉dcmtk的源码 ：<a href="https://github.com/DCMTK/dcmtk" title="GitHub - DCMTK/dcmtk: Official DCMTK Github Mirror">GitHub - DCMTK/dcmtk: Official DCMTK Github Mirror</a>，然后在目录dcmwlm/data/wlistdb/OFFIS中查看，</p> 
<p><img alt="" height="338" src="https://images2.imgbox.com/46/d0/Nio8ukZf_o.png" width="778"></p> 
<p> </p> 
<p>这里选择wlist1.dump</p> 
<p>对于dump文件，用记事本打开，可以看到一部分信息，其中比较重要的：</p> 
<p>(0010,0010)（患者姓名）、(0010,0020)（患者编号）、(0010,0030)（出生日期）、(0010,0040)（性别）、(0020,000d)（检查号）、(0008,0060)（设备 Modality）、(0040,0001)（AE Title）、(0040,0002)（检查、预约日期）和 (0040,0003)（检查、预约时间）。</p> 
<p>相关命令：</p> 
<pre><code>dump2dcm.exe wlist1.dump wlist1.wl --write-xfer-little</code></pre> 
<p>.wl 文件就是.dcm文件，但文件中并不包含真实的像素信息，只包含头部信息。</p> 
<p>最终可以将生成的.wl文件放到wlmscpfs所对应的AE（AE_WYJ）目录下去。</p> 
<h4>findscu.exe</h4> 
<p>dicom查询SCU工具<a href="https://support.dcmtk.org/docs/findscu.html" rel="nofollow" title="🔗">🔗</a></p> 
<p>通过findscu.exe查询文件需要对应的模板文件，查出来的wl信息会根据模板信息展示，所以前提需要准备一个模板的wl文件。</p> 
<p>在dcmtk源码文件夹dcmwlm/data/wlistqry目录下，找到对应的模板dump文件，</p> 
<p><img alt="" height="389" src="https://images2.imgbox.com/fd/5e/9ULx7m3i_o.png" width="850"></p> 
<p> </p> 
<p>这里选择wlistqry1.dump</p> 
<p>相关命令：</p> 
<pre><code># 将wlistqry1.dump转换为将wlistqry1.wl
dcmp2dcm.exe 将wlistqry0.dump 将wlistqry0.wl --write-xfer-little
# 通过findscu查询wl
findscu.exe 10.150.2.78 104 -aec AE_WYJ wlistqry1.wl
-aec 被请求或者说被呼叫的应用端的名称，即命名的AE文件夹AE_WYJ
AE_WYJ 查询的AE
wlistqry1.wl 模板文件wl</code></pre> 
<p><img alt="" height="772" src="https://images2.imgbox.com/4f/ea/RTcbbvU1_o.png" width="1200"></p> 
<p> </p> 
<h4>storescu.exe</h4> 
<p>dicom存储SCU（c-store）工具<a href="https://support.dcmtk.org/docs/storescu.html" rel="nofollow" title="🔗">🔗</a></p> 
<pre><code>storescu.exe -aec DCM4CHEE 10.150.1.98 11112 -v  1.dcm
-aec 即pacs的AE DCM4CHEE</code></pre> 
<h4>dcmdump.exe</h4> 
<p>转储 DICOM 文件和数据集，可以查看.dcm等文件<a href="https://support.dcmtk.org/docs/dcmdump.html" rel="nofollow" title="🔗">🔗</a></p> 
<p>相关命令：</p> 
<pre><code>dcmdump.exe 1.dcm</code></pre> 
<h3>worklist服务搭建</h3> 
<p>debain环境下，dcmtk的使用</p> 
<ol><li> <p>安装dcmtk</p> <pre><code>apt install dcmtk</code></pre> </li><li> <p>准备测试数据</p> 数据文件wlist1.dump、查询文件wlistqry1.dump</li><li> <p>dump转换成wl（本地执行）</p> <pre><code>dcmp2dcm.exe wlist1.dump wlist1.wl --write-xfer-little
dcmp2dcm.exe wlistqry1.dump wlistqry1.wl --write-xfer-little</code></pre> </li><li> <p>服务器目录结构</p> <pre><code>/home/dicom --主文件夹
/home/dicom/wlistdb -- worklist数据文件夹，存放所有AE文件夹
/home/dicom/wlistdb/AE_WYJ  -- 此处新建一个AE_WYJ文件夹，表示有一个名为AE_WYJ的AE，里面存放所有对应的wl文件
/home/dicom/wlistdb/AE_WYJ/lockfile -- 每个目录下需要存放一个空的lockfile文件，touch lockfile命令创建
/home/dicom/wlistdb/AE_WYJ/wlist1.wl -- 将步骤3中的wlist1.wl放到此目录</code></pre> </li><li> <p>启动worklist服务</p> <pre><code># 启动端口为104的worklist服务 
wlmscpfs -d -dfr -dfp wlistdb 104 </code></pre> <p>后台运行可以用nohup启动</p> <pre><code>nohup wlmscpfs -d -dfr -dfp wlistdb 104 &amp;</code></pre> <p>关闭直接杀掉进程</p> <pre><code>ps -ef|grep wlmscpfs
kill -9 进程号</code></pre> </li></ol> 
<h3>pacs服务搭建</h3> 
<p>采用docker搭建的方式，确保环境下已经安装了docker，debain环境安装docker方式参见官网：<a href="https://docs.docker.com/engine/install/debian/" rel="nofollow" title="Install Docker Engine on Debian | Docker Documentation">Install Docker Engine on Debian | Docker Documentation</a></p> 
<p>docker pacs的搭建方式主要参考了官网<a href="https://github.com/dcm4che/dcm4chee-arc-light/wiki/Run-minimum-set-of-archive-services-on-a-single-host" title="https://github.com/dcm4che/dcm4chee-arc-light/wiki/Run-minimum-set-of-archive-services-on-a-single-host">https://github.com/dcm4che/dcm4chee-arc-light/wiki/Run-minimum-set-of-archive-services-on-a-single-host</a>，此处安装最新版本的dcm4chee-arc-light 5.25.0，记录关键步骤：</p> 
<ol><li> <p>创建一个docker的默认桥接</p> <pre><code>docker network create dcm4chee_network</code></pre> </li><li> <p>开启openldap 服务</p> <pre><code>docker run --network=dcm4chee_network --name ldap \
           -p 389:389 \
           -v /var/local/dcm4chee-arc/ldap:/var/lib/openldap/openldap-data \
           -v /var/local/dcm4chee-arc/slapd.d:/etc/openldap/slapd.d \
           -d dcm4che/slapd-dcm4chee:2.6.0-25.0</code></pre> </li><li> <p>开启PostgreSQL服务</p> <pre><code>docker run --network=dcm4chee_network --name db \
           -p 5432:5432 \
           -e POSTGRES_DB=pacsdb \
           -e POSTGRES_USER=pacs \
           -e POSTGRES_PASSWORD=pacs \
           -v /etc/localtime:/etc/localtime:ro \
           -v /etc/timezone:/etc/timezone:ro \
           -v /var/local/dcm4chee-arc/db:/var/lib/postgresql/data \
           -d dcm4che/postgres-dcm4chee:14.1-25</code></pre> </li><li> <p>用已部署的 dcm4che Archive 5 应用程序启动 Wildfly</p> <pre><code>docker run --network=dcm4chee_network --name arc \
           -p 8080:8080 \
           -p 8443:8443 \
           -p 9990:9990 \
           -p 9993:9993 \
           -p 11112:11112 \
           -p 2762:2762 \
           -p 2575:2575 \
           -p 12575:12575 \
           -e POSTGRES_DB=pacsdb \
           -e POSTGRES_USER=pacs \
           -e POSTGRES_PASSWORD=pacs \
           -e WILDFLY_WAIT_FOR="ldap:389 db:5432" \
           -v /etc/localtime:/etc/localtime:ro \
           -v /etc/timezone:/etc/timezone:ro \
           -v /var/local/dcm4chee-arc/wildfly:/opt/wildfly/standalone \
           -d dcm4che/dcm4chee-arc-psql:5.25.0</code></pre> <p>相关命令执行完毕后，直接打开网页：</p> <p><a href="http://10.150.2.78:8080/dcm4chee-arc/ui2/" rel="nofollow" title="http://10.150.2.78:8080/dcm4chee-arc/ui2/">http://10.150.2.78:8080/dcm4chee-arc/ui2/</a></p> <p>如果可以成功打开，则说明已经安装成功了。</p> <img alt="" height="1040" src="https://images2.imgbox.com/b5/4a/MhapE1GR_o.png" width="1200"></li><li> <p> 使用本地storescu.exe进行测试</p> <pre><code>storescu.exe -aec DCM4CHEE 10.150.1.98 11112 -v 1.dcm</code></pre> <p><img alt="" height="269" src="https://images2.imgbox.com/f5/99/K35yBcZG_o.png" width="1200"></p> <p> 可以确定已经上传成功，上传成功的dcm可以在series下点击submit查看</p> <img alt="" height="1028" src="https://images2.imgbox.com/6d/4d/uTleLXgz_o.png" width="1200"></li></ol> 
<p> </p> 
<p>                   </p> 
<p> </p> 
<p> </p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/85b94fe54b606daae6e3721a6270e72a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">VMware 虚拟机无法上网，显示“网络电缆被拔出”的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fbc840c18d1defe31bb5c1ffeb345ac4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Opencv中Mat类详细解读（学习笔记）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 追风少年的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>